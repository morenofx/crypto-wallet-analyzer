<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CryptoFolio v8.70</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#16213e;--border:#2d2d44;--grid:#1e1e35;--text:#fff;--text2:#a0a0a0;--green:#00cec9;--red:#ff6b6b;--blue:#6c5ce7;--yellow:#fdcb6e;--cyan:#00b894;--purple:#a29bfe}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}.sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);padding:16px;position:fixed;height:100vh;display:flex;flex-direction:column}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:30px}.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),#a29bfe);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}.logo-text{font-size:18px;font-weight:700}
.nav{padding:10px 14px;color:var(--text2);cursor:pointer;border-radius:8px;margin-bottom:4px;display:flex;align-items:center;gap:10px;font-size:14px}.nav:hover{background:var(--bg3)}.nav.active{background:var(--blue);color:#fff}
.sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}
.main{flex:1;margin-left:220px;padding:24px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.title{font-size:24px;font-weight:600}.card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px}
.stat{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px}.stat-label{font-size:12px;color:var(--text2);margin-bottom:6px}.stat-value{font-size:22px;font-weight:700;color:var(--green)}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:#a29bfe}.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}.btn-danger{background:var(--red);color:#fff}.btn-sm{padding:6px 12px;font-size:11px}
.input{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;width:100%}.input:focus{outline:none;border-color:var(--blue)}
.table{width:100%;border-collapse:collapse;table-layout:fixed}.table th,.table td{padding:14px 12px;border:1px solid var(--grid);vertical-align:middle}.table th{text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;font-weight:500;background:var(--bg2)}.table td{background:var(--bg3)}.table tr:hover td{background:var(--bg2)}
.token-cell{display:flex;align-items:center;gap:10px}.token-icon{width:32px;height:32px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:10px;overflow:hidden;flex-shrink:0}.token-icon img{width:100%;height:100%;object-fit:cover}
.token-info{min-width:0}.token-info .symbol{font-weight:600;font-size:13px}.token-info .name{font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}.badge-ok{background:var(--green);color:#000}.badge-bad{background:var(--red);color:#fff}.badge-unk{background:var(--bg2);color:var(--text2)}
.chain-tag{display:inline-block;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:500;white-space:nowrap}
.text-mono{font-family:'SF Mono',Monaco,monospace;font-size:12px}.text-right{text-align:right!important}.text-center{text-align:center!important}
.top-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);gap:12px}.top-item:last-child{border-bottom:none}
.top-icon{flex-shrink:0}.top-info{flex:1;min-width:0}.top-row1{display:flex;align-items:center;gap:6px;margin-bottom:2px}.top-sym{font-weight:600;font-size:13px}.top-amt{font-size:10px;color:var(--text2)}
.top-values{text-align:right;flex-shrink:0}.top-val{font-weight:700;font-size:14px;color:var(--green)}.top-pct{font-size:10px;color:var(--text2)}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}.chart-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px}.chart-wrap{height:220px;position:relative}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:20px;width:95%;max-width:520px;max-height:85vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}.modal-title{font-size:16px;font-weight:600}.modal-close{background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer}
.auth-box{min-height:100vh;display:flex;align-items:center;justify-content:center}.auth-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:28px;width:100%;max-width:340px}
.form-group{margin-bottom:14px}.form-label{display:block;margin-bottom:6px;font-size:12px;color:var(--text2)}
.progress{width:100%;height:6px;background:var(--bg2);border-radius:4px;overflow:hidden}.progress-bar{height:100%;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .3s}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{to{transform:rotate(360deg)}}
.scan-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px}
.scan-log{background:var(--bg);border-radius:6px;padding:8px;max-height:150px;overflow-y:auto;font-family:'SF Mono',Monaco,monospace;font-size:10px;margin-top:8px}
.log-ok{color:var(--green)}.log-err{color:var(--red)}.log-info{color:var(--text2)}.log-warn{color:var(--yellow)}
.flex{display:flex}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-4{gap:4px}.gap-8{gap:8px}.gap-12{gap:12px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px 16px;z-index:2000;font-size:13px}.toast.success{border-left:4px solid var(--green)}.toast.error{border-left:4px solid var(--red)}
.tabs{display:flex;gap:8px;margin-bottom:16px}.tab{padding:8px 16px;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;font-size:13px}.tab.active{color:var(--green);border-bottom-color:var(--green)}
.chain-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.chain-item{display:flex;align-items:center;gap:6px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px}
.chain-item.active{border-color:var(--green);background:rgba(0,206,201,.1)}.chain-item input{accent-color:var(--green)}
.chain-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.api-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chk{width:18px;height:18px;accent-color:var(--red);cursor:pointer}
.bulk-bar{background:var(--red);color:#fff;padding:10px 16px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.charts{grid-template-columns:1fr}.chain-grid{grid-template-columns:repeat(2,1fr)}.api-grid{grid-template-columns:1fr}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div id="authScreen" class="auth-box">
<div class="auth-card">
<div class="logo" style="justify-content:center;margin-bottom:20px"><div class="logo-icon">ğŸ’</div><div class="logo-text">CryptoFolio</div></div>
<p style="color:var(--text2);text-align:center;margin-bottom:20px;font-size:12px" id="authVersion">v8.54</p>
<div class="form-group"><label class="form-label">Email</label><input id="authEmail" type="email" class="input"></div>
<div class="form-group"><label class="form-label">Password</label><input id="authPassword" type="password" class="input"></div>
<div id="authError" style="color:var(--red);font-size:12px;margin-bottom:12px"></div>
<div class="flex gap-8"><button onclick="handleLogin()" class="btn btn-primary" style="flex:1">Login</button><button onclick="handleSignup()" class="btn btn-secondary" style="flex:1">Registrati</button></div>
</div>
</div>
<div id="appScreen" class="app" style="display:none">
<aside class="sidebar">
<div class="logo"><div class="logo-icon">ğŸ’</div><div class="logo-text">CryptoFolio</div></div>
<nav><div class="nav active" data-page="dashboard" onclick="showPage('dashboard')">ğŸ“Š Dashboard</div><div class="nav" data-page="wallets" onclick="showPage('wallets')">ğŸ‘› Wallets</div><div class="nav" data-page="exchange" onclick="showPage('exchange')">ğŸ¦ Exchange</div><div class="nav" data-page="tokens" onclick="showPage('tokens')">ğŸª™ Token</div><div class="nav" data-page="settings" onclick="showPage('settings')">âš™ï¸ Settings</div></nav>
<div class="sidebar-footer"><span id="appVersion">v8.54</span><br>ğŸŒ 19 chains<br><span id="sidebarApiStatus">ğŸ”‘ 4 keys</span><br><button onclick="handleLogout()" class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:11px">ğŸšª Logout</button></div>
</aside>
<main class="main">
<div id="page-dashboard">
<div class="header"><h1 class="title">Dashboard</h1><div class="flex gap-8"><button id="currencyBtn" onclick="toggleCurrency()" class="btn btn-secondary btn-sm">ğŸ’¶ EUR</button><button onclick="refreshPrices()" class="btn btn-secondary btn-sm">ğŸ”„</button></div></div>
<div class="stats"><div class="stat"><div class="stat-label">Valore Totale</div><div class="stat-value" id="totalValue">â‚¬0</div></div><div class="stat"><div class="stat-label">Token</div><div class="stat-value" id="totalTokens">0</div></div><div class="stat"><div class="stat-label">Wallets</div><div class="stat-value" id="totalWallets">0</div></div><div class="stat"><div class="stat-label">Chains</div><div class="stat-value" id="totalChains">0</div></div></div>
<div class="charts"><div class="chart-card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">ğŸ“Š Per Chain</div><div class="chart-wrap"><canvas id="chainChart"></canvas></div></div><div class="chart-card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">ğŸ† Top 5</div><div id="topList"></div></div></div>
</div>
<div id="page-wallets" style="display:none">
<div class="header"><h1 class="title">Wallets</h1><button onclick="showAddWallet()" class="btn btn-primary btn-sm">â• Aggiungi</button></div>
<div id="walletScanBox" class="scan-box" style="display:none"><div class="flex justify-between items-center mb-12"><span id="walletScanTitle">ğŸ” Scansione...</span><span id="walletScanPct">0%</span></div><div class="progress"><div class="progress-bar" id="walletScanBar" style="width:0%"></div></div><div id="walletScanStatus" style="font-size:11px;color:var(--text2);margin-top:6px"></div><div class="scan-log" id="walletScanLog"></div></div>
<div class="card"><div id="walletsList"></div></div>
</div>
<div id="page-wallet-detail" style="display:none">
<div class="header">
<div class="flex items-center gap-12"><button onclick="showPage('wallets')" class="btn btn-secondary btn-sm">â†</button><h1 class="title" id="wdName">Wallet</h1></div>
<div class="flex gap-8"><button onclick="renameCurrentWallet()" class="btn btn-sm" style="background:var(--yellow)20;color:var(--yellow)">âœï¸ Rinomina</button><button onclick="scanCurrentWallet()" class="btn btn-primary btn-sm">ğŸ” Scan</button><button onclick="loadWalletTx()" class="btn btn-secondary btn-sm">ğŸ“œ TX</button><button onclick="deleteCurrentWallet()" class="btn btn-sm" style="background:var(--red)20;color:var(--red)">ğŸ—‘ï¸</button></div>
</div>
<div id="wdScanBox" class="scan-box" style="display:none"><div class="flex justify-between items-center mb-12"><span id="wdScanTitle">ğŸ” Scansione...</span><span id="wdScanPct">0%</span></div><div class="progress"><div class="progress-bar" id="wdScanBar" style="width:0%"></div></div><div id="wdScanStatus" style="font-size:11px;color:var(--text2);margin-top:6px"></div><div class="scan-log" id="wdScanLog"></div></div>
<div class="card mb-16"><div class="flex justify-between items-center"><div><div style="font-size:11px;color:var(--text2)">Indirizzo</div><code id="wdAddr" style="font-size:9px;word-break:break-all"></code></div><div style="text-align:right"><div style="font-size:22px;font-weight:700;color:var(--green)" id="wdValue">â‚¬0</div><div style="font-size:11px;color:var(--text2)"><span id="wdTokens">0</span> token</div></div></div></div>
<div class="card mb-16"><div onclick="document.getElementById('wdChainSection').style.display=document.getElementById('wdChainSection').style.display==='none'?'block':'none'" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;font-weight:600">â›“ï¸ Chain da scansionare</span><span style="font-size:10px;color:var(--text2)">â–¼ espandi</span></div><div id="wdChainSection" style="display:none;margin-top:12px"><div class="flex gap-8 mb-12"><button onclick="selectAllChainsWd()" class="btn btn-sm btn-primary">âœ… Tutte</button><button onclick="selectNoChainsWd()" class="btn btn-sm btn-secondary">âŒ Nessuna</button></div><div id="wdChainGrid" class="chain-grid"></div><button onclick="saveWalletChains()" class="btn btn-primary btn-sm" style="margin-top:12px;width:100%">ğŸ’¾ Salva Chain</button></div></div>
<div class="tabs"><div class="tab active" onclick="showWalletTab('tokens')">ğŸª™ Token</div><div class="tab" onclick="showSavedTx()">ğŸ“œ TX</div><div class="tab" onclick="showNFTs()">ğŸ–¼ï¸ NFT</div></div>
<div id="bulkBar" class="bulk-bar" style="display:none"><span id="bulkCount">0 selezionati</span><div class="flex gap-8"><button onclick="selectAllTokens()" class="btn btn-sm btn-secondary">Tutti</button><button onclick="deselectAllTokens()" class="btn btn-sm btn-secondary">Nessuno</button><button onclick="deleteSelectedTokens()" class="btn btn-sm btn-danger">ğŸ—‘ï¸ Elimina</button></div></div>
<div class="card" id="wdTokensTab" style="max-height:500px;overflow-y:auto"></div>
<div class="card" id="wdTxTab" style="display:none;max-height:500px;overflow-y:auto"></div>
<div class="card" id="wdNftTab" style="display:none;max-height:600px;overflow-y:auto"></div>
</div>
<div id="page-exchange" style="display:none">
<div class="header"><h1 class="title">ğŸ¦ Exchanges</h1><div class="flex gap-8"><button onclick="resetExchangeData()" class="btn btn-sm" style="background:var(--red)20;color:var(--red)">ğŸ—‘ï¸ Reset</button><button onclick="showApiModal()" class="btn btn-secondary btn-sm">ğŸ”— Connetti API</button><button onclick="showImportModal()" class="btn btn-primary btn-sm">ğŸ“¥ Import CSV</button><button onclick="showEarnReport()" class="btn btn-sm" style="background:linear-gradient(135deg,#f7971e,#ffd200);color:#000">ğŸ Report Earn</button><button onclick="reconcileTransfers()" class="btn btn-sm" style="background:linear-gradient(135deg,#00c9ff,#92fe9d);color:#000">ğŸ”„ Riconcilia</button><button onclick="calcRW()" class="btn btn-sm" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff">ğŸ“‹ Calcola RW</button></div></div>
<div class="card mb-16" style="background:linear-gradient(135deg,rgba(243,186,47,0.1),rgba(0,230,118,0.1))">
<div style="font-size:13px;font-weight:600;margin-bottom:12px">ğŸ“Š Transazioni per Anno</div>
<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px" id="exYearGrid">
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2021</div><div id="exYear2021">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2022</div><div id="exYear2022">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2023</div><div id="exYear2023">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2024</div><div id="exYear2024">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2025</div><div id="exYear2025">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2026</div><div id="exYear2026">0 TX</div></div>
</div>
</div>
<div id="exExchangeGrid" style="display:flex;flex-direction:column;gap:16px"></div>
</div>
<div id="page-exchange-detail" style="display:none">
<div class="header"><button onclick="showPage('exchange')" class="btn btn-secondary btn-sm">â† Indietro</button><h1 class="title" id="exDetailName" style="margin-left:12px">Exchange</h1><button onclick="resetCurrentExchange()" class="btn btn-sm" style="margin-left:auto;background:var(--red)20;color:var(--red)">ğŸ—‘ï¸ Reset</button></div>
<div class="stats" id="exDetailStats"></div>
<div class="card mb-16">
<div class="flex gap-8 mb-12 flex-wrap"><select id="exDetailYear" class="input" style="width:100px" onchange="loadExchangeDetail()"><option value="">Tutti</option><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option><option value="2021">2021</option></select><select id="exDetailType" class="input" style="width:140px" onchange="loadExchangeDetail()"><option value="">Tutti tipi</option><option value="deposit">ğŸ“¥ Depositi</option><option value="withdraw">ğŸ“¤ Prelievi</option><option value="trade_buy">ğŸ›’ Acquisti</option><option value="trade_sell">ğŸ’° Vendite</option><option value="fee">ğŸ’¸ Fee</option><option value="convert">ğŸ”„ Convert</option><option value="dust">ğŸ§¹ Dust</option><option value="reward">ğŸ Rewards</option><option value="earn_sub">â¬‡ï¸ Earn Sub</option><option value="earn_red">â¬†ï¸ Earn Red</option><option value="earn_move">â†•ï¸ Earn Move</option><option value="fiat_buy">ğŸ’³ Fiat Buy</option><option value="fiat_deposit">ğŸ’¶ Fiat Deposit</option><option value="card_spend">ğŸ’³ Card</option><option value="transfer">â†”ï¸ Transfer</option><option value="liquidity">ğŸŒŠ Liquidity</option><option value="payment">ğŸª Payment</option><option value="send">ğŸ“¨ Send</option><option value="internal_transfer">ğŸ”— Trasf. Interno</option><option value="earn">ğŸ¦ Earn</option><option value="other_in">â“ Other In</option><option value="other_out">â“ Other Out</option></select><input type="text" id="exDetailSearch" class="input" placeholder="ğŸ” Cerca coin..." oninput="loadExchangeDetail()" style="flex:1;min-width:150px"></div>
<div id="exDetailList" style="max-height:500px;overflow-y:auto;padding-right:12px"></div>
</div>
</div>
<div id="page-tokens" style="display:none">
<div class="header"><h1 class="title">Token Manager</h1><div class="flex gap-8"><button onclick="showWhitelist()" class="btn btn-secondary btn-sm">âœ… WL</button><button onclick="showBlacklist()" class="btn btn-secondary btn-sm">ğŸš« BL</button></div></div>
<div class="card">
<div class="flex gap-8 mb-16"><input type="text" id="tmSearch" class="input" placeholder="ğŸ” Cerca..." oninput="renderTM()" style="flex:1"><select id="tmFilter" class="input" style="width:130px" onchange="renderTM()"><option value="visible">ğŸ‘ Visibili</option><option value="hidden">ğŸš« Nascosti</option><option value="all">ğŸ“‹ Tutti</option></select></div>
<div id="tmList" style="max-height:500px;overflow-y:auto"></div>
</div>
</div>
<div id="page-settings" style="display:none">
<div class="header"><h1 class="title">Impostazioni</h1></div>
<div class="card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">ğŸ”‘ API Keys Moralis</div><div class="api-grid"><div class="form-group"><label class="form-label">Key 1</label><input id="apiKey1" class="input"></div><div class="form-group"><label class="form-label">Key 2</label><input id="apiKey2" class="input"></div><div class="form-group"><label class="form-label">Key 3</label><input id="apiKey3" class="input"></div><div class="form-group"><label class="form-label">Key 4</label><input id="apiKey4" class="input"></div></div><button onclick="saveApiKeys()" class="btn btn-primary" style="margin-top:8px">ğŸ’¾ Salva</button></div>
<div class="card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">â˜€ï¸ Helius API Key <span style="font-size:11px;color:var(--text2)">(Solana)</span></div><div style="display:flex;gap:8px;align-items:center"><input id="heliusKey" class="input" style="flex:1" placeholder="Helius API key..."><button onclick="saveHeliusKey()" class="btn btn-primary">ğŸ’¾</button></div><div style="font-size:11px;color:var(--text2);margin-top:6px">ğŸ†“ <a href="https://dashboard.helius.dev" target="_blank" style="color:var(--acc)">Registrati gratis</a> â€” 500K req/mese â€¢ Token + NFT + TX + Prezzi in una API</div><div id="heliusStatus" style="font-size:11px;margin-top:4px"></div></div>
<div class="card"><div class="form-group"><label class="form-label">Valuta</label><select id="setCurrency" class="input" onchange="saveCurrency()"><option value="eur">EUR</option><option value="usd">USD</option></select></div></div>
<div class="card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">ğŸš« Blacklist Stats</div><div id="blStats" style="font-size:12px;color:var(--text2)"></div></div>
<div class="card"><div class="flex gap-8"><button onclick="exportCSV()" class="btn btn-secondary">ğŸ“¤ CSV</button><button onclick="clearBlacklist()" class="btn btn-secondary">ğŸ§¹ Reset BL</button><button onclick="clearAllData()" class="btn btn-danger">ğŸ—‘ï¸ Reset</button></div></div>
</div>
</main>
</div>
<div id="addWalletModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">â• Aggiungi Wallet</h2><button class="modal-close" onclick="closeModal('addWalletModal')">&times;</button></div><div class="form-group"><label class="form-label">Nome</label><input id="wName" class="input" placeholder="MetaMask..."></div><div class="form-group"><label class="form-label">Indirizzo</label><input id="wAddr" class="input" placeholder="0x..."></div><div class="form-group"><label class="form-label">Chain</label><div class="flex gap-8 mb-12"><button onclick="selectAllChains()" class="btn btn-sm btn-primary">âœ… Tutte</button><button onclick="selectNoChains()" class="btn btn-sm btn-secondary">âŒ Nessuna</button></div><div id="modalChainGrid" class="chain-grid"></div></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('addWalletModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="addWallet()" class="btn btn-primary" style="flex:1">â• Aggiungi</button></div></div></div>
<div id="wlModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">âœ… Whitelist</h2><button class="modal-close" onclick="closeModal('wlModal')">&times;</button></div><div class="flex gap-8 mb-16"><input id="wlAdd" class="input" placeholder="Simbolo (es. BTC)"><button onclick="addToWhitelist()" class="btn btn-primary btn-sm">â•</button></div><div id="wlList" style="max-height:300px;overflow-y:auto"></div></div></div>
<div id="blModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">ğŸš« Blacklist</h2><button class="modal-close" onclick="closeModal('blModal')">&times;</button></div><div class="tabs mb-12"><div class="tab active" onclick="showBlTab('symbols')">Simboli (<span id="blSymCount">0</span>)</div><div class="tab" onclick="showBlTab('contracts')">Contratti (<span id="blConCount">0</span>)</div></div><div id="blSymbols"><div class="flex gap-8 mb-16"><input id="blAdd" class="input" placeholder="Simbolo"><button onclick="addToBlacklist()" class="btn btn-primary btn-sm">â•</button></div><div id="blList" style="max-height:250px;overflow-y:auto"></div></div><div id="blContracts" style="display:none"><div id="blConList" style="max-height:300px;overflow-y:auto;font-size:10px"></div></div></div></div>
<div id="importModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">ğŸ“¥ Import CSV/XLSX Exchange</h2><button class="modal-close" onclick="closeModal('importModal')">&times;</button></div><div class="form-group"><label class="form-label">Exchange</label><select id="importExchange" class="input"><option value="binance">Binance</option><option value="bitget">Bitget</option><option value="bitpanda">Bitpanda</option><option value="bybit">Bybit</option><option value="bybit_eu">Bybit EU</option><option value="coinbase">Coinbase</option><option value="crypto_com">Crypto.com App</option><option value="crypto_com_ex">Crypto.com Exchange</option><option value="gate">Gate.io</option><option value="kraken">Kraken</option><option value="kucoin">KuCoin</option><option value="mexc">MEXC</option><option value="nexo">Nexo</option><option value="okx">OKX</option><option value="pionex">Pionex</option><option value="revolut">Revolut</option><option value="whitebit">WhiteBIT</option><option value="youhodler">YouHodler</option><option value="youngplatform">Young Platform</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">File CSV, XLSX o ZIP</label><input type="file" id="importFile" accept=".csv,.zip,.xlsx,.xls" class="input" multiple><div style="font-size:10px;color:var(--text2);margin-top:4px">Puoi caricare CSV, XLSX o ZIP con piÃ¹ file</div><div style="font-size:10px;color:var(--green);margin-top:2px">âœ“ I duplicati vengono ignorati automaticamente</div></div><div id="importPreview" style="display:none;margin:12px 0;padding:12px;background:var(--card);border-radius:8px"><div style="font-size:11px;color:var(--text2)" id="importInfo"></div></div><div id="importProgress" style="display:none;margin:12px 0"><div class="progress"><div class="progress-bar" id="importBar" style="width:0%"></div></div><div style="font-size:11px;color:var(--text2);margin-top:4px" id="importStatus"></div></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('importModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="importCSV()" class="btn btn-primary" style="flex:1" id="importBtn">ğŸ“¥ Importa</button></div></div></div>
<div id="apiModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:500px"><div class="modal-head"><h2 class="modal-title">ğŸ”— Connetti API Exchange</h2><button class="modal-close" onclick="closeModal('apiModal')">&times;</button></div><div class="form-group"><label class="form-label">Exchange</label><select id="apiExchange" class="input"><option value="binance">Binance</option></select></div><div id="apiHelp" style="background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;font-size:11px"><strong>ğŸ“‹ Come ottenere le API Binance:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.binance.com/it/my/settings/api-management" target="_blank" style="color:var(--primary)">Binance API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo "Read" (nessun permesso di trading!)</li><li>Copia API Key e Secret qui sotto</li></ol></div><div class="form-group"><label class="form-label">API Key</label><input type="text" id="binanceApiKey" class="input" placeholder="La tua API Key..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" id="binanceApiSecret" class="input" placeholder="Il tuo Secret..."></div><div id="apiSyncStatus" style="display:none;margin:12px 0;padding:12px;border-radius:8px;font-size:12px"></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('apiModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="testAndSyncApi()" class="btn btn-primary" style="flex:1" id="apiSyncBtn">ğŸš€ Connetti e Sincronizza</button></div></div></div>
<div id="resetModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:400px"><div class="modal-head"><h2 class="modal-title">ğŸ—‘ï¸ Reset Dati Exchange</h2><button class="modal-close" onclick="closeModal('resetModal')">&times;</button></div><div style="margin-bottom:16px;color:var(--text2);font-size:13px">Seleziona cosa vuoi cancellare:</div><div id="resetOptions" style="display:flex;flex-direction:column;gap:8px"></div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><button onclick="closeModal('resetModal')" class="btn btn-secondary" style="width:100%">Annulla</button></div></div></div>
<div id="earnModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:700px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column"><div class="modal-head"><h2 class="modal-title">ğŸ Report Earn/Staking</h2><button class="modal-close" onclick="closeModal('earnModal')">&times;</button></div><div id="earnContent" style="overflow-y:auto;flex:1;padding-right:8px"></div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><button onclick="closeModal('earnModal')" class="btn btn-secondary" style="width:100%">Chiudi</button></div></div></div>
<div id="rwModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:900px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column"><div class="modal-head"><h2 class="modal-title">ğŸ“‹ Quadro RW - Monitoraggio Fiscale</h2><button class="modal-close" onclick="closeModal('rwModal')">&times;</button></div><div id="rwContent" style="flex:1;overflow-y:auto;padding:0 4px"><div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Calcolo saldi e prezzi...</div></div></div><div style="padding:12px 0;border-top:1px solid var(--border);display:flex;gap:8px"><button onclick="exportRW()" class="btn btn-primary" style="flex:1">ğŸ“¥ Esporta CSV</button><button onclick="closeModal('rwModal')" class="btn btn-secondary" style="flex:1">Chiudi</button></div></div></div>
<div id="reconcileModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:900px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column"><div class="modal-head"><h2 class="modal-title">ğŸ”„ Riconciliazione Trasferimenti</h2><button class="modal-close" onclick="closeModal('reconcileModal')">&times;</button></div><div id="reconcileContent" style="flex:1;overflow-y:auto;padding:0 4px"><div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Analisi trasferimenti...</div></div></div><div style="padding:12px 0;border-top:1px solid var(--border);display:flex;gap:8px"><button onclick="applyReconciliation()" class="btn btn-primary" style="flex:1">âœ… Applica Riconciliazione</button><button onclick="closeModal('reconcileModal')" class="btn btn-secondary" style="flex:1">Chiudi</button></div></div></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRYPTOFOLIO v7.93 - Portfolio Tracker con FiscalitÃ  Italiana
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION='8.70';

// CLASSIFICAZIONE ASSET (Fondamentale per calcolo fiscale)
const FIAT_COINS=['EUR','USD','GBP','CHF'];
const STABLECOINS=['USDT','USDC','BUSD','DAI','TUSD','FDUSD','UST','USDP','GUSD','FRAX','LUSD','USDD','PYUSD'];
const EUR_USD_RATES={2021:0.85,2022:0.95,2023:0.92,2024:0.92,2025:0.92,2026:0.92};

function classifyAsset(symbol){
var s=(symbol||'').toUpperCase();
if(FIAT_COINS.includes(s))return'FIAT';
if(STABLECOINS.includes(s))return'STABLE';
return'CRYPTO';
}

const SB_URL='https://welnvmqfnceszrvpjoju.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbG52bXFmbmNlc3pydnBqb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODU5NDksImV4cCI6MjA4NTQ2MTk0OX0.XyUPf7r0GvhoxADFPpG1hc6KCQ0gkvSfbYzywl_D-us';
const DEF_KEYS=['eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjZjYThhZDhkLTEyMTktNDQ0Ny04ZGQ4LWZiZjlmOTlmYzcwYyIsIm9yZ0lkIjoiNDk2ODU3IiwidXNlcklkIjoiNTExMjY4IiwidHlwZUlkIjoiMmY1NzM4MWItYzNmOS00MDA4LTk5OGYtN2ExMmNiYTAzOWI0IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjkzODIzMzQsImV4cCI6NDkyNTE0MjMzNH0.7cb3HhwH4qmvCYIil3ZWFAYcMD3qEcD3J8J16tAvpbM','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjVlNDJkYTQ5LWFlNmYtNGI2ZC05OTYwLTJkNTUwNGUwZDlmNyIsIm9yZ0lkIjoiNDg3NTI0IiwidXNlcklkIjoiNTAxNTk0IiwidHlwZUlkIjoiY2E1NjEyYzUtMGUzMy00Yzk3LTk1ODktNTA1Yjg4ZmIyNzU1IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2ODczNjMsImV4cCI6NDkyMjQ0NzM2M30.kwUGFKbnzJsALQww3R_UgZO00cDy50Rvf6OmLMTuu9c','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjE0ZDdlNmIxLTkzNTEtNGIwMi1hZGMzLWQ3NjA3MjllNjMxMiIsIm9yZ0lkIjoiNDk2OTIxIiwidXNlcklkIjoiNTExMzM2IiwidHlwZUlkIjoiYTgwMTE2N2QtNGE4MS00ZjVjLThiNGUtMjg0YTlkNzRlOTljIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3Njk0Mjc1ODIsImV4cCI6NDkyNTE4NzU4Mn0.iqQXubNVxU4I_MSjuQolQNKSo4vRHSnGiyiHjvos5eE','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjhlY2U3NzU0LTE0NjUtNGQzMS1iNjRjLTZiNzQ0ZDk3Y2E3ZSIsIm9yZ0lkIjoiNDg3NTI5IiwidXNlcklkIjoiNTAxNTk5IiwidHlwZUlkIjoiYWNiNzFlZjQtZGQ1Ni00NzExLWI1YmQtYjkyNTdmYjgxNDRiIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2OTQ2MDEsImV4cCI6NDkyMjQ1NDYwMX0.3ygKvNrptS9FkNBcmGIO-gSAKGPh9B3h2VeuHdioty8'];
let KEYS=[...DEF_KEYS],keyIdx=0;
const CHAINS={eth:{n:'Ethereum',hex:'0x1',c:'#627eea',t:'ETH',gp:'1'},bsc:{n:'BNB Chain',hex:'0x38',c:'#f3ba2f',t:'BNB',gp:'56'},polygon:{n:'Polygon',hex:'0x89',c:'#8247e5',t:'POL',gp:'137'},arbitrum:{n:'Arbitrum',hex:'0xa4b1',c:'#28a0f0',t:'ETH',gp:'42161'},optimism:{n:'Optimism',hex:'0xa',c:'#ff0420',t:'ETH',gp:'10'},base:{n:'Base',hex:'0x2105',c:'#0052ff',t:'ETH',gp:'8453'},avalanche:{n:'Avalanche',hex:'0xa86a',c:'#e84142',t:'AVAX',gp:'43114'},fantom:{n:'Fantom',hex:'0xfa',c:'#1969ff',t:'FTM',gp:'250'},cronos:{n:'Cronos',hex:'0x19',c:'#1199fa',t:'CRO',gp:'25'},pulsechain:{n:'PulseChain',hex:'0x171',c:'#00ff00',t:'PLS',gp:'369',rpc:'https://rpc.pulsechain.com',txApi:'https://api.scan.pulsechain.com/api?module=account&action=txlist&address='},blackfort:{n:'Blackfort',hex:'0x1e8',c:'#5c6bc0',t:'BXN',gp:null,rpc:'https://rpc.blackfort.network/mainnet/rpc',txApi:'https://explorer.blackfort.network/api?module=account&action=txlist&address='},linea:{n:'Linea',hex:'0xe708',c:'#61dfff',t:'ETH',gp:'59144'},gnosis:{n:'Gnosis',hex:'0x64',c:'#04795b',t:'xDAI',gp:'100'},dogechain:{n:'Dogechain',hex:'0x7d0',c:'#c2a633',t:'DOGE',gp:null,rpc:'https://rpc.dogechain.dog'},zora:{n:'Zora',hex:'0x76adf1',c:'#5b5bd6',t:'ETH',gp:null,rpc:'https://rpc.zora.energy'},ton:{n:'TON',hex:null,c:'#0088CC',t:'TON',gp:null,tonApi:'https://tonapi.io/v2'},manta:{n:'Manta Pacific',hex:null,c:'#2667FF',t:'ETH',gp:null,rpc:'https://pacific-rpc.manta.network/http',txApi:'https://pacific-explorer.manta.network/api?module=account&action=txlist&address='},swell:{n:'Swell',hex:null,c:'#3B82F6',t:'ETH',gp:null,rpc:'https://swell-mainnet.alt.technology',txApi:'https://explorer.swellnetwork.io/api?module=account&action=txlist&address='},monad:{n:'Monad',hex:'0x8f',c:'#836EF9',t:'MON',gp:'143'},solana:{n:'Solana',hex:null,c:'#9945FF',t:'SOL',gp:null,solApi:'https://solana-gateway.moralis.io/account/mainnet'}};
const PLS_TOKENS=[{sym:'PLSX',name:'PulseX',contract:'0x95B303987A60C71504D99Aa1b13B4DA07b0790ab',dec:18},{sym:'HEX',name:'HEX',contract:'0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39',dec:8},{sym:'INC',name:'Incentive',contract:'0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d',dec:18},{sym:'WPLS',name:'Wrapped PLS',contract:'0xA1077a294dDE1B09bB078844df40758a5D0f9a27',dec:18},{sym:'DAI',name:'DAI from Ethereum',contract:'0xefD766cCb38EaF1dfd701853BFCe31359239F305',dec:18},{sym:'USDC',name:'USDC from Ethereum',contract:'0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07',dec:6},{sym:'USDT',name:'USDT from Ethereum',contract:'0x0Cb6F5a34ad42ec934882A05265A7d5F59b51A2f',dec:6},{sym:'WETH',name:'WETH from Ethereum',contract:'0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C',dec:18},{sym:'eHEX',name:'HEX from Ethereum',contract:'0x57fde0a71132198BBeC939B98976993d8D89D225',dec:8}];
const NATIVE_ICONS={ETH:'https://assets.coingecko.com/coins/images/279/small/ethereum.png',BNB:'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',POL:'https://assets.coingecko.com/coins/images/4713/small/polygon.png',MATIC:'https://assets.coingecko.com/coins/images/4713/small/polygon.png',AVAX:'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',FTM:'https://assets.coingecko.com/coins/images/4001/small/Fantom_round.png',CRO:'https://assets.coingecko.com/coins/images/7310/small/cro_token_logo.png',xDAI:'https://assets.coingecko.com/coins/images/11062/small/Identity-Primary-DarkBG.png',PLS:'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',PLSX:'https://tokens.app.pulsex.com/images/tokens/0x95B303987A60C71504D99Aa1b13B4DA07b0790ab.png',HEX:'https://tokens.app.pulsex.com/images/tokens/0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39.png',INC:'https://tokens.app.pulsex.com/images/tokens/0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d.png',BXN:'https://assets.coingecko.com/coins/images/15632/small/BXN.png',SHIB:'https://assets.coingecko.com/coins/images/11939/small/shiba.png',BONE:'https://assets.coingecko.com/coins/images/16916/small/bone_icon.png',USDT:'https://assets.coingecko.com/coins/images/325/small/Tether.png',USDC:'https://assets.coingecko.com/coins/images/6319/small/usdc.png',DAI:'https://assets.coingecko.com/coins/images/9956/small/dai-multi-collateral-mcd.png',WETH:'https://assets.coingecko.com/coins/images/2518/small/weth.png',ARB:'https://assets.coingecko.com/coins/images/16547/small/photo_2023-03-29_21.47.00.jpeg',TON:'https://assets.coingecko.com/coins/images/17980/small/ton_symbol.png',DOGE:'https://assets.coingecko.com/coins/images/5/small/dogecoin.png',MON:'https://assets.coingecko.com/coins/images/52954/small/monad.jpg',MANTA:'https://assets.coingecko.com/coins/images/35537/small/manta.png',SOL:'https://assets.coingecko.com/coins/images/4128/small/solana.png'};
const EXPLORERS={eth:'https://etherscan.io/tx/',bsc:'https://bscscan.com/tx/',polygon:'https://polygonscan.com/tx/',arbitrum:'https://arbiscan.io/tx/',optimism:'https://optimistic.etherscan.io/tx/',base:'https://basescan.org/tx/',avalanche:'https://snowtrace.io/tx/',fantom:'https://ftmscan.com/tx/',cronos:'https://cronoscan.com/tx/',pulsechain:'https://scan.pulsechain.com/tx/',blackfort:'https://explorer.blackfort.network/tx/',linea:'https://lineascan.build/tx/',gnosis:'https://gnosisscan.io/tx/',dogechain:'https://explorer.dogechain.dog/tx/',zora:'https://explorer.zora.energy/tx/',ton:'https://tonviewer.com/transaction/',manta:'https://pacific-explorer.manta.network/tx/',swell:'https://explorer.swellnetwork.io/tx/',monad:'https://monadexplorer.com/tx/',solana:'https://solscan.io/tx/'};
const VERIFIED=new Set(['ETH','BTC','BNB','USDT','USDC','DAI','WETH','WBTC','WBNB','LINK','UNI','AAVE','MATIC','POL','AVAX','FTM','CRO','SHIB','DOGE','PEPE','CAKE','PLS','PLSX','HEX','INC','WPLS','LOAN','BONE','eHEX','BXN','ARB','GMX','MAGIC','RDNT','GRT','LDO','RPL','PENDLE','STG','OP','VELO','ATOM','OSMO','LUNC','TON','MON','MANTA','SOL','JUP','RAY','BONK','WIF','JTO','PYTH','ORCA','MSOL','JITOSOL']);
const CG_MAP={ETH:'ethereum',BTC:'bitcoin',BNB:'binancecoin',USDT:'tether',USDC:'usd-coin',WETH:'weth',MATIC:'matic-network',POL:'matic-network',AVAX:'avalanche-2',FTM:'fantom',CRO:'crypto-com-chain',LINK:'chainlink',UNI:'uniswap',AAVE:'aave',PLS:'pulsechain',PLSX:'pulsex',HEX:'hex',INC:'incentive',SHIB:'shiba-inu',DOGE:'dogecoin',PEPE:'pepe',CAKE:'pancakeswap-token',BONE:'bone-shibaswap',DAI:'dai',BXN:'bxn',ARB:'arbitrum',GMX:'gmx',MAGIC:'magic',GRT:'the-graph',LDO:'lido-dao',PENDLE:'pendle',STG:'stargate-finance',OP:'optimism',ATOM:'cosmos',OSMO:'osmosis',LUNC:'terra-luna',TON:'the-open-network',NOT:'notcoin',DOGS:'dogs-2',AI:'sleepless-ai',MON:'monad','1MBABYDOGE':'1mbabydoge',SOL:'solana',JUP:'jupiter-exchange-solana',RAY:'raydium',BONK:'bonk',WIF:'dogwifcoin',JTO:'jito-governance-token',PYTH:'pyth-network',ORCA:'orca',MSOL:'msol',JITOSOL:'jito-staked-sol',RENDER:'render-token',HNT:'helium',W:'wormhole',RNDR:'render-token',MOBILE:'helium-mobile',SAMO:'samoyedcoin',MNDE:'marinade',BSOL:'blazestake-staked-sol',INF:'infinity-solana',KMNO:'kamino',DRIFT:'drift-protocol',TENSOR:'tensor',ME:'magic-eden',TRUMP:'official-trump',MELANIA:'melania-meme'};
// SMART SPAM FILTER - Pattern aggressivi
const SPAM_WORDS=['visit','claim','reward','.com','.org','.io','.xyz','.net','.co','airdrop','bonus','free','gift','http','$','#','voucher','promo','winner','congratulation','lucky','surprise','giveaway','drop','swap.','dex.','earn','yield','farm','mine','nft-','mint','presale','private','sale','launch','moon','100x','1000x','ğŸš€','ğŸ’°','ğŸ','ğŸ“ˆ','telegram','discord'];
const SPAM_PATTERNS=[/^[0-9]+$/,/\d{4,}/,/(.)\1{4,}/,/[^\x00-\x7F]{3,}/];
function isSpam(name,sym){var n=(name||'').toLowerCase(),s=(sym||'').toLowerCase();for(var i=0;i<SPAM_WORDS.length;i++)if(n.includes(SPAM_WORDS[i])||s.includes(SPAM_WORDS[i]))return true;for(var j=0;j<SPAM_PATTERNS.length;j++)if(SPAM_PATTERNS[j].test(n)||SPAM_PATTERNS[j].test(s))return true;if((name||'').length>50||(sym||'').length>15)return true;if(/\s{2,}/.test(name))return true;return false;}
const{createClient}=supabase;const db=createClient(SB_URL,SB_KEY);
let user=null,currency='eur',chart=null,balances=[],prices={},scanning=false,currentWallet=null,inWalletDetail=false;
let whitelist=new Set(JSON.parse(localStorage.getItem('cf_wl')||'[]'));
let blacklist=new Set(JSON.parse(localStorage.getItem('cf_bl')||'[]').map(function(s){return(s||'').toUpperCase();}));
let blacklistContracts=new Set(JSON.parse(localStorage.getItem('cf_bl_contracts')||'[]').map(function(c){return(c||'').toLowerCase();}));
let selectedChains=new Set(JSON.parse(localStorage.getItem('cf_chains')||JSON.stringify(Object.keys(CHAINS))));
let selectedTokenIds=new Set();
function saveBlacklists(){localStorage.setItem('cf_bl',JSON.stringify([...blacklist]));localStorage.setItem('cf_bl_contracts',JSON.stringify([...blacklistContracts]));}
function saveSelectedChains(){localStorage.setItem('cf_chains',JSON.stringify([...selectedChains]));}
function updateBlStats(){var el=document.getElementById('blStats');if(el)el.innerHTML='Simboli: <b>'+blacklist.size+'</b> | Contratti: <b>'+blacklistContracts.size+'</b>';}
function init(){var saved=JSON.parse(localStorage.getItem('cf_apikeys')||'[]').filter(function(k){return k&&k.length>20;});KEYS=saved.length>0?saved.slice(0,4):[...DEF_KEYS];updateApiStatus();var hk=localStorage.getItem('cf_helius_key')||'';if(document.getElementById('heliusKey'))document.getElementById('heliusKey').value=hk;}
function updateApiStatus(){document.getElementById('sidebarApiStatus').textContent='ğŸ”‘ '+KEYS.length+' keys';var hk=localStorage.getItem('cf_helius_key')||'';var hEl=document.getElementById('heliusStatus');if(hEl)hEl.innerHTML=hk?'<span style="color:#00c853">âœ… Helius ON</span>':'<span style="color:var(--text2)">âš ï¸ Helius OFF â€” Solana userÃ  Moralis</span>';}
function saveHeliusKey(){var k=(document.getElementById('heliusKey')||{}).value||'';k=k.trim();if(k){localStorage.setItem('cf_helius_key',k);updateApiStatus();toast('â˜€ï¸ Helius key salvata!');}else{localStorage.removeItem('cf_helius_key');updateApiStatus();toast('Helius key rimossa');}}
async function checkAuth(){init();try{var res=await db.auth.getSession();if(res.data.session){user=res.data.session.user;showApp();}else showAuth();}catch(err){showAuth();document.getElementById('authError').innerHTML='âš ï¸ Connessione a Supabase fallita.<br><small><a href="https://supabase.com/dashboard" target="_blank" style="color:var(--blue)">Verifica il progetto</a></small>';}}
async function handleLogin(){var e=document.getElementById('authEmail').value,p=document.getElementById('authPassword').value;try{var res=await db.auth.signInWithPassword({email:e,password:p});if(res.error){document.getElementById('authError').textContent=res.error.message;return;}user=res.data.user;showApp();}catch(err){document.getElementById('authError').innerHTML='âš ï¸ Connessione fallita.<br><small>Verifica che Supabase non sia in pausa:<br><a href="https://supabase.com/dashboard" target="_blank" style="color:var(--blue)">Apri Dashboard</a></small>';}}
async function handleSignup(){var e=document.getElementById('authEmail').value,p=document.getElementById('authPassword').value;if(p.length<6){document.getElementById('authError').textContent='Min 6 caratteri';return;}var res=await db.auth.signUp({email:e,password:p});if(res.error){document.getElementById('authError').textContent=res.error.message;return;}await db.from('user_profiles').insert({id:res.data.user.id,email:e});user=res.data.user;showApp();toast('Account creato!');}
async function handleLogout(){await db.auth.signOut();user=null;showAuth();}
function showAuth(){document.getElementById('authScreen').style.display='flex';document.getElementById('appScreen').style.display='none';}
function showApp(){document.getElementById('authScreen').style.display='none';document.getElementById('appScreen').style.display='flex';document.getElementById('appVersion').textContent='v'+APP_VERSION;var av=document.getElementById('authVersion');if(av)av.textContent='v'+APP_VERSION;loadDashboard();updateBlStats();}
function showPage(p){document.querySelectorAll('[id^="page-"]').forEach(function(x){x.style.display='none';});document.getElementById('page-'+p).style.display='block';document.querySelectorAll('.nav').forEach(function(x){x.classList.remove('active');});var nav=document.querySelector('[data-page="'+p+'"]');if(nav)nav.classList.add('active');if(p==='exchange')document.querySelector('[data-page="exchange"]').classList.add('active');inWalletDetail=false;selectedTokenIds.clear();updateBulkBar();if(p==='dashboard')loadDashboard();else if(p==='wallets')loadWallets();else if(p==='exchange')loadExchangeTx();else if(p==='tokens')renderTM();else if(p==='settings'){loadSettings();updateBlStats();}}
function closeModal(id){document.getElementById(id).style.display='none';}
function getKey(){return KEYS[keyIdx%KEYS.length];}
function rotateKey(){keyIdx=(keyIdx+1)%KEYS.length;}
function log(m,cls){cls=cls||'log-info';var logEl=inWalletDetail?document.getElementById('wdScanLog'):document.getElementById('walletScanLog');if(logEl){logEl.innerHTML+='<div class="'+cls+'">'+m+'</div>';logEl.scrollTop=logEl.scrollHeight;}}
async function fetchRpcChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.rpc)return null;try{log('  ğŸ”— '+ch.n+' RPC...');var balRes=await fetch(ch.rpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',method:'eth_getBalance',params:[addr,'latest'],id:1})});var balData=await balRes.json();var nativeBal=parseInt(balData.result||'0',16)/1e18;log('  âœ… '+ch.t+': '+fmtN(nativeBal),'log-ok');var tokens=[];if(chainKey==='pulsechain'){for(var i=0;i<PLS_TOKENS.length;i++){var t=PLS_TOKENS[i];try{var data='0x70a08231000000000000000000000000'+addr.slice(2).toLowerCase();var tokRes=await fetch(ch.rpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',method:'eth_call',params:[{to:t.contract,data:data},'latest'],id:i+2})});var tokData=await tokRes.json();if(tokData.result&&tokData.result!=='0x'&&tokData.result!=='0x0'){var bal=parseInt(tokData.result,16)/Math.pow(10,t.dec);if(bal>0){tokens.push({symbol:t.sym,name:t.name,balance:bal,decimals:t.dec,contractAddress:t.contract});log('    âœ… '+t.sym+': '+fmtN(bal),'log-ok');}}}catch(e){}}}return{nativeBalance:nativeBal,tokens:tokens,isRpc:true};}catch(e){log('  âŒ '+ch.n+' error: '+e.message,'log-err');return null;}}
async function fetchTonChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.tonApi)return null;if(!addr.startsWith('EQ')&&!addr.startsWith('UQ'))return null;try{log('  ğŸ’ TON...');console.log('ğŸ”µ TON fetchTonChain for:',addr);var bal=0;var tokens=[];
var tcOk=false;try{var bUrl='https://toncenter.com/api/v2/getAddressBalance?address='+encodeURIComponent(addr);console.log('TON balance URL:',bUrl);var bRes=await fetch(bUrl);console.log('TON balance status:',bRes.status);if(bRes.ok){var bData=await bRes.json();console.log('TON balance response:',JSON.stringify(bData));if(bData.ok){bal=parseInt(bData.result||'0')/1e9;tcOk=true;log('  âœ… TON: '+fmtN(bal),'log-ok');}else{console.log('TON balance not ok:',bData);}}}catch(e){console.error('toncenter v2 err:',e);log('  âš ï¸ toncenter v2 err: '+e.message,'log-warn');}
if(tcOk){await sleep(1100);try{var jUrl='https://toncenter.com/api/v3/jetton/wallets?owner_address='+encodeURIComponent(addr)+'&limit=100';console.log('TON jettons URL:',jUrl);var jRes=await fetch(jUrl);console.log('TON jettons status:',jRes.status);if(jRes.ok){var jData=await jRes.json();console.log('TON jettons response keys:',Object.keys(jData),'wallets:',jData.jetton_wallets?jData.jetton_wallets.length:0);var jWallets=jData.jetton_wallets||[];for(var i=0;i<jWallets.length;i++){var jw=jWallets[i];var jBal=parseInt(jw.balance||'0');var jetton=jw.jetton||{};var jMeta=jetton.metadata||{};var jDec=parseInt(jMeta.decimals||'9');var jAmt=jBal/Math.pow(10,jDec);if(jAmt>0&&(jMeta.symbol||jMeta.name)){tokens.push({symbol:jMeta.symbol||jMeta.name||'?',name:jMeta.name||jMeta.symbol||'?',balance:jAmt,decimals:jDec,contractAddress:jetton.address||jw.jetton_address||'',logo:jMeta.image||null});}}if(tokens.length>0)log('  ğŸ“¦ '+tokens.length+' jettons','log-ok');else console.log('TON: 0 jettons with balance>0');}}catch(je){console.error('toncenter jettons err:',je);log('  âš ï¸ toncenter jettons err: '+je.message,'log-warn');}}
if(!tcOk){try{log('  ğŸ”„ Trying tonapi.io...');console.log('TON trying tonapi.io fallback');var r=await fetch(ch.tonApi+'/accounts/'+addr);console.log('tonapi status:',r.status);if(r.ok){var d=await r.json();console.log('tonapi response:',JSON.stringify(d).substring(0,500));bal=(d.balance||0)/1e9;log('  âœ… TON: '+fmtN(bal)+' (tonapi)','log-ok');tcOk=true;}try{var jr=await fetch(ch.tonApi+'/accounts/'+addr+'/jettons?currencies=eur,usd');console.log('tonapi jettons status:',jr.status);if(jr.ok){var jd=await jr.json();console.log('tonapi jettons:',jd.balances?jd.balances.length:0);var jBals=jd.balances||[];for(var i=0;i<jBals.length;i++){var jt=jBals[i];var jetton2=jt.jetton||{};var jBal2=parseFloat(jt.balance||'0');var jDec2=jetton2.decimals||9;var jAmt2=jBal2/Math.pow(10,jDec2);if(jAmt2>0&&jetton2.symbol){tokens.push({symbol:jetton2.symbol,name:jetton2.name||jetton2.symbol,balance:jAmt2,decimals:jDec2,contractAddress:jetton2.address||'',logo:jetton2.image||null});}}if(tokens.length>0)log('  ğŸ“¦ '+tokens.length+' jettons (tonapi)','log-ok');}}catch(je2){console.error('tonapi jettons err:',je2);}}catch(e2){console.error('tonapi err:',e2);log('  âŒ tonapi err: '+e2.message,'log-err');}}
console.log('TON fetchTonChain result: bal='+bal+', tokens='+tokens.length);return{nativeBalance:bal,tokens:tokens,isTon:true};}catch(e){console.error('TON fatal error:',e);log('  âŒ TON error: '+e.message,'log-err');return null;}}
async function checkGoPlus(contract,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.gp||!contract)return{safe:true,checked:false};try{var r=await fetch('https://api.gopluslabs.io/api/v1/token_security/'+ch.gp+'?contract_addresses='+contract);var d=await r.json();var info=d.result?d.result[contract.toLowerCase()]:null;if(info){var hp=info.is_honeypot==='1';var bl=info.is_blacklisted==='1';return{safe:!hp&&!bl,checked:true,honeypot:hp};}return{safe:true,checked:true};}catch(e){return{safe:true,checked:false};}}
async function fetchSolanaChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.solApi)return null;try{log('  â— Solana...','');var heliusKey=localStorage.getItem('cf_helius_key')||'';if(heliusKey){log('  â˜€ï¸ Helius DAS API...','');var hUrl='https://mainnet.helius-rpc.com/?api-key='+heliusKey;var hRes=await fetch(hUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'cf-sol',method:'getAssetsByOwner',params:{ownerAddress:addr,page:1,limit:1000,displayOptions:{showFungible:true,showNativeBalance:true}}})});if(!hRes.ok){log('  âš ï¸ Helius HTTP '+hRes.status+', fallback Moralis...','log-warn');}else{var hData=await hRes.json();if(hData.result){var natBal=0;if(hData.result.nativeBalance)natBal=parseFloat(hData.result.nativeBalance.lamports||0)/1e9;if(natBal>0)log('  âœ… SOL: '+fmtN(natBal),'log-ok');var tokens=[];var items=hData.result.items||[];for(var i=0;i<items.length;i++){var it=items[i];if(it.interface==='FungibleToken'||it.interface==='FungibleAsset'){var ti=it.token_info||{};var amt=parseFloat(ti.balance||0);var dec=parseInt(ti.decimals||0);var realAmt=dec>0?amt/Math.pow(10,dec):amt;if(realAmt<=0)continue;var sym=ti.symbol||it.content?.metadata?.symbol||'???';var nm=it.content?.metadata?.name||sym;var logo=null;if(it.content&&it.content.files&&it.content.files.length>0)logo=it.content.files[0].cdn_uri||it.content.files[0].uri||null;if(!logo&&it.content&&it.content.links)logo=it.content.links.image||null;var priceUsd=0;if(ti.price_info&&ti.price_info.price_per_token)priceUsd=parseFloat(ti.price_info.price_per_token);tokens.push({symbol:sym,name:nm,balance:realAmt,decimals:dec,contractAddress:it.id||'',logo:logo,priceUsd:priceUsd});}}if(tokens.length>0)log('  ğŸ“¦ '+tokens.length+' SPL tokens (Helius)','log-ok');return{nativeBalance:natBal,tokens:tokens,isSolana:true,isHelius:true};}}}log('  ğŸ”„ Moralis Solana fallback...','');var key=getKey();var bRes=await fetch(ch.solApi+'/'+addr+'/balance',{headers:{'X-API-Key':key}});if(bRes.status===429||bRes.status===401){rotateKey();key=getKey();bRes=await fetch(ch.solApi+'/'+addr+'/balance',{headers:{'X-API-Key':key}});}if(!bRes.ok){log('  âŒ Solana balance error: '+bRes.status,'log-err');return null;}var bData=await bRes.json();var solBal=parseFloat(bData.solana||bData.lamports||'0');if(bData.lamports)solBal=solBal/1e9;if(solBal>0)log('  âœ… SOL: '+fmtN(solBal),'log-ok');var tokens=[];try{var tRes=await fetch(ch.solApi+'/'+addr+'/tokens',{headers:{'X-API-Key':key}});if(tRes.ok){var tData=await tRes.json();var tList=Array.isArray(tData)?tData:[];for(var i=0;i<tList.length;i++){var t=tList[i];var amt=parseFloat(t.amount||'0');if(amt>0&&t.symbol){tokens.push({symbol:t.symbol,name:t.name||t.symbol,balance:amt,decimals:parseInt(t.decimals||0),contractAddress:t.mint||t.token_address||'',logo:t.logo||t.thumbnail||null});}}if(tokens.length>0)log('  ğŸ“¦ '+tokens.length+' SPL tokens','log-ok');}}catch(te){log('  âš ï¸ SPL tokens error: '+te.message,'log-warn');}return{nativeBalance:solBal,tokens:tokens,isSolana:true};}catch(e){log('  âŒ Solana error: '+e.message,'log-err');return null;}}
async function fetchMoralis(addr,chainKey,retry){retry=retry||0;var ch=CHAINS[chainKey];if(!ch)return null;if(ch.rpc){return await fetchRpcChain(addr,chainKey);}if(ch.tonApi){return await fetchTonChain(addr,chainKey);}if(ch.solApi){return await fetchSolanaChain(addr,chainKey);}try{var key=getKey();var nRes=await fetch('https://deep-index.moralis.io/api/v2.2/'+addr+'/balance?chain='+ch.hex,{headers:{'X-API-Key':key}});if(nRes.status===429||nRes.status===401){rotateKey();if(retry<KEYS.length)return fetchMoralis(addr,chainKey,retry+1);return null;}if(!nRes.ok)return null;var nData=await nRes.json();var tRes=await fetch('https://deep-index.moralis.io/api/v2.2/'+addr+'/erc20?chain='+ch.hex,{headers:{'X-API-Key':key}});if(tRes.status===429||tRes.status===401){rotateKey();if(retry<KEYS.length)return fetchMoralis(addr,chainKey,retry+1);return null;}var tData=tRes.ok?await tRes.json():[];return{nativeBalance:nData.balance||'0',tokens:Array.isArray(tData)?tData:[]};}catch(e){if(retry<KEYS.length){rotateKey();return fetchMoralis(addr,chainKey,retry+1);}return null;}}
function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}
function getStatus(sym,name,contract){var u=(sym||'').toUpperCase();if(whitelist.has(u))return'verified';if(blacklist.has(u))return'spam';if(contract&&blacklistContracts.has(contract.toLowerCase()))return'spam';if(VERIFIED.has(u))return'verified';if(isSpam(name,sym))return'spam';return'unverified';}
function isBlacklisted(sym,contract){var u=(sym||'').toUpperCase();if(blacklist.has(u))return true;if(contract&&blacklistContracts.has(contract.toLowerCase()))return true;return false;}
function icon(sym,chain,logo,sz){sz=sz||32;var ch=CHAINS[chain];var c=ch?ch.c:'#888';var s=(sym||'??').slice(0,2).toUpperCase();var u=(sym||'').toUpperCase();if(!logo&&chain==='pulsechain'){var pt=PLS_TOKENS.find(function(t){return t.sym.toUpperCase()===u;});if(pt)logo='https://tokens.app.pulsex.com/images/tokens/'+pt.contract+'.png';}if(!logo&&NATIVE_ICONS[u])logo=NATIVE_ICONS[u];if(logo)return'<div class="token-icon" style="width:'+sz+'px;height:'+sz+'px"><img src="'+logo+'" onerror="this.onerror=null;this.style.display=\'none\';var p=this.parentElement;if(p){p.innerHTML=\'<span>'+s+'</span>\';p.style.background=\''+c+'30\';p.style.color=\''+c+'\';}"></div>';return'<div class="token-icon" style="width:'+sz+'px;height:'+sz+'px;background:'+c+'30;color:'+c+';font-weight:700">'+s+'</div>';}
function fmtC(v){var n=parseFloat(v)||0;return(currency==='eur'?'â‚¬':'$')+n.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtN(v){var n=parseFloat(v)||0;var abs=Math.abs(n);if(abs===0)return'0';if(abs>=1e9)return(n/1e9).toFixed(2)+'B';if(abs>=1e6)return(n/1e6).toFixed(2)+'M';if(abs>=1e3)return Math.round(n).toLocaleString('it-IT');if(abs<0.0001&&abs>0)return n.toFixed(8);if(abs<0.01)return n.toFixed(6);if(abs<1)return n.toFixed(4);return n.toLocaleString('it-IT',{maximumFractionDigits:2});}
function formatAmount(n,coin){var sign=n>=0?'+':'';var abs=Math.abs(n);if(coin==='EUR')return (n>=0?'+':'-')+'â‚¬'+abs.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});var isUsdStable=['USD','USDT','USDC','BUSD','DAI','TUSD','FDUSD'].includes(coin);if(isUsdStable)return (n>=0?'+':'-')+'$'+abs.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});var suffix=coin?' '+coin:'';if(abs>=1e9)return sign+(abs/1e9).toFixed(2)+'B'+suffix;if(abs>=1e6)return sign+(abs/1e6).toFixed(2)+'M'+suffix;if(abs>=1e3)return sign+Math.round(abs).toLocaleString('it-IT')+suffix;if(abs<0.0001&&abs>0)return sign+abs.toFixed(6)+suffix;if(abs<0.01)return sign+abs.toFixed(4)+suffix;if(abs<1)return sign+abs.toFixed(4)+suffix;return sign+abs.toLocaleString('it-IT',{maximumFractionDigits:2})+suffix;}
function toast(msg,type){type=type||'success';document.querySelectorAll('.toast').forEach(function(t){t.remove();});var t=document.createElement('div');t.className='toast '+type;t.innerHTML=(type==='success'?'âœ…':'âŒ')+' '+msg;document.body.appendChild(t);setTimeout(function(){t.remove();},4000);}
function toggleCurrency(){currency=currency==='eur'?'usd':'eur';document.getElementById('currencyBtn').textContent=currency==='eur'?'ğŸ’¶ EUR':'ğŸ’µ USD';loadDashboard();}
function renderChainGrid(id){var h='';for(var k in CHAINS){var ch=CHAINS[k];var on=selectedChains.has(k);h+='<label class="chain-item'+(on?' active':'')+'"><input type="checkbox" '+(on?'checked':'')+' onchange="toggleChain(\''+k+'\',this)"><span class="chain-dot" style="background:'+ch.c+'"></span>'+ch.n+'</label>';}var el=document.getElementById(id);if(el)el.innerHTML=h;}
function toggleChain(k,el){if(el.checked)selectedChains.add(k);else selectedChains.delete(k);el.parentElement.classList.toggle('active',el.checked);saveSelectedChains();}
function selectAllChains(){selectedChains=new Set(Object.keys(CHAINS));saveSelectedChains();renderChainGrid('modalChainGrid');}
function selectNoChains(){selectedChains.clear();saveSelectedChains();renderChainGrid('modalChainGrid');}
function selectAllChainsWd(){selectedChains=new Set(Object.keys(CHAINS));saveSelectedChains();renderChainGrid('wdChainGrid');}
function selectNoChainsWd(){selectedChains.clear();saveSelectedChains();renderChainGrid('wdChainGrid');}
async function fetchPrices(syms){var ids=[];syms.forEach(function(s){var u=(s||'').toUpperCase();if(CG_MAP[u])ids.push(CG_MAP[u]);});ids=[...new Set(ids)];if(!ids.length)return;
try{var cacheRes=await db.from('price_cache').select('*').in('symbol',syms.map(function(s){return(s||'').toUpperCase();}));var cached=cacheRes.data||[];var now=Date.now();var needFetch=[];var cacheMap={};
cached.forEach(function(c){var age=(now-new Date(c.updated_at).getTime())/60000;cacheMap[c.symbol]={eur:c.price_eur||0,usd:c.price_usd||0,age:age};if(age>10)needFetch.push(c.symbol);});
syms.forEach(function(s){var u=(s||'').toUpperCase();if(!cacheMap[u]&&CG_MAP[u])needFetch.push(u);else if(cacheMap[u])prices[u]=cacheMap[u];});
if(needFetch.length===0)return;
var fetchIds=[...new Set(needFetch.map(function(s){return CG_MAP[s];}).filter(Boolean))];
if(fetchIds.length===0)return;
var r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids='+fetchIds.join(',')+'&vs_currencies=eur,usd');var d=await r.json();
var toUpsert=[];
for(var sym in CG_MAP){if(d[CG_MAP[sym]]){var newEur=d[CG_MAP[sym]].eur||0;var newUsd=d[CG_MAP[sym]].usd||0;var old=cacheMap[sym];
if(!old||Math.abs(old.eur-newEur)>0.0000001||Math.abs(old.usd-newUsd)>0.0000001){toUpsert.push({symbol:sym,price_eur:newEur,price_usd:newUsd,updated_at:new Date().toISOString()});}
prices[sym]={eur:newEur,usd:newUsd};}}
window.prices=prices; // Rendi accessibile per calcolo RW
if(toUpsert.length>0){await db.from('price_cache').upsert(toUpsert,{onConflict:'symbol'});console.log('ğŸ’° Prezzi aggiornati:',toUpsert.length);}}catch(e){console.error('Price fetch error:',e);}}
async function refreshPrices(){toast('Aggiornamento...');await fetchPrices(balances.map(function(b){return b.symbol;}));await loadDashboard();toast('Prezzi aggiornati!');}
function safeAmount(bal){if(bal>1e15)return bal/1e18;return bal;}
function updateBulkBar(){var bar=document.getElementById('bulkBar');var cnt=document.getElementById('bulkCount');if(bar){bar.style.display=selectedTokenIds.size>0?'flex':'none';cnt.textContent=selectedTokenIds.size+' selezionati';}}
function toggleTokenSelect(id){if(selectedTokenIds.has(id))selectedTokenIds.delete(id);else selectedTokenIds.add(id);updateBulkBar();var cb=document.querySelector('input[data-id="'+id+'"]');if(cb)cb.checked=selectedTokenIds.has(id);}
function selectAllTokens(){if(!currentWallet)return;var wb=balances.filter(function(b){return b.wallet_id===currentWallet.id&&b.amount>0;});wb.forEach(function(b){selectedTokenIds.add(b.id);});updateBulkBar();document.querySelectorAll('.chk').forEach(function(c){c.checked=true;});}
function deselectAllTokens(){selectedTokenIds.clear();updateBulkBar();document.querySelectorAll('.chk').forEach(function(c){c.checked=false;});}
async function deleteSelectedTokens(){if(selectedTokenIds.size===0)return;if(!confirm('Eliminare '+selectedTokenIds.size+' token e aggiungerli alla blacklist?'))return;toast('Eliminazione...');var ids=[...selectedTokenIds];var addedBl=0;for(var i=0;i<ids.length;i++){var b=balances.find(function(x){return x.id===ids[i];});if(b){if(b.contract_address&&b.contract_address.length>10){blacklistContracts.add(b.contract_address.toLowerCase());addedBl++;}else if(b.symbol){blacklist.add(b.symbol.toUpperCase());addedBl++;}await db.from('balances').delete().eq('id',ids[i]);}}saveBlacklists();balances=balances.filter(function(b){return!selectedTokenIds.has(b.id);});selectedTokenIds.clear();updateBulkBar();renderWalletTokens(currentWallet.id);loadDashboard();updateBlStats();toast(ids.length+' eliminati, '+addedBl+' in blacklist');}
function clearBlacklist(){if(!confirm('Svuotare tutta la blacklist?'))return;blacklist.clear();blacklistContracts.clear();saveBlacklists();updateBlStats();toast('Blacklist svuotata');}
async function scanWallet(wallet){if(scanning)return;scanning=true;
var scanBox,scanTitle,scanPct,scanBar,scanStatus,scanLog;
if(inWalletDetail){scanBox=document.getElementById('wdScanBox');scanTitle=document.getElementById('wdScanTitle');scanPct=document.getElementById('wdScanPct');scanBar=document.getElementById('wdScanBar');scanStatus=document.getElementById('wdScanStatus');scanLog=document.getElementById('wdScanLog');}
else{scanBox=document.getElementById('walletScanBox');scanTitle=document.getElementById('walletScanTitle');scanPct=document.getElementById('walletScanPct');scanBar=document.getElementById('walletScanBar');scanStatus=document.getElementById('walletScanStatus');scanLog=document.getElementById('walletScanLog');}
scanBox.style.display='block';scanLog.innerHTML='';scanTitle.textContent='ğŸ” '+(wallet.name||'Wallet');
try{
var results=[];var chainKeys=[...selectedChains];var done=0;var blSkipped=0;log('ğŸ‘› '+wallet.address.slice(0,10)+'...');log('â›“ï¸ Chain: '+chainKeys.length);log('ğŸš« BL: '+blacklist.size+' sym, '+blacklistContracts.size+' con');
for(var i=0;i<chainKeys.length;i++){var ck=chainKeys[i];var ch=CHAINS[ck];var pct=Math.round((done/chainKeys.length)*100);scanBar.style.width=pct+'%';scanPct.textContent=pct+'%';scanStatus.textContent=ch.n+'...';log('â†’ '+ch.n+'...');
var data=await fetchMoralis(wallet.address,ck);
if(data){var nativeBal=0;if(data.isRpc||data.isCosmos||data.isTon||data.isSolana){nativeBal=data.nativeBalance||0;}else{try{nativeBal=Number(BigInt(data.nativeBalance||'0'))/1e18;}catch(e){}}
if(nativeBal>0.00001){var nLogo=NATIVE_ICONS[ch.t]||null;if(!isBlacklisted(ch.t,null)){results.push({user_id:user.id,wallet_id:wallet.id,symbol:ch.t,name:ch.n+' Native',chain:ck,contract_address:null,amount:safeAmount(nativeBal),logo_url:nLogo,is_hidden:false});log('  âœ… '+ch.t+': '+fmtN(nativeBal),'log-ok');}else{blSkipped++;log('  ğŸš« '+ch.t+' (BL)','log-warn');}}
if(data.tokens&&data.tokens.length>0){if(!data.isRpc&&!data.isCosmos&&!data.isTon)log('  ğŸ“¦ '+data.tokens.length+' token');var added=0,skipped=0;
for(var j=0;j<data.tokens.length;j++){var token=data.tokens[j];var sym=token.symbol||'?';var contract=(data.isRpc||data.isCosmos||data.isTon||data.isSolana)?(token.contractAddress||''):(token.token_address||'');contract=(contract||'').toLowerCase();
if(isBlacklisted(sym,contract)){blSkipped++;continue;}
if(isSpam(token.name,sym)&&!whitelist.has(sym.toUpperCase())){skipped++;continue;}
var bal=0;if(data.isRpc||data.isCosmos||data.isTon||data.isSolana){bal=token.balance||0;}else{try{bal=Number(BigInt(token.balance||'0'))/Math.pow(10,token.decimals||18);}catch(e){try{bal=parseFloat(token.balance||'0')/Math.pow(10,token.decimals||18);}catch(e2){}}}if(bal<=0)continue;
if(!data.isRpc&&!data.isCosmos&&!data.isTon&&!VERIFIED.has(sym.toUpperCase())&&contract){var gp=await checkGoPlus(contract,ck);if(!gp.safe){log('  âš ï¸ '+sym+' HP!','log-err');skipped++;continue;}}
var tLogo=(data.isTon||data.isSolana)?(token.logo||null):(data.isRpc||data.isCosmos)?null:(token.logo||token.thumbnail||null);if(data.isHelius&&token.priceUsd>0){if(!window._heliusPrices)window._heliusPrices={};window._heliusPrices[sym]=token.priceUsd;}results.push({user_id:user.id,wallet_id:wallet.id,symbol:sym,name:token.name||sym,chain:ck,contract_address:contract||null,amount:safeAmount(bal),logo_url:tLogo,is_hidden:false});added++;}
if(!data.isRpc&&!data.isCosmos&&!data.isTon)log('  âœ… '+added+' ok, '+skipped+' spam','log-ok');}}else{log('  âš ï¸ No response','log-warn');}await sleep(200);done++;}
if(blSkipped>0)log('ğŸš« '+blSkipped+' saltati (BL)','log-warn');
scanStatus.textContent='ğŸ’¾ Salvataggio...';log('ğŸ’¾ '+results.length+' token...');
await db.from('balances').delete().eq('wallet_id',wallet.id);if(results.length>0){var ok=0;for(var b=0;b<results.length;b+=20){var batch=results.slice(b,b+20);var insRes=await db.from('balances').insert(batch);if(!insRes.error)ok+=batch.length;}log('ğŸ“Š '+ok+'/'+results.length+' salvati','log-ok');}
await db.from('wallets').update({last_scan_at:new Date().toISOString()}).eq('id',wallet.id);scanBar.style.width='100%';scanPct.textContent='100%';scanStatus.textContent='ğŸ“œ Sync TX...';log('ğŸ“œ Sync TX...','log-ok');
await syncWalletTxSilent(wallet);
scanStatus.textContent='âœ… Completato!';log('âœ… COMPLETATO!','log-ok');toast(results.length+' token');
if(window._heliusPrices){for(var hp in window._heliusPrices){var sym=hp.toUpperCase();if(!prices[sym])prices[sym]={};prices[sym].usd=window._heliusPrices[hp];if(!prices[sym].eur)prices[sym].eur=window._heliusPrices[hp]*0.92;}delete window._heliusPrices;}
await loadDashboard();if(!inWalletDetail)await loadWallets();
if(inWalletDetail&&currentWallet&&currentWallet.id===wallet.id){selectedTokenIds.clear();updateBulkBar();renderWalletTokens(wallet.id);var wb=balances.filter(function(b){return b.wallet_id===wallet.id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});document.getElementById('wdValue').textContent=fmtC(wb.reduce(function(s,b){return s+(b.value_eur||0);},0));document.getElementById('wdTokens').textContent=wb.length;}
}catch(e){log('âŒ '+e.message,'log-err');toast(e.message,'error');}finally{scanning=false;setTimeout(function(){scanBox.style.display='none';},8000);}}
async function loadDashboard(){var wRes=await db.from('wallets').select('*').eq('user_id',user.id);var ws=wRes.data||[];var bRes=await db.from('balances').select('*').in('wallet_id',ws.map(function(w){return w.id;}));balances=bRes.data||[];var syms=[...new Set(balances.map(function(b){return b.symbol;}))];await fetchPrices(syms);var pKey=currency==='eur'?'eur':'usd';balances.forEach(function(b){var u=(b.symbol||'').toUpperCase();b.price=prices[u]?prices[u][pKey]:0;b.value_eur=b.amount*b.price;});var visibleBal=balances.filter(function(b){return getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});var total=visibleBal.reduce(function(s,b){return s+(b.value_eur||0);},0);var chains=new Set(visibleBal.map(function(b){return b.chain;}));document.getElementById('totalValue').textContent=fmtC(total);document.getElementById('totalTokens').textContent=visibleBal.length;document.getElementById('totalWallets').textContent=ws.length;document.getElementById('totalChains').textContent=chains.size;renderCharts(visibleBal);}
function renderCharts(data){var chainData={};data.forEach(function(b){var c=b.chain||'?';chainData[c]=(chainData[c]||0)+(b.value_eur||0);});var labels=Object.keys(chainData).map(function(k){return CHAINS[k]?CHAINS[k].n:k;});var values=Object.values(chainData);var colors=Object.keys(chainData).map(function(k){return CHAINS[k]?CHAINS[k].c:'#888';});var ctx=document.getElementById('chainChart');if(chart)chart.destroy();chart=new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#fff',font:{size:10}}}}}});var sorted=data.slice().sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);}).slice(0,5);var topHtml='';sorted.forEach(function(b){var pct=data.reduce(function(s,x){return s+(x.value_eur||0);},0);pct=pct>0?((b.value_eur||0)/pct*100).toFixed(1):0;var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+';font-size:9px;padding:2px 6px;margin-left:6px">'+ch.n+'</span>':'';topHtml+='<div class="top-item"><div class="top-icon">'+icon(b.symbol,b.chain,b.logo_url,36)+'</div><div class="top-info"><div class="top-row1"><span class="top-sym">'+b.symbol+'</span>'+chTag+'</div><div style="font-size:11px;color:var(--text2)">'+fmtN(b.amount)+'</div></div><div class="top-values"><div class="top-val">'+fmtC(b.value_eur)+'</div><div class="top-pct">'+pct+'%</div></div></div>';});document.getElementById('topList').innerHTML=topHtml||'<div style="color:var(--text2);padding:20px;text-align:center">Nessun token</div>';}
async function loadWallets(){var res=await db.from('wallets').select('*').eq('user_id',user.id).order('created_at',{ascending:false});var ws=res.data||[];var txRes=await db.from('transactions').select('wallet_id').eq('user_id',user.id);var txCounts={};(txRes.data||[]).forEach(function(t){txCounts[t.wallet_id]=(txCounts[t.wallet_id]||0)+1;});var html='';if(ws.length===0){html='<div style="text-align:center;padding:40px;color:var(--text2)">Nessun wallet. Clicca â• per aggiungere.</div>';}else{ws.forEach(function(w){var wb=balances.filter(function(b){return b.wallet_id===w.id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});var val=wb.reduce(function(s,b){return s+(b.value_eur||0);},0);var top3=wb.sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);}).slice(0,3);var top3Html=top3.map(function(t){return icon(t.symbol,t.chain,t.logo_url,20);}).join('');var txCount=txCounts[w.id]||0;var scanTag=w.last_scan_at?'<span style="font-size:9px;background:var(--green)20;color:var(--green);padding:2px 6px;border-radius:4px">ğŸ• '+new Date(w.last_scan_at).toLocaleDateString('it-IT')+'</span>':'<span style="font-size:9px;background:var(--yellow)20;color:var(--yellow);padding:2px 6px;border-radius:4px">âš ï¸ Mai scansionato</span>';var txTag=txCount>0?'<span style="font-size:9px;background:var(--blue)20;color:var(--blue);padding:2px 6px;border-radius:4px">ğŸ“œ '+txCount+' TX</span>':'';html+='<div class="top-item" style="cursor:pointer" onclick="openWallet(\''+w.id+'\')"><div class="top-icon"><div class="token-icon" style="background:linear-gradient(135deg,#8697FF,#7B68EE);display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ°</div></div><div class="top-info"><div class="top-row1"><span class="top-sym">'+(w.name||'Wallet')+'</span></div><div style="font-size:10px;color:var(--text2)">'+w.address.slice(0,8)+'...'+w.address.slice(-6)+'</div><div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;align-items:center">'+scanTag+txTag+(top3Html?'<span style="display:flex;gap:2px;margin-left:4px">'+top3Html+'</span>':'')+'</div></div><div class="top-values"><div class="top-val">'+fmtC(val)+'</div><div class="top-pct">'+wb.length+' token</div></div></div>';});}document.getElementById('walletsList').innerHTML=html;}
function showAddWallet(){document.getElementById('wName').value='';document.getElementById('wAddr').value='';renderChainGrid('modalChainGrid');document.getElementById('addWalletModal').style.display='flex';}
async function addWallet(){var name=document.getElementById('wName').value.trim();var addr=document.getElementById('wAddr').value.trim();if(!addr){toast('Inserisci indirizzo','error');return;}var res=await db.from('wallets').insert({user_id:user.id,name:name||'Wallet',address:addr,chains:[...selectedChains]}).select().single();if(res.error){toast(res.error.message,'error');return;}closeModal('addWalletModal');toast('Wallet aggiunto!');await loadWallets();await scanWallet(res.data);}
async function openWallet(id){var res=await db.from('wallets').select('*').eq('id',id).single();if(!res.data)return;currentWallet=res.data;inWalletDetail=true;document.getElementById('wdName').textContent=currentWallet.name||'Wallet';document.getElementById('wdAddr').textContent=currentWallet.address;selectedChains=new Set(currentWallet.chains||['eth']);renderChainGrid('wdChainGrid');selectedTokenIds.clear();updateBulkBar();var wb=balances.filter(function(b){return b.wallet_id===id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});document.getElementById('wdValue').textContent=fmtC(wb.reduce(function(s,b){return s+(b.value_eur||0);},0));document.getElementById('wdTokens').textContent=wb.length;renderWalletTokens(id);document.getElementById('wdTxTab').style.display='none';document.getElementById('wdNftTab').style.display='none';document.getElementById('wdTokensTab').style.display='block';document.querySelectorAll('[id^="page-"]').forEach(function(x){x.style.display='none';});document.getElementById('page-wallet-detail').style.display='block';}
async function deleteCurrentWallet(){if(!currentWallet)return;if(!confirm('Sicuro di voler eliminare il wallet "'+currentWallet.name+'"?\n\nVerranno eliminati anche tutti i token e le transazioni associate.'))return;try{await db.from('transactions').delete().eq('wallet_id',currentWallet.id);await db.from('balances').delete().eq('wallet_id',currentWallet.id);await db.from('wallets').delete().eq('id',currentWallet.id);balances=balances.filter(function(b){return b.wallet_id!==currentWallet.id;});toast('âœ… Wallet eliminato!');currentWallet=null;showPage('wallets');}catch(e){toast('âŒ Errore: '+e.message,'error');}}
async function saveWalletChains(){if(!currentWallet)return;var chains=[...selectedChains];var res=await db.from('wallets').update({chains:chains}).eq('id',currentWallet.id);if(res.error){toast('Errore: '+res.error.message,'error');return;}currentWallet.chains=chains;toast('âœ… Chain salvate ('+chains.length+')');document.getElementById('wdChainSection').style.display='none';}
async function renameCurrentWallet(){if(!currentWallet)return;var newName=prompt('âœï¸ Rinomina wallet\n\nNome attuale: "'+currentWallet.name+'"\n\nğŸ’¡ Convenzione consigliata: SCOPO | PIATTAFORMA\nEsempi:\nâ€¢ MAIN | METAMASK\nâ€¢ DEFI | BSC\nâ€¢ COLD | LEDGER\nâ€¢ HOLD | ETH\nâ€¢ BRIDGE | MULTICHAIN\nâ€¢ TRADE | RABBY\n\nNuovo nome:',currentWallet.name);if(!newName||newName.trim()===currentWallet.name)return;newName=newName.trim();var res=await db.from('wallets').update({name:newName,updated_at:new Date().toISOString()}).eq('id',currentWallet.id);if(res.error){toast('âŒ Errore: '+res.error.message,'error');return;}currentWallet.name=newName;document.getElementById('wdName').textContent=newName;toast('âœ… Wallet rinominato: '+newName);}
function renderWalletTokens(id){var wb=balances.filter(function(b){return b.wallet_id===id&&b.amount>0;}).sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);});var html='<table class="table"><thead><tr><th style="width:5%" class="text-center"><input type="checkbox" class="chk" onchange="toggleSelectAll(this)"></th><th style="width:32%">Token</th><th style="width:16%" class="text-right">QuantitÃ </th><th style="width:15%" class="text-center">Chain</th><th style="width:16%" class="text-right">Valore</th><th style="width:16%" class="text-center"></th></tr></thead><tbody>';wb.forEach(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);var badge=st==='verified'?'<span class="badge badge-ok">âœ“</span>':st==='spam'?'<span class="badge badge-bad">âš </span>':'<span class="badge badge-unk">?</span>';var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+'">'+ch.n+'</span>':'';var checked=selectedTokenIds.has(b.id)?'checked':'';html+='<tr><td class="text-center"><input type="checkbox" class="chk" data-id="'+b.id+'" '+checked+' onchange="toggleTokenSelect(\''+b.id+'\')"></td><td><div class="token-cell">'+icon(b.symbol,b.chain,b.logo_url)+'<div class="token-info"><div class="symbol">'+b.symbol+' '+badge+'</div><div class="name">'+(b.name||'')+'</div></div></div></td><td class="text-right text-mono">'+fmtN(b.amount)+'</td><td class="text-center">'+chTag+'</td><td class="text-right">'+fmtC(b.value_eur)+'</td><td class="text-center"><button onclick="event.stopPropagation();deleteToken(\''+b.id+'\')" class="btn btn-sm btn-danger">ğŸ—‘ï¸</button></td></tr>';});html+='</tbody></table>';document.getElementById('wdTokensTab').innerHTML=html;}
function toggleSelectAll(el){if(el.checked)selectAllTokens();else deselectAllTokens();}
function showWalletTab(t){document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});event.target.classList.add('active');document.getElementById('wdTokensTab').style.display=t==='tokens'?'block':'none';document.getElementById('wdTxTab').style.display=t==='tx'?'block':'none';document.getElementById('wdNftTab').style.display=t==='nft'?'block':'none';}
async function showSavedTx(){if(!currentWallet)return;document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('wdTokensTab').style.display='none';document.getElementById('wdTxTab').style.display='block';document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--text2)">Caricamento...</div>';try{console.log('Loading TX for wallet:',currentWallet.id);var res=await db.from('transactions').select('*').eq('wallet_id',currentWallet.id).order('tx_timestamp',{ascending:false}).limit(100);console.log('TX result:',res);var txs=res.data||[];var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:12px;color:var(--text2)">'+txs.length+' TX salvate</span><button onclick="loadWalletTx()" class="btn btn-primary btn-sm">ğŸ”„ Sync da blockchain</button></div>';if(txs.length===0){html+='<div style="padding:40px;text-align:center;color:var(--text2)">Nessuna TX salvata.<br>Clicca "Sync da blockchain" per scaricarle.</div>';}else{html+='<table class="table"><thead><tr><th>Data</th><th>Tipo</th><th>Token</th><th>QuantitÃ </th><th>Chain</th><th>Hash</th></tr></thead><tbody>';txs.forEach(function(t){var dt=new Date(t.tx_timestamp).toLocaleString('it-IT');var type=t.tx_type==='transfer_out'||t.tx_type==='sell'?'<span style="color:var(--red)">ğŸ“¤ '+t.tx_type+'</span>':'<span style="color:var(--green)">ğŸ“¥ '+t.tx_type+'</span>';var sym=t.token_in_symbol||t.token_out_symbol||'?';var amt=t.token_in_amount||t.token_out_amount||0;var ch=CHAINS[t.chain];var hashShort=t.tx_hash?t.tx_hash.slice(0,8)+'...':'?';var explorer=EXPLORERS[t.chain]||'https://etherscan.io/tx/';html+='<tr><td style="font-size:11px">'+dt+'</td><td>'+type+'</td><td>'+sym+'</td><td class="text-mono">'+fmtN(amt)+'</td><td>'+(ch?ch.n:t.chain)+'</td><td style="font-size:10px"><a href="'+explorer+t.tx_hash+'" target="_blank" style="color:var(--blue)">'+hashShort+'</a></td></tr>';});html+='</tbody></table>';}document.getElementById('wdTxTab').innerHTML=html;}catch(e){console.error('showSavedTx error:',e);document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--red)">Errore: '+e.message+'<br><button onclick="loadWalletTx()" class="btn btn-primary btn-sm" style="margin-top:12px">ğŸ”„ Sync da blockchain</button></div>';}}
async function deleteToken(id){if(!confirm('Eliminare e aggiungere alla blacklist?'))return;var b=balances.find(function(x){return x.id===id;});if(b){if(b.contract_address&&b.contract_address.length>10){blacklistContracts.add(b.contract_address.toLowerCase());}else if(b.symbol){blacklist.add(b.symbol.toUpperCase());}saveBlacklists();}await db.from('balances').delete().eq('id',id);balances=balances.filter(function(b){return b.id!==id;});renderWalletTokens(currentWallet.id);loadDashboard();updateBlStats();toast('Eliminato!');}
function scanCurrentWallet(){if(currentWallet)scanWallet(currentWallet);}
var SOL_MINTS={'So11111111111111111111111111111111111111112':'SOL','EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v':'USDC','Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB':'USDT','JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN':'JUP','DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263':'BONK','EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm':'WIF','jtojtomepa8beP8AuQc6eXt5FriJwfFMwQx2v2f9mCL':'JTO','HZ1JovNiVvGrGNiiYvEozEVgZ58xaU3RKwX8eACQBCt3':'PYTH','orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE':'ORCA','mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So':'MSOL','J1toso1uCk3RLmjorhTtrVwY9HJ7X8V9yYac6Y7kGCPn':'JITOSOL','bSo13r4TkiE4KumL71LsHTPpL2euBYLFx6h9HP3piy1':'BSOL','rndrizKT3MK1iimdxRdWabcF7Zg7AR5T4nud4EkHBof':'RENDER','hntyVP6YFm1Hg25TN9WGLqM12b8TQmcknKrdu1oxWux':'HNT','85VBFQZC9TZkfaptBWjvUw7YbZjy52A6mjtPGjstQAmQ':'W','6p6xgHyF7AeE6TZkSmFsko444wqoP15icUSqi2jfGiPN':'TRUMP','FU1q8vJpZNUrmqsciSjp8bAKKidGsLmouB8CBdf8TKQv':'MELANIA','7GCihgDB8fe6KNjn2MYtkzZcRjQy3t9GHdC8uHYmW2hr':'POPCAT','A8C3xuqscfmyLrte3VwXVMKFHtBkegXNGv31m3bLmount':'MOUNT','DriFtupJYLTosbwoN8koMbEYSx54aFAVLddWsbkX1PQx':'DRIFT','TNSRxcUxoT9xBG3de7PiJyTDYu7kskLqcpddxnEJAS6':'TENSOR','MEFNBXixkEbait3xn9x0tMQCKzFFQiS9t8NnPErSpump':'ME','7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs':'WETH','27G8MtK7VtTcCHkpASjSDdkWWYfoqT6ggEuKidVJidD4':'JLP','4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R':'RAY','SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt':'SRM','AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB':'GST','DUSTawucrTsGU8hcqRdHDCbuYhCPADMLM2VcCb8VnFnQ':'DUST','RLBxxFkseAZ4RgJH3Sqn8jXxhmGoz9jWxDNJMh8pL7a':'SRLB','SAMEoq74mZ6wBSRnpe5bLBQqtDAsXgfPEMYhNw5Noyp':'SAMO'};
function parseSolTxEntries(tx,walletAddr,ck,mintSymMap){var entries=[];var meta=tx.meta||{};var msg=tx.transaction&&tx.transaction.message?tx.transaction.message:{};var accts=msg.accountKeys||[];var wIdx=-1;for(var a=0;a<accts.length;a++){var pk=typeof accts[a]==='string'?accts[a]:(accts[a].pubkey||'');if(pk===walletAddr){wIdx=a;break;}}var sig=tx.transaction&&tx.transaction.signatures?tx.transaction.signatures[0]:'';var ts=tx.blockTime?new Date(tx.blockTime*1000).toISOString():new Date().toISOString();var slot=tx.slot||0;var fee=(meta.fee||0)/1e9;
var tokenEntries=[];var preTB=meta.preTokenBalances||[];var postTB=meta.postTokenBalances||[];var tMap={};preTB.forEach(function(tb){if(tb.owner===walletAddr){var k=tb.mint;if(!tMap[k])tMap[k]={pre:0,post:0};tMap[k].pre=tb.uiTokenAmount&&tb.uiTokenAmount.uiAmount?tb.uiTokenAmount.uiAmount:0;}});postTB.forEach(function(tb){if(tb.owner===walletAddr){var k=tb.mint;if(!tMap[k])tMap[k]={pre:0,post:0};tMap[k].post=tb.uiTokenAmount&&tb.uiTokenAmount.uiAmount?tb.uiTokenAmount.uiAmount:0;}});Object.keys(tMap).forEach(function(mint){var d=tMap[mint].post-tMap[mint].pre;if(Math.abs(d)<0.000001)return;var tOut=d<0;var tVal=Math.abs(d);var sym=(mintSymMap&&mintSymMap[mint])?mintSymMap[mint]:(SOL_MINTS[mint]||mint.slice(0,6)+'...');tokenEntries.push({hash:sig+':'+mint.slice(0,8),from_address:tOut?walletAddr:'',to_address:tOut?'':walletAddr,value:String(Math.round(tVal*1e18)),block_timestamp:ts,block_number:slot,gas_price:'0',gas:'0',_chain:ck,_isSolana:true,_solSym:sym,_solMint:mint});});
if(wIdx>=0){var pre=(meta.preBalances||[])[wIdx]||0;var post=(meta.postBalances||[])[wIdx]||0;var diff=(post-pre)/1e9;var isOut=diff<0;var val=Math.abs(diff);if(isOut)val=val-fee;var minSol=tokenEntries.length>0?0.001:0.000001;if(Math.abs(val)>minSol){var toAddr='';var fromAddr='';if(isOut){fromAddr=walletAddr;for(var a2=0;a2<accts.length;a2++){if(a2!==wIdx){var pA=(meta.postBalances||[])[a2]||0;var prA=(meta.preBalances||[])[a2]||0;if(pA>prA){toAddr=typeof accts[a2]==='string'?accts[a2]:(accts[a2].pubkey||'');break;}}}}else{toAddr=walletAddr;fromAddr=typeof accts[0]==='string'?accts[0]:(accts[0].pubkey||'');}entries.push({hash:sig,from_address:fromAddr,to_address:toAddr,value:String(Math.round(Math.abs(val)*1e18)),block_timestamp:ts,block_number:slot,gas_price:'0',gas:String(Math.round(fee*1e18)),_chain:ck,_isSolana:true,_solSym:'SOL'});}}
tokenEntries.forEach(function(te){entries.push(te);});return entries;}
async function syncWalletTxSilent(wallet){try{var key=getKey();var heliusKey=localStorage.getItem('cf_helius_key')||'';var allTx=[];var chainsToScan=wallet.chains&&wallet.chains.length>0?wallet.chains:['eth','bsc','polygon','arbitrum'];var skippedChains=[];for(var ck of chainsToScan){var ch=CHAINS[ck];if(!ch)continue;
if(ch.solApi){var hKey=localStorage.getItem('cf_helius_key')||'';var solRpc=hKey?'https://mainnet.helius-rpc.com/?api-key='+hKey:'https://api.mainnet-beta.solana.com';try{var msm={};try{var bq=await db.from('balances').select('contract_address,symbol').eq('wallet_id',wallet.id).eq('chain','solana');(bq.data||[]).forEach(function(b){if(b.contract_address)msm[b.contract_address]=b.symbol;});}catch(e2){}var sr=await fetch(solRpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'cf-sigs',method:'getSignaturesForAddress',params:[wallet.address,{limit:50}]})});if(sr.ok){var sd=await sr.json();var sigs=(sd.result||[]).filter(function(s){return!s.err;});for(var si=0;si<sigs.length;si++){try{var tr=await fetch(solRpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'tx-'+si,method:'getTransaction',params:[sigs[si].signature,{maxSupportedTransactionVersion:0,encoding:'jsonParsed'}]})});if(tr.status===429||tr.status===403){await sleep(2000);tr=await fetch(solRpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'tx-'+si,method:'getTransaction',params:[sigs[si].signature,{maxSupportedTransactionVersion:0,encoding:'jsonParsed'}]})});if(!tr.ok)continue;}if(!tr.ok)continue;var rd=await tr.json();if(!rd.result)continue;var ents=parseSolTxEntries(rd.result,wallet.address,ck,msm);ents.forEach(function(e){allTx.push(e);});}catch(te){}if(si%10===9)await sleep(300);}}}catch(e){console.log('Solana TX err:',e);}continue;}
if(ch.tonApi){try{var tonTxOk=false;try{var tc=await fetch('https://toncenter.com/api/v2/getTransactions?address='+encodeURIComponent(wallet.address)+'&limit=50&archival=true');if(tc.ok){var tcd=await tc.json();if(tcd.ok&&tcd.result&&tcd.result.length>0){tonTxOk=true;tcd.result.forEach(function(t){var inMsg=t.in_msg||{};var outMsgs=t.out_msgs||[];var isOut=outMsgs.length>0&&outMsgs.some(function(m){return parseInt(m.value||0)>0;});var val=0;if(isOut){outMsgs.forEach(function(m){val+=parseInt(m.value||0)/1e9;});}else if(inMsg.value){val=parseInt(inMsg.value||0)/1e9;}allTx.push({hash:t.transaction_id&&t.transaction_id.hash?t.transaction_id.hash:'',from_address:isOut?wallet.address:(inMsg.source||''),to_address:isOut?(outMsgs.length>0&&outMsgs[0].destination?outMsgs[0].destination:''):wallet.address,value:String(Math.round(Math.abs(val)*1e18)),block_timestamp:t.utime?new Date(t.utime*1000).toISOString():new Date().toISOString(),block_number:t.transaction_id&&t.transaction_id.lt?parseInt(t.transaction_id.lt):0,gas_price:'0',gas:String(Math.round(Math.abs(parseInt(t.fee||0))/1e9*1e18)),_chain:ck,_isTon:true});});}}}catch(e2){console.log('toncenter TX err:',e2);}
if(!tonTxOk){try{var tr=await fetch(ch.tonApi+'/blockchain/accounts/'+wallet.address+'/transactions?limit=50');if(tr.ok){var td=await tr.json();(td.transactions||[]).forEach(function(t){var inMsg=t.in_msg||{};var outMsgs=t.out_msgs||[];var isOut=outMsgs.length>0&&outMsgs.some(function(m){return parseInt(m.value||0)>0;});var val=0;if(isOut){outMsgs.forEach(function(m){val+=parseInt(m.value||0)/1e9;});}else if(inMsg.value){val=parseInt(inMsg.value||0)/1e9;}var fromA=isOut?wallet.address:(inMsg.source&&inMsg.source.address?inMsg.source.address:'');var toA=isOut?(outMsgs[0]&&outMsgs[0].destination&&outMsgs[0].destination.address?outMsgs[0].destination.address:''):wallet.address;allTx.push({hash:t.hash||'',from_address:fromA,to_address:toA,value:String(Math.round(Math.abs(val)*1e18)),block_timestamp:t.utime?new Date(t.utime*1000).toISOString():new Date().toISOString(),block_number:parseInt(t.lt||0),gas_price:'0',gas:String(Math.round(Math.abs(parseInt(t.total_fees||0))/1e9*1e18)),_chain:ck,_isTon:true});});}}catch(e3){console.log('tonapi TX err:',e3);}}
}catch(e){console.log('TON TX err:',e);}continue;}
if(!ch.hex&&!ch.txApi){skippedChains.push(ch.n);continue;}
if(ch.txApi){try{var r=await fetch(ch.txApi+wallet.address);if(r.ok){var d=await r.json();if(d.result&&Array.isArray(d.result)){d.result.slice(0,50).forEach(function(t){allTx.push({hash:t.hash,from_address:t.from,to_address:t.to,value:t.value,block_timestamp:new Date(parseInt(t.timeStamp)*1000).toISOString(),block_number:t.blockNumber,gas_price:t.gasPrice,gas:t.gasUsed||t.gas,_chain:ck});});}}}catch(e){console.log('txApi err:',e);}}
else if(ch.gp){try{var r2=await fetch('https://deep-index.moralis.io/api/v2.2/'+wallet.address+'?chain='+ch.hex+'&limit=50',{headers:{'X-API-Key':key}});if(r2.ok){var d2=await r2.json();if(d2.result)allTx=allTx.concat(d2.result.map(function(t){t._chain=ck;return t;}));}}catch(e){}}}
var toSave=[];allTx.forEach(function(t){var ch=CHAINS[t._chain];if(!ch)return;if(t._isSolana||t._isTon){var isOut=t.from_address===wallet.address;var val=Number(t.value||0)/1e18;var sym=t._isTon?'TON':(t._solSym||'SOL');var feeSym=t._isTon?'TON':'SOL';toSave.push({user_id:user.id,wallet_id:wallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:isOut?'transfer_out':'transfer_in',token_in_symbol:isOut?null:sym,token_in_amount:isOut?null:val,token_out_symbol:isOut?sym:null,token_out_amount:isOut?val:null,fee_amount:parseFloat(t.gas||0)/1e18,fee_symbol:feeSym,from_address:t.from_address||'',to_address:t.to_address||'',value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});return;}var isOut=t.from_address.toLowerCase()===wallet.address.toLowerCase();var txType=isOut?'transfer_out':'transfer_in';var val=Number(t.value||0)/1e18;toSave.push({user_id:user.id,wallet_id:wallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:txType,token_in_symbol:isOut?null:ch.t,token_in_amount:isOut?null:val,token_out_symbol:isOut?ch.t:null,token_out_amount:isOut?val:null,fee_amount:Number(t.gas_price||0)*Number(t.gas||0)/1e18,fee_symbol:ch.t,from_address:t.from_address,to_address:t.to_address,value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});});
if(toSave.length>0){for(var i=0;i<toSave.length;i+=20){var batch=toSave.slice(i,i+20);await db.from('transactions').upsert(batch,{onConflict:'chain,tx_hash,wallet_id',ignoreDuplicates:true});}}log('ğŸ“œ '+toSave.length+' TX sync','log-ok');if(skippedChains.length>0)log('âš ï¸ TX non supportate: '+skippedChains.join(', '),'log-warn');}catch(e){console.error('TX sync error:',e);}}
async function loadWalletTx(){if(!currentWallet)return;document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--text2)">ğŸ”„ Sincronizzazione TX dalla blockchain...</div>';try{var key=getKey();var allTx=[];var chainsToScan=currentWallet.chains&&currentWallet.chains.length>0?currentWallet.chains:['eth','bsc','polygon','arbitrum'];var skippedChains=[];
for(var ck of chainsToScan){var ch=CHAINS[ck];if(!ch)continue;
if(ch.solApi){var heliusKey2=localStorage.getItem('cf_helius_key')||'';var solRpc2=heliusKey2?'https://mainnet.helius-rpc.com/?api-key='+heliusKey2:'https://api.mainnet-beta.solana.com';try{console.log('ğŸŸ£ Solana TX via',heliusKey2?'Helius':'RPC pubblico');var msm2={};try{var bq2=await db.from('balances').select('contract_address,symbol').eq('wallet_id',currentWallet.id).eq('chain','solana');(bq2.data||[]).forEach(function(b){if(b.contract_address)msm2[b.contract_address]=b.symbol;});console.log('Mintâ†’Symbol map:',Object.keys(msm2).length,'tokens');}catch(e2){}var sr=await fetch(solRpc2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'cf-sigs2',method:'getSignaturesForAddress',params:[currentWallet.address,{limit:50}]})});console.log('Solana sigs status:',sr.status);if(sr.ok){var sd=await sr.json();if(sd.error){console.error('Solana RPC error:',sd.error);}else{var sigs=(sd.result||[]).filter(function(s){return!s.err;});console.log('Solana signatures:',sigs.length,'(filtered ok)');for(var si=0;si<sigs.length;si++){try{var tr=await fetch(solRpc2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'tx-'+si,method:'getTransaction',params:[sigs[si].signature,{maxSupportedTransactionVersion:0,encoding:'jsonParsed'}]})});if(tr.status===429||tr.status===403){console.log('Rate limited at TX '+si+', waiting 2s...');await sleep(2000);tr=await fetch(solRpc2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:'tx-'+si,method:'getTransaction',params:[sigs[si].signature,{maxSupportedTransactionVersion:0,encoding:'jsonParsed'}]})});if(!tr.ok){await sleep(1000);continue;}}if(!tr.ok)continue;var rd=await tr.json();if(!rd.result)continue;var ents=parseSolTxEntries(rd.result,currentWallet.address,ck,msm2);ents.forEach(function(e){allTx.push(e);});}catch(te){console.error('TX '+si+' err:',te);}if(si%10===9)await sleep(300);}console.log('Solana TX total:',allTx.length);}}}catch(e){console.error('Solana TX err:',e);}continue;}
if(ch.tonApi){try{console.log('ğŸ”µ TON TX fetch for',currentWallet.address);var tonTxOk2=false;try{var tcUrl='https://toncenter.com/api/v2/getTransactions?address='+encodeURIComponent(currentWallet.address)+'&limit=50&archival=true';console.log('TON toncenter URL:',tcUrl);var tc=await fetch(tcUrl);console.log('toncenter status:',tc.status);if(tc.ok){var tcd=await tc.json();console.log('toncenter response ok:',tcd.ok,'results:',tcd.result?tcd.result.length:0);if(tcd.ok&&tcd.result&&tcd.result.length>0){tonTxOk2=true;tcd.result.forEach(function(t){var inMsg=t.in_msg||{};var outMsgs=t.out_msgs||[];var isOut=outMsgs.length>0&&outMsgs.some(function(m){return parseInt(m.value||0)>0;});var val=0;if(isOut){outMsgs.forEach(function(m){val+=parseInt(m.value||0)/1e9;});}else if(inMsg.value){val=parseInt(inMsg.value||0)/1e9;}allTx.push({hash:t.transaction_id&&t.transaction_id.hash?t.transaction_id.hash:'',from_address:isOut?currentWallet.address:(inMsg.source||''),to_address:isOut?(outMsgs.length>0&&outMsgs[0].destination?outMsgs[0].destination:''):currentWallet.address,value:String(Math.round(Math.abs(val)*1e18)),block_timestamp:t.utime?new Date(t.utime*1000).toISOString():new Date().toISOString(),block_number:t.transaction_id&&t.transaction_id.lt?parseInt(t.transaction_id.lt):0,gas_price:'0',gas:String(Math.round(Math.abs(parseInt(t.fee||0))/1e9*1e18)),_chain:ck,_isTon:true});});console.log('TON TX parsed:',tcd.result.length);}}}catch(e2){console.error('toncenter TX err:',e2);}
if(!tonTxOk2){try{console.log('Trying tonapi.io fallback...');var tr=await fetch(ch.tonApi+'/blockchain/accounts/'+currentWallet.address+'/transactions?limit=50');console.log('tonapi status:',tr.status);if(tr.ok){var td=await tr.json();var txItems=td.transactions||[];console.log('tonapi TX:',txItems.length);txItems.forEach(function(t){var inMsg=t.in_msg||{};var outMsgs=t.out_msgs||[];var isOut=outMsgs.length>0&&outMsgs.some(function(m){return parseInt(m.value||0)>0;});var val=0;if(isOut){outMsgs.forEach(function(m){val+=parseInt(m.value||0)/1e9;});}else if(inMsg.value){val=parseInt(inMsg.value||0)/1e9;}var fromA=isOut?currentWallet.address:(inMsg.source&&inMsg.source.address?inMsg.source.address:'');var toA=isOut?(outMsgs[0]&&outMsgs[0].destination&&outMsgs[0].destination.address?outMsgs[0].destination.address:''):currentWallet.address;allTx.push({hash:t.hash||'',from_address:fromA,to_address:toA,value:String(Math.round(Math.abs(val)*1e18)),block_timestamp:t.utime?new Date(t.utime*1000).toISOString():new Date().toISOString(),block_number:parseInt(t.lt||0),gas_price:'0',gas:String(Math.round(Math.abs(parseInt(t.total_fees||0))/1e9*1e18)),_chain:ck,_isTon:true});});}}catch(e3){console.error('tonapi TX err:',e3);}}
}catch(e){console.error('TON TX err:',e);}continue;}
if(!ch.hex&&!ch.txApi){skippedChains.push(ch.n);continue;}
if(ch.txApi){try{console.log('Using txApi for',ck);var r=await fetch(ch.txApi+currentWallet.address);if(r.ok){var d=await r.json();if(d.result&&Array.isArray(d.result)){console.log('txApi TX found:',d.result.length);d.result.slice(0,50).forEach(function(t){allTx.push({hash:t.hash,from_address:t.from,to_address:t.to,value:t.value,block_timestamp:new Date(parseInt(t.timeStamp)*1000).toISOString(),block_number:t.blockNumber,gas_price:t.gasPrice,gas:t.gasUsed||t.gas,_chain:ck});});}}}catch(e){console.log('txApi error for',ck,e);}}
else if(ch.gp){console.log('Using Moralis for',ck,ch.hex);var r=await fetch('https://deep-index.moralis.io/api/v2.2/'+currentWallet.address+'?chain='+ch.hex+'&limit=50',{headers:{'X-API-Key':key}});console.log('Response status:',r.status);if(r.ok){var d=await r.json();console.log('TX found:',d.result?d.result.length:0);if(d.result)allTx=allTx.concat(d.result.map(function(t){t._chain=ck;return t;}));}}}
console.log('Total TX:',allTx.length);if(skippedChains.length>0)toast('âš ï¸ TX non supportate: '+skippedChains.join(', '),'warning');allTx.sort(function(a,b){return new Date(b.block_timestamp)-new Date(a.block_timestamp);});var toSave=[];allTx.forEach(function(t){var ch=CHAINS[t._chain];if(!ch)return;if(t._isSolana||t._isTon){var isOut=t.from_address===currentWallet.address;var val=Number(t.value||0)/1e18;var sym=t._isTon?'TON':(t._solSym||'SOL');var feeSym=t._isTon?'TON':'SOL';toSave.push({user_id:user.id,wallet_id:currentWallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:isOut?'transfer_out':'transfer_in',token_in_symbol:isOut?null:sym,token_in_amount:isOut?null:val,token_out_symbol:isOut?sym:null,token_out_amount:isOut?val:null,fee_amount:parseFloat(t.gas||0)/1e18,fee_symbol:feeSym,from_address:t.from_address||'',to_address:t.to_address||'',value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});return;}var isOut=t.from_address.toLowerCase()===currentWallet.address.toLowerCase();var txType=isOut?'transfer_out':'transfer_in';var val=Number(t.value||0)/1e18;var ch=CHAINS[t._chain];if(!ch)return;toSave.push({user_id:user.id,wallet_id:currentWallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:txType,token_in_symbol:isOut?null:ch.t,token_in_amount:isOut?null:val,token_out_symbol:isOut?ch.t:null,token_out_amount:isOut?val:null,fee_amount:Number(t.gas_price||0)*Number(t.gas||0)/1e18,fee_symbol:ch.t,from_address:t.from_address,to_address:t.to_address,value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});});console.log('TX to save:',toSave.length);if(toSave.length>0){for(var i=0;i<toSave.length;i+=20){var batch=toSave.slice(i,i+20);var uRes=await db.from('transactions').upsert(batch,{onConflict:'chain,tx_hash,wallet_id',ignoreDuplicates:true});if(uRes.error)console.error('Upsert error:',uRes.error);}}toast('âœ… '+toSave.length+' TX sincronizzate!');
if(toSave.length>0||allTx.length===0){var validChains=chainsToScan;try{var oldTx=await db.from('transactions').select('id,chain').eq('wallet_id',currentWallet.id);var toDelete=(oldTx.data||[]).filter(function(t){return!validChains.includes(t.chain);});if(toDelete.length>0){for(var d=0;d<toDelete.length;d+=50){var delBatch=toDelete.slice(d,d+50).map(function(t){return t.id;});await db.from('transactions').delete().in('id',delBatch);}console.log('ğŸ§¹ Rimossi '+toDelete.length+' TX di chain non piÃ¹ associate');}}catch(ce){console.log('Clean old TX err:',ce);}}
await showSavedTx();}catch(e){console.error('TX sync error:',e);document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--red)">Errore: '+e.message+'</div>';}}
let walletNFTs=[];
async function showNFTs(){if(!currentWallet)return;document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});document.querySelectorAll('.tab')[2].classList.add('active');document.getElementById('wdTokensTab').style.display='none';document.getElementById('wdTxTab').style.display='none';document.getElementById('wdNftTab').style.display='block';var nftTab=document.getElementById('wdNftTab');nftTab.innerHTML='<div style="padding:20px;text-align:center;color:var(--text2)">Caricamento NFT...</div>';try{var res=await db.from('nft_balances').select('*').eq('wallet_id',currentWallet.id).order('value_eur',{ascending:false});walletNFTs=res.data||[];renderNFTList();}catch(e){nftTab.innerHTML='<div style="padding:20px;text-align:center;color:var(--red)">Errore: '+e.message+'</div>';}}
async function scanNFTs(){if(!currentWallet)return;var nftTab=document.getElementById('wdNftTab');nftTab.innerHTML='<div style="padding:20px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">ğŸ” Scansione NFT in corso...</div><div id="nftScanLog" style="margin-top:12px;font-size:11px;color:var(--text2)"></div></div>';var logEl=document.getElementById('nftScanLog');var allNFTs=[];var chainsToScan=(currentWallet.chains||['eth','bsc']).filter(function(c){var ch=CHAINS[c];if(!ch||!ch.hex)return false;var NFT_CHAINS=['0x1','0x38','0x89','0xa4b1','0xa','0x2105','0xa86a','0xfa','0x19','0xe708','0x64'];return NFT_CHAINS.includes(ch.hex);});var skippedNft=(currentWallet.chains||[]).filter(function(c){var ch=CHAINS[c];if(!ch||!ch.hex)return true;var NFT_CHAINS=['0x1','0x38','0x89','0xa4b1','0xa','0x2105','0xa86a','0xfa','0x19','0xe708','0x64'];return!NFT_CHAINS.includes(ch.hex);});if(skippedNft.length>0&&logEl)logEl.innerHTML+='â­ï¸ Skip (no NFT API): '+skippedNft.map(function(c){return CHAINS[c]?CHAINS[c].n:c;}).join(', ')+'<br><br>';for(var i=0;i<chainsToScan.length;i++){var ck=chainsToScan[i];var ch=CHAINS[ck];if(logEl)logEl.innerHTML+='â†’ '+ch.n+'...<br>';try{var key=getKey();var url='https://deep-index.moralis.io/api/v2.2/'+currentWallet.address+'/nft?chain='+ch.hex+'&exclude_spam=true&media_items=false&normalizeMetadata=true';var r=await fetch(url,{headers:{'X-API-Key':key}});if(r.status===429||r.status===401){rotateKey();key=getKey();r=await fetch(url,{headers:{'X-API-Key':key}});}if(r.status>=500){await sleep(2000);r=await fetch(url,{headers:{'X-API-Key':key}});if(r.status>=500){await sleep(3000);rotateKey();key=getKey();r=await fetch(url,{headers:{'X-API-Key':key}});}}if(!r.ok){if(logEl)logEl.innerHTML+='  âš ï¸ '+ch.n+': HTTP '+r.status+'<br>';continue;}var d=await r.json();var nfts=(d.result||[]).filter(function(n){return!n.possible_spam;});if(logEl)logEl.innerHTML+='  âœ… '+ch.n+': '+nfts.length+' NFT<br>';for(var j=0;j<nfts.length;j++){var n=nfts[j];var meta=null;try{meta=typeof n.normalized_metadata==='object'?n.normalized_metadata:(typeof n.metadata==='string'?JSON.parse(n.metadata):null);}catch(e){}var img=null;if(meta){img=meta.image||meta.image_url||null;if(img&&img.startsWith('ipfs://'))img='https://ipfs.io/ipfs/'+img.slice(7);}if(!img&&n.collection_logo)img=n.collection_logo;var floorUsd=0;if(n.floor_price_usd)floorUsd=parseFloat(n.floor_price_usd);else if(n.floor_price)floorUsd=parseFloat(n.floor_price)*prices['ETH']?.usd||0;allNFTs.push({user_id:user.id,wallet_id:currentWallet.id,chain:ck,collection_address:n.token_address||'',token_id:n.token_id||'',collection_name:n.name||'Unknown',token_name:(meta&&meta.name)?meta.name:('#'+n.token_id),symbol:n.symbol||'',contract_type:n.contract_type||'ERC721',amount:parseInt(n.amount||1),image_url:img,metadata:meta?JSON.stringify(meta):null,floor_price_usd:floorUsd,value_eur:0,cost_basis_eur:0,verified:!!n.verified_collection,possible_spam:false});}}catch(e){if(logEl)logEl.innerHTML+='  âŒ '+ch.n+': '+e.message+'<br>';}await sleep(300);}if(logEl)logEl.innerHTML+='<br>ğŸ’¾ Salvataggio '+allNFTs.length+' NFT...';var nftBL=JSON.parse(localStorage.getItem('cf_nft_bl')||'[]');allNFTs=allNFTs.filter(function(n){var blKey=(n.collection_address||'').toLowerCase()+'_'+(n.token_id||'');return!nftBL.includes(blKey);});if(logEl)logEl.innerHTML+=' ('+allNFTs.length+' dopo filtro blacklist)<br>';var existingRes=await db.from('nft_balances').select('collection_address,token_id,cost_basis_eur,value_eur').eq('wallet_id',currentWallet.id);var existingMap={};(existingRes.data||[]).forEach(function(e){existingMap[e.collection_address+'_'+e.token_id]={cost:e.cost_basis_eur,val:e.value_eur};});allNFTs.forEach(function(n){var k=n.collection_address+'_'+n.token_id;if(existingMap[k]){n.cost_basis_eur=existingMap[k].cost||0;if(existingMap[k].val>0)n.value_eur=existingMap[k].val;}});await db.from('nft_balances').delete().eq('wallet_id',currentWallet.id);if(allNFTs.length>0){for(var b=0;b<allNFTs.length;b+=20){var batch=allNFTs.slice(b,b+20);await db.from('nft_balances').insert(batch);}}walletNFTs=allNFTs;toast('âœ… '+allNFTs.length+' NFT trovati');renderNFTList();}
function renderNFTList(){var nftTab=document.getElementById('wdNftTab');var totalVal=walletNFTs.reduce(function(s,n){return s+(n.value_eur||n.floor_price_usd||0);},0);var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px"><div><span style="font-size:14px;font-weight:700">ğŸ–¼ï¸ '+walletNFTs.length+' NFT</span><span style="font-size:12px;color:var(--text2);margin-left:8px">â‰ˆ '+fmtC(totalVal)+'</span></div><div class="flex gap-8"><button onclick="scanNFTs()" class="btn btn-primary btn-sm">ğŸ” Scan NFT</button><button onclick="showAddNFTManual()" class="btn btn-secondary btn-sm">âœï¸ Manuale</button></div></div>';if(walletNFTs.length===0){html+='<div style="padding:40px;text-align:center;color:var(--text2)">Nessun NFT trovato.<br>Clicca \"ğŸ” Scan NFT\" per scansionare o \"âœï¸ Manuale\" per aggiungere.</div>';}else{html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">';walletNFTs.forEach(function(n,idx){var img=n.image_url||'';var imgTag=img?'<img src="'+img+'" style="width:100%;height:140px;object-fit:cover;border-radius:8px 8px 0 0" onerror="this.style.display=\'none\'">':'<div style="width:100%;height:140px;background:var(--card);display:flex;align-items:center;justify-content:center;border-radius:8px 8px 0 0;font-size:40px">ğŸ–¼ï¸</div>';var ch=CHAINS[n.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+';font-size:9px;padding:2px 6px">'+ch.n+'</span>':'';var verTag=n.verified?'<span style="color:var(--green);font-size:10px">âœ“</span>':'';var valDisplay=n.value_eur>0?fmtC(n.value_eur):(n.floor_price_usd>0?'~$'+fmtN(n.floor_price_usd):'N/A');var costDisplay=n.cost_basis_eur>0?'<div style="font-size:10px;color:var(--text2)">Costo: '+fmtC(n.cost_basis_eur)+'</div>':'';html+='<div style="background:var(--card);border-radius:12px;overflow:hidden;border:1px solid var(--border)">'+imgTag+'<div style="padding:10px"><div style="font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+n.token_name+' '+verTag+'</div><div style="font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+n.collection_name+'</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">'+chTag+'<span style="font-size:11px;font-weight:600;color:var(--green)">'+valDisplay+'</span></div>'+costDisplay+'<div style="display:flex;gap:4px;margin-top:8px"><button onclick="editNFTValue('+idx+')" class="btn btn-sm btn-secondary" style="flex:1;font-size:10px">ğŸ’° Valore</button><button onclick="deleteNFT('+idx+')" class="btn btn-sm" style="flex:1;font-size:10px;background:var(--red)20;color:var(--red)">ğŸ—‘ï¸</button></div></div></div>';});html+='</div>';}nftTab.innerHTML=html;}
async function editNFTValue(idx){var n=walletNFTs[idx];if(!n)return;var floorInfo=n.floor_price_usd>0?'Floor: $'+n.floor_price_usd:'Floor: N/A';var mHtml='<div id="nftEditModal" class="modal-bg" style="display:flex"><div class="modal" style="max-width:400px"><div class="modal-head"><h2 class="modal-title">ğŸ’° '+((n.token_name||'').slice(0,30))+'</h2><button class="modal-close" onclick="document.getElementById(\'nftEditModal\').remove()">&times;</button></div><div style="display:flex;flex-direction:column;gap:12px;padding:4px 0"><div style="font-size:11px;color:var(--text2);text-align:center">'+floorInfo+'</div><div><label style="font-size:11px;color:var(--text2)">Valore attuale (EUR)</label><input id="nfteVal" class="input" style="width:100%" type="number" step="0.01" value="'+(n.value_eur||0)+'"></div><div><label style="font-size:11px;color:var(--text2)">Costo acquisto (EUR) â€” per Quadro RT</label><input id="nfteCost" class="input" style="width:100%" type="number" step="0.01" value="'+(n.cost_basis_eur||0)+'"></div><button onclick="saveNFTValue('+idx+')" class="btn btn-primary" style="margin-top:8px">ğŸ’¾ Salva</button></div></div></div>';document.body.insertAdjacentHTML('beforeend',mHtml);}
async function saveNFTValue(idx){var n=walletNFTs[idx];if(!n)return;var newVal=parseFloat(document.getElementById('nfteVal').value)||0;var newCost=parseFloat(document.getElementById('nfteCost').value)||0;var res=await db.from('nft_balances').update({value_eur:newVal,cost_basis_eur:newCost}).eq('id',n.id);if(res.error){toast('Errore: '+res.error.message,'error');return;}walletNFTs[idx].value_eur=newVal;walletNFTs[idx].cost_basis_eur=newCost;document.getElementById('nftEditModal').remove();renderNFTList();toast('âœ… Aggiornato!');}
async function deleteNFT(idx){var n=walletNFTs[idx];if(!n)return;if(!confirm('Eliminare "'+n.token_name+'" dalla collezione '+n.collection_name+'?\nNon riapparirÃ  al rescan.'))return;var nftBL=JSON.parse(localStorage.getItem('cf_nft_bl')||'[]');var blKey=(n.collection_address||'').toLowerCase()+'_'+(n.token_id||'');if(blKey.length>5&&!nftBL.includes(blKey)){nftBL.push(blKey);localStorage.setItem('cf_nft_bl',JSON.stringify(nftBL));}await db.from('nft_balances').delete().eq('id',n.id);walletNFTs.splice(idx,1);renderNFTList();toast('NFT eliminato e blacklistato');}
async function showAddNFTManual(){if(!currentWallet)return;var chainOpts='';Object.keys(CHAINS).forEach(function(k){var sel=k==='bsc'?'selected':'';chainOpts+='<option value="'+k+'" '+sel+'>'+CHAINS[k].n+'</option>';});var mHtml='<div id="nftManualModal" class="modal-bg" style="display:flex"><div class="modal" style="max-width:500px"><div class="modal-head"><h2 class="modal-title">âœï¸ Aggiungi NFT Manuale</h2><button class="modal-close" onclick="document.getElementById(\'nftManualModal\').remove()">&times;</button></div><div style="display:flex;flex-direction:column;gap:12px;padding:4px 0"><div><label style="font-size:11px;color:var(--text2)">Chain</label><select id="nftmChain" class="input" style="width:100%">'+chainOpts+'</select></div><div><label style="font-size:11px;color:var(--text2)">Contract Address</label><input id="nftmContract" class="input" style="width:100%" placeholder="0x0a8901b0E25DE..."></div><div><label style="font-size:11px;color:var(--text2)">Token ID</label><input id="nftmTokenId" class="input" style="width:100%" placeholder="8909"></div><div><label style="font-size:11px;color:var(--text2)">Nome NFT</label><input id="nftmName" class="input" style="width:100%" placeholder="Pancake Squad #8909"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label style="font-size:11px;color:var(--text2)">Costo acquisto (EUR)</label><input id="nftmCost" class="input" style="width:100%" type="number" step="0.01" placeholder="3900"></div><div><label style="font-size:11px;color:var(--text2)">Valore attuale (EUR)</label><input id="nftmValue" class="input" style="width:100%" type="number" step="0.01" placeholder="135"></div></div><button onclick="saveManualNFT()" class="btn btn-primary" style="margin-top:8px">ğŸ’¾ Salva NFT</button></div></div></div>';document.body.insertAdjacentHTML('beforeend',mHtml);}
async function saveManualNFT(){var chain=document.getElementById('nftmChain').value;var contract=document.getElementById('nftmContract').value.trim();var tokenId=document.getElementById('nftmTokenId').value.trim();var name=document.getElementById('nftmName').value.trim()||'NFT #'+tokenId;var cost=parseFloat(document.getElementById('nftmCost').value)||0;var value=parseFloat(document.getElementById('nftmValue').value)||0;if(!contract){toast('Inserisci il contract address','error');return;}var nft={user_id:user.id,wallet_id:currentWallet.id,chain:chain,collection_address:contract.toLowerCase(),token_id:tokenId,collection_name:name,token_name:name,symbol:'NFT',contract_type:'ERC721',amount:1,image_url:null,metadata:null,floor_price_usd:0,value_eur:value,cost_basis_eur:cost,verified:false,possible_spam:false};var res=await db.from('nft_balances').insert([nft]);if(res.error){toast('Errore: '+res.error.message,'error');return;}walletNFTs.push(nft);document.getElementById('nftManualModal').remove();renderNFTList();toast('âœ… NFT aggiunto!');}
function renderTM(){var search=(document.getElementById('tmSearch').value||'').toLowerCase();var filter=document.getElementById('tmFilter').value;var list=balances.filter(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);if(filter==='visible'&&(st==='spam'||b.is_hidden))return false;if(filter==='hidden'&&st!=='spam'&&!b.is_hidden)return false;if(search&&!(b.symbol||'').toLowerCase().includes(search)&&!(b.name||'').toLowerCase().includes(search))return false;return true;}).sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);});var html='<table class="table"><thead><tr><th>Token</th><th class="text-center">Chain</th><th class="text-right">QuantitÃ </th><th class="text-center">Status</th><th class="text-center">Azioni</th></tr></thead><tbody>';list.forEach(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);var badge=st==='verified'?'<span class="badge badge-ok">âœ“ OK</span>':st==='spam'?'<span class="badge badge-bad">âš  SPAM</span>':'<span class="badge badge-unk">? </span>';var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+'">'+ch.n+'</span>':'';html+='<tr><td><div class="token-cell">'+icon(b.symbol,b.chain,b.logo_url)+'<div class="token-info"><div class="symbol">'+b.symbol+'</div><div class="name">'+(b.name||'')+'</div></div></div></td><td class="text-center">'+chTag+'</td><td class="text-right text-mono">'+fmtN(b.amount)+'</td><td class="text-center">'+badge+'</td><td class="text-center"><button onclick="addWL(\''+b.symbol+'\')" class="btn btn-sm btn-secondary">âœ…</button> <button onclick="addBL(\''+b.symbol+'\',\''+(b.contract_address||'')+'\')" class="btn btn-sm btn-danger">ğŸš«</button></td></tr>';});html+='</tbody></table>';document.getElementById('tmList').innerHTML=html;}
function addWL(sym){whitelist.add(sym.toUpperCase());localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));renderTM();toast(sym+' in whitelist');}
function addBL(sym,contract){if(contract&&contract.length>10){blacklistContracts.add(contract.toLowerCase());}else{blacklist.add(sym.toUpperCase());}saveBlacklists();renderTM();updateBlStats();toast(sym+' in blacklist');}
function showWhitelist(){var html='';whitelist.forEach(function(s){html+='<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border)"><span>'+s+'</span><button onclick="removeWL(\''+s+'\')" class="btn btn-sm btn-danger">âœ•</button></div>';});document.getElementById('wlList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';document.getElementById('wlModal').style.display='flex';}
function addToWhitelist(){var s=document.getElementById('wlAdd').value.trim().toUpperCase();if(!s)return;whitelist.add(s);localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));document.getElementById('wlAdd').value='';showWhitelist();toast(s+' aggiunto');}
function removeWL(s){whitelist.delete(s);localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));showWhitelist();}
function showImportModal(){document.getElementById('importFile').value='';document.getElementById('importPreview').style.display='none';document.getElementById('importProgress').style.display='none';document.getElementById('importModal').style.display='flex';}
function showApiModal(){document.getElementById('binanceApiKey').value=localStorage.getItem('binance_api_key')||'';document.getElementById('binanceApiSecret').value=localStorage.getItem('binance_api_secret')||'';document.getElementById('apiSyncStatus').style.display='none';document.getElementById('apiModal').style.display='flex';}
async function showEarnReport(){document.getElementById('earnContent').innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)">â³ Caricamento dati...</div>';document.getElementById('earnModal').style.display='flex';
var allTx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).range(page*1000,(page+1)*1000-1);var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===1000;page++;if(page>50)break;}
var earnTypes=['reward','interest','staking','airdrop','bonus','cashback','rebate','referral','learning'];
var earnTx=allTx.filter(function(t){var op=(t.operation||'').toLowerCase();var type=t.tx_type||'';return type==='reward'||earnTypes.some(function(e){return op.includes(e);});});
var byExchange={};var byCoin={};var byYear={};var totalCount=0;
earnTx.forEach(function(t){var ex=t.exchange||'other';var coin=t.coin||'?';var year=t.tax_year||2024;var amt=parseFloat(t.amount)||0;if(amt<=0)return;totalCount++;
if(!byExchange[ex])byExchange[ex]={count:0,coins:{}};byExchange[ex].count++;if(!byExchange[ex].coins[coin])byExchange[ex].coins[coin]={amount:0,count:0};byExchange[ex].coins[coin].amount+=amt;byExchange[ex].coins[coin].count++;
if(!byCoin[coin])byCoin[coin]={amount:0,count:0,exchanges:new Set()};byCoin[coin].amount+=amt;byCoin[coin].count++;byCoin[coin].exchanges.add(ex);
if(!byYear[year])byYear[year]={count:0,coins:{}};byYear[year].count++;if(!byYear[year].coins[coin])byYear[year].coins[coin]=0;byYear[year].coins[coin]+=amt;});
var html='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--yellow)">'+totalCount+'</div><div style="font-size:11px;color:var(--text2)">TX Totali Earn</div></div>';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--green)">'+Object.keys(byCoin).length+'</div><div style="font-size:11px;color:var(--text2)">Coin Diversi</div></div>';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--cyan)">'+Object.keys(byExchange).length+'</div><div style="font-size:11px;color:var(--text2)">Exchange</div></div></div>';
html+='<h3 style="margin:16px 0 8px;font-size:14px">ğŸ“Š Per Exchange</h3><div style="display:flex;flex-direction:column;gap:8px">';
Object.entries(byExchange).sort(function(a,b){return b[1].count-a[1].count;}).forEach(function(e){var ex=e[0];var d=e[1];var logo=EX_LOGOS[ex]||EX_LOGOS.other;var color=EX_COLORS[ex]||'#888';
var topCoins=Object.entries(d.coins).sort(function(a,b){return b[1].count-a[1].count;}).slice(0,5).map(function(c){return c[0]+': '+formatAmount(c[1].amount);}).join(', ');
html+='<div class="card" style="padding:12px;border-left:3px solid '+color+'"><div style="display:flex;align-items:center;gap:8px"><img src="'+logo+'" style="width:24px;height:24px;border-radius:4px" onerror="this.style.display=\'none\'"><strong>'+formatExName(ex)+'</strong><span style="color:var(--yellow);margin-left:auto">'+d.count+' rewards</span></div><div style="font-size:11px;color:var(--text2);margin-top:4px">'+topCoins+'</div></div>';});
html+='</div><h3 style="margin:16px 0 8px;font-size:14px">ğŸª™ Top Coin per QuantitÃ </h3><table class="table" style="font-size:12px"><thead><tr><th>Coin</th><th class="text-right">QuantitÃ </th><th class="text-right">TX</th><th>Exchange</th></tr></thead><tbody>';
Object.entries(byCoin).sort(function(a,b){return b[1].count-a[1].count;}).slice(0,20).forEach(function(c){var coin=c[0];var d=c[1];
html+='<tr><td><strong>'+coin+'</strong></td><td class="text-right" style="color:var(--green)">'+formatAmount(d.amount)+'</td><td class="text-right">'+d.count+'</td><td style="font-size:10px">'+Array.from(d.exchanges).map(formatExName).join(', ')+'</td></tr>';});
html+='</tbody></table>';
html+='<h3 style="margin:16px 0 8px;font-size:14px">ğŸ“… Per Anno</h3><table class="table" style="font-size:12px"><thead><tr><th>Anno</th><th class="text-right">TX Earn</th><th>Top Coin</th></tr></thead><tbody>';
Object.entries(byYear).sort(function(a,b){return parseInt(b[0])-parseInt(a[0]);}).forEach(function(y){var year=y[0];var d=y[1];var topCoin=Object.entries(d.coins).sort(function(a,b){return b[1]-a[1];})[0];
html+='<tr><td><strong>'+year+'</strong></td><td class="text-right" style="color:var(--yellow)">'+d.count+'</td><td>'+( topCoin?topCoin[0]+': '+formatAmount(topCoin[1]):'-')+'</td></tr>';});
html+='</tbody></table>';
document.getElementById('earnContent').innerHTML=html;}
async function resetExchangeData(){var allEx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('exchange').eq('user_id',user.id).range(page*1000,(page+1)*1000-1);var data=res.data||[];data.forEach(function(t){if(t.exchange&&!allEx.includes(t.exchange))allEx.push(t.exchange);});hasMore=data.length===1000;page++;if(page>50)break;}if(allEx.length===0){toast('Nessun dato da cancellare','warning');return;}allEx.sort();var html='<button onclick="confirmReset(\'all\')" class="btn" style="width:100%;background:var(--red)20;color:var(--red);justify-content:flex-start;padding:12px 16px"><span style="margin-right:8px">ğŸ—‘ï¸</span> Cancella TUTTI gli exchange ('+allEx.length+')</button>';allEx.forEach(function(ex){var logo=EX_LOGOS[ex]||EX_LOGOS.other;var color=EX_COLORS[ex]||'#888';html+='<button onclick="confirmReset(\''+ex+'\')" class="btn btn-secondary" style="width:100%;justify-content:flex-start;padding:12px 16px;border-left:3px solid '+color+'"><img src="'+logo+'" style="width:20px;height:20px;border-radius:4px;margin-right:8px" onerror="this.style.display=\'none\'"><span>'+formatExName(ex)+'</span></button>';});document.getElementById('resetOptions').innerHTML=html;document.getElementById('resetModal').style.display='flex';}
async function confirmReset(target){if(target==='all'){if(!confirm('âš ï¸ Sicuro di cancellare TUTTI i dati exchange?'))return;await db.from('exchange_transactions').delete().eq('user_id',user.id);toast('âœ… Tutti i dati exchange cancellati!');}else{if(!confirm('Sicuro di cancellare i dati di '+target+'?'))return;await db.from('exchange_transactions').delete().eq('user_id',user.id).eq('exchange',target);toast('âœ… Dati '+target+' cancellati!');}closeModal('resetModal');loadExchangeTx();}
function showApiStatus(msg,type){var el=document.getElementById('apiSyncStatus');el.style.display='block';el.style.background=type==='success'?'var(--green)20':type==='error'?'var(--red)20':type==='warning'?'var(--yellow)20':'var(--blue)20';el.style.color=type==='success'?'var(--green)':type==='error'?'var(--red)':type==='warning'?'var(--yellow)':'var(--blue)';el.innerHTML=msg;}
var COIN_MAP={BTC:'bitcoin',ETH:'ethereum',BNB:'binancecoin',USDT:'tether',USDC:'usd-coin',XRP:'ripple',ADA:'cardano',DOGE:'dogecoin',SOL:'solana',DOT:'polkadot',MATIC:'matic-network',SHIB:'shiba-inu',LTC:'litecoin',AVAX:'avalanche-2',LINK:'chainlink',ATOM:'cosmos',UNI:'uniswap',LUNA:'terra-luna-2',LUNC:'terra-luna',CAKE:'pancakeswap-token',FTM:'fantom',SAND:'the-sandbox',MANA:'decentraland',AXS:'axie-infinity',AAVE:'aave',CRO:'crypto-com-chain',TRX:'tron',BUSD:'binance-usd',DAI:'dai',PEPE:'pepe',FLOKI:'floki',ARB:'arbitrum',OP:'optimism',APT:'aptos',SUI:'sui',INJ:'injective-protocol',FET:'fetch-ai',NEAR:'near',GRT:'the-graph',RUNE:'thorchain',IMX:'immutable-x',GALA:'gala',ENJ:'enjincoin',CHZ:'chiliz',GMT:'stepn',APE:'apecoin',LRC:'loopring',ALGO:'algorand',VET:'vechain',HBAR:'hedera-hashgraph',XLM:'stellar',XTZ:'tezos',EOS:'eos',NEO:'neo',XMR:'monero',ZEC:'zcash',DASH:'dash',THETA:'theta-token',EGLD:'elrond-erd-2',FLOW:'flow',KCS:'kucoin-shares',ONE:'harmony',HOT:'holotoken',ANKR:'ankr',AUDIO:'audius',BAT:'basic-attention-token',COMP:'compound-governance-token',CRV:'curve-dao-token',SNX:'havven',SUSHI:'sushi',YFI:'yearn-finance','1INCH':'1inch',BAL:'balancer',REN:'republic-protocol',BAND:'band-protocol',STORJ:'storj',OCEAN:'ocean-protocol',FIL:'filecoin',AR:'arweave',STX:'blockstack',CELO:'celo',KAVA:'kava',ROSE:'oasis-network',NOT:'notcoin',TON:'the-open-network',WLD:'worldcoin-wld',JUP:'jupiter-exchange-solana',BONK:'bonk',WIF:'dogwifcoin',ORDI:'ordi',SATS:'sats-ordinals',RATS:'rats-ordinals',SEI:'sei-network',TIA:'celestia',PYTH:'pyth-network',MEME:'memecoin',ACE:'fusionist',AI:'sleepless-ai',XAI:'xai-blockchain',PIXEL:'pixels',PORTAL:'portal-2',STRK:'starknet',ALT:'altlayer',MANTA:'manta-network',DYM:'dymension',BOME:'book-of-meme',ETHFI:'ether-fi',ENA:'ethena',SAGA:'saga-2',REZ:'renzo',IO:'io-net',ZK:'zksync',LISTA:'lista-dao',ZRO:'layerzero',BANANA:'banana-gun',RENDER:'render-token',TAO:'bittensor',FTN:'fasttoken',JASMY:'jasmycoin',CFX:'conflux-token',BLUR:'blur',ID:'space-id',HOOK:'hooked-protocol',HIGH:'highstreet',LEVER:'lever',RDNT:'radiant-capital',MAGIC:'magic',GMX:'gmx',PENDLE:'pendle',SSV:'ssv-network',LDO:'lido-dao',RPL:'rocket-pool',FXS:'frax-share',CVX:'convex-finance',OSMO:'osmosis',SCRT:'secret',JUNO:'juno-network',EVMOS:'evmos',INJ2:'injective-protocol',
// Aggiunte v7.90 da Binance
NFT:'apenft',KLAY:'klay-token',BTT:'bittorrent',WIN:'winklink',STMX:'storm',LAZIO:'lazio-fan-token',SANTOS:'santos-fc-fan-token',PORTO:'fc-porto',CITY:'manchester-city-fan-token',DAR:'mines-of-dalarnia',VTHO:'vethor-token',QI:'benqi',MC:'merit-circle',VOXEL:'voxies',TVK:'terra-virtua-kolect',GAL:'galxe',HFT:'hashflow',CYBER:'cyberconnect',NTRN:'neutron-3',NFP:'nfprompt',AEVO:'aevo',OMNI:'omni-network',DOGS:'dogs-2',CATI:'catizen',HMSTR:'hamster-kombat',SCR:'scroll'};
var rwData=[];
async function calcRW(){document.getElementById('rwModal').style.display='flex';document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Caricamento transazioni exchange...</div></div>';

// 1. CARICA TX EXCHANGE
var exchangeTx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).order('tx_timestamp',{ascending:true}).range(page*1000,(page+1)*1000-1);exchangeTx=exchangeTx.concat(res.data||[]);hasMore=(res.data||[]).length===1000;page++;if(page>50)break;}
console.log('Exchange TX loaded:',exchangeTx.length);

// 2. CARICA SALDI WALLET ON-CHAIN (attuali)
document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Caricamento saldi wallet...</div></div>';
var wRes=await db.from('wallets').select('*').eq('user_id',user.id);
var wallets=wRes.data||[];
var walletBalances=[];
if(wallets.length>0){
var bRes=await db.from('balances').select('*').in('wallet_id',wallets.map(function(w){return w.id;}));
walletBalances=bRes.data||[];
}
console.log('Wallet balances loaded:',walletBalances.length,'from',wallets.length,'wallets');

// 3. CARICA TX WALLET ON-CHAIN (per calcolo storico)
var walletTx=[];
if(wallets.length>0){
var txRes=await db.from('transactions').select('*').in('wallet_id',wallets.map(function(w){return w.id;})).order('tx_timestamp',{ascending:true});
walletTx=txRes.data||[];
}
console.log('Wallet TX loaded:',walletTx.length);

document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Calcolo saldi per anno...</div></div>';
var years=[2021,2022,2023,2024,2025];var results=[];
var currentYear=new Date().getFullYear();
// CARICA SNAPSHOTS API (saldi REALI Binance al 31/12)
var binanceSnapshots=JSON.parse(localStorage.getItem('binance_snapshots')||'{}');
var hasSnapshots=Object.keys(binanceSnapshots).length>0;
console.log('Snapshots disponibili:',hasSnapshots?Object.keys(binanceSnapshots).join(', '):'nessuno');

for(var yi=0;yi<years.length;yi++){
var year=years[yi];
var endDate=new Date(year,11,31,23,59,59);
var isCurrentYear=year===currentYear;

// === SALDI EXCHANGE ===
var exBalances={};
var usedSnapshot=false;

// PRIORITÃ€ 1: Usa snapshot API (saldo REALE dal conto Binance)
if(binanceSnapshots[year]&&binanceSnapshots[year].balances&&binanceSnapshots[year].balances.length>0){
console.log('ğŸ“Š Year',year,': usando SNAPSHOT API (',binanceSnapshots[year].balances.length,'asset, data:',binanceSnapshots[year].date,')');
binanceSnapshots[year].balances.forEach(function(b){
var coin=b.asset;
var amt=parseFloat(b.total)||0;
if(amt>0){
exBalances[coin]={amount:amt,source:'snapshot'};
}
});
usedSnapshot=true;
}else{
// PRIORITÃ€ 2: Calcola dalle TX (fallback)
console.log('ğŸ“ Year',year,': calcolo da TX (no snapshot)');
var debugCounts={};
exchangeTx.forEach(function(t){
var txDate=new Date(t.tx_timestamp);
if(txDate<=endDate){
var op=(t.operation||'').toLowerCase().trim();
var coin=t.coin;
if(!debugCounts[coin])debugCounts[coin]={total:0,sum:0};
debugCounts[coin].total++;
if(op.includes('transfer between main and funding'))return;
if(op.includes('transfer between spot and margin'))return;
var amt=parseFloat(t.amount)||0;
debugCounts[coin].sum+=amt;
if(!exBalances[coin])exBalances[coin]={amount:0,source:'exchange'};
exBalances[coin].amount+=amt;
}});
console.log('=== DEBUG RW Year',year,'(from TX) ===');
['LUNC','NOT','PEPE','SHIB','WIN','BONK','DOGS'].forEach(function(c){
var bal=exBalances[c]?exBalances[c].amount:0;
console.log(c+': saldo='+bal.toFixed(2));
});
}

// FILTRA SALDI: escludi negativi, dust, FIAT e stablecoin
var filteredBalances={};
var FIAT_RW=['EUR','USD','GBP','CHF'];
var STABLE_RW=['USDT','USDC','BUSD','DAI','TUSD','FDUSD','UST','USDP','GUSD','FRAX','LUSD','USDD','PYUSD'];
// Coin obsolete/migrate/rinominate che danno falsi positivi
var OBSOLETE_RW=['BTT','BTTC','TRX','LUNA','LUNA2','USTC','MIR','ANC'];
// Prezzi dalla Dashboard per filtro valore
var dashPrices=window.prices||{};
Object.entries(exBalances).forEach(function(e){
var coin=e[0];
var bal=e[1].amount;
// Escludi FIAT (non sono crypto)
if(FIAT_RW.includes(coin))return;
// Escludi stablecoin (non vanno nel Quadro RW)
if(STABLE_RW.includes(coin))return;
// Escludi coin obsolete/migrate
if(OBSOLETE_RW.includes(coin))return;
// Escludi saldi negativi (errori di calcolo) o dust estremo
if(bal<=0.001)return;
// Escludi coin con valore < â‚¬1 (usa prezzi Dashboard se disponibili)
var price=dashPrices[coin]?.eur||dashPrices[coin.toLowerCase()]?.eur||0;
if(price>0 && bal*price<1)return;
filteredBalances[coin]={amount:bal,source:'exchange'};
});
exBalances=filteredBalances;

// === SALDI WALLET (metodo ibrido) ===
var wBalances={};
if(isCurrentYear){
// Per anno corrente: usa saldi ATTUALI
walletBalances.forEach(function(b){
var sym=(b.symbol||'').toUpperCase();
if(!sym||['EUR','USD'].includes(sym))return;
if(getStatus(b.symbol,b.name,b.contract_address)==='spam')return;
if(b.is_hidden)return;
var amt=parseFloat(b.amount)||0;
if(Math.abs(amt)>0.000001){
if(!wBalances[sym])wBalances[sym]={amount:0,source:'wallet'};
wBalances[sym].amount+=amt;
}});
}else{
// Per anni passati: calcola dalle TX wallet
// Nota: questo funziona solo se le TX sono state sincronizzate
walletTx.forEach(function(t){
var txDate=new Date(t.tx_timestamp);
if(txDate<=endDate){
var sym=t.token_in_symbol||t.token_out_symbol;
if(!sym||['EUR','USD'].includes(sym))return;
var symUp=sym.toUpperCase();
var amt=0;
if(t.token_in_symbol&&t.token_in_amount)amt+=parseFloat(t.token_in_amount)||0;
if(t.token_out_symbol&&t.token_out_amount)amt-=parseFloat(t.token_out_amount)||0;
if(!wBalances[symUp])wBalances[symUp]={amount:0,source:'wallet'};
wBalances[symUp].amount+=amt;
}});
}

// === UNISCI EXCHANGE + WALLET ===
var combined={};
Object.entries(exBalances).forEach(function(e){
var coin=e[0];var data=e[1];
if(['EUR','USD'].includes(coin))return;
if(Math.abs(data.amount)<0.000001)return;
if(!combined[coin])combined[coin]={exchange:0,wallet:0};
combined[coin].exchange=data.amount;
});
Object.entries(wBalances).forEach(function(e){
var coin=e[0];var data=e[1];
if(Math.abs(data.amount)<0.000001)return;
if(!combined[coin])combined[coin]={exchange:0,wallet:0};
combined[coin].wallet=data.amount;
});

var coinsWithBalance=Object.entries(combined).filter(function(e){
var coin=e[0];
var total=e[1].exchange+e[1].wallet;
// Escludi saldi negativi (errori)
if(total<0)return false;
// Escludi saldi troppo piccoli (dust < 0.01)
return total>0.01;
}).map(function(e){
return[e[0],e[1].exchange+e[1].wallet,e[1].exchange,e[1].wallet];
});

console.log('Year',year,'combined balances:',coinsWithBalance.length);
results.push({year:year,balances:coinsWithBalance,isCurrentYear:isCurrentYear});
}

// 4. RECUPERA PREZZI STORICI
document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Recupero prezzi storici...</div></div>';
var allCoins=[...new Set(results.flatMap(function(r){return r.balances.map(function(b){return b[0];});}))];
var pricesToFetch=[];
years.forEach(function(y){allCoins.forEach(function(c){pricesToFetch.push({coin:c,date:y+'-12-31'});});});
var cachedRes=await db.from('historical_prices').select('*').in('coin',allCoins);
var cached={};(cachedRes.data||[]).forEach(function(p){cached[p.coin+'_'+p.date]=p;});
var missing=pricesToFetch.filter(function(p){return!cached[p.coin+'_'+p.date];});

// CARICA PREZZI MANCANTI VIA EDGE FUNCTION
if(missing.length>0){
document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Carico '+missing.length+' prezzi storici...</div></div>';

// Prima carica prezzi attuali per le coin
await fetchPrices(allCoins);
var globalPricesRW=window.prices||{};

// Raggruppa per data
var byDate={};
missing.forEach(function(m){
if(!byDate[m.date])byDate[m.date]=[];
byDate[m.date].push(m.coin);
});

// Chiama Edge Function per ogni data
var dates=Object.keys(byDate);
for(var di=0;di<dates.length;di++){
var date=dates[di];
var coins=byDate[date];
var year=parseInt(date.split('-')[0]);

document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Prezzi '+date+' ('+(di+1)+'/'+dates.length+')...</div></div>';

// Per anno corrente/recente usa prezzi attuali
if(year>=2024){
coins.forEach(function(coin){
if(globalPricesRW[coin]){
var eur=globalPricesRW[coin].eur||0;
var usd=globalPricesRW[coin].usd||0;
if(eur>0){
cached[coin+'_'+date]={price_eur:eur,price_usd:usd};
db.from('historical_prices').upsert({coin:coin,coin_id:COIN_MAP[coin]||coin.toLowerCase(),date:date,price_eur:eur,price_usd:usd},{onConflict:'coin,date'}).then(function(){});
}}});
}else{
// Per anni passati chiama Edge Function
var gotPrices=false;
try{
console.log('Calling historical-prices for',date,'coins:',coins);
var res=await fetch(SB_URL+'/functions/v1/historical-prices',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+SB_KEY},
body:JSON.stringify({coins:coins,date:date})
});
console.log('Historical prices response:',res.status);
if(res.ok){
var data=await res.json();
console.log('Historical prices data:',data);
if(data.prices && Object.keys(data.prices).length>0){
Object.entries(data.prices).forEach(function(e){
var coin=e[0];var p=e[1];
cached[coin+'_'+date]={price_eur:p.eur,price_usd:p.usd};
db.from('historical_prices').upsert({coin:coin,coin_id:COIN_MAP[coin]||coin.toLowerCase(),date:date,price_eur:p.eur,price_usd:p.usd},{onConflict:'coin,date'}).then(function(){});
});
gotPrices=true;
}}else{
var errText=await res.text();
console.error('Historical prices error:',res.status,errText);
}
}catch(e){console.error('Historical prices error:',e);}
// FALLBACK: usa prezzi attuali se Edge Function fallisce
if(!gotPrices){
console.log('Using current prices as fallback for',date);
coins.forEach(function(coin){
if(globalPricesRW[coin]){
var eur=globalPricesRW[coin].eur||0;
var usd=globalPricesRW[coin].usd||0;
if(eur>0){
cached[coin+'_'+date]={price_eur:eur,price_usd:usd};
}}});
}
}}}else{
var globalPricesRW=window.prices||{};
}

// 5. GENERA HTML RISULTATO
rwData=[];var html='';
html+='<div class="card mb-12" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1))"><div style="font-size:12px;margin-bottom:8px"><strong>ğŸ“Š Fonti dati Quadro RW</strong></div>';
html+='<div style="display:flex;gap:16px;font-size:11px;flex-wrap:wrap"><div><span style="color:var(--cyan)">ğŸ¦ Exchange:</span> '+exchangeTx.length+' TX</div>';
html+='<div><span style="color:var(--purple)">ğŸ‘› Wallet:</span> '+wallets.length+' wallet, '+walletBalances.length+' saldi</div>';
if(hasSnapshots)html+='<div><span style="color:var(--green)">ğŸ“Š Snapshots API:</span> '+Object.keys(binanceSnapshots).join(', ')+'</div>';
html+='</div>';
if(!hasSnapshots)html+='<div style="color:var(--yellow);font-size:10px;margin-top:8px">ğŸ’¡ Consiglio: Connetti API Binance (chiavi normali) per avere i saldi REALI al 31/12 ogni anno!</div>';
if(walletTx.length===0&&wallets.length>0)html+='<div style="color:var(--yellow);font-size:10px;margin-top:8px">âš ï¸ TX wallet non sincronizzate - per anni passati usa "Sync TX" nei wallet</div>';
html+='</div>';

years.forEach(function(year){
var r=results.find(function(x){return x.year===year;});
if(!r)return;
var rows=[];var totalEur=0;var totalUnpriced=0;
// USA PREZZI DALLA CACHE GLOBALE (dashboard) SE DISPONIBILI
var globalPrices=window.prices||{};
r.balances.forEach(function(b){
var coin=b[0];var bal=b[1];var exBal=b[2];var wBal=b[3];
var priceData=cached[coin+'_'+year+'-12-31'];
var price=priceData?parseFloat(priceData.price_eur):0;
// Se non ho prezzo storico, usa prezzo attuale dalla dashboard come fallback
if(price===0&&globalPrices[coin]){
price=globalPrices[coin].eur||0;
}
var value=bal*price;
// FILTRO AGGRESSIVO: escludi coin con valore < â‚¬1 o senza prezzo con saldo < 1
var isDust=(price>0&&Math.abs(value)<1)||(price===0&&Math.abs(bal)<1);
console.log('Year',year,'coin',coin,'bal=',bal.toFixed(4),'price=',price.toFixed(6),'value=',value.toFixed(2),'isDust=',isDust);
if(Math.abs(bal)>0.0001&&!isDust){
totalEur+=value;
if(price===0)totalUnpriced++;
rows.push({coin:coin,balance:bal,exBalance:exBal,wBalance:wBal,price:price,value:value});
}});
rows.sort(function(a,b){return Math.abs(b.value)-Math.abs(a.value);});
rwData.push({year:year,total:totalEur,rows:rows});

html+='<div class="card mb-12"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:14px;font-weight:700">ğŸ“… '+year+' - Valore al 31/12'+(r.isCurrentYear?' <span style="font-size:10px;color:var(--yellow)">(saldi attuali wallet)</span>':'')+(binanceSnapshots[year]?' <span style="font-size:10px;color:var(--green)">ğŸ“Š Snapshot API</span>':'')+'</div><div style="font-size:16px;font-weight:700;color:var(--green)">'+fmtC(totalEur)+'</div></div>';
if(rows.length===0){html+='<div style="color:var(--text2);font-size:12px">Nessun saldo crypto</div>';}
else{
if(totalUnpriced>0)html+='<div style="color:var(--yellow);font-size:11px;margin-bottom:8px">âš ï¸ '+totalUnpriced+' coin senza prezzo - <strong>Vai prima in Dashboard per caricare i prezzi!</strong></div>';
html+='<table class="table" style="font-size:11px"><thead><tr><th>Coin</th><th class="text-right">Saldo Tot</th><th class="text-right" style="color:var(--cyan)">ğŸ¦ Ex</th><th class="text-right" style="color:var(--purple)">ğŸ‘› Wal</th><th class="text-right">Prezzo â‚¬</th><th class="text-right">Valore â‚¬</th></tr></thead><tbody>';
rows.slice(0,30).forEach(function(row){
var priceCol=row.price>0?fmtC(row.price):'<span style="color:var(--yellow)">?</span>';
var valueCol=row.price>0?fmtC(row.value):'<span style="color:var(--yellow)">?</span>';
var exCol=row.exBalance?fmtN(row.exBalance):'-';
var wCol=row.wBalance?fmtN(row.wBalance):'-';
html+='<tr><td><strong>'+row.coin+'</strong></td><td class="text-right text-mono">'+fmtN(row.balance)+'</td><td class="text-right text-mono" style="color:var(--cyan)">'+exCol+'</td><td class="text-right text-mono" style="color:var(--purple)">'+wCol+'</td><td class="text-right text-mono">'+priceCol+'</td><td class="text-right text-mono" style="color:var(--green)">'+valueCol+'</td></tr>';
});
if(rows.length>30)html+='<tr><td colspan="6" style="text-align:center;color:var(--text2)">...e altri '+(rows.length-30)+' coin</td></tr>';
html+='</tbody></table>';
}
html+='</div>';
});

// === SEZIONE NFT NEL QUADRO RW ===
var nftRes=await db.from('nft_balances').select('*').eq('user_id',user.id);
var allNfts=nftRes.data||[];
if(allNfts.length>0){
var nftTotal=allNfts.reduce(function(s,n){return s+(n.value_eur||0);},0);
var nftCostTotal=allNfts.reduce(function(s,n){return s+(n.cost_basis_eur||0);},0);
html+='<div class="card mb-12" style="background:linear-gradient(135deg,rgba(236,72,153,0.1),rgba(168,85,247,0.1))"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:14px;font-weight:700">ğŸ–¼ï¸ NFT - Valore Attuale</div><div><span style="font-size:16px;font-weight:700;color:var(--green)">'+fmtC(nftTotal)+'</span><span style="font-size:11px;color:var(--text2);margin-left:8px">(costo: '+fmtC(nftCostTotal)+')</span></div></div>';
html+='<table class="table" style="font-size:11px"><thead><tr><th>NFT</th><th>Collezione</th><th class="text-center">Chain</th><th class="text-right">Costo â‚¬</th><th class="text-right">Valore â‚¬</th><th class="text-right">P/L â‚¬</th></tr></thead><tbody>';
allNfts.forEach(function(n){
var ch=CHAINS[n.chain];
var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+';font-size:9px;padding:2px 6px">'+ch.n+'</span>':'';
var pl=(n.value_eur||0)-(n.cost_basis_eur||0);
var plColor=pl>=0?'var(--green)':'var(--red)';
html+='<tr><td><strong>'+((n.token_name||'').slice(0,25))+'</strong></td><td style="font-size:10px">'+((n.collection_name||'').slice(0,20))+'</td><td class="text-center">'+chTag+'</td><td class="text-right text-mono">'+fmtC(n.cost_basis_eur||0)+'</td><td class="text-right text-mono" style="color:var(--green)">'+fmtC(n.value_eur||0)+'</td><td class="text-right text-mono" style="color:'+plColor+'">'+fmtC(pl)+'</td></tr>';
});
html+='</tbody></table>';
html+='<div style="font-size:10px;color:var(--text2);margin-top:8px">ğŸ’¡ Aggiorna i valori NFT dalla sezione Wallet â†’ ğŸ–¼ï¸ NFT â†’ ğŸ’° Valore</div>';
html+='</div>';
}

document.getElementById('rwContent').innerHTML=html||'<div style="padding:40px;text-align:center;color:var(--text2)">Nessun dato</div>';}
function exportRW(){if(!rwData.length){toast('Nessun dato da esportare','error');return;}var csv='Anno,Coin,Saldo_Totale,Saldo_Exchange,Saldo_Wallet,Prezzo_EUR,Valore_EUR\n';rwData.forEach(function(y){y.rows.forEach(function(r){csv+=y.year+',"'+r.coin+'",'+r.balance+','+(r.exBalance||0)+','+(r.wBalance||0)+','+r.price+','+r.value+'\n';});});var blob=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='QuadroRW_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('âœ… CSV esportato!');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECONCILIATION ENGINE - Identifica trasferimenti interni
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var reconcileData={pairs:[],earnOps:[],stats:{}};
var EARN_OPERATIONS=['Simple Earn Flexible Subscription','Simple Earn Flexible Redemption','Simple Earn Locked Subscription','Simple Earn Locked Redemption','Staking Purchase','Staking Redemption','Launchpool Subscription','Launchpool Redemption','ETH 2.0 Staking','Savings Principal redemption','Savings purchase','POS savings purchase','POS savings redemption','Locked Staking','Auto-Invest','BNB Vault'];
var INTERNAL_TRANSFER_OPS=['Withdraw','Deposit','Transfer Between Spot Account and UM Futures Account','Transfer Between Main and Funding Wallet','Main and Funding Account Transfer','Funding Fee','Asset Recovery'];

async function reconcileTransfers(){
document.getElementById('reconcileModal').style.display='flex';
document.getElementById('reconcileContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Caricamento transazioni exchange...</div></div>';

// 1. CARICA TUTTE LE TX EXCHANGE
var exchangeTx=[];var page=0;var hasMore=true;
while(hasMore){
var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).order('tx_timestamp',{ascending:true}).range(page*1000,(page+1)*1000-1);
exchangeTx=exchangeTx.concat(res.data||[]);
hasMore=(res.data||[]).length===1000;page++;if(page>30)break;
}
console.log('Reconcile: loaded',exchangeTx.length,'exchange TX');

// 2. CARICA TX WALLET
document.getElementById('reconcileContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Caricamento transazioni wallet...</div></div>';
var wRes=await db.from('wallets').select('*').eq('user_id',user.id);
var wallets=wRes.data||[];
var walletTx=[];
if(wallets.length>0){
var txRes=await db.from('transactions').select('*').in('wallet_id',wallets.map(function(w){return w.id;}));
walletTx=txRes.data||[];
}
console.log('Reconcile: loaded',walletTx.length,'wallet TX');

document.getElementById('reconcileContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Analisi trasferimenti...</div></div>';

// 3. IDENTIFICA OPERAZIONI EARN/STAKING (non tassabili)
var earnOps=exchangeTx.filter(function(t){
var op=(t.operation||'').toLowerCase();
return EARN_OPERATIONS.some(function(e){return op.includes(e.toLowerCase());});
});
console.log('Earn/Staking ops:',earnOps.length);

// 4. IDENTIFICA WITHDRAW DAGLI EXCHANGE (anche giÃ  riconciliati)
var withdraws=exchangeTx.filter(function(t){
var op=(t.operation||'').toLowerCase();
var type=t.tx_type||'';
return type==='withdraw'||op.includes('withdraw')||(type==='internal_transfer'&&op.includes('withdraw'));
});
console.log('Withdraws found:',withdraws.length);

// 5. IDENTIFICA DEPOSIT SUGLI EXCHANGE (anche giÃ  riconciliati)
var deposits=exchangeTx.filter(function(t){
var op=(t.operation||'').toLowerCase();
var type=t.tx_type||'';
return (type==='deposit'||( type==='internal_transfer'&&op.includes('deposit')))&&!op.includes('card')&&!op.includes('buy');
});
console.log('Deposits found:',deposits.length);

// 6. CERCA COPPIE WITHDRAW-DEPOSIT (Exchange â†’ Exchange)
var pairs=[];
var usedWithdraws=new Set();
var usedDeposits=new Set();
var TIME_TOLERANCE=60*60*1000; // 60 minuti
var AMOUNT_TOLERANCE=0.02; // 2% per gas fee

withdraws.forEach(function(w){
if(usedWithdraws.has(w.id))return;
var wTime=new Date(w.tx_timestamp).getTime();
var wAmt=Math.abs(parseFloat(w.amount)||0);
var wCoin=w.coin;
var wExchange=w.exchange;

// Cerca deposit corrispondente
var match=deposits.find(function(d){
if(usedDeposits.has(d.id))return false;
if(d.exchange===wExchange)return false; // stesso exchange = no match
if(d.coin!==wCoin)return false;
var dTime=new Date(d.tx_timestamp).getTime();
var timeDiff=dTime-wTime;
if(timeDiff<0||timeDiff>TIME_TOLERANCE)return false;
var dAmt=Math.abs(parseFloat(d.amount)||0);
var amtDiff=Math.abs(wAmt-dAmt)/wAmt;
if(amtDiff>AMOUNT_TOLERANCE)return false;
return true;
});

if(match){
pairs.push({
type:'exchange_to_exchange',
withdraw:w,
deposit:match,
coin:wCoin,
amount:wAmt,
fee:wAmt-Math.abs(parseFloat(match.amount)||0),
from:wExchange,
to:match.exchange
});
usedWithdraws.add(w.id);
usedDeposits.add(match.id);
}
});
console.log('Exchangeâ†’Exchange pairs:',pairs.length);

// 7. CERCA COPPIE WITHDRAW-WALLET (Exchange â†’ Wallet)
withdraws.forEach(function(w){
if(usedWithdraws.has(w.id))return;
var wTime=new Date(w.tx_timestamp).getTime();
var wAmt=Math.abs(parseFloat(w.amount)||0);
var wCoin=w.coin;

var match=walletTx.find(function(t){
if(t.tx_type!=='transfer_in')return false;
var sym=t.token_in_symbol||'';
if(sym.toUpperCase()!==wCoin.toUpperCase())return false;
var tTime=new Date(t.tx_timestamp).getTime();
var timeDiff=tTime-wTime;
if(timeDiff<-5*60*1000||timeDiff>TIME_TOLERANCE)return false;
var tAmt=Math.abs(parseFloat(t.token_in_amount)||0);
var amtDiff=Math.abs(wAmt-tAmt)/wAmt;
if(amtDiff>AMOUNT_TOLERANCE)return false;
return true;
});

if(match){
var wallet=wallets.find(function(ww){return ww.id===match.wallet_id;});
pairs.push({
type:'exchange_to_wallet',
withdraw:w,
walletTx:match,
coin:wCoin,
amount:wAmt,
fee:wAmt-Math.abs(parseFloat(match.token_in_amount)||0),
from:w.exchange,
to:wallet?wallet.name:'Wallet'
});
usedWithdraws.add(w.id);
}
});
console.log('Total pairs after Eâ†’W:',pairs.length);

// 7b. CERCA COPPIE WALLETâ†’EXCHANGE (Wallet â†’ Exchange Deposit)
var usedWalletTx=new Set();
deposits.forEach(function(d){
if(usedDeposits.has(d.id))return;
var dTime=new Date(d.tx_timestamp).getTime();
var dAmt=Math.abs(parseFloat(d.amount)||0);
var dCoin=d.coin;

var match=walletTx.find(function(t){
if(usedWalletTx.has(t.id))return false;
if(t.tx_type!=='transfer_out')return false;
var sym=t.token_out_symbol||'';
if(sym.toUpperCase()!==dCoin.toUpperCase())return false;
var tTime=new Date(t.tx_timestamp).getTime();
var timeDiff=dTime-tTime;
if(timeDiff<-5*60*1000||timeDiff>TIME_TOLERANCE)return false;
var tAmt=Math.abs(parseFloat(t.token_out_amount)||0);
var amtDiff=Math.abs(dAmt-tAmt)/Math.max(dAmt,0.0001);
if(amtDiff>AMOUNT_TOLERANCE)return false;
return true;
});

if(match){
var wallet=wallets.find(function(ww){return ww.id===match.wallet_id;});
pairs.push({
type:'wallet_to_exchange',
deposit:d,
walletTx:match,
coin:dCoin,
amount:dAmt,
fee:Math.abs(parseFloat(match.token_out_amount)||0)-dAmt,
from:wallet?wallet.name:'Wallet',
to:d.exchange
});
usedDeposits.add(d.id);
usedWalletTx.add(match.id);
}
});
console.log('Total pairs after Wâ†’E:',pairs.length);

// 8. GENERA STATISTICHE
var stats={
totalTx:exchangeTx.length,
earnOps:earnOps.length,
withdraws:withdraws.length,
deposits:deposits.length,
pairsFound:pairs.length,
unmatchedWithdraws:withdraws.length-pairs.filter(function(p){return p.withdraw;}).length,
byType:{
exchange_to_exchange:pairs.filter(function(p){return p.type==='exchange_to_exchange';}).length,
exchange_to_wallet:pairs.filter(function(p){return p.type==='exchange_to_wallet';}).length,
wallet_to_exchange:pairs.filter(function(p){return p.type==='wallet_to_exchange';}).length
}
};

reconcileData={pairs:pairs,earnOps:earnOps,stats:stats};

// 9. GENERA HTML RISULTATO
var html='<div class="card mb-12" style="background:linear-gradient(135deg,rgba(0,201,255,0.1),rgba(146,254,157,0.1))">';
html+='<div style="font-size:14px;font-weight:700;margin-bottom:12px">ğŸ“Š Analisi Completata</div>';
html+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:12px">';
html+='<div style="background:var(--card);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--cyan)">'+stats.totalTx+'</div><div style="color:var(--text2)">TX Totali</div></div>';
html+='<div style="background:var(--card);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--green)">'+stats.pairsFound+'</div><div style="color:var(--text2)">Trasf. Interni</div></div>';
html+='<div style="background:var(--card);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--yellow)">'+stats.earnOps+'</div><div style="color:var(--text2)">Earn/Staking</div></div>';
html+='</div></div>';

// Dettaglio trasferimenti trovati
if(pairs.length>0){
html+='<div class="card mb-12"><div style="font-size:13px;font-weight:600;margin-bottom:12px">ğŸ”— Trasferimenti Interni Identificati</div>';
html+='<div style="font-size:11px;color:var(--text2);margin-bottom:8px">Exchangeâ†’Exchange: '+stats.byType.exchange_to_exchange+' | Exchangeâ†’Wallet: '+stats.byType.exchange_to_wallet+' | Walletâ†’Exchange: '+(stats.byType.wallet_to_exchange||0)+'</div>';
html+='<table class="table" style="font-size:11px"><thead><tr><th>Data</th><th>Coin</th><th>QuantitÃ </th><th>Da</th><th>A</th><th>Fee</th></tr></thead><tbody>';
pairs.slice(0,50).forEach(function(p){
var srcTx=p.withdraw||p.deposit;
var dt=new Date(srcTx.tx_timestamp).toLocaleDateString('it-IT');
html+='<tr><td>'+dt+'</td><td><strong>'+p.coin+'</strong></td><td class="text-mono">'+fmtN(p.amount)+'</td>';
html+='<td style="color:var(--cyan)">'+formatExName(p.from)+'</td>';
html+='<td style="color:var(--green)">'+formatExName(p.to)+'</td>';
html+='<td class="text-mono" style="color:var(--red)">'+(p.fee>0?'-'+fmtN(p.fee):'-')+'</td></tr>';
});
if(pairs.length>50)html+='<tr><td colspan="6" style="text-align:center;color:var(--text2)">...e altri '+(pairs.length-50)+' trasferimenti</td></tr>';
html+='</tbody></table></div>';
}

// Warning withdraw non matchati
if(stats.unmatchedWithdraws>0){
html+='<div class="card mb-12" style="background:var(--yellow)10;border:1px solid var(--yellow)40">';
html+='<div style="font-size:13px;font-weight:600;color:var(--yellow);margin-bottom:8px">âš ï¸ '+stats.unmatchedWithdraws+' Withdraw Non Riconciliati</div>';
html+='<div style="font-size:11px;color:var(--text2)">Questi prelievi non hanno un deposito corrispondente. Potrebbero essere:<br>â€¢ Trasferimenti verso wallet non tracciati<br>â€¢ Vendite su exchange esterni<br>â€¢ TX wallet non sincronizzate</div></div>';
}

// Operazioni Earn
if(earnOps.length>0){
html+='<div class="card mb-12"><div style="font-size:13px;font-weight:600;margin-bottom:12px">ğŸ¦ Operazioni Earn/Staking (Non Tassabili)</div>';
html+='<div style="font-size:11px;color:var(--text2);margin-bottom:8px">Subscription/Redemption: movimenti interni Binance, non generano plusvalenze</div>';
var earnByCoin={};
earnOps.forEach(function(t){
if(!earnByCoin[t.coin])earnByCoin[t.coin]={sub:0,red:0,count:0};
earnByCoin[t.coin].count++;
var amt=parseFloat(t.amount)||0;
if(amt<0)earnByCoin[t.coin].sub+=Math.abs(amt);
else earnByCoin[t.coin].red+=amt;
});
html+='<table class="table" style="font-size:11px"><thead><tr><th>Coin</th><th class="text-right">Operazioni</th><th class="text-right">Tot. Subscription</th><th class="text-right">Tot. Redemption</th></tr></thead><tbody>';
Object.entries(earnByCoin).sort(function(a,b){return b[1].count-a[1].count;}).slice(0,20).forEach(function(e){
html+='<tr><td><strong>'+e[0]+'</strong></td><td class="text-right">'+e[1].count+'</td><td class="text-right text-mono" style="color:var(--red)">-'+fmtN(e[1].sub)+'</td><td class="text-right text-mono" style="color:var(--green)">+'+fmtN(e[1].red)+'</td></tr>';
});
html+='</tbody></table></div>';
}

document.getElementById('reconcileContent').innerHTML=html;
}

async function applyReconciliation(){
if(reconcileData.pairs.length===0&&reconcileData.earnOps.length===0){
toast('Nessuna riconciliazione da applicare','warning');
return;
}

toast('Applicazione riconciliazione...');

// Aggiorna le TX con il flag internal_transfer
var updates=[];

// Mark trasferimenti interni
reconcileData.pairs.forEach(function(p){
var cleanRemark=function(r){return(r||'').replace(/\s*\[RECONCILED[^\]]*\]/g,'').trim();};
if(p.withdraw)updates.push({id:p.withdraw.id,tx_type:'internal_transfer',remark:cleanRemark(p.withdraw.remark)+' [RECONCILEDâ†’'+p.to+']'});
if(p.deposit)updates.push({id:p.deposit.id,tx_type:'internal_transfer',remark:cleanRemark(p.deposit.remark)+' [RECONCILEDâ†'+p.from+']'});
});

// Mark operazioni Earn
reconcileData.earnOps.forEach(function(t){
if(t.tx_type!=='earn')updates.push({id:t.id,tx_type:'earn'});
});

console.log('Applying',updates.length,'updates');

var updated=0;
for(var i=0;i<updates.length;i++){
var u=updates[i];
var res=await db.from('exchange_transactions').update({tx_type:u.tx_type,remark:u.remark}).eq('id',u.id);
if(!res.error)updated++;
}

toast('âœ… Riconciliati '+updated+' record!');
closeModal('reconcileModal');
loadExchangeTx();
}
async function testAndSyncApi(){
var apiKey=document.getElementById('binanceApiKey').value.trim();
var apiSecret=document.getElementById('binanceApiSecret').value.trim();
var exchange=document.getElementById('apiExchange').value;
if(!apiKey||!apiSecret){showApiStatus('âŒ Inserisci API Key e Secret','error');return;}
document.getElementById('apiSyncBtn').disabled=true;
console.log('ğŸ”‘ API Key length:',apiKey.length,'Secret length:',apiSecret.length);

var edgeUrl=SB_URL+'/functions/v1/binance-proxy';
var MS90=90*24*3600000;var MS30=30*24*3600000;var TS2021=1609459200000;

// â”€â”€ Lista coin comuni su Binance (incluse delistate ma con storico trade) â”€â”€
var COMMON_COINS=['1INCH','AAVE','ACE','ACH','ADA','AEVO','AGLD','AI','AKRO','ALGO','ALPHA','AMB','ANKR','ANT','APE','API3','APT','AR','ARB','ARPA','ASTR','ATA','ATOM','AVAX','AXS','BAKE','BAL','BANANA','BAND','BAT','BCH','BICO','BLUR','BNB','BNX','BOND','BTC','BTT','CAKE','CATI','CELO','CELR','CFX','CHR','CHZ','CITY','CKB','CLV','COMP','COTI','CRV','CTK','CTXC','CYBER','DAR','DASH','DENT','DEXE','DGB','DOGE','DOT','DREP','DUSK','DYDX','EDU','EGLD','ELF','ENJ','ENS','EOS','ETC','ETH','ETHFI','EURI','EZ','FET','FIL','FIO','FLOKI','FLOW','FLM','FTM','FXS','GAL','GALA','GAS','GHST','GLM','GMT','GNO','GNS','GRT','GTC','HARD','HBAR','HFT','HIGH','HIVE','HMSTR','HOOK','HOT','ICP','ICX','ID','IDEX','ILV','IMX','INJ','IOST','IOTA','IOTX','JASMY','JOE','JUP','KAS','KAVA','KDA','KEY','KLAY','KNC','KSM','LAZIO','LDO','LEVER','LINA','LINK','LIT','LOOM','LPT','LQTY','LRC','LSK','LTC','LUNA','LUNC','MAGIC','MANA','MANTA','MASK','MATIC','MBOX','MC','MEME','METIS','MINA','MKR','MOVR','MTL','MULTI','NAS','NEAR','NEO','NFP','NKN','NMR','NOT','NTRN','OMG','OMNI','ONE','ONT','OP','ORDI','ORN','OXT','PEPE','PENDLE','PEOPLE','PERP','PHB','PIXEL','POLYX','POND','PORTAL','PYTH','QI','QKC','QNT','QTUM','QUICK','RAD','RDNT','REEF','REN','REQ','RLC','RONIN','ROSE','RSR','RUNE','RVN','SAND','SANTOS','SCRT','SCROLL','SEI','SFP','SHIB','SKL','SLP','SNX','SOL','SPELL','SSV','STEEM','STG','STMX','STO','STORJ','STRAX','STX','SUI','SUN','SUPER','SUSHI','SXP','SYS','THETA','TIA','TLM','TOKEN','TON','TRB','TRIBE','TRU','TRUMP','TRX','TVK','UMA','UNI','UNFI','USDC','UTK','VET','VITE','VOXEL','VTHO','W','WAXP','WIF','WIN','WLD','WOO','WRX','XAI','XEM','XLM','XMR','XNO','XRP','XTZ','XVG','XVS','YFI','YGG','ZEC','ZEN','ZIL','ZRX'];

// â”€â”€ Proxy: 1 call = 1 signed Binance request â”€â”€
async function binP(ep,p){
var r=await fetch(edgeUrl,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+SB_KEY},body:JSON.stringify({apiKey:apiKey,apiSecret:apiSecret,endpoint:ep,params:p||{}})});
if(!r.ok){var t='';try{t=await r.text();}catch(x){}throw new Error(r.status+':'+t);}
return r.json();}

function toA(d){if(!d)return[];if(Array.isArray(d))return d;if(d.rows&&Array.isArray(d.rows))return d.rows;if(d.data&&Array.isArray(d.data))return d.data;if(d.list&&Array.isArray(d.list))return d.list;if(d.userAssetDribblets&&Array.isArray(d.userAssetDribblets))return d.userAssetDribblets;return[];}

// â”€â”€ Fetch con finestre temporali â”€â”€
async function fetchW(ep,p,wMs,lbl,from){var a=[];var s=from||TS2021;var n=Date.now();var tot=Math.ceil((n-s)/wMs);var i=0;
while(s<n){i++;if(i%5===1)showApiStatus(lbl+' ['+i+'/'+tot+']','info');var e=Math.min(s+wMs,n);
try{a=a.concat(toA(await binP(ep,Object.assign({},p,{startTime:s,endTime:e}))));}catch(x){}s=e+1;}return a;}

// â”€â”€ Fetch con finestre + pagine â”€â”€
async function fetchWP(ep,p,wMs,pSz,lbl,from){var a=[];var s=from||TS2021;var n=Date.now();var tot=Math.ceil((n-s)/wMs);var i=0;
while(s<n){i++;if(i%5===1)showApiStatus(lbl+' ['+i+'/'+tot+']','info');var e=Math.min(s+wMs,n);
var pg=1;while(pg<=20){try{var d=toA(await binP(ep,Object.assign({},p,{startTime:s,endTime:e,current:pg,size:pSz})));
a=a.concat(d);if(d.length<pSz)break;pg++;}catch(x){break;}}s=e+1;}return a;}

var allData={};var stepLog=[];
var pBtn=document.getElementById('apiSyncBtn');

try{
// â•â•â• 1. TEST CONNESSIONE â•â•â•
showApiStatus('ğŸ”— Test connessione...','info');pBtn.textContent='ğŸ”„ 5%';
var acct=await binP('/api/v3/account',{});
allData.balances=(acct.balances||[]).filter(function(b){return parseFloat(b.free)>0||parseFloat(b.locked)>0;});
stepLog.push('âœ… Connesso ('+allData.balances.length+' coin con saldo)');

// â•â•â• 2. SNAPSHOTS â•â•â•
showApiStatus('ğŸ“Š Snapshots annuali...','info');pBtn.textContent='ğŸ”„ 8%';
allData.snapshots={};
for(var yr=2021;yr<=2025;yr++){try{var sd=await binP('/sapi/v1/accountSnapshot',{type:'SPOT',startTime:new Date(yr+'-12-25').getTime(),endTime:new Date((yr+1)+'-01-02').getTime(),limit:7});
if(sd.snapshotVos&&sd.snapshotVos.length>0){var sn=sd.snapshotVos[sd.snapshotVos.length-1];var sb=(sn.data.balances||[]).filter(function(b){return parseFloat(b.free)>0||parseFloat(b.locked)>0;});
if(sb.length>0)allData.snapshots[yr]={date:new Date(sn.updateTime).toISOString(),balances:sb};}}catch(x){}}
stepLog.push('ğŸ“Š Snapshots: '+Object.keys(allData.snapshots).length+' anni');

// â•â•â• 3. DEPOSITS â•â•â•
pBtn.textContent='ğŸ”„ 12%';
allData.deposits=await fetchW('/sapi/v1/capital/deposit/hisrec',{status:1},MS90,'ğŸ“¥ Depositi');
stepLog.push('ğŸ“¥ Depositi: '+allData.deposits.length);

// â•â•â• 4. WITHDRAWS â•â•â•
pBtn.textContent='ğŸ”„ 18%';
allData.withdraws=await fetchW('/sapi/v1/capital/withdraw/history',{status:6},MS90,'ğŸ“¤ Prelievi');
stepLog.push('ğŸ“¤ Prelievi: '+allData.withdraws.length);

// â•â•â• 5. FIAT PAYMENTS â•â•â•
showApiStatus('ğŸ’³ Acquisti/Vendite EUR...','info');pBtn.textContent='ğŸ”„ 22%';
try{allData.fiatBuys=toA(await binP('/sapi/v1/fiat/payments',{transactionType:'0',rows:500})).filter(function(f){return f.status==='Completed'||f.status==='Successful';});}catch(x){allData.fiatBuys=[];}
try{allData.fiatSells=toA(await binP('/sapi/v1/fiat/payments',{transactionType:'1',rows:500})).filter(function(f){return f.status==='Completed'||f.status==='Successful';});}catch(x){allData.fiatSells=[];}
stepLog.push('ğŸ’³ Fiat Pay: '+allData.fiatBuys.length+' buy / '+allData.fiatSells.length+' sell');

// â•â•â• 6. TRADES â•â•â•
pBtn.textContent='ğŸ”„ 25%';
// Costruisci lista COMPLETA di coin da controllare
var coinSet={};
allData.balances.forEach(function(b){coinSet[b.asset]=1;});
allData.deposits.forEach(function(d){coinSet[d.coin]=1;});
allData.withdraws.forEach(function(w){coinSet[w.coin]=1;});
// Aggiungi coin dagli snapshot annuali
Object.values(allData.snapshots).forEach(function(s){(s.balances||[]).forEach(function(b){coinSet[b.asset]=1;});});
// Aggiungi TUTTE le coin comuni
COMMON_COINS.forEach(function(c){coinSet[c]=1;});
// Rimuovi stablecoin/fiat
['EUR','USD','USDT','USDC','BUSD','FDUSD','DAI','TUSD','EURI'].forEach(function(c){delete coinSet[c];});
var cl=Object.keys(coinSet);
console.log('ğŸ“ˆ Trades: checking '+cl.length+' coins');

var tQs=['USDT','EUR','BUSD','BTC','BNB','FDUSD'];
allData.trades=[];var trFound=0;
for(var ci=0;ci<cl.length;ci++){
if(ci%10===0){showApiStatus('ğŸ“ˆ Trades: '+cl[ci]+' ['+(ci+1)+'/'+cl.length+'] (trovati: '+allData.trades.length+')','info');
pBtn.textContent='ğŸ”„ '+(25+Math.round(ci/cl.length*30))+'%';}
for(var qi=0;qi<tQs.length;qi++){
if(cl[ci]===tQs[qi])continue;var sym=cl[ci]+tQs[qi];var st=TS2021;
while(st<Date.now()){try{var tr=await binP('/api/v3/myTrades',{symbol:sym,startTime:st,limit:1000});
if(!Array.isArray(tr)||tr.length===0)break;
tr.forEach(function(t){t.baseAsset=cl[ci];t.quoteAsset=tQs[qi];});
allData.trades=allData.trades.concat(tr);if(tr.length<1000)break;st=tr[tr.length-1].time+1;
}catch(x){break;}}}}
stepLog.push('ğŸ“ˆ Trades: '+allData.trades.length+' (da '+cl.length+' coin)');
console.log('ğŸ“ˆ Trades totali:',allData.trades.length);

// â•â•â• 7. CONVERSIONS â•â•â•
pBtn.textContent='ğŸ”„ 58%';
allData.conversions=await fetchW('/sapi/v1/convert/tradeFlow',{},MS30,'ğŸ”„ Conversioni');
stepLog.push('ğŸ”„ Conversioni: '+allData.conversions.length);

// â•â•â• 8. EARN REWARDS (Simple Earn, DAL 2021!) â•â•â•
pBtn.textContent='ğŸ”„ 62%';
allData.earnRewards=[];allData.earnSubscriptions=[];allData.earnRedemptions=[];
// Cerca DAL 2021 - Binance ha migrato i vecchi dati
var eEps=['/sapi/v1/simple-earn/flexible/history/rewardsRecord','/sapi/v1/simple-earn/locked/history/rewardsRecord'];
var eTs=['REALTIME','BONUS','REWARDS'];
for(var ei=0;ei<eEps.length;ei++){for(var et=0;et<eTs.length;et++){
var el=(ei===0?'Flex':'Lock')+' '+eTs[et];
try{var er=await fetchWP(eEps[ei],{type:eTs[et]},MS30,100,'ğŸ’° '+el,TS2021);
allData.earnRewards=allData.earnRewards.concat(er);console.log(el+':',er.length);}catch(x){}}}
// Subscriptions/Redemptions
try{allData.earnSubscriptions=await fetchWP('/sapi/v1/simple-earn/flexible/history/subscriptionRecord',{},MS30,100,'ğŸ’° Flex Subs',TS2021);}catch(x){}
try{var fr=await fetchWP('/sapi/v1/simple-earn/flexible/history/redemptionRecord',{},MS30,100,'ğŸ’° Flex Reds',TS2021);allData.earnRedemptions=fr;}catch(x){}
try{var ls=await fetchWP('/sapi/v1/simple-earn/locked/history/subscriptionRecord',{},MS30,100,'ğŸ’° Lock Subs',TS2021);allData.earnSubscriptions=allData.earnSubscriptions.concat(ls);}catch(x){}
try{var lr=await fetchWP('/sapi/v1/simple-earn/locked/history/redemptionRecord',{},MS30,100,'ğŸ’° Lock Reds',TS2021);allData.earnRedemptions=allData.earnRedemptions.concat(lr);}catch(x){}
stepLog.push('ğŸ’° Earn: '+allData.earnRewards.length+' rewards, '+allData.earnSubscriptions.length+' subs, '+allData.earnRedemptions.length+' reds');

// â•â•â• 9. OLD SAVINGS (Lending 2021-2022) â•â•â•
pBtn.textContent='ğŸ”„ 80%';
allData.oldEarnRewards=[];
var lTs=['DAILY','ACTIVITY','CUSTOMIZED_FIXED'];
for(var li=0;li<lTs.length;li++){try{
var lr=await fetchW('/sapi/v1/lending/union/interestHistory',{lendingType:lTs[li],size:100},MS30,'ğŸ’° Old '+lTs[li]);
allData.oldEarnRewards=allData.oldEarnRewards.concat(lr);console.log('Old '+lTs[li]+':',lr.length);}catch(x){console.log('Old '+lTs[li]+': endpoint non disponibile');}}
stepLog.push('ğŸ’° Old Savings: '+allData.oldEarnRewards.length);

// â•â•â• 10. STAKING â•â•â•
pBtn.textContent='ğŸ”„ 86%';
allData.stakingRewards=[];
// Prova endpoint staking (deprecato ma potrebbe funzionare)
var sPs=['STAKING','F_DEFI','L_DEFI'];
for(var si=0;si<sPs.length;si++){try{var sp=0;
while(sp<100){showApiStatus('ğŸ¥© '+sPs[si]+' [page '+(sp+1)+']','info');
var sr=toA(await binP('/sapi/v1/staking/stakingRecord',{product:sPs[si],txnType:'INTEREST',current:sp,size:100}));
allData.stakingRewards=allData.stakingRewards.concat(sr);if(sr.length<100)break;sp++;}
console.log('Staking '+sPs[si]+':',allData.stakingRewards.length);}catch(x){console.log('Staking '+sPs[si]+': non disponibile ('+x.message+')');}}
stepLog.push('ğŸ¥© Staking: '+allData.stakingRewards.length);

// â•â•â• 11. DIVIDENDS â•â•â•
pBtn.textContent='ğŸ”„ 92%';
allData.dividends=await fetchW('/sapi/v1/asset/assetDividend',{limit:500},MS90,'ğŸ Dividends');
stepLog.push('ğŸ Dividends: '+allData.dividends.length);

// â•â•â• 12. FIAT ORDERS â•â•â•
showApiStatus('ğŸ’¶ Bonifici...','info');pBtn.textContent='ğŸ”„ 96%';
try{allData.fiatDeposits=toA(await binP('/sapi/v1/fiat/orders',{transactionType:'0',rows:500})).filter(function(f){return f.status==='Successful';});}catch(x){allData.fiatDeposits=[];}
try{allData.fiatWithdraws=toA(await binP('/sapi/v1/fiat/orders',{transactionType:'1',rows:500})).filter(function(f){return f.status==='Successful';});}catch(x){allData.fiatWithdraws=[];}
stepLog.push('ğŸ’¶ Fiat: '+allData.fiatDeposits.length+' dep / '+allData.fiatWithdraws.length+' with');

// â•â•â• 13. DUST â•â•â•
showApiStatus('ğŸ§¹ Dust...','info');pBtn.textContent='ğŸ”„ 100%';
try{allData.dustLog=toA(await binP('/sapi/v1/asset/dribblet',{}));}catch(x){allData.dustLog=[];}
stepLog.push('ğŸ§¹ Dust: '+allData.dustLog.length);

// â•â•â• 14. ETH STAKING â•â•â•
showApiStatus('ğŸ”· ETH Staking...','info');
allData.ethStaking=[];
try{allData.ethStaking=await fetchWP('/sapi/v1/eth-staking/eth/history/rewardsHistory',{},MS30,100,'ğŸ”· ETH Staking',TS2021);
}catch(x){console.log('ETH Staking: non disponibile');}
if(allData.ethStaking.length>0)stepLog.push('ğŸ”· ETH Staking: '+allData.ethStaking.length);

// â•â•â• 15. UNIVERSAL TRANSFER (Spotâ†”Earnâ†”Funding) â•â•â•
showApiStatus('â†”ï¸ Transfers...','info');
allData.transfers=[];
var transferTypes=['MAIN_UMFUTURE','MAIN_CMFUTURE','MAIN_MARGIN','MAIN_MINING','MAIN_FUNDING','FUNDING_MAIN','FUNDING_UMFUTURE','MAIN_OPTION'];
for(var ti=0;ti<transferTypes.length;ti++){try{
var tf=await fetchWP('/sapi/v1/asset/transfer',{type:transferTypes[ti]},MS30,100,'â†”ï¸ '+transferTypes[ti],TS2021);
tf.forEach(function(t){t.transferType=transferTypes[ti];});
allData.transfers=allData.transfers.concat(tf);
}catch(x){}}
if(allData.transfers.length>0)stepLog.push('â†”ï¸ Transfers: '+allData.transfers.length);

// â•â•â• 16. OLD LENDING PURCHASE/REDEEM â•â•â•
showApiStatus('ğŸ“¦ Old Lending...','info');
allData.oldLendPurchase=[];allData.oldLendRedeem=[];
try{allData.oldLendPurchase=await fetchW('/sapi/v1/lending/union/purchaseRecord',{},MS30,'ğŸ“¦ Old Purchase',TS2021);
}catch(x){console.log('Old lending purchase: non disponibile');}
try{allData.oldLendRedeem=await fetchW('/sapi/v1/lending/union/redemptionRecord',{},MS30,'ğŸ“¦ Old Redeem',TS2021);
}catch(x){console.log('Old lending redeem: non disponibile');}
if(allData.oldLendPurchase.length>0)stepLog.push('ğŸ“¦ Old Purchase: '+allData.oldLendPurchase.length);
if(allData.oldLendRedeem.length>0)stepLog.push('ğŸ“¦ Old Redeem: '+allData.oldLendRedeem.length);

// â•â•â• 17. BINANCE PAY â•â•â•
showApiStatus('ğŸ’³ Binance Pay...','info');
allData.payTx=[];
try{var payRes=await binP('/sapi/v1/pay/transactions',{limit:100});
allData.payTx=toA(payRes);}catch(x){console.log('Pay: non disponibile');}
if(allData.payTx.length>0)stepLog.push('ğŸ’³ Pay: '+allData.payTx.length);

// â•â•â• 18. REBATE (Cashback/Commission) â•â•â•
showApiStatus('ğŸ’¸ Rebate...','info');
allData.rebate=[];
try{var rebRes=await binP('/sapi/v1/rebate/taxQuery',{});
allData.rebate=toA(rebRes);}catch(x){console.log('Rebate: non disponibile');}
if(allData.rebate.length>0)stepLog.push('ğŸ’¸ Rebate: '+allData.rebate.length);

// â•â•â• 19. C2C / P2P â•â•â•
showApiStatus('ğŸ¤ P2P...','info');
allData.c2c=[];
try{var c2cBuy=toA(await binP('/sapi/v1/c2c/orderMatch/listUserOrderHistory',{tradeType:'BUY',rows:100}));
var c2cSell=toA(await binP('/sapi/v1/c2c/orderMatch/listUserOrderHistory',{tradeType:'SELL',rows:100}));
allData.c2c=c2cBuy.concat(c2cSell);}catch(x){console.log('C2C: non disponibile');}
if(allData.c2c.length>0)stepLog.push('ğŸ¤ C2C/P2P: '+allData.c2c.length);

// â•â•â• 20. MINING â•â•â•
showApiStatus('â›ï¸ Mining...','info');
allData.mining=[];
try{var mineRes=await binP('/sapi/v1/mining/payment/list',{algo:'sha256',userName:'_'});
allData.mining=toA(mineRes);}catch(x){console.log('Mining: non disponibile');}
if(allData.mining.length>0)stepLog.push('â›ï¸ Mining: '+allData.mining.length);

// â•â•â• 21. LOAN INCOME â•â•â•
showApiStatus('ğŸ¦ Loans...','info');
allData.loans=[];
try{allData.loans=toA(await binP('/sapi/v1/loan/income',{limit:100}));
}catch(x){console.log('Loans: non disponibile');}
if(allData.loans.length>0)stepLog.push('ğŸ¦ Loans: '+allData.loans.length);

// â•â•â• 22. NFT â•â•â•
allData.nft=[];
try{var nftBuy=toA(await binP('/sapi/v1/nft/history/transactions',{orderType:0,limit:50}));
var nftSell=toA(await binP('/sapi/v1/nft/history/transactions',{orderType:1,limit:50}));
allData.nft=nftBuy.concat(nftSell);}catch(x){}
if(allData.nft.length>0)stepLog.push('ğŸ–¼ï¸ NFT: '+allData.nft.length);

// â•â•â• 23. BSWAP (Liquid Swap) â•â•â•
allData.bswap=[];
try{allData.bswap=toA(await binP('/sapi/v1/bswap/liquidityOps',{limit:100}));
}catch(x){console.log('BSwap: non disponibile');}
if(allData.bswap.length>0)stepLog.push('ğŸŒŠ BSwap: '+allData.bswap.length);

// â•â•â• LOG DIAGNOSTICO NUOVI ENDPOINT â•â•â•
console.log('=== NUOVI ENDPOINT RISULTATI ===');
console.log('ETH Staking:',allData.ethStaking.length);
console.log('Universal Transfers:',allData.transfers.length);
console.log('Old Lending Purchase:',allData.oldLendPurchase.length);
console.log('Old Lending Redeem:',allData.oldLendRedeem.length);
console.log('Pay:',allData.payTx.length);
console.log('Rebate:',allData.rebate.length);
console.log('C2C/P2P:',allData.c2c.length);
console.log('Mining:',allData.mining.length);
console.log('Loans:',allData.loans.length);
console.log('NFT:',allData.nft.length);
console.log('BSwap:',allData.bswap.length);
if(allData.ethStaking.length>0)console.log('ETH Staking sample:',JSON.stringify(allData.ethStaking.slice(0,2)));
if(allData.transfers.length>0)console.log('Transfer sample:',JSON.stringify(allData.transfers.slice(0,3)));
if(allData.oldLendPurchase.length>0)console.log('Old Purchase sample:',JSON.stringify(allData.oldLendPurchase.slice(0,2)));
if(allData.payTx.length>0)console.log('Pay sample:',JSON.stringify(allData.payTx.slice(0,2)));
if(allData.rebate.length>0)console.log('Rebate sample:',JSON.stringify(allData.rebate.slice(0,2)));
if(allData.c2c.length>0)console.log('C2C sample:',JSON.stringify(allData.c2c.slice(0,2)));
if(allData.loans.length>0)console.log('Loans sample:',JSON.stringify(allData.loans.slice(0,2)));
if(allData.bswap.length>0)console.log('BSwap sample:',JSON.stringify(allData.bswap.slice(0,2)));

// SALVA CHIAVI API
localStorage.setItem('binance_api_key',apiKey);
localStorage.setItem('binance_api_secret',apiSecret);
console.log('âœ… API Keys salvate in localStorage');

// SALVA SNAPSHOTS per Quadro RW
if(allData.snapshots&&Object.keys(allData.snapshots).length>0){
localStorage.setItem('binance_snapshots',JSON.stringify(allData.snapshots));
console.log('ğŸ“Š Snapshots salvati:',Object.keys(allData.snapshots));
var snapYears=Object.keys(allData.snapshots);
var snapInfo=snapYears.map(function(y){return y+': '+allData.snapshots[y].balances.length+' asset';}).join(', ');
stepLog.push('ğŸ“Š Snapshots: '+snapInfo);
}

// LOG BILANCI ATTUALI
if(allData.balances&&allData.balances.length>0){
console.log('ğŸ’° Saldi attuali Binance:');
allData.balances.forEach(function(b){
console.log('  '+b.asset+': free='+b.free+' locked='+b.locked);
});
}

// PROCESSA TRANSAZIONI
var allTx=[];

// DEPOSITS
(allData.deposits||[]).forEach(function(d){
var ts=new Date(d.insertTime);
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Deposit',account:'Spot',coin:d.coin,amount:parseFloat(d.amount),tx_type:'deposit',asset_type:classifyAsset(d.coin),remark:d.txId||''});
});

// WITHDRAWS
(allData.withdraws||[]).forEach(function(w){
var ts=new Date(w.completeTime||w.applyTime);
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Withdraw',account:'Spot',coin:w.coin,amount:-parseFloat(w.amount),tx_type:'withdraw',asset_type:classifyAsset(w.coin),remark:w.txId||''});
});

// FIAT PAYMENTS (Acquisti/Vendite crypto con EUR) - NUOVO!
(allData.fiatBuys||[]).forEach(function(f){
var ts=new Date(parseInt(f.createTime));
var crypto=f.cryptoCurrency||f.asset||'';
var fiat=f.fiatCurrency||'EUR';
var cryptoAmt=parseFloat(f.obtainAmount||f.cryptoAmount||0);
var fiatAmt=parseFloat(f.sourceAmount||f.fiatAmount||f.totalFee||0);
if(cryptoAmt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Buy Crypto',account:'Spot',coin:crypto,amount:cryptoAmt,tx_type:'trade_buy',asset_type:classifyAsset(crypto),remark:'Buy with '+fiat+' ('+fiatAmt+')',price_eur:fiatAmt/cryptoAmt,value_eur:fiatAmt,needs_price:false});
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(parseInt(f.createTime)+1).toISOString(),tax_year:ts.getFullYear(),operation:'Buy Crypto',account:'Spot',coin:fiat,amount:-fiatAmt,tx_type:'trade_sell',asset_type:'FIAT',remark:'Buy '+crypto,needs_price:false});
}});

(allData.fiatSells||[]).forEach(function(f){
var ts=new Date(parseInt(f.createTime));
var crypto=f.cryptoCurrency||f.asset||'';
var fiat=f.fiatCurrency||'EUR';
var cryptoAmt=parseFloat(f.sourceAmount||f.cryptoAmount||0);
var fiatAmt=parseFloat(f.obtainAmount||f.fiatAmount||0);
if(cryptoAmt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Sell Crypto',account:'Spot',coin:crypto,amount:-cryptoAmt,tx_type:'trade_sell',asset_type:classifyAsset(crypto),remark:'Sell for '+fiat+' ('+fiatAmt+')',price_eur:fiatAmt/cryptoAmt,value_eur:fiatAmt,needs_price:false});
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(parseInt(f.createTime)+1).toISOString(),tax_year:ts.getFullYear(),operation:'Sell Crypto',account:'Spot',coin:fiat,amount:fiatAmt,tx_type:'trade_buy',asset_type:'FIAT',remark:'Sell '+crypto,needs_price:false});
}});

// SPOT TRADES (myTrades) - NUOVO!
(allData.trades||[]).forEach(function(t){
var ts=new Date(t.time);
var isBuyer=t.isBuyer;
var sym=t.symbol||'';
// Determina base/quote dal symbol (es. BTCUSDT â†’ BTC + USDT)
var base=t.baseAsset||'';
var quote=t.quoteAsset||'';
var qty=parseFloat(t.qty||0);
var quoteQty=parseFloat(t.quoteQty||0);
var price=parseFloat(t.price||0);
var commission=parseFloat(t.commission||0);
var commAsset=t.commissionAsset||'';
if(qty>0){
// Operazione sulla base asset
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Spot Trade',account:'Spot',coin:base,amount:isBuyer?qty:-qty,tx_type:isBuyer?'trade_buy':'trade_sell',asset_type:classifyAsset(base),pair:sym,remark:'Trade '+sym+' @ '+price});
// Operazione sulla quote asset (inversa)
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(t.time+1).toISOString(),tax_year:ts.getFullYear(),operation:'Spot Trade',account:'Spot',coin:quote,amount:isBuyer?-quoteQty:quoteQty,tx_type:isBuyer?'trade_sell':'trade_buy',asset_type:classifyAsset(quote),pair:sym,remark:'Trade '+sym+' @ '+price});
// Fee
if(commission>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(t.time+2).toISOString(),tax_year:ts.getFullYear(),operation:'Trading Fee',account:'Spot',coin:commAsset,amount:-commission,tx_type:'fee',asset_type:classifyAsset(commAsset),remark:'Fee on '+sym});
}}});

// CONVERSIONS (Binance Convert)
(allData.conversions||[]).forEach(function(c){
var ts=new Date(parseInt(c.createTime));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Binance Convert',account:'Spot',coin:c.fromAsset,amount:-parseFloat(c.fromAmount),tx_type:'trade_sell',asset_type:classifyAsset(c.fromAsset),remark:'Convert '+c.fromAsset+' â†’ '+c.toAsset});
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(parseInt(c.createTime)+1).toISOString(),tax_year:ts.getFullYear(),operation:'Binance Convert',account:'Spot',coin:c.toAsset,amount:parseFloat(c.toAmount),tx_type:'trade_buy',asset_type:classifyAsset(c.toAsset),remark:'Convert '+c.fromAsset+' â†’ '+c.toAsset});
});

// EARN SUBSCRIPTIONS
(allData.earnSubscriptions||[]).forEach(function(e){
var ts=new Date(parseInt(e.time));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Simple Earn Flexible Subscription',account:'Spot',coin:e.asset,amount:-parseFloat(e.amount),tx_type:'earn_sub',asset_type:classifyAsset(e.asset),remark:'Earn Subscription'});
});

// EARN REDEMPTIONS
(allData.earnRedemptions||[]).forEach(function(e){
var ts=new Date(parseInt(e.time));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Simple Earn Flexible Redemption',account:'Spot',coin:e.asset,amount:parseFloat(e.amount),tx_type:'earn_red',asset_type:classifyAsset(e.asset),remark:'Earn Redemption'});
});

// EARN REWARDS (interessi Simple Earn 2023+)
(allData.earnRewards||[]).forEach(function(e){
var ts=new Date(parseInt(e.time));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Simple Earn Interest',account:'Spot',coin:e.asset,amount:parseFloat(e.rewards),tx_type:'reward',asset_type:classifyAsset(e.asset),remark:'Earn Interest'});
});

// OLD EARN REWARDS (Savings/Lending 2021-2022)
(allData.oldEarnRewards||[]).forEach(function(e){
var ts=new Date(e.time||e.createTime);
var coin=e.asset||e.productName||'';
var amt=parseFloat(e.interest||e.amount||e.reward||0);
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Savings Interest',account:'Spot',coin:coin,amount:amt,tx_type:'reward',asset_type:classifyAsset(coin),remark:'Old Savings'});
}});

// DIVIDENDS
(allData.dividends||[]).forEach(function(d){
var ts=new Date(parseInt(d.divTime));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Distribution',account:'Spot',coin:d.asset,amount:parseFloat(d.amount),tx_type:'reward',asset_type:classifyAsset(d.asset),remark:d.enInfo||'Dividend'});
});

// STAKING REWARDS (old Binance Staking)
(allData.stakingRewards||[]).forEach(function(s){
var ts=new Date(parseInt(s.time||s.updateTime||s.datetime));
var coin=s.asset||s.positionAsset||'';
var amt=parseFloat(s.reward||s.amount||0);
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Staking Reward',account:'Spot',coin:coin,amount:amt,tx_type:'reward',asset_type:classifyAsset(coin),remark:'Staking'});
}});

// FIAT DEPOSITS
(allData.fiatDeposits||[]).forEach(function(f){
var ts=new Date(parseInt(f.createTime));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Fiat Deposit',account:'Spot',coin:f.fiatCurrency,amount:parseFloat(f.amount),tx_type:'deposit',asset_type:'FIAT',remark:'Fiat deposit'});
});

// FIAT WITHDRAWS
(allData.fiatWithdraws||[]).forEach(function(f){
var ts=new Date(parseInt(f.createTime));
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Fiat Withdraw',account:'Spot',coin:f.fiatCurrency,amount:-parseFloat(f.amount),tx_type:'withdraw',asset_type:'FIAT',remark:'Fiat withdraw'});
});

// DUST LOG
(allData.dustLog||[]).forEach(function(d){
var ts=new Date(parseInt(d.operateTime));
(d.userAssetDribbletDetails||[]).forEach(function(det){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Small Assets Exchange BNB',account:'Spot',coin:det.fromAsset,amount:-parseFloat(det.amount),tx_type:'trade_sell',asset_type:classifyAsset(det.fromAsset),remark:'Dust to BNB'});
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(parseInt(d.operateTime)+1).toISOString(),tax_year:ts.getFullYear(),operation:'Small Assets Exchange BNB',account:'Spot',coin:'BNB',amount:parseFloat(det.transferedAmount),tx_type:'trade_buy',asset_type:'CRYPTO',remark:'Dust to BNB'});
});
});

// ETH STAKING REWARDS
(allData.ethStaking||[]).forEach(function(s){
var ts=new Date(parseInt(s.time||s.updateTime||Date.now()));
var amt=parseFloat(s.reward||s.amount||s.holding||0);
if(amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'ETH Staking Reward',account:'Spot',coin:'ETH',amount:amt,tx_type:'reward',asset_type:'CRYPTO',remark:'ETH 2.0 Staking'});
}});

// OLD LENDING PURCHASE (Spotâ†’Earn)
(allData.oldLendPurchase||[]).forEach(function(p){
var ts=new Date(parseInt(p.createTime||p.purchaseTime||Date.now()));
var coin=p.asset||p.productName||'';
var amt=parseFloat(p.amount||p.lot||0);
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Savings Subscription',account:'Spot',coin:coin,amount:-amt,tx_type:'earn_sub',asset_type:classifyAsset(coin),remark:'Old Savings Purchase'});
}});

// OLD LENDING REDEEM (Earnâ†’Spot)
(allData.oldLendRedeem||[]).forEach(function(r){
var ts=new Date(parseInt(r.createTime||r.redemptionTime||Date.now()));
var coin=r.asset||r.projectName||'';
var amt=parseFloat(r.amount||r.principal||0);
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Savings Redemption',account:'Spot',coin:coin,amount:amt,tx_type:'earn_red',asset_type:classifyAsset(coin),remark:'Old Savings Redemption'});
}});

// BINANCE PAY
(allData.payTx||[]).forEach(function(p){
var ts=new Date(parseInt(p.transactionTime||p.createTime||Date.now()));
var coin=p.currency||p.asset||'';
var amt=parseFloat(p.amount||0);
var typ=p.transactionType||'';
if(coin&&amt!==0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Binance Pay '+typ,account:'Spot',coin:coin,amount:amt,tx_type:amt>0?'deposit':'withdraw',asset_type:classifyAsset(coin),remark:'Binance Pay'});
}});

// REBATE/CASHBACK
(allData.rebate||[]).forEach(function(r){
var ts=new Date(parseInt(r.time||r.updateTime||Date.now()));
var coin=r.asset||'BNB';
var amt=parseFloat(r.amount||r.income||0);
if(amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Commission Rebate',account:'Spot',coin:coin,amount:amt,tx_type:'reward',asset_type:classifyAsset(coin),remark:'Rebate'});
}});

// C2C/P2P
(allData.c2c||[]).forEach(function(c){
var ts=new Date(parseInt(c.createTime||Date.now()));
var coin=c.asset||c.fiatUnit||'';
var amt=parseFloat(c.amount||0);
var isBuy=c.tradeType==='BUY';
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'P2P '+(isBuy?'Buy':'Sell'),account:'Spot',coin:coin,amount:isBuy?amt:-amt,tx_type:isBuy?'trade_buy':'trade_sell',asset_type:classifyAsset(coin),remark:'C2C/P2P'});
}});

// LOANS
(allData.loans||[]).forEach(function(l){
var ts=new Date(parseInt(l.time||l.timestamp||Date.now()));
var coin=l.asset||'';
var amt=parseFloat(l.amount||l.income||0);
if(coin&&amt!==0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Loan '+l.type,account:'Spot',coin:coin,amount:amt,tx_type:amt>0?'deposit':'withdraw',asset_type:classifyAsset(coin),remark:'Crypto Loan'});
}});

// BSWAP (Liquid Swap)
(allData.bswap||[]).forEach(function(b){
var ts=new Date(parseInt(b.operateTime||b.updateTime||Date.now()));
var coin=b.poolName||'';
var amt=parseFloat(b.shareAmount||b.amount||0);
var op=b.operation||'';
if(coin&&amt>0){
allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:ts.toISOString(),tax_year:ts.getFullYear(),operation:'Liquid Swap '+op,account:'Spot',coin:coin,amount:op==='REMOVE'?amt:-amt,tx_type:op==='ADD'?'earn_sub':'earn_red',asset_type:classifyAsset(coin),remark:'BSwap'});
}});

console.log('API TX totali:',allTx.length);

// SOMMARIO
var summaryHtml='<div style="font-size:11px;line-height:1.8">'+stepLog.join('<br>')+'</div>';
summaryHtml+='<div style="margin-top:8px;font-weight:600">ğŸ“¦ Totale: '+allTx.length+' transazioni</div>';

if(allTx.length>0){
summaryHtml+='<div style="color:var(--text2);margin-top:4px">ğŸ”„ Salvataggio in corso...</div>';
showApiStatus(summaryHtml,'success');
var inserted=0;
for(var i=0;i<allTx.length;i+=100){
var batch=allTx.slice(i,i+100);
try{
var res2=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation',ignoreDuplicates:true});
if(!res2.error)inserted+=batch.length;
}catch(e){console.error('Batch error:',e);}
}
showApiStatus(summaryHtml.replace('Salvataggio in corso...','âœ… '+inserted+' TX salvate!'),'success');
toast('âœ… API Binance: '+inserted+' TX + '+Object.keys(allData.snapshots||{}).length+' snapshots!');
}else{
showApiStatus(summaryHtml,'success');
if(allData.snapshots&&Object.keys(allData.snapshots).length>0){
toast('ğŸ“Š Snapshots salvati! Apri Quadro RW per i saldi reali.');
}else{
toast('Connesso ma nessuna TX trovata.');
}
}

setTimeout(function(){closeModal('apiModal');loadExchangeTx();},3000);

}catch(e){
console.error('API Error:',e);
if(e.message.includes('FunctionNotFound')||e.message.includes('404')||e.message.includes('TypeError')){
showApiStatus('âš ï¸ Edge Function non deployata. Devi deployare binance-proxy v3!<br><a href="#" onclick="showEdgeFunctionHelp();return false;" style="color:var(--primary)">â†’ Come deployare</a>','warning');
}else{
showApiStatus('âŒ '+e.message,'error');
}}
document.getElementById('apiSyncBtn').disabled=false;
document.getElementById('apiSyncBtn').textContent='ğŸš€ Connetti e Sincronizza';
}
function showEdgeFunctionHelp(){alert('COME DEPLOYARE LA EDGE FUNCTION:\\n\\n1. Installa Supabase CLI:\\n   npm install -g supabase\\n\\n2. Login:\\n   supabase login\\n\\n3. Link al progetto:\\n   supabase link --project-ref TUO_PROJECT_REF\\n\\n4. Crea la funzione:\\n   supabase functions new binance-proxy\\n\\n5. Copia il file supabase_edge_function_binance.ts\\n\\n6. Deploy:\\n   supabase functions deploy binance-proxy\\n\\nScarica il file dalla chat!');}
function updateApiHelp(){var ex=document.getElementById('apiExchange').value;var helps={binance:'<strong>ğŸ“‹ Come ottenere le API Binance:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.binance.com/it/my/settings/api-management" target="_blank" style="color:var(--primary)">Binance API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo "Read" (nessun permesso di trading!)</li><li>Copia API Key e Secret qui sotto</li></ol>',kucoin:'<strong>ğŸ“‹ Come ottenere le API KuCoin:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.kucoin.com/account/api" target="_blank" style="color:var(--primary)">KuCoin API Management</a></li><li>Crea una nuova API</li><li>Imposta permessi "General" e "Trade" in sola lettura</li></ol>',bybit:'<strong>ğŸ“‹ Come ottenere le API Bybit:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.bybit.com/app/user/api-management" target="_blank" style="color:var(--primary)">Bybit API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo permessi di lettura</li></ol>'};document.getElementById('apiHelp').innerHTML=helps[ex]||helps.binance;}
var currentExchange='';var exDetailPage=1;var exDetailTxs=[];
var EX_LOGOS={binance:'https://assets.coingecko.com/markets/images/52/small/binance.jpg',bitget:'https://s2.coinmarketcap.com/static/img/exchanges/64x64/513.png',bitpanda:'https://cdn.bitpanda.com/media/redesign/favicon/favicon-32x32.png',bybit:'https://assets.coingecko.com/markets/images/698/small/bybit_spot.png',bybit_eu:'https://assets.coingecko.com/markets/images/698/small/bybit_spot.png',coinbase:'https://assets.coingecko.com/markets/images/23/small/Coinbase_Coin_Primary.png',crypto_com:'https://assets.coingecko.com/markets/images/589/small/crypto_com.jpg',crypto_com_ex:'https://assets.coingecko.com/markets/images/589/small/crypto_com.jpg',gate:'https://assets.coingecko.com/markets/images/60/small/gate_io_logo1.jpg',kraken:'https://assets.coingecko.com/markets/images/29/small/kraken.jpg',kucoin:'https://assets.coingecko.com/markets/images/61/small/kucoin.png',mexc:'https://assets.coingecko.com/markets/images/409/small/MEXC.png',nexo:'https://assets.coingecko.com/coins/images/3695/small/nexo.png',okx:'https://assets.coingecko.com/markets/images/96/small/WeChat_Image_20220117220452.png',pionex:'https://s2.coinmarketcap.com/static/img/exchanges/64x64/542.png',revolut:'https://assets.coingecko.com/markets/images/1285/small/Revolut.jpeg',whitebit:'https://assets.coingecko.com/markets/images/418/small/whitebit.png',youhodler:'https://assets.coingecko.com/markets/images/1136/small/youhodler.jpeg',youngplatform:'https://s2.coinmarketcap.com/static/img/exchanges/64x64/607.png',other:'https://assets.coingecko.com/coins/images/1/small/bitcoin.png'};
var EX_COLORS={binance:'#f3ba2f',bitget:'#00f0ff',bitpanda:'#3d9970',bybit:'#f7a600',bybit_eu:'#f7a600',coinbase:'#0052ff',crypto_com:'#002d74',crypto_com_ex:'#002d74',gate:'#17e5c1',kraken:'#5741d9',kucoin:'#23af91',mexc:'#1972f5',nexo:'#4f97f7',okx:'#000',pionex:'#0093d5',revolut:'#0075eb',whitebit:'#02c076',youhodler:'#4361ee',youngplatform:'#00d09c',other:'#888'};
var EX_NAMES={binance:'Binance',bitget:'Bitget',bitpanda:'Bitpanda',bybit:'Bybit',bybit_eu:'Bybit EU',coinbase:'Coinbase',crypto_com:'Crypto.com App',crypto_com_ex:'Crypto.com Exchange',gate:'Gate.io',kraken:'Kraken',kucoin:'KuCoin',mexc:'MEXC',nexo:'Nexo',okx:'OKX',pionex:'Pionex',revolut:'Revolut',whitebit:'WhiteBIT',youhodler:'YouHodler',youngplatform:'Young Platform',other:'Altro'};
function formatExName(ex){return EX_NAMES[ex]||ex.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();});}
var STABLES=['EUR','USD','USDT','USDC','BUSD','DAI','TUSD'];
async function loadExchangeTx(){var allTx=[];var page=0;var pageSize=1000;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).range(page*pageSize,(page+1)*pageSize-1);var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===pageSize;page++;if(page>50)break;}console.log('Loaded TX:',allTx.length,'('+page+' pages)');

// OPERAZIONI INTERNE DA ESCLUDERE DAI TOTALI â‚¬
var INTERNAL_OPS=['earn_sub','earn_red','earn_move','transfer','internal_transfer','liquidity'];
var EARN_KEYWORDS=['subscription','redemption','savings','locked','flexible','launchpool subscription','vault','staking purchase','staking redemption','pos savings','auto-invest','transfer between'];

function isInternalOp(t){
var type=t.tx_type||'';
var op=(t.operation||'').toLowerCase();
var remark=(t.remark||'').toLowerCase();
// Escludi operazioni Earn/Staking e trasferimenti interni
if(INTERNAL_OPS.includes(type))return true;
for(var i=0;i<EARN_KEYWORDS.length;i++){
if(op.includes(EARN_KEYWORDS[i])||remark.includes(EARN_KEYWORDS[i]))return true;
}
// Escludi trasferimenti tra account (Spotâ†”Fundingâ†”Margin)
if(op.includes('transfer')&&(op.includes('spot')||op.includes('funding')||op.includes('margin')||op.includes('main')))return true;
return false;
}

var byYear={2021:{tx:0,types:{}},2022:{tx:0,types:{}},2023:{tx:0,types:{}},2024:{tx:0,types:{}},2025:{tx:0,types:{}},2026:{tx:0,types:{}}};var byExchange={};
allTx.forEach(function(t){var y=t.tax_year||2021;var type=t.tx_type||'other';var coin=t.coin||'';var amt=parseFloat(t.amount)||0;var isFiat=FIAT_COINS.includes(coin);

if(byYear[y]){
byYear[y].tx++;
byYear[y].types[type]=(byYear[y].types[type]||0)+1;
}

if(!byExchange[t.exchange])byExchange[t.exchange]={count:0,coins:new Set(),years:new Set(),types:{},byYear:{}};
byExchange[t.exchange].count++;byExchange[t.exchange].coins.add(coin);byExchange[t.exchange].years.add(y);
byExchange[t.exchange].types[type]=(byExchange[t.exchange].types[type]||0)+1;

if(!byExchange[t.exchange].byYear[y])byExchange[t.exchange].byYear[y]={tx:0,types:{}};
byExchange[t.exchange].byYear[y].tx++;
byExchange[t.exchange].byYear[y].types[type]=(byExchange[t.exchange].byYear[y].types[type]||0)+1;
});

// Render anno cards
var typeLabels={deposit:'ğŸ“¥',withdraw:'ğŸ“¤',trade_buy:'ğŸ›’',trade_sell:'ğŸ’°',fee:'ğŸ’¸',convert:'ğŸ”„',dust:'ğŸ§¹',reward:'ğŸ',earn_sub:'â¬‡ï¸',earn_red:'â¬†ï¸',earn_move:'â†•ï¸',fiat_buy:'ğŸ’³',fiat_deposit:'ğŸ’¶',card_spend:'ğŸ§',transfer:'â†”ï¸',liquidity:'ğŸŒŠ',payment:'ğŸª',send:'ğŸ“¨',other_in:'â“',other_out:'â“'};
for(var y=2021;y<=2026;y++){var el=document.getElementById('exYear'+y);if(el){var d=byYear[y];
var html='<div style="font-size:16px;font-weight:700;color:var(--cyan)">'+d.tx+' TX</div>';
el.innerHTML=html;}}

// Render tabella exchange
var html='';if(Object.keys(byExchange).length===0){html='<div class="card" style="grid-column:1/-1;padding:40px;text-align:center;color:var(--text2)">Nessun exchange. Clicca "Import CSV" per importare dati.</div>';}else{Object.entries(byExchange).forEach(function(e){var ex=e[0];var data=e[1];var color=EX_COLORS[ex]||'#888';var logo=EX_LOGOS[ex]||EX_LOGOS.other;
html+='<div class="card" style="grid-column:1/-1"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;cursor:pointer" onclick="openExchangeDetail(\''+ex+'\')"><div style="width:48px;height:48px;border-radius:12px;background:'+color+'20;display:flex;align-items:center;justify-content:center;overflow:hidden"><img src="'+logo+'" style="width:36px;height:36px;border-radius:8px" onerror="this.style.display=\'none\';var p=this.parentElement;if(p)p.innerHTML=\'ğŸ¦\';"></div><div style="flex:1"><div style="font-size:18px;font-weight:700">'+formatExName(ex)+'</div><div style="font-size:12px;color:var(--text2)">'+data.count+' TX totali â€¢ '+data.coins.size+' coin</div></div><button onclick="event.stopPropagation();openExchangeDetail(\''+ex+'\')" class="btn btn-sm btn-secondary">Dettagli â†’</button></div>';

html+='<div style="overflow-x:auto"><table class="table" style="font-size:12px;margin:0"><thead><tr><th>Anno</th><th class="text-right">TX</th><th class="text-right">ğŸ“¥ Dep</th><th class="text-right">ğŸ“¤ With</th><th class="text-right">ğŸ›’ Buy</th><th class="text-right">ğŸ’° Sell</th><th class="text-right">ğŸ”„ Conv</th><th class="text-right">ğŸ Reward</th><th class="text-right">â†•ï¸ Earn</th><th class="text-right">ğŸ’¸ Fee</th></tr></thead><tbody>';
var years=[2021,2022,2023,2024,2025,2026];
function gT(types,keys){var s=0;keys.forEach(function(k){s+=(types[k]||0);});return s;}
years.forEach(function(y){if(data.byYear[y]&&data.byYear[y].tx>0){var tp=data.byYear[y].types;
var dep=gT(tp,['deposit','fiat_deposit']);var wit=gT(tp,['withdraw']);var buy=gT(tp,['trade_buy','fiat_buy']);var sell=gT(tp,['trade_sell']);var conv=gT(tp,['convert','dust']);var rew=gT(tp,['reward']);var earn=gT(tp,['earn_sub','earn_red','earn_move']);var fee=gT(tp,['fee']);
html+='<tr style="cursor:pointer" onclick="openExchangeDetail(\''+ex+'\');setTimeout(function(){document.getElementById(\'exDetailYear\').value=\''+y+'\';loadExchangeDetail();},100)"><td><strong>'+y+'</strong></td><td class="text-right text-mono" style="color:var(--cyan)">'+data.byYear[y].tx+'</td><td class="text-right text-mono" style="color:var(--green)">'+(dep||'â€“')+'</td><td class="text-right text-mono" style="color:var(--red)">'+(wit||'â€“')+'</td><td class="text-right text-mono" style="color:var(--green)">'+(buy||'â€“')+'</td><td class="text-right text-mono" style="color:var(--red)">'+(sell||'â€“')+'</td><td class="text-right text-mono" style="color:var(--blue)">'+(conv||'â€“')+'</td><td class="text-right text-mono" style="color:var(--yellow)">'+(rew||'â€“')+'</td><td class="text-right text-mono" style="color:var(--cyan)">'+(earn||'â€“')+'</td><td class="text-right text-mono" style="color:var(--text2)">'+(fee||'â€“')+'</td></tr>';}});
var tp=data.types;var dep=gT(tp,['deposit','fiat_deposit']);var wit=gT(tp,['withdraw']);var buy=gT(tp,['trade_buy','fiat_buy']);var sell=gT(tp,['trade_sell']);var conv=gT(tp,['convert','dust']);var rew=gT(tp,['reward']);var earn=gT(tp,['earn_sub','earn_red','earn_move']);var fee=gT(tp,['fee']);
html+='<tr style="background:var(--bg2);font-weight:700"><td>TOTALE</td><td class="text-right text-mono" style="color:var(--cyan)">'+data.count+'</td><td class="text-right text-mono" style="color:var(--green)">'+dep+'</td><td class="text-right text-mono" style="color:var(--red)">'+wit+'</td><td class="text-right text-mono" style="color:var(--green)">'+buy+'</td><td class="text-right text-mono" style="color:var(--red)">'+sell+'</td><td class="text-right text-mono" style="color:var(--blue)">'+conv+'</td><td class="text-right text-mono" style="color:var(--yellow)">'+rew+'</td><td class="text-right text-mono" style="color:var(--cyan)">'+earn+'</td><td class="text-right text-mono" style="color:var(--text2)">'+fee+'</td></tr>';
html+='</tbody></table></div></div>';});}document.getElementById('exExchangeGrid').innerHTML=html;}
function openExchangeDetail(ex){currentExchange=ex;exDetailPage=1;exDetailTxs=[];var color=EX_COLORS[ex]||'#888';var logo=EX_LOGOS[ex]||EX_LOGOS.other;document.getElementById('exDetailName').innerHTML='<div class="flex items-center gap-12"><img src="'+logo+'" style="width:32px;height:32px;border-radius:8px" onerror="this.style.display=\'none\'"><span>'+formatExName(ex)+'</span></div>';document.getElementById('exDetailYear').value='';document.getElementById('exDetailType').value='';document.getElementById('exDetailSearch').value='';document.getElementById('page-exchange').style.display='none';document.getElementById('page-exchange-detail').style.display='block';loadExchangeDetail();}
async function resetCurrentExchange(){if(!currentExchange)return;if(!confirm('Sicuro di cancellare tutti i dati di '+currentExchange+'?'))return;try{await db.from('exchange_transactions').delete().eq('user_id',user.id).eq('exchange',currentExchange);toast('âœ… Dati '+currentExchange+' cancellati!');showPage('exchange');}catch(e){toast('âŒ Errore: '+e.message,'error');}}
async function loadExchangeDetail(){if(!currentExchange)return;exDetailPage=1;var yearFilter=document.getElementById('exDetailYear').value;var typeFilter=document.getElementById('exDetailType').value;var searchFilter=(document.getElementById('exDetailSearch').value||'').toLowerCase();
var allTx=[];var page=0;var hasMore=true;while(hasMore){var query=db.from('exchange_transactions').select('*').eq('user_id',user.id).eq('exchange',currentExchange).order('tx_timestamp',{ascending:false}).range(page*1000,(page+1)*1000-1);if(yearFilter)query=query.eq('tax_year',parseInt(yearFilter));if(typeFilter)query=query.eq('tx_type',typeFilter);var res=await query;var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===1000;page++;if(page>10)break;}
var txs=allTx;if(searchFilter)txs=txs.filter(function(t){return(t.coin||'').toLowerCase().includes(searchFilter)||(t.operation||'').toLowerCase().includes(searchFilter);});
var txs=allTx;if(searchFilter)txs=txs.filter(function(t){return(t.coin||'').toLowerCase().includes(searchFilter)||(t.operation||'').toLowerCase().includes(searchFilter)||(t.tx_type||'').toLowerCase().includes(searchFilter);});
var coins=new Set();var byType={};
txs.forEach(function(t){coins.add(t.coin);var tp=t.tx_type||'other';byType[tp]=(byType[tp]||0)+1;});
var catIcons={deposit:'ğŸ“¥',withdraw:'ğŸ“¤',trade_buy:'ğŸ›’',trade_sell:'ğŸ’°',fee:'ğŸ’¸',convert:'ğŸ”„',dust:'ğŸ§¹',reward:'ğŸ',earn_sub:'â¬‡ï¸',earn_red:'â¬†ï¸',earn_move:'â†•ï¸',fiat_buy:'ğŸ’³',fiat_deposit:'ğŸ’¶',card_spend:'ğŸ’³',transfer:'â†”ï¸',liquidity:'ğŸŒŠ',payment:'ğŸª',send:'ğŸ“¨',internal_transfer:'ğŸ”—',earn:'ğŸ¦',other_in:'â“',other_out:'â“'};
var statsHtml='<div class="stat"><div class="stat-label">Totale TX</div><div class="stat-value" style="color:var(--cyan)">'+txs.length+'</div></div>';
statsHtml+='<div class="stat"><div class="stat-label">Coin</div><div class="stat-value">'+coins.size+'</div></div>';
var typOrder=['deposit','withdraw','trade_buy','trade_sell','fee','convert','dust','reward','earn_sub','earn_red','earn_move','fiat_buy','fiat_deposit','card_spend','transfer','liquidity','payment','send','internal_transfer','earn','other_in','other_out'];
typOrder.forEach(function(tp){if(byType[tp]){statsHtml+='<div class="stat" style="cursor:pointer" onclick="document.getElementById(\'exDetailType\').value=\''+tp+'\';loadExchangeDetail()"><div class="stat-label">'+(catIcons[tp]||'')+' '+tp+'</div><div class="stat-value" style="font-size:14px">'+byType[tp]+'</div></div>';}});
document.getElementById('exDetailStats').innerHTML=statsHtml;
exDetailTxs=txs;renderExDetailPage();}
function renderExDetailPage(){var txs=exDetailTxs;var pageSize=100;var totalPages=Math.ceil(txs.length/pageSize);if(exDetailPage>totalPages)exDetailPage=totalPages;if(exDetailPage<1)exDetailPage=1;var start=(exDetailPage-1)*pageSize;var end=start+pageSize;var pageTxs=txs.slice(start,end);
if(txs.length===0){document.getElementById('exDetailList').innerHTML='<div style="padding:40px;text-align:center;color:var(--text2)">Nessuna transazione</div>';return;}
var typeIcons={deposit:'ğŸ“¥',withdraw:'ğŸ“¤',trade_buy:'ğŸ›’',trade_sell:'ğŸ’°',fee:'ğŸ’¸',convert:'ğŸ”„',dust:'ğŸ§¹',reward:'ğŸ',earn_sub:'â¬‡ï¸',earn_red:'â¬†ï¸',earn_move:'â†•ï¸',fiat_buy:'ğŸ’³',fiat_deposit:'ğŸ’¶',card_spend:'ğŸ’³',transfer:'â†”ï¸',liquidity:'ğŸŒŠ',payment:'ğŸª',send:'ğŸ“¨',internal_transfer:'ğŸ”—',earn:'ğŸ¦',other_in:'â“',other_out:'â“',other:'â€¢'};var typeColors={deposit:'var(--green)',withdraw:'var(--red)',trade_buy:'var(--green)',trade_sell:'var(--red)',fee:'var(--red)',convert:'var(--blue)',dust:'var(--text2)',reward:'var(--yellow)',earn_sub:'var(--cyan)',earn_red:'var(--cyan)',earn_move:'var(--cyan)',fiat_buy:'var(--green)',fiat_deposit:'var(--green)',card_spend:'var(--red)',transfer:'var(--cyan)',liquidity:'var(--purple)',payment:'var(--purple)',send:'var(--purple)',internal_transfer:'#00b4d8',earn:'#f7971e',other_in:'var(--text2)',other_out:'var(--text2)',other:'var(--text2)'};
var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">';
html+='<div style="font-size:12px;color:var(--text2)">Totale: <strong>'+txs.length+'</strong> TX | Pagina '+exDetailPage+' di '+totalPages+'</div>';
html+='<div style="display:flex;gap:4px;align-items:center">';
html+='<button onclick="exDetailGoPage(1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===1?'disabled':'')+'>â®</button>';
html+='<button onclick="exDetailGoPage(exDetailPage-1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===1?'disabled':'')+'>â—€</button>';
var startP=Math.max(1,exDetailPage-2);var endP=Math.min(totalPages,startP+4);if(endP-startP<4)startP=Math.max(1,endP-4);
for(var p=startP;p<=endP;p++){html+='<button onclick="exDetailGoPage('+p+')" class="btn btn-sm '+(p===exDetailPage?'btn-primary':'btn-secondary')+'" style="padding:4px 10px;min-width:32px">'+p+'</button>';}
html+='<button onclick="exDetailGoPage(exDetailPage+1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===totalPages?'disabled':'')+'>â–¶</button>';
html+='<button onclick="exDetailGoPage('+totalPages+')" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===totalPages?'disabled':'')+'>â­</button>';
html+='</div></div>';
pageTxs.forEach(function(t){var d=new Date(t.tx_timestamp);var dateStr=d.toLocaleDateString('it-IT')+' '+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});var amt=parseFloat(t.amount);var amtStr=formatAmount(amt,t.coin);var amtColor=amt>=0?'var(--green)':'var(--red)';var icon=typeIcons[t.tx_type]||'â€¢';var opColor=typeColors[t.tx_type]||'var(--text2)';var typeName=t.tx_type||'other';
html+='<div style="display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:12px">';
var coinLower=t.coin.toLowerCase();var iconUrl='https://assets.coincap.io/assets/icons/'+coinLower+'@2x.png';
html+='<div style="position:relative;width:36px;height:36px;flex-shrink:0"><img src="'+iconUrl+'" style="width:36px;height:36px;border-radius:50%" onerror="this.style.display=\'none\';var n=this.nextElementSibling;if(n)n.style.display=\'flex\';"><div style="display:none;width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff">'+t.coin.slice(0,3)+'</div><div style="position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;border-radius:50%;background:'+opColor+';display:flex;align-items:center;justify-content:center;font-size:9px;border:2px solid var(--bg)">'+icon+'</div></div>';
var reconBadge='';if(typeName==='internal_transfer')reconBadge=' <span style="font-size:9px;padding:1px 4px;border-radius:3px;background:#00b4d820;color:#00b4d8;font-weight:700">RICONCILIATO</span>';else if(typeName==='earn'&&(t.remark||'').includes('[RECONCILED'))reconBadge=' <span style="font-size:9px;padding:1px 4px;border-radius:3px;background:#f7971e20;color:#f7971e;font-weight:700">EARN</span>';
html+='<div style="flex:1;min-width:0;overflow:hidden"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div style="font-weight:600;white-space:nowrap">'+t.coin+' <span style="font-size:10px;padding:1px 5px;border-radius:4px;background:'+opColor+'20;color:'+opColor+'">'+typeName+'</span>'+reconBadge+'</div><div class="text-mono" style="color:'+amtColor+';font-weight:600;white-space:nowrap;font-size:13px">'+amtStr+'</div></div>';
var priceStr=t.price_eur?'@â‚¬'+fmtN(t.price_eur):'';var valueStr=t.value_eur?'<span style="color:var(--cyan);font-weight:600">â‚¬'+fmtN(t.value_eur)+'</span>':'';
var remarkStr=t.remark?'<span style="color:var(--text2)"> Â· '+t.remark.substring(0,60)+'</span>':'';
html+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-top:2px;gap:8px"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">'+t.operation+(priceStr?' '+priceStr:'')+remarkStr+'</div><div style="white-space:nowrap;flex-shrink:0">'+valueStr+(valueStr?' Â· ':'')+dateStr+'</div></div></div></div>';});
html+='<div style="display:flex;justify-content:center;margin-top:12px;gap:4px">';
html+='<button onclick="exDetailGoPage(exDetailPage-1)" class="btn btn-secondary" style="padding:8px 16px" '+(exDetailPage===1?'disabled':'')+'>â—€ Precedente</button>';
html+='<button onclick="exDetailGoPage(exDetailPage+1)" class="btn btn-secondary" style="padding:8px 16px" '+(exDetailPage===totalPages?'disabled':'')+'>Successiva â–¶</button>';
html+='</div>';
document.getElementById('exDetailList').innerHTML=html;}
function exDetailGoPage(p){var totalPages=Math.ceil(exDetailTxs.length/100);if(p<1)p=1;if(p>totalPages)p=totalPages;exDetailPage=p;renderExDetailPage();document.getElementById('exDetailList').scrollTop=0;}
function toggleYearDetail(year){var el=document.getElementById('yearDetail'+year);el.style.display=el.style.display==='none'?'block':'none';}
async function importCSV(){var files=document.getElementById('importFile').files;if(!files.length){toast('Seleziona file CSV o ZIP','error');return;}var exchange=document.getElementById('importExchange').value;document.getElementById('importProgress').style.display='block';document.getElementById('importBtn').disabled=true;var totalImported=0;var totalParsed=0;var totalErrors=0;var csvTexts=[];
for(var f=0;f<files.length;f++){var file=files[f];document.getElementById('importStatus').textContent='ğŸ“„ Lettura '+file.name+'...';if(file.name.endsWith('.zip')){try{var zip=await JSZip.loadAsync(file);var csvFiles=Object.keys(zip.files).filter(function(n){return (n.endsWith('.csv')||n.endsWith('.xlsx')||n.endsWith('.xls'))&&!n.startsWith('__MACOSX')&&!n.includes('/.DS_')&&!n.includes('SUMMARY.csv')&&!n.includes('Trade Details')&&!n.includes('Order-Splitting')&&!n.includes('Asset Snapshots')&&!n.includes('Positions')&&!n.includes('for-cointrack');});console.log('File trovati nel ZIP:',csvFiles);for(var c=0;c<csvFiles.length;c++){if(csvFiles[c].endsWith('.xlsx')||csvFiles[c].endsWith('.xls')){var xlsxData=await zip.files[csvFiles[c]].async('arraybuffer');var wb=XLSX.read(xlsxData,{type:'array'});var ws=wb.Sheets[wb.SheetNames[0]];
if(ws['!ref']&&ws['A1']){var ref=ws['!ref'];var match=ref.match(/^([A-Z]+)(\d+):([A-Z]+)(\d+)$/);if(match&&parseInt(match[2])>1){ws['!ref']=match[1]+'1:'+match[3]+match[4];console.log('Fixed ZIP XLSX range:',ref,'->',ws['!ref']);}}
var csvContent=XLSX.utils.sheet_to_csv(ws);csvTexts.push({name:csvFiles[c],text:csvContent});console.log('Letto XLSX:',csvFiles[c],'righe:',csvContent.split('\n').length);}else{var csvContent=await zip.files[csvFiles[c]].async('string');csvTexts.push({name:csvFiles[c],text:csvContent});console.log('Letto:',csvFiles[c],'righe:',csvContent.split('\n').length);}}}catch(e){console.error('ZIP error:',e);toast('Errore ZIP: '+e.message,'error');}}else if(file.name.endsWith('.xlsx')||file.name.endsWith('.xls')){var data=await file.arrayBuffer();var wb=XLSX.read(data,{type:'array'});var ws=wb.Sheets[wb.SheetNames[0]];
// Fix per MEXC: il range potrebbe non includere la riga 1 (header)
if(ws['!ref']&&ws['A1']){var ref=ws['!ref'];var match=ref.match(/^([A-Z]+)(\d+):([A-Z]+)(\d+)$/);if(match&&parseInt(match[2])>1){ws['!ref']=match[1]+'1:'+match[3]+match[4];console.log('Fixed XLSX range:',ref,'->',ws['!ref']);}}
var text=XLSX.utils.sheet_to_csv(ws);csvTexts.push({name:file.name,text:text});console.log('Letto XLSX:',file.name,'righe:',text.split('\n').length);}else{var text=await file.text();csvTexts.push({name:file.name,text:text});}}
console.log('Totale file CSV:',csvTexts.length);document.getElementById('importStatus').textContent='ğŸ“Š Elaborazione '+csvTexts.length+' file...';
for(var i=0;i<csvTexts.length;i++){var csv=csvTexts[i];var cleanText=csv.text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');var lines=cleanText.split('\n');var toInsert=[];
var headerLine='';var dataStartLine=1;
for(var h=0;h<Math.min(10,lines.length);h++){var lineH=lines[h]||'';if(lineH.includes('Timestamp')&&lineH.includes('Transaction')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('User_ID')&&lineH.includes('UTC_Time')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date')&&lineH.includes('Type')&&lineH.includes('Asset')&&lineH.includes('Chain')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date & Time')&&lineH.includes('Coin')&&lineH.includes('QTY')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Currency')&&lineH.includes('Cash Flow')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Spot Pairs')&&lineH.includes('Direction')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('order')&&lineH.includes('Date')&&lineH.includes('Coin')&&lineH.includes('Type')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Transaction ID')&&lineH.includes('Amount Asset')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Timestamp (UTC)')&&lineH.includes('Transaction Description')&&lineH.includes('Transaction Kind')){headerLine=lineH;dataStartLine=h+1;if(lines[h+1]&&lines[h+1].startsWith('---'))dataStartLine=h+2;break;}if(lineH.includes('Ora')&&lineH.includes('Criptovaluta')&&lineH.includes('Tipo')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('event_time_display')&&lineH.includes('instrument_name')&&lineH.includes('journal_type')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date')&&lineH.includes('Received Amount')&&lineH.includes('Sent Amount')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Order ID')&&lineH.includes('Order Time')&&lineH.includes('Side')&&lineH.includes('Filled Amount')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('UID')&&lineH.includes('Symbol')&&lineH.includes('Side')&&lineH.includes('Filled Amount')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('UID')&&lineH.includes('Coin')&&lineH.includes('Amount')&&lineH.includes('Hash')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('UID')&&lineH.includes('Currency')&&lineH.includes('Side')&&lineH.includes('Remark')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date & Time')&&lineH.includes('Transaction ID')&&lineH.includes('Type')&&lineH.includes('Currency')&&lineH.includes('Direction')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('date(UTC')&&lineH.includes('executed_qty')&&lineH.includes('side')&&lineH.includes('symbol')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('date(UTC')&&lineH.includes('tx_type')&&lineH.includes('coin')&&lineH.includes('network')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Symbol')&&lineH.includes('Type')&&lineH.includes('Quantity')&&lineH.includes('Price')&&lineH.includes('Value')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('UID')&&lineH.includes('Coppie')&&lineH.includes('Direzione')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('UID')&&lineH.includes('Pairs')&&lineH.includes('Direction')&&lineH.includes('Executed Qty')){headerLine=lineH;dataStartLine=h+1;break;}}
if(!headerLine)headerLine=lines[0]||'';
console.log('CSV Header:',headerLine,'dataStart:',dataStartLine);
var isBinance=headerLine.includes('User_ID')&&headerLine.includes('UTC_Time');var isCoinbase=headerLine.includes('Transaction Type')&&headerLine.includes('Asset')&&headerLine.includes('Quantity');var isKraken=headerLine.includes('txid')&&headerLine.includes('refid');
var isBybitDeposit=headerLine.includes('Date')&&headerLine.includes('Type')&&headerLine.includes('Asset')&&headerLine.includes('Chain');var isBybitFund=headerLine.includes('Date & Time')&&headerLine.includes('Coin')&&headerLine.includes('QTY');var isBybitUta=headerLine.includes('Currency')&&headerLine.includes('Cash Flow')&&headerLine.includes('Wallet Balance');var isBybitSpot=headerLine.includes('Spot Pairs')&&headerLine.includes('Direction')&&headerLine.includes('Filled');
var isBitget=headerLine.includes('order')&&headerLine.includes('Date')&&headerLine.includes('Coin')&&headerLine.includes('Type')&&headerLine.includes('Amount');
var isBitpanda=headerLine.includes('Transaction ID')&&headerLine.includes('Amount Asset');
var isCryptoCom=headerLine.includes('Timestamp (UTC)')&&headerLine.includes('Transaction Description')&&headerLine.includes('Transaction Kind');
var isCryptoComExDeposit=headerLine.includes('Ora')&&headerLine.includes('Criptovaluta')&&headerLine.includes('Tipo');
var isCryptoComExJournal=headerLine.includes('event_time_display')&&headerLine.includes('instrument_name')&&headerLine.includes('journal_type');
var isOkipo=headerLine.includes('Date')&&headerLine.includes('Received Amount')&&headerLine.includes('Sent Amount');
var isOkxOfficial=headerLine.includes('Order ID')&&headerLine.includes('Order Time')&&headerLine.includes('Side')&&headerLine.includes('Filled Amount')&&!headerLine.includes('UID');
var isKucoinSpot=headerLine.includes('UID')&&headerLine.includes('Symbol')&&headerLine.includes('Side')&&headerLine.includes('Filled Amount');
var isKucoinDeposit=headerLine.includes('UID')&&headerLine.includes('Coin')&&headerLine.includes('Amount')&&headerLine.includes('Hash');
var isKucoinAccount=headerLine.includes('UID')&&headerLine.includes('Currency')&&headerLine.includes('Side')&&headerLine.includes('Remark');
var isYouHodler=headerLine.includes('Date & Time')&&headerLine.includes('Transaction ID')&&headerLine.includes('Type')&&headerLine.includes('Currency')&&headerLine.includes('Direction');
var isPionexTrading=headerLine.includes('date(UTC')&&headerLine.includes('executed_qty')&&headerLine.includes('side')&&headerLine.includes('symbol');
var isPionexDeposit=headerLine.includes('date(UTC')&&headerLine.includes('tx_type')&&headerLine.includes('coin')&&headerLine.includes('network');
var isRevolut=headerLine.includes('Symbol')&&headerLine.includes('Type')&&headerLine.includes('Quantity')&&headerLine.includes('Price')&&headerLine.includes('Value');
var isTatax=headerLine.includes('Symbol')&&headerLine.includes('MovementType')&&headerLine.includes('Quantity')&&headerLine.includes('Countervalue');
var isBybit=isBybitDeposit||isBybitFund||isBybitUta||isBybitSpot;
var isGate=headerLine.includes('action_desc')&&headerLine.includes('action_data')&&headerLine.includes('change_amount');
var isTerra=headerLine.includes('timestamp')&&headerLine.includes('tx_type')&&headerLine.includes('received_amount')&&headerLine.includes('sent_amount')&&headerLine.includes('received_currency');
var isYoungLedger=headerLine.includes('credit')&&headerLine.includes('debit')&&headerLine.includes('currency')&&headerLine.includes('tx_type');
var isYoungTrades=headerLine.includes('base')&&headerLine.includes('quote')&&headerLine.includes('brokerage')&&headerLine.includes('side');
var isYoung=isYoungLedger||isYoungTrades;
var isNexo=headerLine.includes('Transaction')&&headerLine.includes('Input Currency')&&headerLine.includes('Output Currency')&&headerLine.includes('USD Equivalent');
var isMexcIt=headerLine.includes('UID')&&headerLine.includes('Coppie')&&headerLine.includes('Direzione');
var isMexcEn=headerLine.includes('UID')&&headerLine.includes('Pairs')&&headerLine.includes('Direction')&&headerLine.includes('Executed Qty');
var isMexc=isMexcIt||isMexcEn;
console.log('Format - Binance:',isBinance,'Tatax:',isTatax,'Coinbase:',isCoinbase,'Bybit:',isBybit,'Bitget:',isBitget,'Bitpanda:',isBitpanda,'CryptoCom:',isCryptoCom,'CryptoComEx:',isCryptoComExDeposit||isCryptoComExJournal,'OKX:',isOkipo||isOkxOfficial,'KuCoin:',isKucoinSpot||isKucoinDeposit||isKucoinAccount,'YouHodler:',isYouHodler,'Pionex:',isPionexTrading||isPionexDeposit,'Revolut:',isRevolut,'Gate:',isGate,'Terra:',isTerra,'Young:',isYoung,'Nexo:',isNexo,'MEXC:',isMexc,'dataStart:',dataStartLine);

// === NEXO: Parser dedicato ===
if(isNexo){
var nexoTxs=[];
for(var nx=dataStartLine;nx<lines.length;nx++){
var nLine=lines[nx].trim();if(!nLine)continue;
var nCols=parseCSVLine(nLine);
// Transaction,Type,Input Currency,Input Amount,Output Currency,Output Amount,USD Equivalent,Fee,Fee Currency,Details,Date / Time (UTC)
if(nCols.length<11)continue;
var nTxId=(nCols[0]||'').trim();
var nType=(nCols[1]||'').trim();
var nInCoin=(nCols[2]||'').trim().toUpperCase();
var nInAmt=parseFloat(nCols[3]||0);
var nOutCoin=(nCols[4]||'').trim().toUpperCase();
var nOutAmt=parseFloat(nCols[5]||0);
var nFee=parseFloat(nCols[7]||0);
var nFeeCoin=(nCols[8]||'').trim().toUpperCase();
var nDetails=(nCols[9]||'').replace(/"/g,'').trim();
var nTime=(nCols[10]||'').trim();
if(!nTime)continue;
var nTimestamp=nTime.replace(' ','T')+'Z';
var nYear=parseInt(nTime.slice(0,4));
if(isNaN(nYear)||nYear<2010||nYear>2030)continue;
var nTypeLower=nType.toLowerCase();
var txType='other';var coin='';var amount=0;
// Classifica per tipo
if(nTypeLower.includes('interest')||nTypeLower.includes('cashback')){
txType='reward';coin=nOutCoin||nInCoin;amount=nOutAmt||Math.abs(nInAmt);
}else if(nTypeLower.includes('withdrawal')||nTypeLower==='transfer out'||nTypeLower==='withdraw exchanged'){
txType='withdraw';coin=nInCoin;amount=nInAmt<0?nInAmt:-Math.abs(nInAmt);
}else if(nTypeLower.includes('deposit')||nTypeLower==='top up crypto'||nTypeLower==='transfer in'){
txType='deposit';coin=nInCoin||nOutCoin;amount=Math.abs(nInAmt)||nOutAmt;
}else if(nTypeLower.includes('exchange')||nTypeLower.includes('sell order')){
// Exchange: input esce, output entra
if(nInAmt!==0&&nInCoin){
nexoTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:nTimestamp,tax_year:nYear,operation:nType,account:'Nexo',coin:nInCoin,amount:nInAmt<0?nInAmt:-Math.abs(nInAmt),remark:nDetails,tx_type:'trade_sell',asset_type:classifyAsset(nInCoin)});
}
if(nOutAmt>0&&nOutCoin){
nexoTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:nTimestamp+'1',tax_year:nYear,operation:nType,account:'Nexo',coin:nOutCoin,amount:nOutAmt,remark:nDetails,tx_type:'trade_buy',asset_type:classifyAsset(nOutCoin)});
}
continue;
}else if(nTypeLower.includes('card purchase')||nTypeLower.includes('card transaction fee')){
txType='payment';coin=nInCoin;amount=nInAmt<0?nInAmt:-Math.abs(nInAmt);
}else if(nTypeLower.includes('repayment')||nTypeLower.includes('liquidation')){
txType='other_out';coin=nInCoin||nOutCoin;amount=nInAmt!==0?nInAmt:nOutAmt;
}else if(nTypeLower.includes('assimilation')||nTypeLower.includes('credit')){
txType='other_in';coin=nOutCoin||nInCoin;amount=nOutAmt||nInAmt;
}else{
coin=nOutCoin||nInCoin;amount=nOutAmt||nInAmt;
txType=amount>=0?'other_in':'other_out';
}
if(!coin||coin==='-')continue;
nexoTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:nTimestamp,tax_year:nYear,operation:nType,account:'Nexo',coin:coin,amount:amount,remark:nDetails,tx_type:txType,asset_type:classifyAsset(coin)});
// Fee separata
if(nFee>0&&nFeeCoin&&nFeeCoin!=='-'){
nexoTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:nTimestamp+'2',tax_year:nYear,operation:'Fee',account:'Nexo',coin:nFeeCoin,amount:-nFee,remark:'Transaction fee',tx_type:'fee',asset_type:classifyAsset(nFeeCoin)});
}
}
console.log('Nexo: '+nexoTxs.length+' TX parsed');
if(nexoTxs.length>0){
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+nexoTxs.length+' TX Nexo)...';
var inserted=0;var errors=0;
for(var b=0;b<nexoTxs.length;b+=100){
var batch=nexoTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Nexo upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Nexo exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=nexoTxs.length;
console.log('Nexo inserted:',inserted,'errors:',errors);
}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}
// === FINE NEXO ===

// === YOUNG PLATFORM: Parser dedicato ===
if(isYoung){
var youngTxs=[];
for(var yy=dataStartLine;yy<lines.length;yy++){
var yLine=lines[yy].trim();if(!yLine)continue;
var yCols=parseCSVLine(yLine);
if(isYoungLedger&&yCols.length>=6){
// Ledger: id,credit,debit,currency,date,tx_type
var yCredit=parseFloat(yCols[1]||0);
var yDebit=parseFloat(yCols[2]||0);
var yCoin=(yCols[3]||'').trim().toUpperCase();
var yTime=(yCols[4]||'').trim();
var yType=(yCols[5]||'').trim();
if(!yTime||!yCoin)continue;
var yTimestamp=yTime;
var yYear=parseInt(yTime.slice(0,4));
if(isNaN(yYear)||yYear<2010||yYear>2030)continue;
var yAmt=yCredit>0?yCredit:-yDebit;
if(yAmt===0)continue;
var txType='other';var yTypeLower=yType.toLowerCase();
if(yTypeLower==='deposit')txType='deposit';
else if(yTypeLower==='withdrawal')txType='withdraw';
else if(yTypeLower==='insta_trade'||yTypeLower==='order_matched')txType=yAmt>0?'trade_buy':'trade_sell';
else if(yTypeLower==='order_placement')txType=yAmt>0?'other_in':'other_out';
else if(yTypeLower==='locked_term')txType=yAmt>0?'earn_red':'earn_sub';
else if(yTypeLower==='fee')txType='fee';
else if(yTypeLower==='dust_conversion')txType='dust';
else if(yTypeLower==='admin')txType=yAmt>0?'reward':'fee';
else txType=yAmt>0?'other_in':'other_out';
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp,tax_year:yYear,operation:yType,account:'Young Platform',coin:yCoin,amount:yAmt,remark:'',tx_type:txType,asset_type:classifyAsset(yCoin)});
}
else if(isYoungTrades&&yCols.length>=10){
// Trades: id,base,quote,amount,volume,rate,brokerage,brokerage_currency,side,date,order_id
var yBase=(yCols[1]||'').trim().toUpperCase();
var yQuote=(yCols[2]||'').trim().toUpperCase();
var yAmount=parseFloat(yCols[3]||0);
var yVolume=parseFloat(yCols[4]||0);
var yBrokerage=parseFloat(yCols[6]||0);
var yBrokerageCoin=(yCols[7]||'').trim().toUpperCase();
var ySide=(yCols[8]||'').trim().toUpperCase();
var yTime=(yCols[9]||'').trim();
var yOrderId=(yCols[10]||'').trim();
if(!yTime||!yBase)continue;
var yTimestamp=yTime;
var yYear=parseInt(yTime.slice(0,4));
if(isNaN(yYear)||yYear<2010||yYear>2030)continue;
// BUY: ricevo base, pago quote
// SELL: pago base, ricevo quote
if(ySide==='BUY'){
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp,tax_year:yYear,operation:'Trade Buy',account:'Young Platform',coin:yBase,amount:yVolume,remark:yOrderId,tx_type:'trade_buy',asset_type:classifyAsset(yBase)});
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp+'1',tax_year:yYear,operation:'Trade Buy',account:'Young Platform',coin:yQuote,amount:-yAmount,remark:yOrderId,tx_type:'trade_sell',asset_type:classifyAsset(yQuote)});
}else{
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp,tax_year:yYear,operation:'Trade Sell',account:'Young Platform',coin:yBase,amount:-yVolume,remark:yOrderId,tx_type:'trade_sell',asset_type:classifyAsset(yBase)});
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp+'1',tax_year:yYear,operation:'Trade Sell',account:'Young Platform',coin:yQuote,amount:yAmount,remark:yOrderId,tx_type:'trade_buy',asset_type:classifyAsset(yQuote)});
}
// Fee
if(yBrokerage>0&&yBrokerageCoin){
youngTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:yTimestamp+'2',tax_year:yYear,operation:'Fee',account:'Young Platform',coin:yBrokerageCoin,amount:-yBrokerage,remark:'Trading fee',tx_type:'fee',asset_type:classifyAsset(yBrokerageCoin)});
}
}
}
console.log('Young Platform: '+youngTxs.length+' TX parsed');
if(youngTxs.length>0){
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+youngTxs.length+' TX Young)...';
var inserted=0;var errors=0;
for(var b=0;b<youngTxs.length;b+=100){
var batch=youngTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Young upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Young exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=youngTxs.length;
console.log('Young inserted:',inserted,'errors:',errors);
}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}
// === FINE YOUNG PLATFORM ===

// === TERRA/LUNC: Parser dedicato ===
if(isTerra){
var terraTxs=[];
for(var tt=dataStartLine;tt<lines.length;tt++){
var tLine=lines[tt].trim();if(!tLine)continue;
var tCols=parseCSVLine(tLine);
// timestamp,tx_type,received_amount,received_currency,sent_amount,sent_currency,fee,fee_currency,comment,txid
if(tCols.length<8)continue;
var tTime=(tCols[0]||'').trim();
var tType=(tCols[1]||'').trim();
var recvAmt=parseFloat(tCols[2]||0);
var recvCoin=(tCols[3]||'').trim().toUpperCase();
var sentAmt=parseFloat(tCols[4]||0);
var sentCoin=(tCols[5]||'').trim().toUpperCase();
var feeAmt=parseFloat(tCols[6]||0);
var feeCoin=(tCols[7]||'').trim().toUpperCase();
var comment=(tCols[8]||'').trim();
var txid=(tCols[9]||'').trim();
if(!tTime)continue;
var tTimestamp=tTime.includes('T')?tTime:tTime.replace(' ','T');
if(!tTimestamp.includes('Z')&&!tTimestamp.includes('+'))tTimestamp+='Z';
var tYear=parseInt(tTime.slice(0,4));
if(isNaN(tYear)||tYear<2010||tYear>2030)continue;
// Determina tipo e coin
var txType='other';var coin='';var amount=0;
var tTypeLower=tType.toLowerCase();
if(recvAmt>0&&recvCoin){
coin=recvCoin;amount=recvAmt;
if(tTypeLower==='transfer')txType='deposit';
else if(tTypeLower.includes('stake')||tTypeLower.includes('reward'))txType='reward';
else if(tTypeLower.includes('swap'))txType='trade_buy';
else txType='other_in';
}
if(sentAmt>0&&sentCoin){
coin=sentCoin;amount=-sentAmt;
if(tTypeLower==='transfer')txType='withdraw';
else if(tTypeLower.includes('swap'))txType='trade_sell';
else if(tTypeLower.includes('stake'))txType='earn_sub';
else txType='other_out';
}
// Solo fee (gas)
if(!recvAmt&&!sentAmt&&feeAmt>0){
coin=feeCoin;amount=-feeAmt;txType='fee';
}
if(!coin||coin.length<1)continue;
terraTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:tTimestamp,tax_year:tYear,operation:tType||'Unknown',account:'Terra',coin:coin,amount:amount,remark:comment||('TX: '+txid.slice(0,16)+'...'),tx_type:txType,asset_type:classifyAsset(coin)});
// Se c'Ã¨ anche fee separata, aggiungi record fee
if(feeAmt>0&&feeCoin&&(recvAmt>0||sentAmt>0)){
terraTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:tTimestamp+'1',tax_year:tYear,operation:'Fee',account:'Terra',coin:feeCoin,amount:-feeAmt,remark:'Gas fee',tx_type:'fee',asset_type:classifyAsset(feeCoin)});
}
}
console.log('Terra/LUNC: '+terraTxs.length+' TX parsed');
if(terraTxs.length>0){
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+terraTxs.length+' TX Terra)...';
var inserted=0;var errors=0;
for(var b=0;b<terraTxs.length;b+=100){
var batch=terraTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Terra upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Terra exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=terraTxs.length;
console.log('Terra inserted:',inserted,'errors:',errors);
}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}
// === FINE TERRA/LUNC ===

// === GATE.IO: Parser dedicato ===
if(isGate){
var gateTxs=[];
for(var g=dataStartLine;g<lines.length;g++){
var gLine=lines[g].trim();if(!gLine)continue;
// Gate.io usa mix comma+tab: pulisci i tab
var cleanLine=gLine.replace(/\t/g,'');
var gCols=parseCSVLine(cleanLine);
// Formato: no, time, action_desc, action_data, change_amount, amount, additional_info
if(gCols.length<5)continue;
var gTime=(gCols[1]||'').trim();
var gAction=(gCols[2]||'').trim();
var gActionData=(gCols[3]||'').trim();
var gChangeRaw=(gCols[4]||'').trim();
// Parsa change_amount: "-16.130533000000 BNB" â†’ amount=-16.13, coin=BNB
var gMatch=gChangeRaw.match(/^([+-]?\d+\.?\d*)\s+(.+)$/);
if(!gMatch)continue;
var gAmt=parseFloat(gMatch[1]);
var gCoin=gMatch[2].trim().toUpperCase();
if(!gCoin||gCoin.length<1||gCoin.length>20)continue;
if(isNaN(gAmt))continue;
// Skip POINT (punti promo Gate.io)
if(gCoin==='POINT')continue;
var gTimestamp=gTime.includes('T')?gTime:gTime.replace(' ','T');
if(!gTimestamp.includes('Z')&&!gTimestamp.includes('+'))gTimestamp+='Z';
var gYear=parseInt(gTime.slice(0,4));
if(isNaN(gYear)||gYear<2010||gYear>2030)continue;
// Classifica tipo TX
var gType='other';var gActionLower=gAction.toLowerCase();
if(gActionLower==='buy')gType='trade_buy';
else if(gActionLower==='sell')gType='trade_sell';
else if(gActionLower.includes('trading fee'))gType='fee';
else if(gActionLower.includes('deposit'))gType='deposit';
else if(gActionLower.includes('withdrawal'))gType='withdraw';
else if(gActionLower.includes('dust swap')&&gActionLower.includes('added'))gType='convert';
else if(gActionLower.includes('dust swap')&&gActionLower.includes('deducted'))gType='dust';
else if(gActionLower.includes('startup sale'))gType='reward';
else if(gActionLower.includes('new operation'))gType='other_in';
else if(gActionLower.includes('reward')||gActionLower.includes('interest')||gActionLower.includes('airdrop'))gType='reward';
else if(gAmt>=0)gType='other_in';
else gType='other_out';
gateTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:gTimestamp,tax_year:gYear,operation:gAction,account:'Gate.io',coin:gCoin,amount:gAmt,remark:'Order: '+gActionData,tx_type:gType,asset_type:classifyAsset(gCoin)});
}
console.log('Gate.io: '+gateTxs.length+' TX parsed');
if(gateTxs.length>0){
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+gateTxs.length+' TX Gate.io)...';
var inserted=0;var errors=0;
for(var b=0;b<gateTxs.length;b+=100){
var batch=gateTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Gate upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Gate exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=gateTxs.length;
console.log('Gate.io inserted:',inserted,'errors:',errors);
}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}
// === FINE GATE.IO ===

// === TATAX: Formato esportato da Tatax via API Binance ===
if(isTatax){
var tataxTxs=parseTatax(csv.text,user.id);
if(tataxTxs.length>0){
console.log('Tatax: '+tataxTxs.length+' TX');
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+tataxTxs.length+' TX Tatax)...';
var inserted=0;var errors=0;
for(var b=0;b<tataxTxs.length;b+=100){
var batch=tataxTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=tataxTxs.length;
console.log('Tatax inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE TATAX ===

// === BINANCE: USA PARSER AVANZATO v2 ===
if(isBinance){
var binanceTxs=parseBinanceAdvanced(csv.text,user.id);
if(binanceTxs.length>0){
var withPrice=binanceTxs.filter(function(t){return t.price_eur;}).length;
var needsPrice=binanceTxs.filter(function(t){return t.needs_price&&!t.price_eur;}).length;
console.log('Binance v2: '+binanceTxs.length+' TX, '+withPrice+' con prezzo, '+needsPrice+' serve CoinGecko');
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+binanceTxs.length+' TX con prezzi)...';
var inserted=0;var errors=0;
for(var b=0;b<binanceTxs.length;b+=100){
var batch=binanceTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=binanceTxs.length;
console.log('Binance inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE BINANCE PARSER v2 ===

// === REVOLUT: USA PARSER AVANZATO ===
if(isRevolut){
var revolutTxs=parseRevolutAdvanced(csv.text,user.id,exchange);
if(revolutTxs.length>0){
var withPrice=revolutTxs.filter(function(t){return t.price_eur;}).length;
console.log('Revolut v2: '+revolutTxs.length+' TX, '+withPrice+' con prezzo');
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+revolutTxs.length+' TX)...';
var inserted=0;var errors=0;
for(var b=0;b<revolutTxs.length;b+=100){
var batch=revolutTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=revolutTxs.length;
console.log('Revolut inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE REVOLUT PARSER ===

// === COINBASE: USA PARSER AVANZATO ===
if(isCoinbase){
var coinbaseTxs=parseCoinbaseAdvanced(csv.text,user.id,exchange);
if(coinbaseTxs.length>0){
var withPrice=coinbaseTxs.filter(function(t){return t.price_eur;}).length;
console.log('Coinbase v2: '+coinbaseTxs.length+' TX, '+withPrice+' con prezzo');
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+coinbaseTxs.length+' TX)...';
var inserted=0;var errors=0;
for(var b=0;b<coinbaseTxs.length;b+=100){
var batch=coinbaseTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=coinbaseTxs.length;
console.log('Coinbase inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE COINBASE PARSER ===

// === BYBIT: USA PARSER AVANZATO ===
if(isBybit){
var bybitTxs=parseBybitAdvanced(csv.text,user.id,exchange);
if(bybitTxs.length>0){
var withPrice=bybitTxs.filter(function(t){return t.price_eur;}).length;
console.log('Bybit v2: '+bybitTxs.length+' TX, '+withPrice+' con prezzo');
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+bybitTxs.length+' TX)...';
var inserted=0;var errors=0;
for(var b=0;b<bybitTxs.length;b+=100){
var batch=bybitTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('Upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('Exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=bybitTxs.length;
console.log('Bybit inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE BYBIT PARSER ===

// === MEXC PARSER DEDICATO ===
if(isMexc){
var mexcTxs=[];
console.log('MEXC parser: lines=',lines.length,'dataStart=',dataStartLine);
for(var mx=dataStartLine;mx<lines.length;mx++){
var mLine=lines[mx].trim();if(!mLine)continue;
var mCols=parseCSVLine(mLine);
if(mCols.length<8)continue;
var mPair=mCols[1]?.replace(/"/g,'').trim()||'';
var mTime=mCols[2]?.replace(/"/g,'').trim()||'';
var mDir=mCols[4]?.replace(/"/g,'').trim()||'';
var mQty=parseFloat(mCols[7]?.replace(/"/g,'')||0);
var mStatus=(mCols[10]||'').toString().replace(/"/g,'').trim().toLowerCase();
if(mStatus!=='eseguito'&&mStatus!=='filled'&&mStatus!=='executed')continue;
if(!mTime||!mPair||mQty===0)continue;
var mCoin=mPair.split('_')[0];
var mTimestamp=mTime.includes('T')?mTime:mTime.replace(' ','T');
if(!mTimestamp.includes('Z')&&!mTimestamp.includes('+'))mTimestamp+='Z';
var mYear=parseInt(mTime.slice(0,4));
if(isNaN(mYear)||mYear<2010||mYear>2030)continue;
var mOp=mDir;
var mAmt=mQty;
if(mDir.toLowerCase().includes('vendi')||mDir.toLowerCase()==='sell'){mAmt=-Math.abs(mQty);mOp='Sell';}else{mOp='Buy';}
var mType=mDir.toLowerCase().includes('vendi')||mDir.toLowerCase()==='sell'?'trade_sell':'trade_buy';
mexcTxs.push({user_id:user.id,exchange:exchange,tx_timestamp:mTimestamp,tax_year:mYear,operation:mOp+' '+mCoin,account:'MEXC',coin:mCoin,amount:mAmt,remark:'MEXC '+mPair,tx_type:mType,asset_type:classifyAsset(mCoin)});
}
console.log('MEXC parsed:',mexcTxs.length,'records');
if(mexcTxs.length>0){
var inserted=0;var errors=0;
for(var b=0;b<mexcTxs.length;b+=100){
var batch=mexcTxs.slice(b,b+100);
try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});
if(res.error){console.error('MEXC upsert error:',res.error);errors+=batch.length;}else{inserted+=batch.length;}}
catch(e){console.error('MEXC exception:',e);errors+=batch.length;}}
totalImported+=inserted;totalParsed+=mexcTxs.length;totalErrors+=errors;
console.log('MEXC inserted:',inserted,'errors:',errors);
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';
continue;}}
// === FINE MEXC PARSER ===

for(var j=dataStartLine;j<lines.length;j++){var line=lines[j].trim();if(!line)continue;var cols=parseCSVLine(line);
var utcTime,operation,coin,change,remark='',account='Spot';
if(isBinance&&cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[4]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);remark=cols[6]?.replace(/"/g,'')||'';account=cols[2]?.replace(/"/g,'')||'Spot';}
else if(isCoinbase&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'');operation=cols[2]?.replace(/"/g,'');coin=cols[3]?.replace(/"/g,'');change=parseFloat(cols[4]?.replace(/"/g,'')||0);if(cols.length>=11)remark=cols[10]?.replace(/"/g,'')||'';account='Coinbase';
var totalEurStr=cols[8]?.replace(/"/g,'').replace('â‚¬','').replace(',','.')||'0';var valueEur=parseFloat(totalEurStr)||0;}
else if(isBybitDeposit&&cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[2]?.replace(/"/g,'');coin=cols[3]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);remark=(cols[4]||'')+' '+(cols[7]||'');account='Bybit';if(operation==='Withdraw')change=-Math.abs(change);}
else if(isBybitFund&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'');coin=cols[2]?.replace(/"/g,'');change=parseFloat(cols[3]?.replace(/"/g,'')||0);operation=cols[4]?.replace(/"/g,'')||'';remark=cols[6]?.replace(/"/g,'')||'';account='Bybit Fund';}
else if(isBybitUta&&cols.length>=14){utcTime=cols[14]?.replace(/"/g,'');coin=cols[1]?.replace(/"/g,'');change=parseFloat(cols[11]?.replace(/"/g,'')||0);operation=cols[3]?.replace(/"/g,'')||'';remark=cols[13]?.replace(/"/g,'')||'';account='Bybit UTA';}
else if(isBybitSpot&&cols.length>=10){utcTime=cols[10]?.replace(/"/g,'');var pair=cols[1]?.replace(/"/g,'')||'';coin=pair.replace(/USDT|USDC|EUR|USD/g,'');operation=cols[3]?.replace(/"/g,'')||'';change=parseFloat(cols[6]?.replace(/"/g,'')||0);if(operation==='SELL')change=-Math.abs(change);remark='Spot Trade '+pair;account='Bybit Spot';}
else if(isBitget&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'').trim();coin=cols[2]?.replace(/"/g,'').trim();operation=cols[3]?.replace(/"/g,'').trim();change=parseFloat(cols[4]?.replace(/"/g,'')||0);remark=operation;account='Bitget';}
else if(isBitpanda&&cols.length>=8){utcTime=cols[1]?.replace(/"/g,'').trim();operation=cols[2]?.replace(/"/g,'').trim();var inOut=cols[3]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[6]?.replace(/"/g,'')||0);coin=cols[7]?.replace(/"/g,'').trim();if(inOut==='outgoing')change=-Math.abs(change);remark=operation+' '+inOut;account='Bitpanda';}
else if(isCryptoCom&&cols.length>=10){utcTime=cols[0]?.replace(/"/g,'').trim();var desc=cols[1]?.replace(/"/g,'').trim()||'';coin=cols[2]?.replace(/"/g,'').trim();change=parseFloat(cols[3]?.replace(/"/g,'')||0);var toCoin=cols[4]?.replace(/"/g,'').trim()||'';var toAmt=parseFloat(cols[5]?.replace(/"/g,'')||0);var kind=cols[9]?.replace(/"/g,'').trim()||'';operation=desc;remark=kind;account='Crypto.com';
var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');if(!timestamp.includes('Z'))timestamp+='Z';var taxYear=parseInt(utcTime.slice(0,4));
if((kind.includes('purchase')||desc.includes('Bought')||desc.includes('Defi Purchase'))&&toCoin&&toAmt){
toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp,tax_year:taxYear,operation:'Buy '+toCoin,account:'Crypto.com',coin:toCoin,amount:toAmt,remark:kind,tx_type:'trade_buy',asset_type:classifyAsset(toCoin)});
if(coin&&change!==0){toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp+'1',tax_year:taxYear,operation:'Spend '+coin,account:'Crypto.com',coin:coin,amount:change,remark:kind,tx_type:'trade_sell',asset_type:classifyAsset(coin)});}
continue;}
if(kind.includes('viban')&&desc.includes('Sold')){operation='sell';}}
else if(isCryptoComExDeposit&&cols.length>=4){var rawTime=cols[0]?.replace(/"/g,'').trim()||'';var utcMatch=rawTime.match(/\(([^)]+)\)/);utcTime=utcMatch?utcMatch[1].replace(' UTC',''):rawTime;var rawCoin=cols[1]?.replace(/"/g,'').trim()||'';coin=rawCoin.split('(')[0];operation=cols[2]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[3]?.replace(/"/g,'')||0);remark=cols[6]?.replace(/"/g,'')||'';account='Crypto.com Exchange';if(operation.toLowerCase().includes('prelievo')||operation.toLowerCase().includes('withdraw'))change=-Math.abs(change);}
else if(isCryptoComExJournal&&cols.length>=8){utcTime=cols[0]?.replace(/"/g,'').trim().replace(' +00:00','');coin=cols[1]?.replace(/"/g,'').trim()||'';operation=cols[3]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[7]?.replace(/"/g,'')||0);remark=operation;account='Crypto.com Exchange';}
else if(isOkipo&&cols.length>=5){utcTime=cols[0]?.replace(/"/g,'').trim();var recvAmt=parseFloat(cols[1]?.replace(/"/g,'')||0);var recvCoin=cols[2]?.replace(/"/g,'').trim()||'';var sentAmt=parseFloat(cols[3]?.replace(/"/g,'')||0);var sentCoin=cols[4]?.replace(/"/g,'').trim()||'';
var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp+='Z';var taxYear=parseInt(utcTime.slice(0,4));
if(recvAmt>0&&recvCoin){toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp,tax_year:taxYear,operation:'Trade Receive',account:'OKX',coin:recvCoin,amount:recvAmt,remark:'Received '+recvCoin+' for '+sentCoin,tx_type:'trade_buy',asset_type:classifyAsset(recvCoin)});}
if(sentAmt>0&&sentCoin){toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp+'1',tax_year:taxYear,operation:'Trade Send',account:'OKX',coin:sentCoin,amount:-sentAmt,remark:'Sent '+sentCoin+' for '+recvCoin,tx_type:'trade_sell',asset_type:classifyAsset(sentCoin)});}
continue;}
else if(isOkxOfficial&&cols.length>=10){utcTime=cols[1]?.replace(/"/g,'').trim();var symbol=cols[3]?.replace(/"/g,'').trim()||'';var side=cols[5]?.replace(/"/g,'').trim()||'';var filledAmt=parseFloat(cols[8]?.replace(/"/g,'')||0);var status=cols[16]?.replace(/"/g,'').trim()||'';
if(status!=='COMPLETE'&&status!=='FILLED')continue;
coin=symbol.split('-')[0];change=filledAmt;operation=side;if(side.toLowerCase()==='sell')change=-Math.abs(change);remark=symbol+' '+side;account='OKX';}
else if(isKucoinSpot&&cols.length>=10){utcTime=cols[3]?.replace(/"/g,'').trim();var symbol=cols[4]?.replace(/"/g,'').trim()||'';var side=cols[5]?.replace(/"/g,'').trim()||'';var filledAmt=parseFloat(cols[10]?.replace(/"/g,'')||0);coin=symbol.split('-')[0];change=filledAmt;operation=side;if(side.toLowerCase()==='sell')change=-Math.abs(change);remark=symbol+' '+side;account='KuCoin';}
else if(isKucoinDeposit&&cols.length>=5){utcTime=cols[2]?.replace(/"/g,'').trim();coin=cols[3]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[4]?.replace(/"/g,'')||0);var status=cols[9]?.replace(/"/g,'').trim()||'';operation=cols[10]?.replace(/"/g,'').trim()||'Deposit';if(csv.name.includes('Withdrawal')){change=-Math.abs(change);operation='Withdrawal';}remark=status;account='KuCoin';}
else if(isKucoinAccount&&cols.length>=7){utcTime=cols[6]?.replace(/"/g,'').trim();coin=cols[2]?.replace(/"/g,'').trim()||'';var side=cols[3]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[4]?.replace(/"/g,'')||0);var kcType=cols[8]?.replace(/"/g,'').trim()||'';if(side.toLowerCase().includes('withdraw')||side.toLowerCase()==='sell')change=-Math.abs(change);operation=side;remark=(cols[7]?.replace(/"/g,'').trim()||'')+' '+kcType;account='KuCoin';}
else if(isYouHodler&&cols.length>=6){utcTime=cols[0]?.replace(/"/g,'').trim();operation=cols[3]?.replace(/"/g,'').trim()||'';coin=(cols[4]?.replace(/"/g,'').trim()||'').toUpperCase();change=parseFloat(cols[5]?.replace(/"/g,'')||0);var direction=cols[15]?.replace(/"/g,'').trim()||'';if(direction==='OUT'&&!operation.toLowerCase().includes('burnt'))change=Math.abs(change);if(operation.toLowerCase().includes('burnt')||operation.toLowerCase().includes('withdraw'))change=-Math.abs(change);remark=operation;account='YouHodler';}
else if(isPionexTrading&&cols.length>=6){utcTime=cols[0]?.replace(/"/g,'').trim();var execQty=parseFloat(cols[1]?.replace(/"/g,'')||0);var side=cols[4]?.replace(/"/g,'').trim()||'';var symbol=cols[5]?.replace(/"/g,'').trim()||'';coin=symbol.split('_')[0];change=execQty;operation=side;if(side.toUpperCase()==='SELL')change=-Math.abs(change);remark=symbol+' '+side;account='Pionex';}
else if(isPionexDeposit&&cols.length>=4){utcTime=cols[0]?.replace(/"/g,'').trim();var txType=cols[1]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[2]?.replace(/"/g,'')||0);coin=cols[3]?.replace(/"/g,'').trim()||'';operation=txType;if(txType.toUpperCase()==='WITHDRAW')change=-Math.abs(change);remark=txType;account='Pionex';}
else if(isRevolut&&cols.length>=7){var dateStr=cols[6]?.replace(/"/g,'').trim()||'';var mesiIT={gen:'01',feb:'02',mar:'03',apr:'04',mag:'05',giu:'06',lug:'07',ago:'08',set:'09',ott:'10',nov:'11',dic:'12'};var dm=dateStr.match(/(\d+)\s+(\w+)\s+(\d{4}),?\s+(\d+):(\d+):(\d+)/);if(dm){var mm=mesiIT[dm[2].toLowerCase()]||'01';utcTime=dm[3]+'-'+mm+'-'+dm[1].padStart(2,'0')+'T'+dm[4]+':'+dm[5]+':'+dm[6];}else{utcTime=dateStr;}
coin=cols[0]?.replace(/"/g,'').trim()||'';operation=cols[1]?.replace(/"/g,'').trim()||'';var qtyStr=cols[2]?.replace(/"/g,'').trim()||'0';change=parseFloat(qtyStr.replace(/\./g,'').replace(',','.'))||0;if(operation.toLowerCase().includes('vendita')||operation.toLowerCase()==='sell')change=-Math.abs(change);remark=operation;account='Revolut';}
else if(isKraken&&cols.length>=7){utcTime=cols[2]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[5]?.replace(/"/g,'');change=parseFloat(cols[6]?.replace(/"/g,'')||0);}
else if(cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[4]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);}
if(!utcTime||!coin||coin.length<1)continue;
var valueEur=typeof valueEur!=='undefined'?valueEur:0;
var txType='other';var opLower=(operation||'').toLowerCase();var remarkLower=(remark||'').toLowerCase();if(opLower.includes('deposit')||opLower==='incoming'||remarkLower.includes('deposit')||opLower.includes('deposito')||opLower.includes('onchain_deposit')||opLower.includes('ricezione'))txType='deposit';else if(opLower.includes('withdraw')||opLower.includes('withdrawal')||opLower.includes('prelievo')||opLower.includes('onchain_withdrawal')||opLower.includes('burnt')||opLower.includes('invio'))txType='withdraw';else if(opLower.includes('buy')||opLower==='buy'||opLower.includes('coin purchase')||opLower.includes('bought')||remarkLower.includes('purchase')||opLower.includes('acquisto'))txType='trade_buy';else if(opLower.includes('sell')||opLower.includes('sold')||opLower==='sell'||opLower.includes('vendita'))txType='trade_sell';else if(opLower.includes('fee')||opLower.includes('commissione'))txType='fee';else if(opLower.includes('reward')||opLower.includes('interest')||opLower.includes('staking')||opLower.includes('learning')||opLower.includes('airdrop')||opLower.includes('bonus')||opLower.includes('redeem')||opLower.includes('cashback')||opLower.includes('rebate')||remarkLower.includes('reward')||remarkLower.includes('cashback')||opLower.includes('saving interest')||opLower.includes('miner'))txType='reward';else if(opLower.includes('convert')||opLower.includes('exchange')||opLower.includes('swap')||opLower==='fiat')txType='convert';else if(opLower.includes('transfer')||opLower==='receive'||opLower==='send'||opLower==='transfer_in'||opLower==='transfer_out')txType='transfer';else if(opLower.includes('top up')||opLower.includes('card')||remarkLower.includes('card_top_up'))txType='payment';
var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp=timestamp.replace(' UTC','')+'Z';
var taxYear=parseInt(utcTime.slice(0,4));if(isNaN(taxYear)||taxYear<2010||taxYear>2030)continue;
if(!coin||coin.length>20)continue;
if(isNaN(change))change=0;
toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp,tax_year:taxYear,operation:(operation||'Unknown').slice(0,100),account:(account||'Spot').slice(0,50),coin:coin.slice(0,20),amount:change,remark:(remark||'').slice(0,255),tx_type:txType,asset_type:classifyAsset(coin)});}
totalParsed+=toInsert.length;console.log('File',csv.name,'parsed:',toInsert.length,'records');if(toInsert.length===0){console.warn('âš ï¸ File',csv.name,'- 0 records! Header:',headerLine.slice(0,100),'Format: CryptoCom=',isCryptoCom,'CryptoComExDep=',isCryptoComExDeposit,'CryptoComExJournal=',isCryptoComExJournal,'dataStart=',dataStartLine,'totalLines=',lines.length);}
var seen={};var uniqueInsert=[];toInsert.forEach(function(r){var key=r.tx_timestamp+'|'+r.coin+'|'+r.amount+'|'+r.operation;if(!seen[key]){seen[key]=true;uniqueInsert.push(r);}});if(uniqueInsert.length<toInsert.length)console.log('Dedup:',toInsert.length,'->',uniqueInsert.length);toInsert=uniqueInsert;
document.getElementById('importStatus').textContent='ğŸ’¾ Salvataggio '+csv.name+' ('+toInsert.length+' TX)...';document.getElementById('importBar').style.width=Math.round(((i+0.5)/csvTexts.length)*100)+'%';
if(toInsert.length>0){var inserted=0;var errors=0;for(var b=0;b<toInsert.length;b+=100){var batch=toInsert.slice(b,b+100);try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});if(res.error){console.error('âŒ Upsert error batch',b,':',res.error.message,res.error.details,res.error.code);console.log('First record of failed batch:',JSON.stringify(batch[0]));errors+=batch.length;}else{inserted+=batch.length;}}catch(e){console.error('âŒ Exception batch',b,':',e);errors+=batch.length;}}totalImported+=inserted;totalErrors+=errors;console.log('File',csv.name,'inserted:',inserted,'errors:',errors);if(errors>0)console.warn('âš ï¸ '+errors+' records falliti per '+csv.name);}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';}
console.log('TOTALE - Parsed:',totalParsed,'Imported:',totalImported,'Errors:',totalErrors);document.getElementById('importBar').style.width='100%';var statusMsg='âœ… '+totalImported+' TX importate ('+totalParsed+' parsate)';if(totalErrors>0)statusMsg+=' âš ï¸ '+totalErrors+' errori';document.getElementById('importStatus').textContent=statusMsg;document.getElementById('importBtn').disabled=false;if(totalErrors>0){toast('âš ï¸ '+totalImported+' TX importate, '+totalErrors+' errori - controlla Console','warning');}else{toast('âœ… '+totalImported+' TX importate!');}setTimeout(function(){closeModal('importModal');loadExchangeTx();},2000);}
function parseCSVLine(line){var result=[];var inQuotes=false;var current='';for(var i=0;i<line.length;i++){var c=line[i];if(c==='"'){inQuotes=!inQuotes;}else if(c===','&&!inQuotes){result.push(current);current='';}else{current+=c;}}result.push(current);return result;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BINANCE PARSER v2 - Con calcolo prezzi automatico
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STABLECOINS, FIAT_COINS, EUR_USD_RATES sono definiti globalmente all'inizio
var COINGECKO_IDS={BTC:'bitcoin',ETH:'ethereum',BNB:'binancecoin',SOL:'solana',ADA:'cardano',XRP:'ripple',DOGE:'dogecoin',DOT:'polkadot',MATIC:'matic-network',SHIB:'shiba-inu',AVAX:'avalanche-2',LINK:'chainlink',LTC:'litecoin',ATOM:'cosmos',UNI:'uniswap',FIL:'filecoin',NEAR:'near',APE:'apecoin',SAND:'the-sandbox',MANA:'decentraland',AXS:'axie-infinity',AAVE:'aave',CRO:'crypto-com-chain',FTM:'fantom',CAKE:'pancakeswap-token',LUNA:'terra-luna-2',LUNC:'terra-luna',GRT:'the-graph',ENJ:'enjincoin',CHZ:'chiliz',ONE:'harmony',GALA:'gala',THETA:'theta-token',XTZ:'tezos',EOS:'eos',NEO:'neo',TRX:'tron',VET:'vechain',ALGO:'algorand',XLM:'stellar',HBAR:'hedera-hashgraph',EGLD:'elrond-erd-2',FLOW:'flow',KAVA:'kava',AR:'arweave',STX:'blockstack',CELO:'celo',ROSE:'oasis-network',INJ:'injective-protocol',SUI:'sui',APT:'aptos',SEI:'sei-network',TIA:'celestia',OP:'optimism',ARB:'arbitrum',PEPE:'pepe',FLOKI:'floki',WIF:'dogwifcoin',BONK:'bonk',NOT:'notcoin',TON:'the-open-network',PENDLE:'pendle',JUP:'jupiter-exchange-solana',WLD:'worldcoin-wld',BLUR:'blur',IMX:'immutable-x',CYBER:'cyberconnect',RDNT:'radiant-capital',ID:'space-id',HOOK:'hooked-protocol',HIGH:'highstreet',NFT:'apenft',BTT:'bittorrent',WIN:'winklink',STMX:'storm',HOT:'holotoken',CELR:'celer-network',NKN:'nkn',ANKR:'ankr',BAT:'basic-attention-token',ZRX:'0x',SNX:'havven',COMP:'compound-governance-token',YFI:'yearn-finance',SUSHI:'sushi',CRV:'curve-dao-token','1INCH':'1inch',BAL:'balancer',LRC:'loopring',KSM:'kusama',AUDIO:'audius',RUNE:'thorchain',FET:'fetch-ai',OCEAN:'ocean-protocol',BAND:'band-protocol',STORJ:'storj',SKL:'skale',CTSI:'cartesi',REN:'republic-protocol'};

var priceCache=JSON.parse(localStorage.getItem('cryptofolio_price_cache')||'{}');
function savePriceCache(){localStorage.setItem('cryptofolio_price_cache',JSON.stringify(priceCache));}

async function getHistoricalPrice(coin,dateStr){
var cacheKey=coin+'_'+dateStr;
if(priceCache[cacheKey])return priceCache[cacheKey];
var cgId=COINGECKO_IDS[coin.toUpperCase()];
if(!cgId){console.log('No CoinGecko ID for',coin);return null;}
var parts=dateStr.split('-');
var cgDate=parts[2]+'-'+parts[1]+'-'+parts[0];
try{
var url='https://api.coingecko.com/api/v3/coins/'+cgId+'/history?date='+cgDate+'&localization=false';
var res=await fetch(url);
if(!res.ok){console.warn('CoinGecko error for',coin,dateStr);return null;}
var data=await res.json();
var priceEur=data.market_data?.current_price?.eur||null;
var priceUsd=data.market_data?.current_price?.usd||null;
if(priceEur){priceCache[cacheKey]={eur:priceEur,usd:priceUsd};savePriceCache();}
return priceCache[cacheKey]||null;
}catch(e){console.error('CoinGecko fetch error:',e);return null;}}

function groupByTimestamp(txs,toleranceMs){
if(txs.length===0)return[];
txs.sort(function(a,b){return a.timestamp-b.timestamp;});
var groups=[];var currentGroup=[txs[0]];
for(var i=1;i<txs.length;i++){
var diff=txs[i].timestamp-currentGroup[0].timestamp;
if(diff<=toleranceMs){currentGroup.push(txs[i]);}
else{groups.push(currentGroup);currentGroup=[txs[i]];}}
groups.push(currentGroup);
return groups;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER BINANCE SEMPLIFICATO - Approccio Somma Algebrica (come Gemini)
// Ogni riga CSV = 1 transazione, amount = Change
// SALVA TUTTO - la somma algebrica darÃ  il saldo corretto (Spot + Earn)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseBinanceAdvanced(csvText,userId){
var lines=csvText.split('\n').filter(function(l){return l.trim();});
if(lines.length<2)return[];
var results=[];
var skipped=0;

// OPERAZIONI DA ESCLUDERE (solo trasferimenti tra wallet interni che si annullano)
var SKIP_OPS=['transfer between main and funding','transfer between spot and margin'];

for(var i=1;i<lines.length;i++){
var cols=parseCSVLine(lines[i]);
if(cols.length<6)continue;
var utcTime=cols[1]?.replace(/"/g,'').trim();
var account=cols[2]?.replace(/"/g,'').trim()||'Spot';
var operation=cols[3]?.replace(/"/g,'').trim();
var coin=cols[4]?.replace(/"/g,'').trim();
var change=parseFloat(cols[5]?.replace(/"/g,'')||0);
var remark=cols[6]?.replace(/"/g,'').trim()||'';
if(!utcTime||!coin||isNaN(change)||change===0)continue;

var opLower=operation.toLowerCase();

// SKIP solo transfer tra wallet (si annullano a coppie)
var shouldSkip=false;
for(var s=0;s<SKIP_OPS.length;s++){
if(opLower.includes(SKIP_OPS[s])){shouldSkip=true;break;}
}
if(shouldSkip){skipped++;continue;}

// Calcola anno e tipo
var year=parseInt(utcTime.substring(0,4));
var txType=classifyOp(operation,change);
var isEur=coin==='EUR';
var isStable=STABLECOINS.includes(coin);
var eurUsdRate=EUR_USD_RATES[year]||0.92;

// CREA TRANSAZIONE - amount = change (positivo o negativo)
results.push({
user_id:userId,
exchange:'binance',
tx_timestamp:formatTs(utcTime),
tax_year:year,
operation:operation,
account:account,
coin:coin,
amount:change, // IMPORTANTE: usa il change direttamente!
tx_type:txType,
asset_type:classifyAsset(coin),
price_eur:isEur?1:(isStable?eurUsdRate:null),
value_eur:isEur?Math.abs(change):(isStable?Math.abs(change)*eurUsdRate:null),
remark:remark,
needs_price:!isEur&&!isStable
});
}
console.log('Binance parsed:',results.length,'skipped (transfer):',skipped);
return results;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER TATAX - Formato esportato da Tatax via API Binance
// Symbol,TokenAddress,TimeStamp,MovementType,Quantity,Countervalue,...
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseTatax(csvText,userId){
var lines=csvText.split('\n').filter(function(l){return l.trim();});
if(lines.length<2)return[];
var results=[];

for(var i=1;i<lines.length;i++){
var cols=parseCSVLine(lines[i]);
if(cols.length<5)continue;
var symbol=cols[0]?.replace(/"/g,'').trim();
var timestamp=cols[2]?.replace(/"/g,'').trim();
var movementType=cols[3]?.replace(/"/g,'').trim();
var quantity=parseFloat(cols[4]?.replace(/"/g,'')||0);
if(!symbol||!timestamp||isNaN(quantity)||quantity===0)continue;

// Normalizza symbol: rimuovi .LENDING@BINANCE, .STAKING@BINANCE, etc.
var coin=symbol.split('.')[0].split('@')[0];

// Calcola anno
var year=parseInt(timestamp.substring(0,4));

// Classifica operazione
var txType='other';
var mt=movementType.toUpperCase();
if(mt==='DEPOSIT')txType='deposit';
else if(mt==='WITHDRAWAL')txType='withdraw';
else if(mt==='CREDIT')txType='trade_buy';
else if(mt==='DEBIT')txType='trade_sell';
else if(mt==='EXCHANGE_FEE')txType='fee';
else if(mt.includes('INTEREST')||mt.includes('REWARD'))txType='reward';
else if(mt.includes('AIRDROP'))txType='reward';

var isEur=coin==='EUR';
var isStable=STABLECOINS.includes(coin);
var eurUsdRate=EUR_USD_RATES[year]||0.92;

results.push({
user_id:userId,
exchange:'binance',
tx_timestamp:formatTs(timestamp),
tax_year:year,
operation:movementType,
account:'Spot',
coin:coin,
amount:quantity,
tx_type:txType,
asset_type:classifyAsset(coin),
price_eur:isEur?1:(isStable?eurUsdRate:null),
value_eur:isEur?Math.abs(quantity):(isStable?Math.abs(quantity)*eurUsdRate:null),
remark:symbol.includes('.')?symbol:'',
needs_price:!isEur&&!isStable
});
}
console.log('Tatax parsed:',results.length);
return results;}

function createBaseTx(tx,userId,year,txType,needsPrice){
return{user_id:userId,exchange:'binance',tx_timestamp:formatTs(tx.utcTime),tax_year:year,operation:tx.operation,account:tx.account,coin:tx.coin,amount:tx.change,tx_type:txType,remark:tx.remark,needs_price:needsPrice};}

function classifyOp(op,change){
var o=(op||'').toLowerCase().trim();

// â•â•â• EXACT MATCH MAP (prioritÃ  massima) â•â•â•
var exactMap={
// DEPOSITI ESTERNI (crypto da wallet o fiat da banca)
'deposit':'deposit','fiat deposit':'deposit','deposit fiat ocbs':'deposit',
// PRELIEVI ESTERNI (crypto verso wallet o fiat verso banca)
'withdraw':'withdraw','fiat withdraw':'withdraw','withdrawal - initiate freeze':'withdraw',
// SPOT TRADING (Transaction Buy+Spend = acquisto, Sold+Revenue = vendita)
'transaction buy':'trade_buy','transaction spend':'trade_sell',
'transaction sold':'trade_sell','transaction revenue':'trade_buy',
'transaction fee':'fee','transaction related':'convert',
'buy':'trade_buy','sell':'trade_sell','fee':'fee',
// FIAT TRADE (acquisto/vendita crypto con EUR/carta)
'buy crypto with card':'fiat_buy','buy crypto with fiat':'fiat_buy',
'fiat ocbs - add fiat and fees':'fiat_deposit',
'convert fiat to crypto ocbs':'fiat_buy',
// CONVERT
'binance convert':'convert','cex swap - convert':'convert',
'cex swap - withdraw success':'convert','auto-invest transaction':'convert',
// EARN (movimenti interni, non tassabili)
'simple earn flexible subscription':'earn_sub','simple earn flexible redemption':'earn_red',
'simple earn locked subscription':'earn_sub','simple earn locked redemption':'earn_red',
'staking purchase':'earn_sub','staking redemption':'earn_red',
'launchpool subscription/redemption':'earn_move','launchpad subscribe':'earn_sub',
'dual savings purchase':'earn_sub','dual savings settlement':'earn_red',
// REWARDS (reddito tassabile)
'simple earn flexible interest':'reward','simple earn locked rewards':'reward',
'simple earn flexible airdrop':'reward',
'bnb vault rewards':'reward','staking rewards':'reward',
'swap farming rewards':'reward','commission rebate':'reward',
'cashback voucher':'reward','cash voucher distribution':'reward','cash voucher':'reward',
'binance card cashback':'reward','mission reward distribution':'reward',
'distribution':'reward','megadrop rewards':'reward',
'airdrop assets':'reward','nft - burn and win':'reward',
'fund recovery':'reward','asset recovery':'reward',
'launchpad token distribution':'reward',
'launchpool airdrop - user claim distribution':'reward',
'launchpool airdrop - system distribution':'reward',
// DUST (conversione briciole in BNB)
'small assets exchange bnb':'dust',
// CARD (spesa con carta Binance)
'binance card spending':'card_spend','pre auth - capture':'card_spend','tax payment':'card_spend',
// TRANSFER (tra account interni Binance)
'transfer between main and funding wallet':'transfer',
// LIQUIDITY (pool di liquiditÃ )
'liquid swap add':'liquidity','liquid swap add/sell':'liquidity',
'liquidity farming remove':'liquidity','swap farming transaction':'liquidity',
// PAY/SEND
'merchant acquiring':'payment','merchant payment':'payment',
'send':'send','crypto box':'reward'
};

if(exactMap[o]!==undefined)return exactMap[o];

// â•â•â• FALLBACK con keyword (per operazioni non mappate) â•â•â•
if(o.includes('subscription')||o.includes('staking purchase'))return'earn_sub';
if(o.includes('redemption')||o.includes('staking redemption'))return'earn_red';
if(o.includes('deposit')&&!o.includes('launchpool'))return'deposit';
if(o.includes('withdraw'))return'withdraw';
if(o.includes('interest')||o.includes('reward')||o.includes('cashback')||o.includes('airdrop')||o.includes('distribution'))return'reward';
if(o.includes('convert')||o.includes('swap'))return'convert';
if(o.includes('fee'))return'fee';
if(o.includes('transfer'))return'transfer';
if(o.includes('buy')||o.includes('purchase'))return'trade_buy';
if(o.includes('sell')||o.includes('sold'))return'trade_sell';
if(o.includes('card'))return'card_spend';
if(o.includes('payment'))return'payment';
return change>0?'other_in':'other_out';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER REVOLUT AVANZATO - Estrae prezzi dal CSV
// Formato: Symbol,Type,Quantity,Price,Value,Total Fees,Date
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseRevolutAdvanced(csvText,userId,exchange){
var lines=csvText.split('\n').filter(function(l){return l.trim();});
if(lines.length<2)return[];
var results=[];
var mesiIT={gen:'01',feb:'02',mar:'03',apr:'04',mag:'05',giu:'06',lug:'07',ago:'08',set:'09',ott:'10',nov:'11',dic:'12'};

for(var i=1;i<lines.length;i++){
var cols=parseCSVLine(lines[i]);
if(cols.length<7)continue;

var coin=cols[0]?.replace(/"/g,'').trim()||'';
var operation=cols[1]?.replace(/"/g,'').trim()||'';
var qtyStr=cols[2]?.replace(/"/g,'').trim()||'0';
var priceStr=cols[3]?.replace(/"/g,'').trim()||'0';
var valueStr=cols[4]?.replace(/"/g,'').trim()||'0';
var feeStr=cols[5]?.replace(/"/g,'').trim()||'0';
var dateStr=cols[6]?.replace(/"/g,'').trim()||'';

// Parsing quantitÃ  (formato italiano: 1.234,56)
var qty=parseFloat(qtyStr.replace(/\./g,'').replace(',','.'))||0;
var price=parseFloat(priceStr.replace(/\./g,'').replace(',','.'))||0;
var value=parseFloat(valueStr.replace(/\./g,'').replace(',','.'))||0;
var fee=parseFloat(feeStr.replace(/\./g,'').replace(',','.'))||0;

// Parsing data italiana: "15 gen 2024, 10:30:45"
var utcTime='';
var dm=dateStr.match(/(\d+)\s+(\w+)\s+(\d{4}),?\s+(\d+):(\d+):(\d+)/);
if(dm){
var mm=mesiIT[dm[2].toLowerCase()]||'01';
utcTime=dm[3]+'-'+mm+'-'+dm[1].padStart(2,'0')+'T'+dm[4]+':'+dm[5]+':'+dm[6]+'Z';
}else{
utcTime=dateStr.replace(' ','T')+'Z';
}

if(!utcTime||!coin)continue;

var taxYear=parseInt(utcTime.slice(0,4));
var opLower=operation.toLowerCase();

// Determina tx_type e segno
var txType='other';
var amount=qty;
if(opLower.includes('vendita')||opLower==='sell'){
txType='trade_sell';
amount=-Math.abs(qty);
}else if(opLower.includes('acquisto')||opLower==='buy'){
txType='trade_buy';
amount=Math.abs(qty);
}else if(opLower.includes('ricezione')||opLower.includes('receive')){
txType='deposit';
amount=Math.abs(qty);
}else if(opLower.includes('invio')||opLower.includes('send')){
txType='withdraw';
amount=-Math.abs(qty);
}

results.push({
user_id:userId,
exchange:exchange||'revolut',
tx_timestamp:utcTime,
tax_year:taxYear,
operation:operation,
account:'Revolut',
coin:coin,
amount:amount,
tx_type:txType,
asset_type:classifyAsset(coin),
pair:coin+'/EUR',
price_eur:price||null,
price_usd:price?price/0.92:null,
value_eur:value||Math.abs(amount*price)||null,
fee_amount:fee||null,
fee_coin:'EUR',
remark:operation,
needs_price:!price
});
}
console.log('Revolut parsed:',results.length);
return results;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER COINBASE AVANZATO - Estrae prezzi dal CSV
// Formato: Timestamp,Transaction Type,Asset,Quantity Transacted,Spot Price Currency,
//          Spot Price at Transaction,Subtotal,Total (inclusive of fees),Fees,Notes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCoinbaseAdvanced(csvText,userId,exchange){
var lines=csvText.split('\n').filter(function(l){return l.trim();});
if(lines.length<2)return[];
var results=[];

// Find header row
var dataStart=0;var hasIdCol=false;
for(var h=0;h<Math.min(10,lines.length);h++){
if(lines[h].includes('Timestamp')&&lines[h].includes('Transaction Type')){
hasIdCol=lines[h].indexOf('ID,')===0||lines[h].startsWith('"ID"');
dataStart=h+1;break;
}
}

function cleanNum(s){return parseFloat((s||'').replace(/[â‚¬$Â£,\s"]/g,'')||0)||0;}

for(var i=dataStart;i<lines.length;i++){
var cols=parseCSVLine(lines[i]);
if(cols.length<5)continue;

// Se c'Ã¨ colonna ID, shifta di 1
var off=hasIdCol?1:0;
var utcTime=(cols[off]||'').replace(/"/g,'').trim();
var operation=(cols[off+1]||'').replace(/"/g,'').trim();
var coin=(cols[off+2]||'').replace(/"/g,'').trim();
var qty=cleanNum(cols[off+3]);
var spotCurrency=(cols[off+4]||'').replace(/[â‚¬$Â£"]/g,'').trim()||'EUR';
var spotPrice=cleanNum(cols[off+5]);
var subtotal=cleanNum(cols[off+6]);
var total=cleanNum(cols[off+7]);
var fees=cleanNum(cols[off+8]);
var notes=(cols[off+9]||'').replace(/"/g,'').trim();

if(!utcTime||!coin||qty===0)continue;

var timestamp=utcTime.replace(' UTC','').replace('UTC','');
timestamp=timestamp.includes('T')?timestamp:timestamp.replace(' ','T');
if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp+='Z';
var taxYear=parseInt(utcTime.slice(0,4));
var opLower=operation.toLowerCase();

var txType='other';var amount=qty;
if(opLower.includes('buy')||opLower.includes('advance trade buy')){
txType='trade_buy';amount=Math.abs(qty);
}else if(opLower.includes('sell')||opLower.includes('advance trade sell')){
txType='trade_sell';amount=-Math.abs(qty);
}else if(opLower.includes('receive')||opLower.includes('deposit')){
txType='deposit';amount=Math.abs(qty);
}else if(opLower.includes('send')||opLower.includes('withdraw')){
txType='withdraw';amount=-Math.abs(qty);
}else if(opLower.includes('reward')||opLower.includes('interest')||opLower.includes('learning')||opLower.includes('staking')||opLower.includes('deprecation')){
txType='reward';amount=Math.abs(qty);
}else if(opLower.includes('convert')){
txType='convert';
}else if(opLower.includes('transfer')){
txType='transfer';
}

var priceEur=spotPrice;var valueEur=Math.abs(total||subtotal);
if(spotCurrency==='USD'){priceEur=spotPrice*0.92;valueEur=Math.abs(total||subtotal)*0.92;}

results.push({
user_id:userId,
exchange:exchange||'coinbase',
tx_timestamp:timestamp,
tax_year:taxYear,
operation:operation,
account:'Coinbase',
coin:coin,
amount:amount,
tx_type:txType,
remark:notes||operation
});
}
console.log('Coinbase parsed:',results.length,'hasIdCol:',hasIdCol);
return results;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSER BYBIT AVANZATO - Gestisce tutti i formati Bybit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseBybitAdvanced(csvText,userId,exchange,formatType){
var lines=csvText.split('\n').filter(function(l){return l.trim();});
if(lines.length<2)return[];
var results=[];
var headerLine=lines[0]||'';

// Detect format
var isDeposit=headerLine.includes('Date')&&headerLine.includes('Type')&&headerLine.includes('Asset')&&headerLine.includes('Chain');
var isFund=headerLine.includes('Date & Time')&&headerLine.includes('Coin')&&headerLine.includes('QTY');
var isUta=headerLine.includes('Currency')&&headerLine.includes('Cash Flow')&&headerLine.includes('Wallet Balance');
var isSpot=headerLine.includes('Spot Pairs')&&headerLine.includes('Direction')&&headerLine.includes('Filled');

for(var i=1;i<lines.length;i++){
var cols=parseCSVLine(lines[i]);
if(cols.length<4)continue;

var utcTime='',coin='',amount=0,operation='',remark='',account='Bybit';

if(isDeposit&&cols.length>=6){
utcTime=cols[1]?.replace(/"/g,'').trim();
operation=cols[2]?.replace(/"/g,'').trim();
coin=cols[3]?.replace(/"/g,'').trim();
amount=parseFloat(cols[5]?.replace(/"/g,'')||0);
remark=(cols[4]||'')+' '+(cols[7]||'');
if(operation==='Withdraw')amount=-Math.abs(amount);
}
else if(isFund&&cols.length>=5){
utcTime=cols[1]?.replace(/"/g,'').trim();
coin=cols[2]?.replace(/"/g,'').trim();
amount=parseFloat(cols[3]?.replace(/"/g,'')||0);
operation=cols[4]?.replace(/"/g,'').trim()||'';
remark=cols[6]?.replace(/"/g,'')||'';
account='Bybit Fund';
}
else if(isUta&&cols.length>=14){
utcTime=cols[14]?.replace(/"/g,'').trim();
coin=cols[1]?.replace(/"/g,'').trim();
amount=parseFloat(cols[11]?.replace(/"/g,'')||0);
operation=cols[3]?.replace(/"/g,'').trim()||'';
remark=cols[13]?.replace(/"/g,'')||'';
account='Bybit UTA';
}
else if(isSpot&&cols.length>=10){
utcTime=cols[10]?.replace(/"/g,'').trim();
var pair=cols[1]?.replace(/"/g,'')||'';
coin=pair.replace(/USDT|USDC|EUR|USD/g,'');
operation=cols[3]?.replace(/"/g,'')||'';
amount=parseFloat(cols[6]?.replace(/"/g,'')||0);
var price=parseFloat(cols[5]?.replace(/"/g,'')||0);
var total=parseFloat(cols[9]?.replace(/"/g,'')||0);
if(operation==='SELL')amount=-Math.abs(amount);
remark='Spot Trade '+pair;
account='Bybit Spot';

// Per Spot abbiamo il prezzo!
if(price>0){
var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');
if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp+='Z';
var taxYear=parseInt(utcTime.slice(0,4));
var txType=operation==='SELL'?'trade_sell':'trade_buy';
results.push({
user_id:userId,
exchange:exchange||'bybit',
tx_timestamp:timestamp,
tax_year:taxYear,
operation:operation,
account:account,
coin:coin,
amount:amount,
tx_type:txType,
asset_type:classifyAsset(coin),
pair:pair,
price_eur:price*0.92,
price_usd:price,
value_eur:total*0.92,
remark:remark,
needs_price:false
});
continue;
}
}

if(!utcTime||!coin)continue;

var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');
if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp+='Z';
var taxYear=parseInt(utcTime.slice(0,4));
var txType=classifyOp(operation,amount);

results.push({
user_id:userId,
exchange:exchange||'bybit',
tx_timestamp:timestamp,
tax_year:taxYear,
operation:operation,
account:account,
coin:coin,
amount:amount,
tx_type:txType,
asset_type:classifyAsset(coin),
remark:remark,
needs_price:true
});
}
console.log('Bybit parsed:',results.length);
return results;
}

function formatTs(utcTime){
var ts=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');
if(!ts.includes('Z')&&!ts.includes('+'))ts+='Z';
return ts;}

async function fillMissingPrices(txs){
var needsPriceTxs=txs.filter(function(t){return t.needs_price&&!t.price_eur;});
if(needsPriceTxs.length===0)return txs;
console.log('Filling prices for',needsPriceTxs.length,'transactions...');
var byDateCoin={};
needsPriceTxs.forEach(function(t){
var dateStr=t.tx_timestamp.slice(0,10);
var key=t.coin+'_'+dateStr;
if(!byDateCoin[key])byDateCoin[key]={coin:t.coin,date:dateStr,txs:[]};
byDateCoin[key].txs.push(t);});
var keys=Object.keys(byDateCoin);
var filled=0;
for(var i=0;i<Math.min(keys.length,50);i++){
var k=byDateCoin[keys[i]];
var price=await getHistoricalPrice(k.coin,k.date);
if(price&&price.eur){
k.txs.forEach(function(t){t.price_eur=price.eur;t.price_usd=price.usd;t.value_eur=Math.abs(t.amount)*price.eur;});
filled+=k.txs.length;}
await new Promise(function(r){setTimeout(r,250);});}
console.log('Filled',filled,'prices');
return txs;}
function showBlacklist(){document.getElementById('blSymCount').textContent=blacklist.size;document.getElementById('blConCount').textContent=blacklistContracts.size;showBlTab('symbols');document.getElementById('blModal').style.display='flex';}
function showBlTab(t){document.querySelectorAll('#blModal .tab').forEach(function(x){x.classList.remove('active');});event.target.classList.add('active');document.getElementById('blSymbols').style.display=t==='symbols'?'block':'none';document.getElementById('blContracts').style.display=t==='contracts'?'block':'none';if(t==='symbols'){var html='';blacklist.forEach(function(s){html+='<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border)"><span>'+s+'</span><button onclick="removeBL(\''+s+'\')" class="btn btn-sm btn-secondary">âœ•</button></div>';});document.getElementById('blList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';}else{var html='';blacklistContracts.forEach(function(c){html+='<div class="flex justify-between items-center" style="padding:6px 0;border-bottom:1px solid var(--border)"><code style="font-size:9px;word-break:break-all">'+c+'</code><button onclick="removeBlCon(\''+c+'\')" class="btn btn-sm btn-secondary" style="margin-left:8px">âœ•</button></div>';});document.getElementById('blConList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';}}
function addToBlacklist(){var s=document.getElementById('blAdd').value.trim().toUpperCase();if(!s)return;blacklist.add(s);saveBlacklists();document.getElementById('blAdd').value='';updateBlStats();showBlacklist();toast(s+' in blacklist');}
function removeBL(s){blacklist.delete(s);saveBlacklists();updateBlStats();showBlTab('symbols');}
function removeBlCon(c){blacklistContracts.delete(c);saveBlacklists();updateBlStats();showBlTab('contracts');}
function loadSettings(){var keys=JSON.parse(localStorage.getItem('cf_apikeys')||'[]');document.getElementById('apiKey1').value=keys[0]||'';document.getElementById('apiKey2').value=keys[1]||'';document.getElementById('apiKey3').value=keys[2]||'';document.getElementById('apiKey4').value=keys[3]||'';document.getElementById('setCurrency').value=localStorage.getItem('cf_currency')||'eur';}
function saveApiKeys(){var keys=[document.getElementById('apiKey1').value.trim(),document.getElementById('apiKey2').value.trim(),document.getElementById('apiKey3').value.trim(),document.getElementById('apiKey4').value.trim()].filter(function(k){return k.length>20;});localStorage.setItem('cf_apikeys',JSON.stringify(keys));KEYS=keys.length>0?keys:[...DEF_KEYS];updateApiStatus();toast('API Keys salvate!');}
function saveCurrency(){currency=document.getElementById('setCurrency').value;localStorage.setItem('cf_currency',currency);loadDashboard();}
function exportCSV(){var csv='Symbol,Name,Chain,Amount,Value_EUR,Contract\n';balances.forEach(function(b){csv+='"'+b.symbol+'","'+(b.name||'')+'","'+b.chain+'",'+b.amount+','+(b.value_eur||0)+',"'+(b.contract_address||'')+'"\n';});var blob=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='cryptofolio_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('CSV esportato!');}
async function clearAllData(){if(!confirm('Eliminare TUTTI i dati?'))return;await db.from('balances').delete().eq('user_id',user.id);await db.from('wallets').delete().eq('user_id',user.id);balances=[];localStorage.removeItem('cf_wl');localStorage.removeItem('cf_bl');localStorage.removeItem('cf_bl_contracts');whitelist.clear();blacklist.clear();blacklistContracts.clear();loadDashboard();loadWallets();toast('Dati eliminati!');}
checkAuth();
</script>
</body>
</html>
