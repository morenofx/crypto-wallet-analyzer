<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFolio v7 - Supabase Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --green: #3fb950;
            --red: #f85149;
            --blue: #58a6ff;
            --yellow: #d29922;
            --purple: #a371f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .logo h1 { font-size: 20px; color: var(--green); }
        .logo span { font-size: 11px; color: var(--text-secondary); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-tertiary); color: var(--text-primary); border-left-color: var(--green); }
        
        /* Main */
        .main-content { flex: 1; margin-left: 220px; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
        .page-title { font-size: 24px; font-weight: 600; }
        
        /* Cards */
        .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 14px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 600; }
        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--blue); }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--red); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Inputs */
        .input { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 14px; width: 100%; }
        .input:focus { outline: none; border-color: var(--blue); }
        
        /* Table */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px; font-size: 12px; color: var(--text-secondary); border-bottom: 1px solid var(--border); font-weight: 500; }
        .table td { padding: 12px; border-bottom: 1px solid var(--border); }
        .table tr:hover { background: var(--bg-tertiary); }
        
        /* Token */
        .token-row { display: flex; align-items: center; gap: 12px; }
        .token-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 11px; background-size: cover; background-position: center; }
        .token-icon img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .token-symbol { font-weight: 600; font-size: 14px; }
        .token-name { font-size: 12px; color: var(--text-secondary); }
        .chain-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; }
        
        /* Charts */
        .chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; min-height: 300px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        
        /* Auth */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; }
        .auth-title { font-size: 24px; margin-bottom: 8px; text-align: center; }
        .auth-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: 32px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
        
        /* Progress */
        .progress-bar { width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--green); transition: width 0.3s; }
        .scan-status { font-size: 13px; color: var(--text-secondary); margin-top: 8px; }
        
        /* Utils */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-8 { gap: 8px; }
        .gap-16 { gap: 16px; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .text-right { text-align: right; }
        .text-secondary { color: var(--text-secondary); }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-yellow { color: var(--yellow); }
        .font-mono { font-family: monospace; }
        
        /* Loading & Toast */
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; z-index: 2000; max-width: 350px; }
        .toast.success { border-left: 4px solid var(--green); }
        .toast.error { border-left: 4px solid var(--red); }
        
        .hide-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; opacity: 0.5; font-size: 14px; padding: 4px 8px; }
        .hide-btn:hover { color: var(--red); opacity: 1; }
        
        .verified-badge { color: var(--green); margin-left: 4px; }
        .warning-badge { color: var(--yellow); margin-left: 4px; }
        
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .chart-container { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-title">ğŸ’° CryptoFolio</h1>
            <p class="auth-subtitle">v7 - Supabase Edition</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="authEmail" class="input" placeholder="tua@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="authPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button onclick="handleLogin()" class="btn btn-primary" style="width:100%;margin-bottom:12px;">ğŸ” Accedi</button>
            <button onclick="handleSignup()" class="btn btn-secondary" style="width:100%;">âœ¨ Registrati</button>
            <p id="authError" class="text-red" style="margin-top:12px;text-align:center;font-size:13px;"></p>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container" style="display:none;">
        <nav class="sidebar">
            <div class="logo"><h1>ğŸ’° CryptoFolio</h1><span>v7.0 Supabase</span></div>
            <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')"><span>ğŸ“Š</span><span>Dashboard</span></div>
            <div class="nav-item" data-page="wallets" onclick="showPage('wallets')"><span>ğŸ‘›</span><span>Wallets</span></div>
            <div class="nav-item" data-page="transactions" onclick="showPage('transactions')"><span>ğŸ“œ</span><span>Transazioni</span></div>
            <div class="nav-item" data-page="tax" onclick="showPage('tax')"><span>ğŸ“‹</span><span>Report Fiscale</span></div>
            <div class="nav-item" data-page="settings" onclick="showPage('settings')"><span>âš™ï¸</span><span>Impostazioni</span></div>
            <div style="position:absolute;bottom:20px;left:20px;right:20px;">
                <button onclick="handleLogout()" class="btn btn-secondary" style="width:100%;">ğŸšª Logout</button>
            </div>
        </nav>
        
        <main class="main-content">
            <!-- Dashboard -->
            <div id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="flex gap-8">
                        <button onclick="scanAllWallets()" class="btn btn-primary" id="scanBtn">ğŸ” Scansiona Wallets</button>
                        <button onclick="refreshPrices()" class="btn btn-secondary">ğŸ’° Aggiorna Prezzi</button>
                        <button onclick="toggleCurrency()" class="btn btn-secondary" id="currencyBtn">ğŸ’¶ EUR</button>
                    </div>
                </div>
                
                <!-- Scan Progress -->
                <div id="scanProgress" class="card" style="display:none;">
                    <div class="card-title mb-8">ğŸ” Scansione in corso...</div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
                    <div class="scan-status" id="scanStatus">Inizializzazione...</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">ğŸ’° Patrimonio Totale</div><div class="stat-value green" id="totalValue">â‚¬0,00</div></div>
                    <div class="stat-card"><div class="stat-label">ğŸ‘› Wallets</div><div class="stat-value blue" id="walletCount">0</div></div>
                    <div class="stat-card"><div class="stat-label">ğŸª™ Token</div><div class="stat-value" id="tokenCount">0</div></div>
                    <div class="stat-card"><div class="stat-label">â›“ï¸ Chain</div><div class="stat-value" id="chainCount">0</div></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-card"><div class="card-title mb-16">ğŸ“Š Distribuzione Portfolio</div><canvas id="portfolioChart"></canvas></div>
                    <div class="chart-card"><div class="card-title mb-16">ğŸ† Top Holdings</div><div id="topHoldings"><p class="text-secondary">Scansiona i wallet per vedere i dati</p></div></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸª™ Tutti i Token <span id="hiddenCount" class="text-secondary"></span></div>
                        <div class="flex gap-8">
                            <select id="chainFilter" class="input" style="width:150px;" onchange="renderTokenList()">
                                <option value="">Tutte le chain</option>
                            </select>
                            <button onclick="toggleShowHidden()" class="btn btn-secondary btn-sm" id="hiddenBtn">ğŸ‘ï¸ Mostra nascosti</button>
                        </div>
                    </div>
                    <div id="tokenList"><p class="text-secondary">Scansiona i wallet per vedere i token</p></div>
                </div>
            </div>
            
            <!-- Wallets Page -->
            <div id="page-wallets" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Wallets</h1>
                    <button onclick="showAddWalletModal()" class="btn btn-primary">â• Aggiungi Wallet</button>
                </div>
                <div id="walletList"><p class="text-secondary">Nessun wallet. Clicca "Aggiungi Wallet"!</p></div>
            </div>
            
            <!-- Transactions Page -->
            <div id="page-transactions" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Transazioni</h1>
                    <div class="flex gap-8">
                        <select id="txYearFilter" class="input" style="width:120px;" onchange="loadTransactions()">
                            <option value="">Tutti</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div id="txCount" class="text-secondary mb-16"></div>
                    <div id="transactionList"><p class="text-secondary">Nessuna transazione</p></div>
                </div>
            </div>
            
            <!-- Tax Page -->
            <div id="page-tax" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Report Fiscale</h1>
                    <select id="taxYear" class="input" style="width:120px;" onchange="loadTaxReport()">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">ğŸ’µ Ricavi</div><div class="stat-value" id="taxProceeds">â‚¬0</div></div>
                    <div class="stat-card"><div class="stat-label">ğŸ“¦ Costo</div><div class="stat-value" id="taxCost">â‚¬0</div></div>
                    <div class="stat-card"><div class="stat-label">ğŸ“ˆ Plusvalenze</div><div class="stat-value text-green" id="taxGains">â‚¬0</div></div>
                    <div class="stat-card"><div class="stat-label">ğŸ“‰ Minusvalenze</div><div class="stat-value text-red" id="taxLosses">â‚¬0</div></div>
                </div>
                <div class="card">
                    <div class="card-title mb-16">ğŸ‡®ğŸ‡¹ Quadro RW - Giacenza Media</div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">1Â° Gennaio</div><div id="giacenzaJan" style="font-size:18px;font-weight:600;">â‚¬0</div></div>
                        <div class="stat-card"><div class="stat-label">31 Dicembre</div><div id="giacenzaDec" style="font-size:18px;font-weight:600;">â‚¬0</div></div>
                        <div class="stat-card"><div class="stat-label">Giacenza Media</div><div id="giacenzaMedia" style="font-size:18px;font-weight:600;">â‚¬0</div></div>
                        <div class="stat-card"><div class="stat-label">Soglia â‚¬51.645,69</div><div id="sogliaStatus" style="font-size:18px;font-weight:600;">-</div></div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="page-settings" style="display:none;">
                <div class="page-header"><h1 class="page-title">Impostazioni</h1></div>
                <div class="card">
                    <div class="card-title mb-16">ğŸ‘¤ Profilo</div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" id="settingsEmail" class="input" disabled></div>
                    <div class="form-group">
                        <label class="form-label">Valuta Preferita</label>
                        <select id="settingsCurrency" class="input" onchange="saveSettings()">
                            <option value="eur">EUR (â‚¬)</option>
                            <option value="usd">USD ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Metodo Calcolo Fiscale</label>
                        <select id="settingsTaxMethod" class="input" onchange="saveSettings()">
                            <option value="lifo">LIFO (Last In, First Out)</option>
                            <option value="fifo">FIFO (First In, First Out)</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title mb-16">ğŸ”§ Azioni</div>
                    <button onclick="clearCache()" class="btn btn-secondary mb-8">ğŸ—‘ï¸ Pulisci Cache Prezzi</button>
                    <button onclick="exportData()" class="btn btn-secondary">ğŸ“¤ Esporta Dati CSV</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">â• Aggiungi Wallet</h2><button class="modal-close" onclick="closeModal('addWalletModal')">&times;</button></div>
            <div class="form-group"><label class="form-label">Nome (opzionale)</label><input type="text" id="walletName" class="input" placeholder="Es: MetaMask Principale"></div>
            <div class="form-group"><label class="form-label">Indirizzo Wallet</label><input type="text" id="walletAddress" class="input" placeholder="0x..."></div>
            <div class="form-group">
                <label class="form-label">Tipo Wallet</label>
                <select id="walletType" class="input">
                    <option value="evm">EVM (Ethereum, BSC, Polygon, etc.)</option>
                    <option value="solana">Solana</option>
                    <option value="cosmos">Cosmos</option>
                </select>
            </div>
            <div class="flex gap-8" style="margin-top:20px;">
                <button onclick="closeModal('addWalletModal')" class="btn btn-secondary" style="flex:1;">Annulla</button>
                <button onclick="addWallet()" class="btn btn-primary" style="flex:1;">â• Aggiungi</button>
            </div>
        </div>
    </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURAZIONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://welnvmqfnceszrvpjoju.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbG52bXFmbmNlc3pydnBqb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODU5NDksImV4cCI6MjA4NTQ2MTk0OX0.XyUPf7r0GvhoxADFPpG1hc6KCQ0gkvSfbYzywl_D-us';

const MORALIS_KEYS = [
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjZjYThhZDhkLTEyMTktNDQ0Ny04ZGQ4LWZiZjlmOTlmYzcwYyIsIm9yZ0lkIjoiNDk2ODU3IiwidXNlcklkIjoiNTExMjY4IiwidHlwZUlkIjoiMmY1NzM4MWItYzNmOS00MDA4LTk5OGYtN2ExMmNiYTAzOWI0IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjkzODIzMzQsImV4cCI6NDkyNTE0MjMzNH0.7cb3HhwH4qmvCYIil3ZWFAYcMD3qEcD3J8J16tAvpbM',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjVlNDJkYTQ5LWFlNmYtNGI2ZC05OTYwLTJkNTUwNGUwZDlmNyIsIm9yZ0lkIjoiNDg3NTI0IiwidXNlcklkIjoiNTAxNTk0IiwidHlwZUlkIjoiY2E1NjEyYzUtMGUzMy00Yzk3LTk1ODktNTA1Yjg4ZmIyNzU1IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2ODczNjMsImV4cCI6NDkyMjQ0NzM2M30.kwUGFKbnzJsALQww3R_UgZO00cDy50Rvf6OmLMTuu9c',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjE0ZDdlNmIxLTkzNTEtNGIwMi1hZGMzLWQ3NjA3MjllNjMxMiIsIm9yZ0lkIjoiNDk2OTIxIiwidXNlcklkIjoiNTExMzM2IiwidHlwZUlkIjoiYTgwMTE2N2QtNGE4MS00ZjVjLThiNGUtMjg0YTlkNzRlOTljIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3Njk0Mjc1ODIsImV4cCI6NDkyNTE4NzU4Mn0.iqQXubNVxU4I_MSjuQolQNKSo4vRHSnGiyiHjvos5eE',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjhlY2U3NzU0LTE0NjUtNGQzMS1iNjRjLTZiNzQ0ZDk3Y2E3ZSIsIm9yZ0lkIjoiNDg3NTI5IiwidXNlcklkIjoiNTAxNTk5IiwidHlwZUlkIjoiYWNiNzFlZjQtZGQ1Ni00NzExLWI1YmQtYjkyNTdmYjgxNDRiIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2OTQ2MDEsImV4cCI6NDkyMjQ1NDYwMX0.3ygKvNrptS9FkNBcmGIO-gSAKGPh9B3h2VeuHdioty8'
];

let currentMoralisIndex = 0;

// Chain config
const CHAINS = {
    eth: { name: 'Ethereum', moralis: 'eth', color: '#627eea', native: 'ETH', icon: 'ğŸ”·' },
    bsc: { name: 'BNB Chain', moralis: 'bsc', color: '#f3ba2f', native: 'BNB', icon: 'ğŸ’›' },
    polygon: { name: 'Polygon', moralis: 'polygon', color: '#8247e5', native: 'POL', icon: 'ğŸ’œ' },
    arbitrum: { name: 'Arbitrum', moralis: 'arbitrum', color: '#28a0f0', native: 'ETH', icon: 'ğŸ”µ' },
    optimism: { name: 'Optimism', moralis: 'optimism', color: '#ff0420', native: 'ETH', icon: 'ğŸ”´' },
    base: { name: 'Base', moralis: 'base', color: '#0052ff', native: 'ETH', icon: 'ğŸ”·' },
    avalanche: { name: 'Avalanche', moralis: 'avalanche', color: '#e84142', native: 'AVAX', icon: 'ğŸ”º' },
    fantom: { name: 'Fantom', moralis: 'fantom', color: '#1969ff', native: 'FTM', icon: 'ğŸ‘»' },
    cronos: { name: 'Cronos', moralis: 'cronos', color: '#002d74', native: 'CRO', icon: 'ğŸ’™' },
    pulse: { name: 'PulseChain', moralis: 'pulsechain', color: '#00ff00', native: 'PLS', icon: 'ğŸ’š' }
};

// Trust Wallet chains for icons
const TRUST_WALLET_CHAINS = {
    eth: 'ethereum', bsc: 'smartchain', polygon: 'polygon', arbitrum: 'arbitrum',
    optimism: 'optimism', base: 'base', avalanche: 'avalanche', fantom: 'fantom', cronos: 'cronos'
};

// Token icons fallback
const TOKEN_ICONS = {
    'BTC': 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png',
    'ETH': 'https://assets.coingecko.com/coins/images/279/small/ethereum.png',
    'BNB': 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',
    'USDT': 'https://assets.coingecko.com/coins/images/325/small/Tether.png',
    'USDC': 'https://assets.coingecko.com/coins/images/6319/small/usdc.png'
};

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let userProfile = null;
let currency = 'eur';
let portfolioChart = null;
let allBalances = [];
let showHidden = false;
let priceCache = {};
let isScanning = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkAuth() {
    const { data: { session } } = await db.auth.getSession();
    if (session) { currentUser = session.user; await loadUserProfile(); showApp(); }
    else { showAuthScreen(); }
}

async function handleLogin() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) { document.getElementById('authError').textContent = error.message; return; }
    currentUser = data.user;
    await loadUserProfile();
    showApp();
}

async function handleSignup() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (password.length < 6) { document.getElementById('authError').textContent = 'Password min 6 caratteri'; return; }
    const { data, error } = await db.auth.signUp({ email, password });
    if (error) { document.getElementById('authError').textContent = error.message; return; }
    await db.from('user_profiles').insert({ id: data.user.id, email, preferred_currency: 'eur', tax_method: 'lifo' });
    currentUser = data.user;
    await loadUserProfile();
    showApp();
    showToast('Account creato! ğŸ‰');
}

async function handleLogout() { await db.auth.signOut(); currentUser = null; showAuthScreen(); }

async function loadUserProfile() {
    const { data } = await db.from('user_profiles').select('*').eq('id', currentUser.id).single();
    if (data) { userProfile = data; currency = data.preferred_currency || 'eur'; }
}

function showAuthScreen() { document.getElementById('authScreen').style.display = 'flex'; document.getElementById('appScreen').style.display = 'none'; }
function showApp() { document.getElementById('authScreen').style.display = 'none'; document.getElementById('appScreen').style.display = 'flex'; loadDashboard(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(page) {
    document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
    document.getElementById(`page-${page}`).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
    
    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'wallets': loadWallets(); break;
        case 'transactions': loadTransactions(); break;
        case 'tax': loadTaxReport(); break;
        case 'settings': loadSettings(); break;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MORALIS API (con cascade)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function moralisRequest(endpoint, params = {}) {
    const queryString = new URLSearchParams(params).toString();
    const url = `https://deep-index.moralis.io/api/v2.2/${endpoint}${queryString ? '?' + queryString : ''}`;
    
    for (let attempt = 0; attempt < MORALIS_KEYS.length; attempt++) {
        const keyIndex = (currentMoralisIndex + attempt) % MORALIS_KEYS.length;
        try {
            const response = await fetch(url, {
                headers: { 'X-API-Key': MORALIS_KEYS[keyIndex], 'Accept': 'application/json' }
            });
            
            if (response.status === 429) {
                console.log(`API ${keyIndex + 1} rate limited, trying next...`);
                continue;
            }
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            currentMoralisIndex = keyIndex;
            return await response.json();
        } catch (e) {
            console.log(`API ${keyIndex + 1} error:`, e.message);
        }
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COINGECKO API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPrices(symbols) {
    const uniqueSymbols = [...new Set(symbols.map(s => s.toUpperCase()))];
    const needFetch = uniqueSymbols.filter(s => !priceCache[s]);
    
    if (needFetch.length === 0) return priceCache;
    
    try {
        const ids = needFetch.map(s => symbolToCoingeckoId(s)).filter(Boolean).join(',');
        if (!ids) return priceCache;
        
        const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=eur,usd`);
        const data = await response.json();
        
        for (const [id, prices] of Object.entries(data)) {
            const symbol = coingeckoIdToSymbol(id);
            if (symbol) {
                priceCache[symbol] = { eur: prices.eur || 0, usd: prices.usd || 0 };
            }
        }
    } catch (e) {
        console.error('CoinGecko error:', e);
    }
    
    return priceCache;
}

function symbolToCoingeckoId(symbol) {
    const map = {
        'BTC': 'bitcoin', 'ETH': 'ethereum', 'BNB': 'binancecoin', 'USDT': 'tether', 'USDC': 'usd-coin',
        'SOL': 'solana', 'AVAX': 'avalanche-2', 'MATIC': 'matic-network', 'POL': 'matic-network',
        'FTM': 'fantom', 'CRO': 'crypto-com-chain', 'PLS': 'pulsechain', 'DAI': 'dai',
        'WETH': 'weth', 'WBNB': 'wbnb', 'LINK': 'chainlink', 'UNI': 'uniswap', 'AAVE': 'aave'
    };
    return map[symbol.toUpperCase()] || symbol.toLowerCase();
}

function coingeckoIdToSymbol(id) {
    const map = {
        'bitcoin': 'BTC', 'ethereum': 'ETH', 'binancecoin': 'BNB', 'tether': 'USDT', 'usd-coin': 'USDC',
        'solana': 'SOL', 'avalanche-2': 'AVAX', 'matic-network': 'POL', 'fantom': 'FTM',
        'crypto-com-chain': 'CRO', 'pulsechain': 'PLS', 'dai': 'DAI', 'weth': 'WETH'
    };
    return map[id] || id.toUpperCase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN ICONS (Trust Wallet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTokenIcon(symbol, chain, contractAddress) {
    // Trust Wallet
    if (contractAddress && TRUST_WALLET_CHAINS[chain]) {
        const twChain = TRUST_WALLET_CHAINS[chain];
        return `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/${twChain}/assets/${contractAddress}/logo.png`;
    }
    
    // Fallback icons
    if (TOKEN_ICONS[symbol.toUpperCase()]) {
        return TOKEN_ICONS[symbol.toUpperCase()];
    }
    
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLET SCANNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function scanAllWallets() {
    if (isScanning) return;
    isScanning = true;
    
    const scanBtn = document.getElementById('scanBtn');
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<div class="spinner"></div> Scansione...';
    
    document.getElementById('scanProgress').style.display = 'block';
    
    try {
        // Get wallets
        const { data: wallets } = await db.from('wallets').select('*').eq('user_id', currentUser.id);
        
        if (!wallets || wallets.length === 0) {
            showToast('Nessun wallet da scansionare', 'error');
            return;
        }
        
        const allNewBalances = [];
        let processed = 0;
        const total = wallets.length * Object.keys(CHAINS).length;
        
        for (const wallet of wallets) {
            if (wallet.wallet_type === 'evm') {
                for (const [chainKey, chainConfig] of Object.entries(CHAINS)) {
                    updateProgress((processed / total) * 100, `Scansione ${chainConfig.name}...`);
                    
                    try {
                        // Native balance
                        const nativeData = await moralisRequest(`${wallet.address}/balance`, { chain: chainConfig.moralis });
                        if (nativeData && nativeData.balance && nativeData.balance !== '0') {
                            const nativeAmount = parseFloat(nativeData.balance) / 1e18;
                            if (nativeAmount > 0.0001) {
                                allNewBalances.push({
                                    user_id: currentUser.id,
                                    wallet_id: wallet.id,
                                    symbol: chainConfig.native,
                                    name: chainConfig.native,
                                    chain: chainKey,
                                    contract_address: null,
                                    amount: nativeAmount,
                                    logo_url: TOKEN_ICONS[chainConfig.native] || null,
                                    is_hidden: false,
                                    is_spam: false
                                });
                            }
                        }
                        
                        // ERC20 tokens
                        const tokensData = await moralisRequest(`${wallet.address}/erc20`, { chain: chainConfig.moralis });
                        if (tokensData && Array.isArray(tokensData)) {
                            for (const token of tokensData) {
                                const decimals = parseInt(token.decimals) || 18;
                                const amount = parseFloat(token.balance) / Math.pow(10, decimals);
                                
                                if (amount > 0 && token.symbol) {
                                    const isSpam = isLikelySpam(token.symbol, token.name);
                                    
                                    allNewBalances.push({
                                        user_id: currentUser.id,
                                        wallet_id: wallet.id,
                                        symbol: token.symbol,
                                        name: token.name || token.symbol,
                                        chain: chainKey,
                                        contract_address: token.token_address,
                                        amount: amount,
                                        logo_url: getTokenIcon(token.symbol, chainKey, token.token_address) || token.logo || token.thumbnail,
                                        is_hidden: false,
                                        is_spam: isSpam
                                    });
                                }
                            }
                        }
                        
                        await sleep(100); // Rate limiting
                    } catch (e) {
                        console.error(`Error scanning ${chainConfig.name}:`, e);
                    }
                    
                    processed++;
                }
            }
        }
        
        updateProgress(80, 'Caricamento prezzi...');
        
        // Fetch prices
        const symbols = [...new Set(allNewBalances.map(b => b.symbol))];
        await fetchPrices(symbols);
        
        // Add prices to balances
        for (const bal of allNewBalances) {
            const price = priceCache[bal.symbol.toUpperCase()];
            bal.price_eur = price?.eur || 0;
            bal.price_usd = price?.usd || 0;
        }
        
        updateProgress(90, 'Salvataggio in database...');
        
        // Clear old balances
        await db.from('balances').delete().eq('user_id', currentUser.id);
        
        // Insert new balances (batch)
        if (allNewBalances.length > 0) {
            const batchSize = 100;
            for (let i = 0; i < allNewBalances.length; i += batchSize) {
                const batch = allNewBalances.slice(i, i + batchSize);
                await db.from('balances').insert(batch);
            }
        }
        
        // Update wallet scan time
        for (const wallet of wallets) {
            await db.from('wallets').update({ last_scan_at: new Date().toISOString(), scan_status: 'completed' }).eq('id', wallet.id);
        }
        
        updateProgress(100, 'Completato!');
        
        showToast(`Scansione completata! ${allNewBalances.length} token trovati`);
        
        // Reload dashboard
        await loadDashboard();
        
    } catch (e) {
        console.error('Scan error:', e);
        showToast('Errore nella scansione: ' + e.message, 'error');
    } finally {
        isScanning = false;
        scanBtn.disabled = false;
        scanBtn.innerHTML = 'ğŸ” Scansiona Wallets';
        setTimeout(() => { document.getElementById('scanProgress').style.display = 'none'; }, 2000);
    }
}

function updateProgress(percent, status) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('scanStatus').textContent = status;
}

function isLikelySpam(symbol, name) {
    const spamPatterns = [
        /\$.*\.com/i, /\.com$/i, /\.io$/i, /\.org$/i, /airdrop/i, /claim/i,
        /free/i, /bonus/i, /reward/i, /\.eth$/i, /visit/i, /http/i
    ];
    const text = (symbol + ' ' + name).toLowerCase();
    return spamPatterns.some(p => p.test(text));
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
    // Load balances from DB
    const { data: balances } = await db.from('balances').select('*').eq('user_id', currentUser.id).order('value_eur', { ascending: false });
    
    allBalances = balances || [];
    
    // Calculate totals
    let totalEur = 0, totalUsd = 0;
    const chains = new Set();
    const tokens = new Set();
    
    for (const b of allBalances) {
        if (!b.is_hidden && !b.is_spam && b.amount > 0) {
            totalEur += b.value_eur || 0;
            totalUsd += b.value_usd || 0;
            chains.add(b.chain);
            tokens.add(b.symbol);
        }
    }
    
    document.getElementById('totalValue').textContent = formatCurrency(currency === 'eur' ? totalEur : totalUsd);
    document.getElementById('tokenCount').textContent = tokens.size;
    document.getElementById('chainCount').textContent = chains.size;
    
    // Wallet count
    const { count } = await db.from('wallets').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
    document.getElementById('walletCount').textContent = count || 0;
    
    // Populate chain filter
    populateChainFilter(chains);
    
    // Render holdings and chart
    renderTopHoldings();
    renderChart();
    renderTokenList();
}

function populateChainFilter(chains) {
    const select = document.getElementById('chainFilter');
    select.innerHTML = '<option value="">Tutte le chain</option>';
    for (const chain of chains) {
        const config = CHAINS[chain];
        if (config) {
            select.innerHTML += `<option value="${chain}">${config.icon} ${config.name}</option>`;
        }
    }
}

function renderTopHoldings() {
    const visible = allBalances.filter(b => !b.is_hidden && !b.is_spam && b.amount > 0);
    
    // Aggregate by symbol
    const bySymbol = {};
    for (const b of visible) {
        if (!bySymbol[b.symbol]) {
            bySymbol[b.symbol] = { symbol: b.symbol, amount: 0, value_eur: 0, value_usd: 0, chains: new Set(), logo_url: b.logo_url };
        }
        bySymbol[b.symbol].amount += b.amount;
        bySymbol[b.symbol].value_eur += b.value_eur || 0;
        bySymbol[b.symbol].value_usd += b.value_usd || 0;
        bySymbol[b.symbol].chains.add(b.chain);
    }
    
    const sorted = Object.values(bySymbol).sort((a, b) => b.value_eur - a.value_eur).slice(0, 7);
    
    if (sorted.length === 0) {
        document.getElementById('topHoldings').innerHTML = '<p class="text-secondary">Nessun asset</p>';
        return;
    }
    
    const total = sorted.reduce((s, h) => s + (currency === 'eur' ? h.value_eur : h.value_usd), 0);
    
    let html = '';
    for (const h of sorted) {
        const value = currency === 'eur' ? h.value_eur : h.value_usd;
        const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
        const chain = [...h.chains][0];
        const color = CHAINS[chain]?.color || '#888';
        
        html += `
            <div class="flex items-center justify-between" style="padding:10px 0;border-bottom:1px solid var(--border);">
                <div class="flex items-center gap-8">
                    <div class="token-icon" style="background:${color}30;color:${color};">
                        ${h.logo_url ? `<img src="${h.logo_url}" onerror="this.style.display='none';this.parentElement.textContent='${h.symbol.slice(0,3)}'">` : h.symbol.slice(0,3)}
                    </div>
                    <div>
                        <div class="token-symbol">${h.symbol}</div>
                        <div class="token-name">${formatNumber(h.amount)}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div style="font-weight:600;">${formatCurrency(value)}</div>
                    <div class="text-secondary" style="font-size:12px;">${pct}%</div>
                </div>
            </div>
        `;
    }
    document.getElementById('topHoldings').innerHTML = html;
}

function renderChart() {
    const visible = allBalances.filter(b => !b.is_hidden && !b.is_spam && b.amount > 0);
    
    // Aggregate
    const bySymbol = {};
    for (const b of visible) {
        if (!bySymbol[b.symbol]) bySymbol[b.symbol] = 0;
        bySymbol[b.symbol] += (currency === 'eur' ? b.value_eur : b.value_usd) || 0;
    }
    
    const sorted = Object.entries(bySymbol).sort((a, b) => b[1] - a[1]).slice(0, 7);
    
    const ctx = document.getElementById('portfolioChart');
    if (portfolioChart) portfolioChart.destroy();
    
    if (sorted.length === 0) {
        ctx.parentElement.innerHTML = '<div class="card-title mb-16">ğŸ“Š Distribuzione Portfolio</div><p class="text-secondary">Nessun dato</p>';
        return;
    }
    
    const colors = ['#3fb950', '#58a6ff', '#a371f7', '#f85149', '#d29922', '#8b949e', '#238636'];
    
    portfolioChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sorted.map(s => s[0]),
            datasets: [{ data: sorted.map(s => s[1]), backgroundColor: colors, borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: { position: 'right', labels: { color: '#fff', padding: 10, font: { size: 11 } } }
            }
        }
    });
}

function renderTokenList() {
    const chainFilter = document.getElementById('chainFilter').value;
    
    let filtered = allBalances.filter(b => b.amount > 0);
    
    if (chainFilter) {
        filtered = filtered.filter(b => b.chain === chainFilter);
    }
    
    if (!showHidden) {
        filtered = filtered.filter(b => !b.is_hidden && !b.is_spam);
    }
    
    const hiddenCount = allBalances.filter(b => b.is_hidden || b.is_spam).length;
    document.getElementById('hiddenCount').textContent = hiddenCount > 0 ? `(${hiddenCount} nascosti)` : '';
    
    if (filtered.length === 0) {
        document.getElementById('tokenList').innerHTML = '<p class="text-secondary">Nessun token</p>';
        return;
    }
    
    // Sort by value
    filtered.sort((a, b) => (b.value_eur || 0) - (a.value_eur || 0));
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th style="width:30px;"></th>
                    <th>Token</th>
                    <th>Chain</th>
                    <th class="text-right">QuantitÃ </th>
                    <th class="text-right">Prezzo</th>
                    <th class="text-right">Valore</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
    `;
    
    for (const b of filtered) {
        const price = currency === 'eur' ? b.price_eur : b.price_usd;
        const value = currency === 'eur' ? b.value_eur : b.value_usd;
        const chainConfig = CHAINS[b.chain] || { name: b.chain, color: '#888', icon: 'â›“ï¸' };
        const isHidden = b.is_hidden || b.is_spam;
        
        html += `
            <tr style="${isHidden ? 'opacity:0.5;' : ''}">
                <td>
                    <div class="token-icon" style="background:${chainConfig.color}30;width:28px;height:28px;font-size:10px;">
                        ${b.logo_url ? `<img src="${b.logo_url}" onerror="this.style.display='none';this.parentElement.textContent='${b.symbol.slice(0,2)}'">` : b.symbol.slice(0,2)}
                    </div>
                </td>
                <td>
                    <div class="token-symbol">${b.symbol}${b.is_spam ? ' <span class="warning-badge">âš ï¸</span>' : ''}</div>
                    <div class="token-name">${b.name || ''}</div>
                </td>
                <td><span class="chain-badge" style="background:${chainConfig.color}25;color:${chainConfig.color};">${chainConfig.icon} ${chainConfig.name}</span></td>
                <td class="text-right font-mono">${formatNumber(b.amount)}</td>
                <td class="text-right text-secondary">${formatCurrency(price)}</td>
                <td class="text-right text-green" style="font-weight:600;">${formatCurrency(value)}</td>
                <td><button class="hide-btn" onclick="toggleHideToken('${b.id}', ${!b.is_hidden})">${b.is_hidden ? 'ğŸ‘ï¸' : 'âœ•'}</button></td>
            </tr>
        `;
    }
    
    html += '</tbody></table>';
    document.getElementById('tokenList').innerHTML = html;
}

async function toggleHideToken(id, hide) {
    await db.from('balances').update({ is_hidden: hide }).eq('id', id);
    const bal = allBalances.find(b => b.id === id);
    if (bal) bal.is_hidden = hide;
    renderTokenList();
    renderTopHoldings();
    renderChart();
    showToast(hide ? 'Token nascosto' : 'Token visibile');
}

function toggleShowHidden() {
    showHidden = !showHidden;
    document.getElementById('hiddenBtn').textContent = showHidden ? 'ğŸ‘ï¸ Nascondi filtrati' : 'ğŸ‘ï¸ Mostra nascosti';
    renderTokenList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWallets() {
    const { data: wallets } = await db.from('wallets').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    
    if (!wallets || wallets.length === 0) {
        document.getElementById('walletList').innerHTML = '<div class="card"><p class="text-secondary">Nessun wallet. Clicca "Aggiungi Wallet"!</p></div>';
        return;
    }
    
    let html = '';
    for (const w of wallets) {
        // Get wallet value
        const { data: balances } = await db.from('balances').select('value_eur, value_usd').eq('wallet_id', w.id);
        const totalEur = balances?.reduce((s, b) => s + (b.value_eur || 0), 0) || 0;
        const totalUsd = balances?.reduce((s, b) => s + (b.value_usd || 0), 0) || 0;
        const total = currency === 'eur' ? totalEur : totalUsd;
        
        const lastScan = w.last_scan_at ? new Date(w.last_scan_at).toLocaleString('it-IT') : 'Mai';
        
        html += `
            <div class="card" style="margin-bottom:16px;">
                <div class="flex items-center justify-between mb-16">
                    <div>
                        <h3 style="font-size:16px;margin-bottom:4px;">${w.name || 'Wallet'}</h3>
                        <code class="text-secondary" style="font-size:11px;">${w.address}</code>
                        <div class="text-secondary" style="font-size:11px;margin-top:4px;">Tipo: ${w.wallet_type.toUpperCase()} | Ultimo scan: ${lastScan}</div>
                    </div>
                    <div class="text-right">
                        <div style="font-size:22px;font-weight:600;color:var(--green);">${formatCurrency(total)}</div>
                    </div>
                </div>
                <div class="flex gap-8">
                    <button onclick="scanSingleWallet('${w.id}')" class="btn btn-primary btn-sm">ğŸ” Scansiona</button>
                    <button onclick="deleteWallet('${w.id}')" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Elimina</button>
                </div>
            </div>
        `;
    }
    document.getElementById('walletList').innerHTML = html;
}

function showAddWalletModal() { document.getElementById('addWalletModal').style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

async function addWallet() {
    const name = document.getElementById('walletName').value.trim();
    const address = document.getElementById('walletAddress').value.trim();
    const type = document.getElementById('walletType').value;
    
    if (!address) { showToast('Inserisci indirizzo', 'error'); return; }
    
    const { error } = await db.from('wallets').insert({ user_id: currentUser.id, address, name: name || null, wallet_type: type });
    
    if (error) { showToast(error.message, 'error'); return; }
    
    closeModal('addWalletModal');
    document.getElementById('walletName').value = '';
    document.getElementById('walletAddress').value = '';
    
    showToast('Wallet aggiunto! ğŸ‰');
    loadWallets();
    loadDashboard();
}

async function deleteWallet(id) {
    if (!confirm('Eliminare questo wallet e tutti i suoi dati?')) return;
    
    await db.from('balances').delete().eq('wallet_id', id);
    await db.from('transactions').delete().eq('wallet_id', id);
    await db.from('wallets').delete().eq('id', id);
    
    showToast('Wallet eliminato');
    loadWallets();
    loadDashboard();
}

async function scanSingleWallet(walletId) {
    showToast('Scansione wallet in corso...');
    await scanAllWallets(); // For now, scan all
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTransactions() {
    const year = document.getElementById('txYearFilter').value;
    
    let query = db.from('transactions').select('*').eq('user_id', currentUser.id).order('tx_timestamp', { ascending: false }).limit(100);
    
    if (year) query = query.eq('tax_year', parseInt(year));
    
    const { data, count } = await query;
    
    document.getElementById('txCount').textContent = data ? `${data.length} transazioni` : '';
    
    if (!data || data.length === 0) {
        document.getElementById('transactionList').innerHTML = '<p class="text-secondary">Nessuna transazione. Scansiona i wallet per importare lo storico.</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Data</th><th>Tipo</th><th>Token</th><th class="text-right">QuantitÃ </th><th class="text-right">Valore</th><th>Chain</th></tr></thead><tbody>';
    
    for (const tx of data) {
        const date = new Date(tx.tx_timestamp).toLocaleDateString('it-IT');
        const symbol = tx.token_in_symbol || tx.token_out_symbol || '-';
        const amount = tx.token_in_amount || tx.token_out_amount || 0;
        const isIn = !!tx.token_in_symbol;
        const chain = CHAINS[tx.chain];
        
        html += `
            <tr>
                <td>${date}</td>
                <td><span class="chain-badge" style="background:${isIn ? 'var(--green)' : 'var(--red)'}25;color:${isIn ? 'var(--green)' : 'var(--red)'};">${tx.tx_type}</span></td>
                <td>${symbol}</td>
                <td class="text-right font-mono">${isIn ? '+' : '-'}${formatNumber(amount)}</td>
                <td class="text-right">${formatCurrency(tx.value_eur)}</td>
                <td><span class="chain-badge" style="background:${chain?.color || '#888'}25;color:${chain?.color || '#888'};">${chain?.name || tx.chain}</span></td>
            </tr>
        `;
    }
    
    document.getElementById('transactionList').innerHTML = html + '</tbody></table>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAX REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTaxReport() {
    const year = parseInt(document.getElementById('taxYear').value);
    
    const { data: summary } = await db.rpc('get_tax_summary', { p_user_id: currentUser.id, p_year: year });
    
    if (summary && summary[0]) {
        document.getElementById('taxProceeds').textContent = formatCurrency(summary[0].total_proceeds_eur);
        document.getElementById('taxCost').textContent = formatCurrency(summary[0].total_cost_basis_eur);
        document.getElementById('taxGains').textContent = formatCurrency(summary[0].total_gains_eur);
        document.getElementById('taxLosses').textContent = formatCurrency(summary[0].total_losses_eur);
    }
    
    const { data: giacenza } = await db.rpc('calculate_giacenza_media', { p_user_id: currentUser.id, p_year: year });
    
    if (giacenza && giacenza[0]) {
        document.getElementById('giacenzaJan').textContent = formatCurrency(giacenza[0].giacenza_jan1_eur);
        document.getElementById('giacenzaDec').textContent = formatCurrency(giacenza[0].giacenza_dec31_eur);
        document.getElementById('giacenzaMedia').textContent = formatCurrency(giacenza[0].giacenza_media_eur);
        document.getElementById('sogliaStatus').innerHTML = giacenza[0].soglia_superata 
            ? '<span class="text-red">âš ï¸ SUPERATA</span>' 
            : '<span class="text-green">âœ“ OK</span>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings() {
    document.getElementById('settingsEmail').value = currentUser.email;
    document.getElementById('settingsCurrency').value = userProfile?.preferred_currency || 'eur';
    document.getElementById('settingsTaxMethod').value = userProfile?.tax_method || 'lifo';
}

async function saveSettings() {
    const newCurrency = document.getElementById('settingsCurrency').value;
    const taxMethod = document.getElementById('settingsTaxMethod').value;
    
    await db.from('user_profiles').update({ preferred_currency: newCurrency, tax_method: taxMethod }).eq('id', currentUser.id);
    
    currency = newCurrency;
    userProfile.preferred_currency = newCurrency;
    userProfile.tax_method = taxMethod;
    
    showToast('Impostazioni salvate!');
}

function clearCache() {
    priceCache = {};
    localStorage.removeItem('priceCache');
    showToast('Cache pulita!');
}

function exportData() {
    // Export balances as CSV
    let csv = 'Symbol,Chain,Amount,Price EUR,Value EUR\n';
    for (const b of allBalances) {
        csv += `${b.symbol},${b.chain},${b.amount},${b.price_eur},${b.value_eur}\n`;
    }
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cryptofolio_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showToast('CSV esportato!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatCurrency(value) {
    const v = parseFloat(value) || 0;
    const symbol = currency === 'eur' ? 'â‚¬' : '$';
    return symbol + v.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatNumber(value) {
    const n = parseFloat(value) || 0;
    if (n === 0) return '0';
    if (n < 0.0001) return n.toExponential(2);
    if (n < 0.01) return n.toFixed(6);
    if (n < 1) return n.toFixed(4);
    if (n < 1000) return n.toFixed(2);
    return n.toLocaleString('it-IT', { maximumFractionDigits: 2 });
}

function toggleCurrency() {
    currency = currency === 'eur' ? 'usd' : 'eur';
    document.getElementById('currencyBtn').textContent = currency === 'eur' ? 'ğŸ’¶ EUR' : 'ğŸ’µ USD';
    loadDashboard();
}

async function refreshPrices() {
    showToast('Aggiornamento prezzi...');
    
    const symbols = [...new Set(allBalances.map(b => b.symbol))];
    priceCache = {}; // Clear cache
    await fetchPrices(symbols);
    
    // Update in DB
    for (const b of allBalances) {
        const price = priceCache[b.symbol.toUpperCase()];
        if (price) {
            await db.from('balances').update({ price_eur: price.eur, price_usd: price.usd }).eq('id', b.id);
            b.price_eur = price.eur;
            b.price_usd = price.usd;
            b.value_eur = b.amount * price.eur;
            b.value_usd = b.amount * price.usd;
        }
    }
    
    loadDashboard();
    showToast('Prezzi aggiornati!');
}

function showToast(msg, type = 'success') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
checkAuth();
db.auth.onAuthStateChange((e, s) => { if (e === 'SIGNED_OUT') showAuthScreen(); });
</script>
</body>
</html>
