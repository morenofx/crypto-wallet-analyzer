<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFolio v7 - Supabase Edition</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
            --blue: #58a6ff;
            --purple: #a371f7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 20px;
            color: var(--green);
        }
        
        .logo span {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--green);
        }
        
        .nav-item .icon {
            font-size: 18px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 220px;
            padding: 24px;
        }
        
        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
        }
        
        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--blue); }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--green);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2ea043;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-danger {
            background: var(--red);
            color: white;
        }
        
        /* Inputs */
        .input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 14px;
            width: 100%;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--blue);
        }
        
        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }
        
        .table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .table tr:hover {
            background: var(--bg-tertiary);
        }
        
        /* Token Row */
        .token-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .token-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .token-info {
            display: flex;
            flex-direction: column;
        }
        
        .token-symbol {
            font-weight: 600;
        }
        
        .token-name {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Chain Badge */
        .chain-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        /* Charts */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Auth */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .auth-title {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .auth-subtitle {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Utilities */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-8 { gap: 8px; }
        .gap-16 { gap: 16px; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .text-right { text-align: right; }
        .text-secondary { color: var(--text-secondary); }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .font-mono { font-family: monospace; }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { border-left: 4px solid var(--green); }
        .toast.error { border-left: 4px solid var(--red); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Hide btn */
        .hide-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0.4;
            font-size: 12px;
            padding: 4px;
        }
        
        .hide-btn:hover {
            color: var(--red);
            opacity: 1;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .chart-container { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-title">ğŸ’° CryptoFolio</h1>
            <p class="auth-subtitle">v7 - Supabase Edition</p>
            
            <div id="authForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="authEmail" class="input" placeholder="tua@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="authPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button onclick="handleLogin()" class="btn btn-primary" style="width:100%;margin-bottom:12px;">
                    ğŸ” Accedi
                </button>
                <button onclick="handleSignup()" class="btn btn-secondary" style="width:100%;">
                    âœ¨ Registrati
                </button>
                <p id="authError" class="text-red" style="margin-top:12px;text-align:center;font-size:13px;"></p>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container" style="display:none;">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h1>ğŸ’° CryptoFolio</h1>
                <span>v7.0 Supabase</span>
            </div>
            
            <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
                <span class="icon">ğŸ“Š</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-page="wallets" onclick="showPage('wallets')">
                <span class="icon">ğŸ‘›</span>
                <span>Wallets</span>
            </div>
            <div class="nav-item" data-page="transactions" onclick="showPage('transactions')">
                <span class="icon">ğŸ“œ</span>
                <span>Transazioni</span>
            </div>
            <div class="nav-item" data-page="tax" onclick="showPage('tax')">
                <span class="icon">ğŸ“‹</span>
                <span>Report Fiscale</span>
            </div>
            <div class="nav-item" data-page="settings" onclick="showPage('settings')">
                <span class="icon">âš™ï¸</span>
                <span>Impostazioni</span>
            </div>
            
            <div style="position:absolute;bottom:20px;left:20px;right:20px;">
                <button onclick="handleLogout()" class="btn btn-secondary" style="width:100%;">
                    ğŸšª Logout
                </button>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="flex gap-8">
                        <button onclick="refreshPrices()" class="btn btn-secondary">ğŸ”„ Aggiorna Prezzi</button>
                        <button onclick="toggleCurrency()" class="btn btn-secondary" id="currencyBtn">ğŸ’¶ EUR</button>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ’° Patrimonio Totale</div>
                        <div class="stat-value green" id="totalValue">â‚¬0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ‘› Wallets</div>
                        <div class="stat-value blue" id="walletCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸª™ Token</div>
                        <div class="stat-value" id="tokenCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">â›“ï¸ Chain</div>
                        <div class="stat-value" id="chainCount">0</div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="chart-container">
                    <div class="chart-card">
                        <div class="card-title mb-16">ğŸ“Š Distribuzione Portfolio</div>
                        <canvas id="portfolioChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="card-title mb-16">ğŸ† Top Holdings</div>
                        <div id="topHoldings"></div>
                    </div>
                </div>
                
                <!-- Token List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸª™ Tutti i Token</div>
                        <div class="flex gap-8">
                            <button onclick="toggleHidden()" class="btn btn-secondary" id="hiddenBtn">
                                ğŸ‘ï¸ Mostra Nascosti
                            </button>
                        </div>
                    </div>
                    <div id="tokenList">
                        <div class="loading"><div class="spinner"></div> Caricamento...</div>
                    </div>
                </div>
            </div>
            
            <!-- Wallets Page -->
            <div id="page-wallets" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Wallets</h1>
                    <button onclick="showAddWalletModal()" class="btn btn-primary">â• Aggiungi Wallet</button>
                </div>
                
                <div id="walletList">
                    <div class="loading"><div class="spinner"></div> Caricamento...</div>
                </div>
            </div>
            
            <!-- Transactions Page -->
            <div id="page-transactions" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Transazioni</h1>
                    <div class="flex gap-8">
                        <select id="txYearFilter" class="input" style="width:120px;" onchange="loadTransactions()">
                            <option value="">Tutti gli anni</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                        <select id="txTypeFilter" class="input" style="width:140px;" onchange="loadTransactions()">
                            <option value="">Tutti i tipi</option>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                            <option value="swap">Swap</option>
                            <option value="transfer_in">Transfer In</option>
                            <option value="transfer_out">Transfer Out</option>
                        </select>
                    </div>
                </div>
                
                <div class="card">
                    <div id="txStats" class="mb-16 text-secondary" style="font-size:13px;"></div>
                    <div id="transactionList">
                        <div class="loading"><div class="spinner"></div> Caricamento...</div>
                    </div>
                    <div id="txPagination" class="flex justify-between items-center" style="margin-top:16px;"></div>
                </div>
            </div>
            
            <!-- Tax Page -->
            <div id="page-tax" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Report Fiscale</h1>
                    <select id="taxYear" class="input" style="width:120px;" onchange="loadTaxReport()">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ’µ Ricavi Totali</div>
                        <div class="stat-value" id="taxProceeds">â‚¬0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“¦ Costo di Carico</div>
                        <div class="stat-value" id="taxCost">â‚¬0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“ˆ Plusvalenze</div>
                        <div class="stat-value text-green" id="taxGains">â‚¬0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“‰ Minusvalenze</div>
                        <div class="stat-value text-red" id="taxLosses">â‚¬0</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title mb-16">ğŸ‡®ğŸ‡¹ Quadro RW - Giacenza Media</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">1Â° Gennaio</div>
                            <div class="stat-value" id="giacenzaJan1" style="font-size:20px;">â‚¬0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">31 Dicembre</div>
                            <div class="stat-value" id="giacenzaDec31" style="font-size:20px;">â‚¬0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Giacenza Media</div>
                            <div class="stat-value" id="giacenzaMedia" style="font-size:20px;">â‚¬0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Soglia â‚¬51.645,69</div>
                            <div class="stat-value" id="sogliaStatus" style="font-size:20px;">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="page-settings" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Impostazioni</h1>
                </div>
                
                <div class="card">
                    <div class="card-title mb-16">ğŸ‘¤ Profilo</div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="settingsEmail" class="input" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valuta Preferita</label>
                        <select id="settingsCurrency" class="input" onchange="saveSettings()">
                            <option value="eur">EUR (â‚¬)</option>
                            <option value="usd">USD ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Metodo Calcolo Fiscale</label>
                        <select id="settingsTaxMethod" class="input" onchange="saveSettings()">
                            <option value="lifo">LIFO (Last In, First Out)</option>
                            <option value="fifo">FIFO (First In, First Out)</option>
                            <option value="avg">Costo Medio</option>
                        </select>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title mb-16">ğŸ”‘ API Keys</div>
                    <div class="form-group">
                        <label class="form-label">Moralis API Key</label>
                        <input type="password" id="moralisKey" class="input" placeholder="Inserisci API key...">
                    </div>
                    <button onclick="saveApiKeys()" class="btn btn-primary">ğŸ’¾ Salva API Keys</button>
                </div>
                
                <div class="card">
                    <div class="card-title mb-16">âš ï¸ Zona Pericolosa</div>
                    <button onclick="clearAllData()" class="btn btn-danger">ğŸ—‘ï¸ Elimina Tutti i Dati</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">â• Aggiungi Wallet</h2>
                <button class="modal-close" onclick="closeModal('addWalletModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Nome (opzionale)</label>
                <input type="text" id="walletName" class="input" placeholder="Es: MetaMask Principale">
            </div>
            <div class="form-group">
                <label class="form-label">Indirizzo Wallet</label>
                <input type="text" id="walletAddress" class="input" placeholder="0x...">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select id="walletType" class="input">
                    <option value="evm">EVM (Ethereum, BSC, Polygon...)</option>
                    <option value="solana">Solana</option>
                    <option value="cosmos">Cosmos</option>
                </select>
            </div>
            <div class="flex gap-8" style="margin-top:20px;">
                <button onclick="closeModal('addWalletModal')" class="btn btn-secondary" style="flex:1;">Annulla</button>
                <button onclick="addWallet()" class="btn btn-primary" style="flex:1;">â• Aggiungi</button>
            </div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURAZIONE SUPABASE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // CREDENZIALI SUPABASE
        const SUPABASE_URL = 'https://welnvmqfnceszrvpjoju.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbG52bXFmbmNlc3pydnBqb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODU5NDksImV4cCI6MjA4NTQ2MTk0OX0.XyUPf7r0GvhoxADFPpG1hc6KCQ0gkvSfbYzywl_D-us';
        
        // Inizializza Supabase
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentUser = null;
        let userProfile = null;
        let currency = 'eur';
        let showHiddenTokens = false;
        let portfolioChart = null;
        let txPage = 0;
        const TX_PER_PAGE = 50;
        
        // Chain colors
        const CHAIN_COLORS = {
            eth: '#627eea',
            bsc: '#f3ba2f',
            polygon: '#8247e5',
            arbitrum: '#28a0f0',
            optimism: '#ff0420',
            base: '#0052ff',
            avalanche: '#e84142',
            fantom: '#1969ff',
            cronos: '#002d74',
            pulse: '#00ff00',
            solana: '#9945FF'
        };
        
        const CHAIN_NAMES = {
            eth: 'Ethereum',
            bsc: 'BNB Chain',
            polygon: 'Polygon',
            arbitrum: 'Arbitrum',
            optimism: 'Optimism',
            base: 'Base',
            avalanche: 'Avalanche',
            fantom: 'Fantom',
            cronos: 'Cronos',
            pulse: 'PulseChain',
            solana: 'Solana'
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showApp();
            } else {
                showAuth();
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            const { data, error } = await db.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                document.getElementById('authError').textContent = error.message;
                return;
            }
            
            currentUser = data.user;
            await loadUserProfile();
            showApp();
        }
        
        async function handleSignup() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (password.length < 6) {
                document.getElementById('authError').textContent = 'Password deve essere almeno 6 caratteri';
                return;
            }
            
            const { data, error } = await db.auth.signUp({
                email,
                password
            });
            
            if (error) {
                document.getElementById('authError').textContent = error.message;
                return;
            }
            
            // Crea profilo utente
            await db.from('user_profiles').insert({
                id: data.user.id,
                email: email,
                preferred_currency: 'eur',
                tax_method: 'lifo'
            });
            
            currentUser = data.user;
            await loadUserProfile();
            showApp();
            
            showToast('Account creato! Benvenuto ğŸ‰', 'success');
        }
        
        async function handleLogout() {
            await db.auth.signOut();
            currentUser = null;
            userProfile = null;
            showAuth();
        }
        
        async function loadUserProfile() {
            const { data } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (data) {
                userProfile = data;
                currency = data.preferred_currency || 'eur';
            }
        }
        
        function showAuth() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'flex';
            loadDashboard();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
            
            // Show selected page
            document.getElementById(`page-${page}`).style.display = 'block';
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            // Load page data
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'wallets': loadWallets(); break;
                case 'transactions': loadTransactions(); break;
                case 'tax': loadTaxReport(); break;
                case 'settings': loadSettings(); break;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DASHBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadDashboard() {
            // Load portfolio summary
            const { data: summary } = await db.rpc('get_portfolio_summary', {
                p_user_id: currentUser.id
            });
            
            if (summary && summary[0]) {
                const s = summary[0];
                const value = currency === 'eur' ? s.total_value_eur : s.total_value_usd;
                document.getElementById('totalValue').textContent = formatCurrency(value);
                document.getElementById('tokenCount').textContent = s.token_count || 0;
                document.getElementById('chainCount').textContent = s.chain_count || 0;
            }
            
            // Count wallets
            const { count } = await supabase
                .from('wallets')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id);
            
            document.getElementById('walletCount').textContent = count || 0;
            
            // Load top holdings
            await loadTopHoldings();
            
            // Load token list
            await loadTokenList();
        }
        
        async function loadTopHoldings() {
            const { data: holdings } = await db.rpc('get_top_holdings', {
                p_user_id: currentUser.id,
                p_limit: 7,
                p_currency: currency
            });
            
            if (!holdings || holdings.length === 0) {
                document.getElementById('topHoldings').innerHTML = '<p class="text-secondary">Nessun asset</p>';
                return;
            }
            
            // Render chart
            renderPortfolioChart(holdings);
            
            // Render list
            let html = '';
            holdings.forEach((h, i) => {
                const color = getChainColor(h.chains?.[0] || 'eth');
                html += `
                    <div class="flex items-center justify-between" style="padding:10px 0;border-bottom:1px solid var(--border);">
                        <div class="flex items-center gap-8">
                            <div class="token-icon" style="background:${color}30;color:${color};">${h.symbol.slice(0,3)}</div>
                            <div>
                                <div class="token-symbol">${h.symbol}</div>
                                <div class="token-name">${formatNumber(h.total_amount)}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div style="font-weight:600;">${formatCurrency(h.total_value)}</div>
                            <div class="text-secondary" style="font-size:12px;">${h.percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('topHoldings').innerHTML = html;
        }
        
        function renderPortfolioChart(holdings) {
            const ctx = document.getElementById('portfolioChart');
            
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            const colors = [
                '#3fb950', '#58a6ff', '#a371f7', '#f85149', '#d29922',
                '#8b949e', '#238636', '#1f6feb'
            ];
            
            portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: holdings.map(h => h.symbol),
                    datasets: [{
                        data: holdings.map(h => h.total_value),
                        backgroundColor: colors.slice(0, holdings.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#ffffff',
                                padding: 12,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }
        
        async function loadTokenList() {
            const { data: balances } = await supabase
                .from('balances')
                .select('*')
                .eq('user_id', currentUser.id)
                .gt('amount', 0)
                .order('value_eur', { ascending: false });
            
            if (!balances || balances.length === 0) {
                document.getElementById('tokenList').innerHTML = `
                    <div class="loading">
                        <p>Nessun token. Aggiungi un wallet per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            // Filter hidden
            const filtered = showHiddenTokens ? balances : balances.filter(b => !b.is_hidden && !b.is_spam);
            
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Chain</th>
                            <th class="text-right">QuantitÃ </th>
                            <th class="text-right">Prezzo</th>
                            <th class="text-right">Valore</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filtered.forEach(b => {
                const price = currency === 'eur' ? b.price_eur : b.price_usd;
                const value = currency === 'eur' ? b.value_eur : b.value_usd;
                const chainColor = CHAIN_COLORS[b.chain] || '#888';
                const chainName = CHAIN_NAMES[b.chain] || b.chain;
                
                html += `
                    <tr${b.is_hidden ? ' style="opacity:0.5;"' : ''}>
                        <td>
                            <div class="token-row">
                                <div class="token-icon" style="background:${chainColor}30;color:${chainColor};">
                                    ${b.symbol.slice(0,3)}
                                </div>
                                <div class="token-info">
                                    <span class="token-symbol">${b.symbol}</span>
                                    <span class="token-name">${b.name || ''}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="chain-badge" style="background:${chainColor}25;color:${chainColor};">
                                ${chainName}
                            </span>
                        </td>
                        <td class="text-right font-mono">${formatNumber(b.amount)}</td>
                        <td class="text-right text-secondary">${formatCurrency(price)}</td>
                        <td class="text-right text-green" style="font-weight:600;">${formatCurrency(value)}</td>
                        <td>
                            <button class="hide-btn" onclick="toggleTokenHidden('${b.id}', ${!b.is_hidden})">
                                ${b.is_hidden ? 'ğŸ‘ï¸' : 'âœ•'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('tokenList').innerHTML = html;
        }
        
        async function toggleTokenHidden(balanceId, hidden) {
            await supabase
                .from('balances')
                .update({ is_hidden: hidden })
                .eq('id', balanceId);
            
            loadTokenList();
            showToast(hidden ? 'Token nascosto' : 'Token visibile', 'success');
        }
        
        function toggleHidden() {
            showHiddenTokens = !showHiddenTokens;
            document.getElementById('hiddenBtn').textContent = showHiddenTokens ? 'ğŸ‘ï¸ Nascondi Filtrati' : 'ğŸ‘ï¸ Mostra Nascosti';
            loadTokenList();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WALLETS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadWallets() {
            const { data: wallets } = await supabase
                .from('wallets')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (!wallets || wallets.length === 0) {
                document.getElementById('walletList').innerHTML = `
                    <div class="card">
                        <p class="text-secondary">Nessun wallet. Clicca "Aggiungi Wallet" per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            for (const w of wallets) {
                // Count tokens
                const { count } = await supabase
                    .from('balances')
                    .select('*', { count: 'exact', head: true })
                    .eq('wallet_id', w.id)
                    .gt('amount', 0);
                
                // Sum value
                const { data: sumData } = await supabase
                    .from('balances')
                    .select('value_eur')
                    .eq('wallet_id', w.id);
                
                const totalValue = sumData?.reduce((sum, b) => sum + (b.value_eur || 0), 0) || 0;
                
                html += `
                    <div class="card" style="margin-bottom:16px;">
                        <div class="flex items-center justify-between mb-16">
                            <div>
                                <h3 style="font-size:16px;margin-bottom:4px;">${w.name || 'Wallet'}</h3>
                                <code class="text-secondary" style="font-size:12px;">${w.address.slice(0,10)}...${w.address.slice(-8)}</code>
                            </div>
                            <div class="text-right">
                                <div style="font-size:20px;font-weight:600;color:var(--green);">${formatCurrency(totalValue)}</div>
                                <div class="text-secondary" style="font-size:12px;">${count || 0} token</div>
                            </div>
                        </div>
                        <div class="flex gap-8">
                            <button onclick="scanWallet('${w.id}')" class="btn btn-primary" style="flex:1;">
                                ğŸ” Scansiona
                            </button>
                            <button onclick="deleteWallet('${w.id}')" class="btn btn-danger">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('walletList').innerHTML = html;
        }
        
        function showAddWalletModal() {
            document.getElementById('addWalletModal').style.display = 'flex';
        }
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        async function addWallet() {
            const name = document.getElementById('walletName').value;
            const address = document.getElementById('walletAddress').value.trim();
            const type = document.getElementById('walletType').value;
            
            if (!address) {
                showToast('Inserisci un indirizzo wallet', 'error');
                return;
            }
            
            const { error } = await db.from('wallets').insert({
                user_id: currentUser.id,
                address: address,
                name: name || null,
                wallet_type: type
            });
            
            if (error) {
                showToast('Errore: ' + error.message, 'error');
                return;
            }
            
            closeModal('addWalletModal');
            document.getElementById('walletName').value = '';
            document.getElementById('walletAddress').value = '';
            
            showToast('Wallet aggiunto! ğŸ‰', 'success');
            loadWallets();
        }
        
        async function deleteWallet(walletId) {
            if (!confirm('Eliminare questo wallet e tutti i suoi dati?')) return;
            
            await db.from('wallets').delete().eq('id', walletId);
            
            showToast('Wallet eliminato', 'success');
            loadWallets();
        }
        
        async function scanWallet(walletId) {
            showToast('Scansione in corso... (demo)', 'success');
            
            // In produzione qui chiameresti l'Edge Function
            // che usa Moralis/Etherscan per fetch i dati reali
            
            // Per ora simuliamo aggiungendo dati demo
            const { data: wallet } = await supabase
                .from('wallets')
                .select('*')
                .eq('id', walletId)
                .single();
            
            if (wallet) {
                // Aggiorna status
                await supabase
                    .from('wallets')
                    .update({ 
                        last_scan_at: new Date().toISOString(),
                        scan_status: 'completed'
                    })
                    .eq('id', walletId);
                
                showToast('Scansione completata!', 'success');
                loadWallets();
                loadDashboard();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TRANSACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadTransactions() {
            const year = document.getElementById('txYearFilter').value || null;
            const type = document.getElementById('txTypeFilter').value || null;
            
            let query = supabase
                .from('transactions')
                .select('*', { count: 'exact' })
                .eq('user_id', currentUser.id)
                .order('tx_timestamp', { ascending: false })
                .range(txPage * TX_PER_PAGE, (txPage + 1) * TX_PER_PAGE - 1);
            
            if (year) query = query.eq('tax_year', parseInt(year));
            if (type) query = query.eq('tx_type', type);
            
            const { data: transactions, count } = await query;
            
            // Stats
            document.getElementById('txStats').textContent = `${count || 0} transazioni trovate`;
            
            if (!transactions || transactions.length === 0) {
                document.getElementById('transactionList').innerHTML = `
                    <p class="text-secondary">Nessuna transazione</p>
                `;
                return;
            }
            
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Token</th>
                            <th class="text-right">QuantitÃ </th>
                            <th class="text-right">Valore</th>
                            <th>Chain</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            transactions.forEach(tx => {
                const date = new Date(tx.tx_timestamp).toLocaleDateString('it-IT');
                const symbol = tx.token_in_symbol || tx.token_out_symbol || '-';
                const amount = tx.token_in_amount || tx.token_out_amount || 0;
                const isIn = !!tx.token_in_symbol;
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>
                            <span class="chain-badge" style="background:${isIn ? 'var(--green)' : 'var(--red)'}25;color:${isIn ? 'var(--green)' : 'var(--red)'};">
                                ${tx.tx_type}
                            </span>
                        </td>
                        <td>${symbol}</td>
                        <td class="text-right font-mono">${isIn ? '+' : '-'}${formatNumber(amount)}</td>
                        <td class="text-right">${formatCurrency(tx.value_eur)}</td>
                        <td>
                            <span class="chain-badge" style="background:${CHAIN_COLORS[tx.chain] || '#888'}25;color:${CHAIN_COLORS[tx.chain] || '#888'};">
                                ${tx.chain}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('transactionList').innerHTML = html;
            
            // Pagination
            const totalPages = Math.ceil((count || 0) / TX_PER_PAGE);
            document.getElementById('txPagination').innerHTML = `
                <button class="btn btn-secondary" ${txPage === 0 ? 'disabled' : ''} onclick="txPage--;loadTransactions();">
                    â† Precedente
                </button>
                <span class="text-secondary">Pagina ${txPage + 1} di ${totalPages}</span>
                <button class="btn btn-secondary" ${txPage >= totalPages - 1 ? 'disabled' : ''} onclick="txPage++;loadTransactions();">
                    Successivo â†’
                </button>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TAX REPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadTaxReport() {
            const year = parseInt(document.getElementById('taxYear').value);
            
            // Get tax summary
            const { data: summary } = await db.rpc('get_tax_summary', {
                p_user_id: currentUser.id,
                p_year: year
            });
            
            if (summary && summary[0]) {
                const s = summary[0];
                document.getElementById('taxProceeds').textContent = formatCurrency(s.total_proceeds_eur);
                document.getElementById('taxCost').textContent = formatCurrency(s.total_cost_basis_eur);
                document.getElementById('taxGains').textContent = formatCurrency(s.total_gains_eur);
                document.getElementById('taxLosses').textContent = formatCurrency(s.total_losses_eur);
            }
            
            // Get giacenza media
            const { data: giacenza } = await db.rpc('calculate_giacenza_media', {
                p_user_id: currentUser.id,
                p_year: year
            });
            
            if (giacenza && giacenza[0]) {
                const g = giacenza[0];
                document.getElementById('giacenzaJan1').textContent = formatCurrency(g.giacenza_jan1_eur);
                document.getElementById('giacenzaDec31').textContent = formatCurrency(g.giacenza_dec31_eur);
                document.getElementById('giacenzaMedia').textContent = formatCurrency(g.giacenza_media_eur);
                document.getElementById('sogliaStatus').innerHTML = g.soglia_superata 
                    ? '<span class="text-red">âš ï¸ SUPERATA</span>' 
                    : '<span class="text-green">âœ“ OK</span>';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SETTINGS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function loadSettings() {
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('settingsCurrency').value = userProfile?.preferred_currency || 'eur';
            document.getElementById('settingsTaxMethod').value = userProfile?.tax_method || 'lifo';
        }
        
        async function saveSettings() {
            const newCurrency = document.getElementById('settingsCurrency').value;
            const taxMethod = document.getElementById('settingsTaxMethod').value;
            
            await supabase
                .from('user_profiles')
                .update({
                    preferred_currency: newCurrency,
                    tax_method: taxMethod
                })
                .eq('id', currentUser.id);
            
            currency = newCurrency;
            userProfile.preferred_currency = newCurrency;
            userProfile.tax_method = taxMethod;
            
            showToast('Impostazioni salvate!', 'success');
        }
        
        async function saveApiKeys() {
            const moralisKey = document.getElementById('moralisKey').value;
            
            // In produzione salveresti in api_keys table (criptato)
            localStorage.setItem('moralis_key', moralisKey);
            
            showToast('API Keys salvate!', 'success');
        }
        
        async function clearAllData() {
            if (!confirm('âš ï¸ ATTENZIONE: Questa azione eliminerÃ  TUTTI i tuoi dati. Continuare?')) return;
            if (!confirm('Sei SICURO? Questa azione Ã¨ irreversibile!')) return;
            
            await db.from('transactions').delete().eq('user_id', currentUser.id);
            await db.from('balances').delete().eq('user_id', currentUser.id);
            await db.from('wallets').delete().eq('user_id', currentUser.id);
            
            showToast('Tutti i dati eliminati', 'success');
            loadDashboard();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function formatCurrency(value) {
            if (!value) return currency === 'eur' ? 'â‚¬0,00' : '$0.00';
            
            if (currency === 'eur') {
                return 'â‚¬' + parseFloat(value).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return '$' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }
        
        function formatNumber(value) {
            if (!value) return '0';
            const num = parseFloat(value);
            if (num < 0.0001) return num.toExponential(2);
            if (num < 1) return num.toFixed(6);
            if (num < 1000) return num.toFixed(4);
            return num.toLocaleString('it-IT', { maximumFractionDigits: 2 });
        }
        
        function getChainColor(chain) {
            return CHAIN_COLORS[chain] || '#888888';
        }
        
        function toggleCurrency() {
            currency = currency === 'eur' ? 'usd' : 'eur';
            document.getElementById('currencyBtn').textContent = currency === 'eur' ? 'ğŸ’¶ EUR' : 'ğŸ’µ USD';
            loadDashboard();
        }
        
        async function refreshPrices() {
            showToast('Aggiornamento prezzi...', 'success');
            // In produzione chiameresti Edge Function per update prezzi
            setTimeout(() => {
                loadDashboard();
                showToast('Prezzi aggiornati!', 'success');
            }, 1000);
        }
        
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âš ï¸'}</span> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Check auth on load
        checkAuth();
        
        // Listen for auth changes
        db.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                showAuth();
            }
        });
    </script>
</body>
</html>
