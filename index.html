<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFolio v7 - Supabase Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --green: #3fb950;
            --red: #f85149;
            --blue: #58a6ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .app-container { display: flex; min-height: 100vh; }
        
        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
        }
        .logo { padding: 0 20px 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .logo h1 { font-size: 20px; color: var(--green); }
        .logo span { font-size: 11px; color: var(--text-secondary); }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 20px; color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-tertiary); color: var(--text-primary); border-left-color: var(--green); }
        
        .main-content { flex: 1; margin-left: 220px; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 600; }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 14px; color: var(--text-secondary); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 600; }
        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--blue); }
        
        .btn {
            padding: 10px 20px; border-radius: 8px; border: none;
            cursor: pointer; font-size: 14px; font-weight: 500;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--red); color: white; }
        
        .input {
            background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px 14px;
            color: var(--text-primary); font-size: 14px; width: 100%;
        }
        .input:focus { outline: none; border-color: var(--blue); }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px; font-size: 12px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
        .table td { padding: 12px; border-bottom: 1px solid var(--border); }
        .table tr:hover { background: var(--bg-tertiary); }
        
        .token-row { display: flex; align-items: center; gap: 12px; }
        .token-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; }
        .token-symbol { font-weight: 600; }
        .token-name { font-size: 12px; color: var(--text-secondary); }
        .chain-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        
        .chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; min-height: 300px; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; width: 90%; max-width: 500px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-card {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 16px; padding: 40px; width: 100%; max-width: 400px;
        }
        .auth-title { font-size: 24px; margin-bottom: 8px; text-align: center; }
        .auth-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: 32px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-8 { gap: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .text-right { text-align: right; }
        .text-secondary { color: var(--text-secondary); }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .font-mono { font-family: monospace; }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; z-index: 2000; }
        .toast.success { border-left: 4px solid var(--green); }
        .toast.error { border-left: 4px solid var(--red); }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .chart-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-title">üí∞ CryptoFolio</h1>
            <p class="auth-subtitle">v7 - Supabase Edition</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="authEmail" class="input" placeholder="tua@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="authPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button onclick="handleLogin()" class="btn btn-primary" style="width:100%;margin-bottom:12px;">üîê Accedi</button>
            <button onclick="handleSignup()" class="btn btn-secondary" style="width:100%;">‚ú® Registrati</button>
            <p id="authError" class="text-red" style="margin-top:12px;text-align:center;font-size:13px;"></p>
        </div>
    </div>
    
    <div id="appScreen" class="app-container" style="display:none;">
        <nav class="sidebar">
            <div class="logo"><h1>üí∞ CryptoFolio</h1><span>v7.0 Supabase</span></div>
            <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')"><span>üìä</span><span>Dashboard</span></div>
            <div class="nav-item" data-page="wallets" onclick="showPage('wallets')"><span>üëõ</span><span>Wallets</span></div>
            <div class="nav-item" data-page="transactions" onclick="showPage('transactions')"><span>üìú</span><span>Transazioni</span></div>
            <div class="nav-item" data-page="tax" onclick="showPage('tax')"><span>üìã</span><span>Report Fiscale</span></div>
            <div class="nav-item" data-page="settings" onclick="showPage('settings')"><span>‚öôÔ∏è</span><span>Impostazioni</span></div>
            <div style="position:absolute;bottom:20px;left:20px;right:20px;">
                <button onclick="handleLogout()" class="btn btn-secondary" style="width:100%;">üö™ Logout</button>
            </div>
        </nav>
        
        <main class="main-content">
            <div id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="flex gap-8">
                        <button onclick="loadDashboard()" class="btn btn-secondary">üîÑ Aggiorna</button>
                        <button onclick="toggleCurrency()" class="btn btn-secondary" id="currencyBtn">üí∂ EUR</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">üí∞ Patrimonio Totale</div><div class="stat-value green" id="totalValue">‚Ç¨0,00</div></div>
                    <div class="stat-card"><div class="stat-label">üëõ Wallets</div><div class="stat-value blue" id="walletCount">0</div></div>
                    <div class="stat-card"><div class="stat-label">ü™ô Token</div><div class="stat-value" id="tokenCount">0</div></div>
                    <div class="stat-card"><div class="stat-label">‚õìÔ∏è Chain</div><div class="stat-value" id="chainCount">0</div></div>
                </div>
                <div class="chart-container">
                    <div class="chart-card"><div class="card-title mb-16">üìä Distribuzione</div><canvas id="portfolioChart"></canvas></div>
                    <div class="chart-card"><div class="card-title mb-16">üèÜ Top Holdings</div><div id="topHoldings"></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">ü™ô Token</div></div>
                    <div id="tokenList"><div class="loading"><div class="spinner"></div> Caricamento...</div></div>
                </div>
            </div>
            
            <div id="page-wallets" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Wallets</h1>
                    <button onclick="showAddWalletModal()" class="btn btn-primary">‚ûï Aggiungi Wallet</button>
                </div>
                <div id="walletList"><div class="loading"><div class="spinner"></div> Caricamento...</div></div>
            </div>
            
            <div id="page-transactions" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Transazioni</h1>
                    <select id="txYearFilter" class="input" style="width:120px;" onchange="loadTransactions()">
                        <option value="">Tutti</option><option value="2024">2024</option><option value="2023">2023</option>
                    </select>
                </div>
                <div class="card"><div id="transactionList"><p class="text-secondary">Nessuna transazione</p></div></div>
            </div>
            
            <div id="page-tax" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Report Fiscale</h1>
                    <select id="taxYear" class="input" style="width:120px;" onchange="loadTaxReport()">
                        <option value="2024">2024</option><option value="2023">2023</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">üìà Plusvalenze</div><div class="stat-value text-green" id="taxGains">‚Ç¨0</div></div>
                    <div class="stat-card"><div class="stat-label">üìâ Minusvalenze</div><div class="stat-value text-red" id="taxLosses">‚Ç¨0</div></div>
                    <div class="stat-card"><div class="stat-label">üìä Netto</div><div class="stat-value" id="taxNet">‚Ç¨0</div></div>
                    <div class="stat-card"><div class="stat-label">üáÆüáπ Giacenza Media</div><div class="stat-value" id="giacenzaMedia">‚Ç¨0</div></div>
                </div>
            </div>
            
            <div id="page-settings" style="display:none;">
                <div class="page-header"><h1 class="page-title">Impostazioni</h1></div>
                <div class="card">
                    <div class="card-title mb-16">üë§ Profilo</div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" id="settingsEmail" class="input" disabled></div>
                    <div class="form-group"><label class="form-label">Valuta</label><select id="settingsCurrency" class="input" onchange="saveSettings()"><option value="eur">EUR</option><option value="usd">USD</option></select></div>
                    <div class="form-group"><label class="form-label">Metodo Fiscale</label><select id="settingsTaxMethod" class="input" onchange="saveSettings()"><option value="lifo">LIFO</option><option value="fifo">FIFO</option></select></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="addWalletModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">‚ûï Aggiungi Wallet</h2><button class="modal-close" onclick="closeModal('addWalletModal')">&times;</button></div>
            <div class="form-group"><label class="form-label">Nome</label><input type="text" id="walletName" class="input" placeholder="Es: MetaMask"></div>
            <div class="form-group"><label class="form-label">Indirizzo</label><input type="text" id="walletAddress" class="input" placeholder="0x..."></div>
            <div class="form-group"><label class="form-label">Tipo</label><select id="walletType" class="input"><option value="evm">EVM</option><option value="solana">Solana</option></select></div>
            <div class="flex gap-8" style="margin-top:20px;">
                <button onclick="closeModal('addWalletModal')" class="btn btn-secondary" style="flex:1;">Annulla</button>
                <button onclick="addWallet()" class="btn btn-primary" style="flex:1;">‚ûï Aggiungi</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://welnvmqfnceszrvpjoju.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbG52bXFmbmNlc3pydnBqb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODU5NDksImV4cCI6MjA4NTQ2MTk0OX0.XyUPf7r0GvhoxADFPpG1hc6KCQ0gkvSfbYzywl_D-us';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let userProfile = null;
        let currency = 'eur';
        let portfolioChart = null;
        
        const CHAIN_COLORS = { eth:'#627eea', bsc:'#f3ba2f', polygon:'#8247e5', arbitrum:'#28a0f0', base:'#0052ff', avalanche:'#e84142', fantom:'#1969ff', cronos:'#002d74', pulse:'#00ff00', solana:'#9945FF' };
        const CHAIN_NAMES = { eth:'Ethereum', bsc:'BNB Chain', polygon:'Polygon', arbitrum:'Arbitrum', base:'Base', avalanche:'Avalanche', fantom:'Fantom', cronos:'Cronos', pulse:'PulseChain', solana:'Solana' };
        
        async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            if (session) { currentUser = session.user; await loadUserProfile(); showApp(); }
            else { showAuth(); }
        }
        
        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) { document.getElementById('authError').textContent = error.message; return; }
            currentUser = data.user;
            await loadUserProfile();
            showApp();
        }
        
        async function handleSignup() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            if (password.length < 6) { document.getElementById('authError').textContent = 'Password min 6 caratteri'; return; }
            const { data, error } = await db.auth.signUp({ email, password });
            if (error) { document.getElementById('authError').textContent = error.message; return; }
            await db.from('user_profiles').insert({ id: data.user.id, email: email, preferred_currency: 'eur', tax_method: 'lifo' });
            currentUser = data.user;
            await loadUserProfile();
            showApp();
            showToast('Account creato! üéâ');
        }
        
        async function handleLogout() { await db.auth.signOut(); currentUser = null; showAuth(); }
        
        async function loadUserProfile() {
            const { data } = await db.from('user_profiles').select('*').eq('id', currentUser.id).single();
            if (data) { userProfile = data; currency = data.preferred_currency || 'eur'; }
        }
        
        function showAuth() { document.getElementById('authScreen').style.display = 'flex'; document.getElementById('appScreen').style.display = 'none'; }
        function showApp() { document.getElementById('authScreen').style.display = 'none'; document.getElementById('appScreen').style.display = 'flex'; loadDashboard(); }
        
        function showPage(page) {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
            document.getElementById(`page-${page}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            if (page === 'dashboard') loadDashboard();
            if (page === 'wallets') loadWallets();
            if (page === 'transactions') loadTransactions();
            if (page === 'tax') loadTaxReport();
            if (page === 'settings') loadSettings();
        }
        
        async function loadDashboard() {
            const { data: summary } = await db.rpc('get_portfolio_summary', { p_user_id: currentUser.id });
            if (summary && summary[0]) {
                document.getElementById('totalValue').textContent = formatCurrency(currency === 'eur' ? summary[0].total_value_eur : summary[0].total_value_usd);
                document.getElementById('tokenCount').textContent = summary[0].token_count || 0;
                document.getElementById('chainCount').textContent = summary[0].chain_count || 0;
            }
            const { count } = await db.from('wallets').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
            document.getElementById('walletCount').textContent = count || 0;
            await loadTopHoldings();
            await loadTokenList();
        }
        
        async function loadTopHoldings() {
            const { data: holdings } = await db.rpc('get_top_holdings', { p_user_id: currentUser.id, p_limit: 7, p_currency: currency });
            if (!holdings || holdings.length === 0) { document.getElementById('topHoldings').innerHTML = '<p class="text-secondary">Nessun asset</p>'; return; }
            
            const ctx = document.getElementById('portfolioChart');
            if (portfolioChart) portfolioChart.destroy();
            portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: holdings.map(h => h.symbol), datasets: [{ data: holdings.map(h => h.total_value), backgroundColor: ['#3fb950','#58a6ff','#a371f7','#f85149','#d29922','#8b949e','#238636'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });
            
            let html = '';
            holdings.forEach(h => {
                const color = CHAIN_COLORS[h.chains?.[0]] || '#888';
                html += `<div class="flex items-center justify-between" style="padding:10px 0;border-bottom:1px solid var(--border);"><div class="flex items-center gap-8"><div class="token-icon" style="background:${color}30;color:${color};">${h.symbol.slice(0,3)}</div><div><div class="token-symbol">${h.symbol}</div><div class="token-name">${formatNumber(h.total_amount)}</div></div></div><div class="text-right"><div style="font-weight:600;">${formatCurrency(h.total_value)}</div><div class="text-secondary" style="font-size:12px;">${h.percentage}%</div></div></div>`;
            });
            document.getElementById('topHoldings').innerHTML = html;
        }
        
        async function loadTokenList() {
            const { data: balances } = await db.from('balances').select('*').eq('user_id', currentUser.id).gt('amount', 0).order('value_eur', { ascending: false });
            if (!balances || balances.length === 0) { document.getElementById('tokenList').innerHTML = '<p class="text-secondary">Nessun token</p>'; return; }
            let html = '<table class="table"><thead><tr><th>Token</th><th>Chain</th><th class="text-right">Quantit√†</th><th class="text-right">Valore</th></tr></thead><tbody>';
            balances.filter(b => !b.is_hidden).forEach(b => {
                const value = currency === 'eur' ? b.value_eur : b.value_usd;
                const color = CHAIN_COLORS[b.chain] || '#888';
                html += `<tr><td><div class="token-row"><div class="token-icon" style="background:${color}30;color:${color};">${b.symbol.slice(0,3)}</div><span class="token-symbol">${b.symbol}</span></div></td><td><span class="chain-badge" style="background:${color}25;color:${color};">${CHAIN_NAMES[b.chain]||b.chain}</span></td><td class="text-right font-mono">${formatNumber(b.amount)}</td><td class="text-right text-green">${formatCurrency(value)}</td></tr>`;
            });
            document.getElementById('tokenList').innerHTML = html + '</tbody></table>';
        }
        
        async function loadWallets() {
            const { data: wallets } = await db.from('wallets').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            if (!wallets || wallets.length === 0) { document.getElementById('walletList').innerHTML = '<div class="card"><p class="text-secondary">Nessun wallet</p></div>'; return; }
            let html = '';
            for (const w of wallets) {
                const { data: sumData } = await db.from('balances').select('value_eur').eq('wallet_id', w.id);
                const total = sumData?.reduce((s, b) => s + (b.value_eur || 0), 0) || 0;
                html += `<div class="card" style="margin-bottom:16px;"><div class="flex items-center justify-between mb-16"><div><h3 style="font-size:16px;">${w.name||'Wallet'}</h3><code class="text-secondary" style="font-size:12px;">${w.address.slice(0,10)}...${w.address.slice(-6)}</code></div><div class="text-right"><div style="font-size:20px;font-weight:600;color:var(--green);">${formatCurrency(total)}</div></div></div><button onclick="deleteWallet('${w.id}')" class="btn btn-danger">üóëÔ∏è Elimina</button></div>`;
            }
            document.getElementById('walletList').innerHTML = html;
        }
        
        function showAddWalletModal() { document.getElementById('addWalletModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        async function addWallet() {
            const name = document.getElementById('walletName').value;
            const address = document.getElementById('walletAddress').value.trim();
            if (!address) { showToast('Inserisci indirizzo', 'error'); return; }
            const { error } = await db.from('wallets').insert({ user_id: currentUser.id, address, name: name || null, wallet_type: document.getElementById('walletType').value });
            if (error) { showToast(error.message, 'error'); return; }
            closeModal('addWalletModal');
            document.getElementById('walletName').value = '';
            document.getElementById('walletAddress').value = '';
            showToast('Wallet aggiunto! üéâ');
            loadWallets();
        }
        
        async function deleteWallet(id) { if (!confirm('Eliminare?')) return; await db.from('wallets').delete().eq('id', id); showToast('Eliminato'); loadWallets(); }
        
        async function loadTransactions() {
            const year = document.getElementById('txYearFilter').value;
            let query = db.from('transactions').select('*').eq('user_id', currentUser.id).order('tx_timestamp', { ascending: false }).limit(50);
            if (year) query = query.eq('tax_year', parseInt(year));
            const { data } = await query;
            if (!data || data.length === 0) { document.getElementById('transactionList').innerHTML = '<p class="text-secondary">Nessuna transazione</p>'; return; }
            let html = '<table class="table"><thead><tr><th>Data</th><th>Tipo</th><th>Token</th><th class="text-right">Valore</th></tr></thead><tbody>';
            data.forEach(tx => { html += `<tr><td>${new Date(tx.tx_timestamp).toLocaleDateString('it-IT')}</td><td>${tx.tx_type}</td><td>${tx.token_in_symbol||tx.token_out_symbol||'-'}</td><td class="text-right">${formatCurrency(tx.value_eur)}</td></tr>`; });
            document.getElementById('transactionList').innerHTML = html + '</tbody></table>';
        }
        
        async function loadTaxReport() {
            const year = parseInt(document.getElementById('taxYear').value);
            const { data: s } = await db.rpc('get_tax_summary', { p_user_id: currentUser.id, p_year: year });
            if (s && s[0]) { document.getElementById('taxGains').textContent = formatCurrency(s[0].total_gains_eur); document.getElementById('taxLosses').textContent = formatCurrency(s[0].total_losses_eur); document.getElementById('taxNet').textContent = formatCurrency(s[0].net_gain_loss_eur); }
            const { data: g } = await db.rpc('calculate_giacenza_media', { p_user_id: currentUser.id, p_year: year });
            if (g && g[0]) { document.getElementById('giacenzaMedia').textContent = formatCurrency(g[0].giacenza_media_eur); }
        }
        
        function loadSettings() { document.getElementById('settingsEmail').value = currentUser.email; document.getElementById('settingsCurrency').value = userProfile?.preferred_currency || 'eur'; document.getElementById('settingsTaxMethod').value = userProfile?.tax_method || 'lifo'; }
        async function saveSettings() { await db.from('user_profiles').update({ preferred_currency: document.getElementById('settingsCurrency').value, tax_method: document.getElementById('settingsTaxMethod').value }).eq('id', currentUser.id); currency = document.getElementById('settingsCurrency').value; showToast('Salvato!'); }
        
        function formatCurrency(v) { return (currency === 'eur' ? '‚Ç¨' : '$') + (parseFloat(v) || 0).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatNumber(v) { const n = parseFloat(v) || 0; return n < 0.0001 ? n.toExponential(2) : n < 1 ? n.toFixed(6) : n.toLocaleString('it-IT', { maximumFractionDigits: 4 }); }
        function toggleCurrency() { currency = currency === 'eur' ? 'usd' : 'eur'; document.getElementById('currencyBtn').textContent = currency === 'eur' ? 'üí∂ EUR' : 'üíµ USD'; loadDashboard(); }
        function showToast(msg, type = 'success') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
        
        checkAuth();
        db.auth.onAuthStateChange((e, s) => { if (e === 'SIGNED_OUT') showAuth(); });
    </script>
</body>
</html>
