<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CryptoFolio v7.75</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#16213e;--border:#2d2d44;--grid:#1e1e35;--text:#fff;--text2:#a0a0a0;--green:#00cec9;--red:#ff6b6b;--blue:#6c5ce7;--yellow:#fdcb6e;--cyan:#00b894;--purple:#a29bfe}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}.sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);padding:16px;position:fixed;height:100vh;display:flex;flex-direction:column}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:30px}.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),#a29bfe);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}.logo-text{font-size:18px;font-weight:700}
.nav{padding:10px 14px;color:var(--text2);cursor:pointer;border-radius:8px;margin-bottom:4px;display:flex;align-items:center;gap:10px;font-size:14px}.nav:hover{background:var(--bg3)}.nav.active{background:var(--blue);color:#fff}
.sidebar-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}
.main{flex:1;margin-left:220px;padding:24px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.title{font-size:24px;font-weight:600}.card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px}
.stat{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px}.stat-label{font-size:12px;color:var(--text2);margin-bottom:6px}.stat-value{font-size:22px;font-weight:700;color:var(--green)}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:#a29bfe}.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}.btn-danger{background:var(--red);color:#fff}.btn-sm{padding:6px 12px;font-size:11px}
.input{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;width:100%}.input:focus{outline:none;border-color:var(--blue)}
.table{width:100%;border-collapse:collapse;table-layout:fixed}.table th,.table td{padding:14px 12px;border:1px solid var(--grid);vertical-align:middle}.table th{text-align:left;color:var(--text2);font-size:11px;text-transform:uppercase;font-weight:500;background:var(--bg2)}.table td{background:var(--bg3)}.table tr:hover td{background:var(--bg2)}
.token-cell{display:flex;align-items:center;gap:10px}.token-icon{width:32px;height:32px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:10px;overflow:hidden;flex-shrink:0}.token-icon img{width:100%;height:100%;object-fit:cover}
.token-info{min-width:0}.token-info .symbol{font-weight:600;font-size:13px}.token-info .name{font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}.badge-ok{background:var(--green);color:#000}.badge-bad{background:var(--red);color:#fff}.badge-unk{background:var(--bg2);color:var(--text2)}
.chain-tag{display:inline-block;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:500;white-space:nowrap}
.text-mono{font-family:'SF Mono',Monaco,monospace;font-size:12px}.text-right{text-align:right!important}.text-center{text-align:center!important}
.top-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);gap:12px}.top-item:last-child{border-bottom:none}
.top-icon{flex-shrink:0}.top-info{flex:1;min-width:0}.top-row1{display:flex;align-items:center;gap:6px;margin-bottom:2px}.top-sym{font-weight:600;font-size:13px}.top-amt{font-size:10px;color:var(--text2)}
.top-values{text-align:right;flex-shrink:0}.top-val{font-weight:700;font-size:14px;color:var(--green)}.top-pct{font-size:10px;color:var(--text2)}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}.chart-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px}.chart-wrap{height:220px;position:relative}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:20px;width:95%;max-width:520px;max-height:85vh;overflow-y:auto}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}.modal-title{font-size:16px;font-weight:600}.modal-close{background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer}
.auth-box{min-height:100vh;display:flex;align-items:center;justify-content:center}.auth-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:28px;width:100%;max-width:340px}
.form-group{margin-bottom:14px}.form-label{display:block;margin-bottom:6px;font-size:12px;color:var(--text2)}
.progress{width:100%;height:6px;background:var(--bg2);border-radius:4px;overflow:hidden}.progress-bar{height:100%;background:linear-gradient(90deg,var(--green),var(--blue));transition:width .3s}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{to{transform:rotate(360deg)}}
.scan-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px}
.scan-log{background:var(--bg);border-radius:6px;padding:8px;max-height:150px;overflow-y:auto;font-family:'SF Mono',Monaco,monospace;font-size:10px;margin-top:8px}
.log-ok{color:var(--green)}.log-err{color:var(--red)}.log-info{color:var(--text2)}.log-warn{color:var(--yellow)}
.flex{display:flex}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-4{gap:4px}.gap-8{gap:8px}.gap-12{gap:12px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px 16px;z-index:2000;font-size:13px}.toast.success{border-left:4px solid var(--green)}.toast.error{border-left:4px solid var(--red)}
.tabs{display:flex;gap:8px;margin-bottom:16px}.tab{padding:8px 16px;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;font-size:13px}.tab.active{color:var(--green);border-bottom-color:var(--green)}
.chain-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.chain-item{display:flex;align-items:center;gap:6px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px}
.chain-item.active{border-color:var(--green);background:rgba(0,206,201,.1)}.chain-item input{accent-color:var(--green)}
.chain-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.api-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chk{width:18px;height:18px;accent-color:var(--red);cursor:pointer}
.bulk-bar{background:var(--red);color:#fff;padding:10px 16px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.charts{grid-template-columns:1fr}.chain-grid{grid-template-columns:repeat(2,1fr)}.api-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="authScreen" class="auth-box">
<div class="auth-card">
<div class="logo" style="justify-content:center;margin-bottom:20px"><div class="logo-icon">üíé</div><div class="logo-text">CryptoFolio</div></div>
<p style="color:var(--text2);text-align:center;margin-bottom:20px;font-size:12px">v7.75 - 17 Chains</p>
<div class="form-group"><label class="form-label">Email</label><input id="authEmail" type="email" class="input"></div>
<div class="form-group"><label class="form-label">Password</label><input id="authPassword" type="password" class="input"></div>
<div id="authError" style="color:var(--red);font-size:12px;margin-bottom:12px"></div>
<div class="flex gap-8"><button onclick="handleLogin()" class="btn btn-primary" style="flex:1">Login</button><button onclick="handleSignup()" class="btn btn-secondary" style="flex:1">Registrati</button></div>
</div>
</div>
<div id="appScreen" class="app" style="display:none">
<aside class="sidebar">
<div class="logo"><div class="logo-icon">üíé</div><div class="logo-text">CryptoFolio</div></div>
<nav><div class="nav active" data-page="dashboard" onclick="showPage('dashboard')">üìä Dashboard</div><div class="nav" data-page="wallets" onclick="showPage('wallets')">üëõ Wallets</div><div class="nav" data-page="exchange" onclick="showPage('exchange')">üè¶ Exchange</div><div class="nav" data-page="tokens" onclick="showPage('tokens')">ü™ô Token</div><div class="nav" data-page="settings" onclick="showPage('settings')">‚öôÔ∏è Settings</div></nav>
<div class="sidebar-footer">v7.75<br>üåê 17 chains<br><span id="apiStatus">üîë 4 keys</span><br><button onclick="handleLogout()" class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:11px">üö™ Logout</button></div>
</aside>
<main class="main">
<div id="page-dashboard">
<div class="header"><h1 class="title">Dashboard</h1><div class="flex gap-8"><button id="currencyBtn" onclick="toggleCurrency()" class="btn btn-secondary btn-sm">üí∂ EUR</button><button onclick="refreshPrices()" class="btn btn-secondary btn-sm">üîÑ</button></div></div>
<div class="stats"><div class="stat"><div class="stat-label">Valore Totale</div><div class="stat-value" id="totalValue">‚Ç¨0</div></div><div class="stat"><div class="stat-label">Token</div><div class="stat-value" id="totalTokens">0</div></div><div class="stat"><div class="stat-label">Wallets</div><div class="stat-value" id="totalWallets">0</div></div><div class="stat"><div class="stat-label">Chains</div><div class="stat-value" id="totalChains">0</div></div></div>
<div class="charts"><div class="chart-card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">üìä Per Chain</div><div class="chart-wrap"><canvas id="chainChart"></canvas></div></div><div class="chart-card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">üèÜ Top 5</div><div id="topList"></div></div></div>
</div>
<div id="page-wallets" style="display:none">
<div class="header"><h1 class="title">Wallets</h1><button onclick="showAddWallet()" class="btn btn-primary btn-sm">‚ûï Aggiungi</button></div>
<div id="walletScanBox" class="scan-box" style="display:none"><div class="flex justify-between items-center mb-12"><span id="walletScanTitle">üîç Scansione...</span><span id="walletScanPct">0%</span></div><div class="progress"><div class="progress-bar" id="walletScanBar" style="width:0%"></div></div><div id="walletScanStatus" style="font-size:11px;color:var(--text2);margin-top:6px"></div><div class="scan-log" id="walletScanLog"></div></div>
<div class="card"><div id="walletsList"></div></div>
</div>
<div id="page-wallet-detail" style="display:none">
<div class="header">
<div class="flex items-center gap-12"><button onclick="showPage('wallets')" class="btn btn-secondary btn-sm">‚Üê</button><h1 class="title" id="wdName">Wallet</h1></div>
<div class="flex gap-8"><button onclick="scanCurrentWallet()" class="btn btn-primary btn-sm">üîç Scan</button><button onclick="loadWalletTx()" class="btn btn-secondary btn-sm">üìú TX</button><button onclick="deleteCurrentWallet()" class="btn btn-sm" style="background:var(--red)20;color:var(--red)">üóëÔ∏è</button></div>
</div>
<div id="wdScanBox" class="scan-box" style="display:none"><div class="flex justify-between items-center mb-12"><span id="wdScanTitle">üîç Scansione...</span><span id="wdScanPct">0%</span></div><div class="progress"><div class="progress-bar" id="wdScanBar" style="width:0%"></div></div><div id="wdScanStatus" style="font-size:11px;color:var(--text2);margin-top:6px"></div><div class="scan-log" id="wdScanLog"></div></div>
<div class="card mb-16"><div class="flex justify-between items-center"><div><div style="font-size:11px;color:var(--text2)">Indirizzo</div><code id="wdAddr" style="font-size:9px;word-break:break-all"></code></div><div style="text-align:right"><div style="font-size:22px;font-weight:700;color:var(--green)" id="wdValue">‚Ç¨0</div><div style="font-size:11px;color:var(--text2)"><span id="wdTokens">0</span> token</div></div></div></div>
<div class="card mb-16"><div onclick="document.getElementById('wdChainSection').style.display=document.getElementById('wdChainSection').style.display==='none'?'block':'none'" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;font-weight:600">‚õìÔ∏è Chain da scansionare</span><span style="font-size:10px;color:var(--text2)">‚ñº espandi</span></div><div id="wdChainSection" style="display:none;margin-top:12px"><div id="wdChainGrid" class="chain-grid"></div><button onclick="saveWalletChains()" class="btn btn-primary btn-sm" style="margin-top:12px;width:100%">üíæ Salva Chain</button></div></div>
<div class="tabs"><div class="tab active" onclick="showWalletTab('tokens')">ü™ô Token</div><div class="tab" onclick="showSavedTx()">üìú TX</div></div>
<div id="bulkBar" class="bulk-bar" style="display:none"><span id="bulkCount">0 selezionati</span><div class="flex gap-8"><button onclick="selectAllTokens()" class="btn btn-sm btn-secondary">Tutti</button><button onclick="deselectAllTokens()" class="btn btn-sm btn-secondary">Nessuno</button><button onclick="deleteSelectedTokens()" class="btn btn-sm btn-danger">üóëÔ∏è Elimina</button></div></div>
<div class="card" id="wdTokensTab" style="max-height:500px;overflow-y:auto"></div>
<div class="card" id="wdTxTab" style="display:none;max-height:500px;overflow-y:auto"></div>
</div>
<div id="page-exchange" style="display:none">
<div class="header"><h1 class="title">üè¶ Exchanges</h1><div class="flex gap-8"><button onclick="resetExchangeData()" class="btn btn-sm" style="background:var(--red)20;color:var(--red)">üóëÔ∏è Reset</button><button onclick="showApiModal()" class="btn btn-secondary btn-sm">üîó Connetti API</button><button onclick="showImportModal()" class="btn btn-primary btn-sm">üì• Import CSV</button><button onclick="showEarnReport()" class="btn btn-sm" style="background:linear-gradient(135deg,#f7971e,#ffd200);color:#000">üéÅ Report Earn</button><button onclick="calcRW()" class="btn btn-sm" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff">üìã Calcola RW</button></div></div>
<div class="card mb-16" style="background:linear-gradient(135deg,rgba(243,186,47,0.1),rgba(0,230,118,0.1))">
<div style="font-size:13px;font-weight:600;margin-bottom:12px">üìä Riepilogo per Anno Fiscale</div>
<div style="font-size:9px;color:var(--text2);margin-bottom:8px">üì• Depositi EUR | üì§ Prelievi EUR | üéÅ Rewards | üõí Acquisti | üí∞ Vendite</div>
<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px" id="exYearGrid">
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2021</div><div id="exYear2021">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2022</div><div id="exYear2022">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2023</div><div id="exYear2023">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2024</div><div id="exYear2024">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2025</div><div id="exYear2025">0 TX</div></div>
<div style="background:var(--card);border-radius:8px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--text2)">2026</div><div id="exYear2026">0 TX</div></div>
</div>
</div>
<div id="exExchangeGrid" style="display:flex;flex-direction:column;gap:16px"></div>
</div>
<div id="page-exchange-detail" style="display:none">
<div class="header"><button onclick="showPage('exchange')" class="btn btn-secondary btn-sm">‚Üê Indietro</button><h1 class="title" id="exDetailName" style="margin-left:12px">Exchange</h1><button onclick="resetCurrentExchange()" class="btn btn-sm" style="margin-left:auto;background:var(--red)20;color:var(--red)">üóëÔ∏è Reset</button></div>
<div class="stats"><div class="stat"><div class="stat-label">Transazioni</div><div class="stat-value" id="exDetailTx">0</div></div><div class="stat"><div class="stat-label">Coin</div><div class="stat-value" id="exDetailCoins">0</div></div><div class="stat"><div class="stat-label">Depositi ‚Ç¨</div><div class="stat-value" style="color:var(--green)" id="exDetailIn">‚Ç¨0</div></div><div class="stat"><div class="stat-label">Prelievi ‚Ç¨</div><div class="stat-value" style="color:var(--red)" id="exDetailOut">‚Ç¨0</div></div></div>
<div class="card mb-16">
<div class="flex gap-8 mb-12 flex-wrap"><select id="exDetailYear" class="input" style="width:100px" onchange="loadExchangeDetail()"><option value="">Tutti</option><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option><option value="2021">2021</option></select><select id="exDetailType" class="input" style="width:120px" onchange="loadExchangeDetail()"><option value="">Tutti tipi</option><option value="deposit">üì• Depositi</option><option value="withdraw">üì§ Prelievi</option><option value="trade_buy">üõí Acquisti</option><option value="trade_sell">üí∞ Vendite</option><option value="reward">üéÅ Rewards</option><option value="convert">üîÑ Convert</option><option value="fee">üí∏ Fee</option><option value="payment">üí≥ Pagamenti</option><option value="transfer">‚ÜîÔ∏è Transfer</option></select><input type="text" id="exDetailSearch" class="input" placeholder="üîç Cerca coin..." oninput="loadExchangeDetail()" style="flex:1;min-width:150px"></div>
<div id="exDetailList" style="max-height:500px;overflow-y:auto;padding-right:12px"></div>
</div>
</div>
<div id="page-tokens" style="display:none">
<div class="header"><h1 class="title">Token Manager</h1><div class="flex gap-8"><button onclick="showWhitelist()" class="btn btn-secondary btn-sm">‚úÖ WL</button><button onclick="showBlacklist()" class="btn btn-secondary btn-sm">üö´ BL</button></div></div>
<div class="card">
<div class="flex gap-8 mb-16"><input type="text" id="tmSearch" class="input" placeholder="üîç Cerca..." oninput="renderTM()" style="flex:1"><select id="tmFilter" class="input" style="width:130px" onchange="renderTM()"><option value="visible">üëÅ Visibili</option><option value="hidden">üö´ Nascosti</option><option value="all">üìã Tutti</option></select></div>
<div id="tmList" style="max-height:500px;overflow-y:auto"></div>
</div>
</div>
<div id="page-settings" style="display:none">
<div class="header"><h1 class="title">Impostazioni</h1></div>
<div class="card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">üîë API Keys Moralis</div><div class="api-grid"><div class="form-group"><label class="form-label">Key 1</label><input id="apiKey1" class="input"></div><div class="form-group"><label class="form-label">Key 2</label><input id="apiKey2" class="input"></div><div class="form-group"><label class="form-label">Key 3</label><input id="apiKey3" class="input"></div><div class="form-group"><label class="form-label">Key 4</label><input id="apiKey4" class="input"></div></div><button onclick="saveApiKeys()" class="btn btn-primary" style="margin-top:8px">üíæ Salva</button></div>
<div class="card"><div class="form-group"><label class="form-label">Valuta</label><select id="setCurrency" class="input" onchange="saveCurrency()"><option value="eur">EUR</option><option value="usd">USD</option></select></div></div>
<div class="card"><div style="font-size:13px;margin-bottom:12px;font-weight:600">üö´ Blacklist Stats</div><div id="blStats" style="font-size:12px;color:var(--text2)"></div></div>
<div class="card"><div class="flex gap-8"><button onclick="exportCSV()" class="btn btn-secondary">üì§ CSV</button><button onclick="clearBlacklist()" class="btn btn-secondary">üßπ Reset BL</button><button onclick="clearAllData()" class="btn btn-danger">üóëÔ∏è Reset</button></div></div>
</div>
</main>
</div>
<div id="addWalletModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">‚ûï Aggiungi Wallet</h2><button class="modal-close" onclick="closeModal('addWalletModal')">&times;</button></div><div class="form-group"><label class="form-label">Nome</label><input id="wName" class="input" placeholder="MetaMask..."></div><div class="form-group"><label class="form-label">Indirizzo</label><input id="wAddr" class="input" placeholder="0x..."></div><div class="form-group"><label class="form-label">Chain</label><div class="flex gap-8 mb-12"><button onclick="selectAllChains()" class="btn btn-sm btn-primary">‚úÖ Tutte</button><button onclick="selectNoChains()" class="btn btn-sm btn-secondary">‚ùå Nessuna</button></div><div id="modalChainGrid" class="chain-grid"></div></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('addWalletModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="addWallet()" class="btn btn-primary" style="flex:1">‚ûï Aggiungi</button></div></div></div>
<div id="wlModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">‚úÖ Whitelist</h2><button class="modal-close" onclick="closeModal('wlModal')">&times;</button></div><div class="flex gap-8 mb-16"><input id="wlAdd" class="input" placeholder="Simbolo (es. BTC)"><button onclick="addToWhitelist()" class="btn btn-primary btn-sm">‚ûï</button></div><div id="wlList" style="max-height:300px;overflow-y:auto"></div></div></div>
<div id="blModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">üö´ Blacklist</h2><button class="modal-close" onclick="closeModal('blModal')">&times;</button></div><div class="tabs mb-12"><div class="tab active" onclick="showBlTab('symbols')">Simboli (<span id="blSymCount">0</span>)</div><div class="tab" onclick="showBlTab('contracts')">Contratti (<span id="blConCount">0</span>)</div></div><div id="blSymbols"><div class="flex gap-8 mb-16"><input id="blAdd" class="input" placeholder="Simbolo"><button onclick="addToBlacklist()" class="btn btn-primary btn-sm">‚ûï</button></div><div id="blList" style="max-height:250px;overflow-y:auto"></div></div><div id="blContracts" style="display:none"><div id="blConList" style="max-height:300px;overflow-y:auto;font-size:10px"></div></div></div></div>
<div id="importModal" class="modal-bg" style="display:none"><div class="modal"><div class="modal-head"><h2 class="modal-title">üì• Import CSV Exchange</h2><button class="modal-close" onclick="closeModal('importModal')">&times;</button></div><div class="form-group"><label class="form-label">Exchange</label><select id="importExchange" class="input"><option value="binance">Binance</option><option value="bitget">Bitget</option><option value="bitpanda">Bitpanda</option><option value="bybit">Bybit</option><option value="bybit_eu">Bybit EU</option><option value="cake">PancakeSwap (CAKE)</option><option value="coinbase">Coinbase</option><option value="crypto_com">Crypto.com</option><option value="gate">Gate.io</option><option value="kraken">Kraken</option><option value="kucoin">KuCoin</option><option value="mexc">MEXC</option><option value="nexo">Nexo</option><option value="okx">OKX</option><option value="pionex">Pionex</option><option value="revolut">Revolut</option><option value="whitebit">WhiteBIT</option><option value="youhodler">YouHodler</option><option value="youngplatform">Young Platform</option><option value="cosmos">Cosmos (ATOM)</option><option value="osmosis">Osmosis (OSMO)</option><option value="terra">Terra (LUNC)</option><option value="pulsechain">PulseChain</option><option value="manta">Manta Pacific</option><option value="other">Altro</option></select></div><div class="form-group"><label class="form-label">File CSV o ZIP</label><input type="file" id="importFile" accept=".csv,.zip" class="input" multiple><div style="font-size:10px;color:var(--text2);margin-top:4px">Puoi caricare CSV singoli o ZIP con pi√π CSV</div><div style="font-size:10px;color:var(--green);margin-top:2px">‚úì I duplicati vengono ignorati automaticamente</div></div><div id="importPreview" style="display:none;margin:12px 0;padding:12px;background:var(--card);border-radius:8px"><div style="font-size:11px;color:var(--text2)" id="importInfo"></div></div><div id="importProgress" style="display:none;margin:12px 0"><div class="progress"><div class="progress-bar" id="importBar" style="width:0%"></div></div><div style="font-size:11px;color:var(--text2);margin-top:4px" id="importStatus"></div></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('importModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="importCSV()" class="btn btn-primary" style="flex:1" id="importBtn">üì• Importa</button></div></div></div>
<div id="apiModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:500px"><div class="modal-head"><h2 class="modal-title">üîó Connetti API Exchange</h2><button class="modal-close" onclick="closeModal('apiModal')">&times;</button></div><div class="form-group"><label class="form-label">Exchange</label><select id="apiExchange" class="input"><option value="binance">Binance</option></select></div><div id="apiHelp" style="background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;font-size:11px"><strong>üìã Come ottenere le API Binance:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.binance.com/it/my/settings/api-management" target="_blank" style="color:var(--primary)">Binance API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo "Read" (nessun permesso di trading!)</li><li>Copia API Key e Secret qui sotto</li></ol></div><div class="form-group"><label class="form-label">API Key</label><input type="text" id="apiKey2" class="input" placeholder="La tua API Key..."></div><div class="form-group"><label class="form-label">Secret Key</label><input type="password" id="apiSecret" class="input" placeholder="Il tuo Secret..."></div><div id="apiStatus" style="display:none;margin:12px 0;padding:12px;border-radius:8px;font-size:12px"></div><div class="flex gap-8" style="margin-top:16px"><button onclick="closeModal('apiModal')" class="btn btn-secondary" style="flex:1">Annulla</button><button onclick="testAndSyncApi()" class="btn btn-primary" style="flex:1" id="apiSyncBtn">üöÄ Connetti e Sincronizza</button></div></div></div>
<div id="resetModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:400px"><div class="modal-head"><h2 class="modal-title">üóëÔ∏è Reset Dati Exchange</h2><button class="modal-close" onclick="closeModal('resetModal')">&times;</button></div><div style="margin-bottom:16px;color:var(--text2);font-size:13px">Seleziona cosa vuoi cancellare:</div><div id="resetOptions" style="display:flex;flex-direction:column;gap:8px"></div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><button onclick="closeModal('resetModal')" class="btn btn-secondary" style="width:100%">Annulla</button></div></div></div>
<div id="earnModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:700px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column"><div class="modal-head"><h2 class="modal-title">üéÅ Report Earn/Staking</h2><button class="modal-close" onclick="closeModal('earnModal')">&times;</button></div><div id="earnContent" style="overflow-y:auto;flex:1;padding-right:8px"></div><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><button onclick="closeModal('earnModal')" class="btn btn-secondary" style="width:100%">Chiudi</button></div></div></div>
<div id="rwModal" class="modal-bg" style="display:none"><div class="modal" style="max-width:900px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column"><div class="modal-head"><h2 class="modal-title">üìã Quadro RW - Monitoraggio Fiscale</h2><button class="modal-close" onclick="closeModal('rwModal')">&times;</button></div><div id="rwContent" style="flex:1;overflow-y:auto;padding:0 4px"><div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Calcolo saldi e prezzi...</div></div></div><div style="padding:12px 0;border-top:1px solid var(--border);display:flex;gap:8px"><button onclick="exportRW()" class="btn btn-primary" style="flex:1">üì• Esporta CSV</button><button onclick="closeModal('rwModal')" class="btn btn-secondary" style="flex:1">Chiudi</button></div></div></div>
<script>
const SB_URL='https://welnvmqfnceszrvpjoju.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlbG52bXFmbmNlc3pydnBqb2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODU5NDksImV4cCI6MjA4NTQ2MTk0OX0.XyUPf7r0GvhoxADFPpG1hc6KCQ0gkvSfbYzywl_D-us';
const DEF_KEYS=['eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjZjYThhZDhkLTEyMTktNDQ0Ny04ZGQ4LWZiZjlmOTlmYzcwYyIsIm9yZ0lkIjoiNDk2ODU3IiwidXNlcklkIjoiNTExMjY4IiwidHlwZUlkIjoiMmY1NzM4MWItYzNmOS00MDA4LTk5OGYtN2ExMmNiYTAzOWI0IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjkzODIzMzQsImV4cCI6NDkyNTE0MjMzNH0.7cb3HhwH4qmvCYIil3ZWFAYcMD3qEcD3J8J16tAvpbM','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjVlNDJkYTQ5LWFlNmYtNGI2ZC05OTYwLTJkNTUwNGUwZDlmNyIsIm9yZ0lkIjoiNDg3NTI0IiwidXNlcklkIjoiNTAxNTk0IiwidHlwZUlkIjoiY2E1NjEyYzUtMGUzMy00Yzk3LTk1ODktNTA1Yjg4ZmIyNzU1IiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2ODczNjMsImV4cCI6NDkyMjQ0NzM2M30.kwUGFKbnzJsALQww3R_UgZO00cDy50Rvf6OmLMTuu9c','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjE0ZDdlNmIxLTkzNTEtNGIwMi1hZGMzLWQ3NjA3MjllNjMxMiIsIm9yZ0lkIjoiNDk2OTIxIiwidXNlcklkIjoiNTExMzM2IiwidHlwZUlkIjoiYTgwMTE2N2QtNGE4MS00ZjVjLThiNGUtMjg0YTlkNzRlOTljIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3Njk0Mjc1ODIsImV4cCI6NDkyNTE4NzU4Mn0.iqQXubNVxU4I_MSjuQolQNKSo4vRHSnGiyiHjvos5eE','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjhlY2U3NzU0LTE0NjUtNGQzMS1iNjRjLTZiNzQ0ZDk3Y2E3ZSIsIm9yZ0lkIjoiNDg3NTI5IiwidXNlcklkIjoiNTAxNTk5IiwidHlwZUlkIjoiYWNiNzFlZjQtZGQ1Ni00NzExLWI1YmQtYjkyNTdmYjgxNDRiIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NjY2OTQ2MDEsImV4cCI6NDkyMjQ1NDYwMX0.3ygKvNrptS9FkNBcmGIO-gSAKGPh9B3h2VeuHdioty8'];
let KEYS=[...DEF_KEYS],keyIdx=0;
const CHAINS={eth:{n:'Ethereum',hex:'0x1',c:'#627eea',t:'ETH',gp:'1'},bsc:{n:'BNB Chain',hex:'0x38',c:'#f3ba2f',t:'BNB',gp:'56'},polygon:{n:'Polygon',hex:'0x89',c:'#8247e5',t:'POL',gp:'137'},arbitrum:{n:'Arbitrum',hex:'0xa4b1',c:'#28a0f0',t:'ETH',gp:'42161'},optimism:{n:'Optimism',hex:'0xa',c:'#ff0420',t:'ETH',gp:'10'},base:{n:'Base',hex:'0x2105',c:'#0052ff',t:'ETH',gp:'8453'},avalanche:{n:'Avalanche',hex:'0xa86a',c:'#e84142',t:'AVAX',gp:'43114'},fantom:{n:'Fantom',hex:'0xfa',c:'#1969ff',t:'FTM',gp:'250'},cronos:{n:'Cronos',hex:'0x19',c:'#1199fa',t:'CRO',gp:'25'},pulsechain:{n:'PulseChain',hex:'0x171',c:'#00ff00',t:'PLS',gp:'369',rpc:'https://rpc.pulsechain.com',txApi:'https://api.scan.pulsechain.com/api?module=account&action=txlist&address='},blackfort:{n:'Blackfort',hex:'0x1e8',c:'#5c6bc0',t:'BXN',gp:null,rpc:'https://rpc.blackfort.network/mainnet/rpc',txApi:'https://explorer.blackfort.network/api?module=account&action=txlist&address='},linea:{n:'Linea',hex:'0xe708',c:'#61dfff',t:'ETH',gp:'59144'},gnosis:{n:'Gnosis',hex:'0x64',c:'#04795b',t:'xDAI',gp:'100'},cosmos:{n:'Cosmos',hex:null,c:'#6f7390',t:'ATOM',gp:null,lcd:'https://lcd-cosmoshub.keplr.app'},osmosis:{n:'Osmosis',hex:null,c:'#5E12A0',t:'OSMO',gp:null,lcd:'https://lcd-osmosis.keplr.app'},terra:{n:'Terra Classic',hex:null,c:'#FFD83D',t:'LUNC',gp:null,lcd:'https://terra-classic-lcd.publicnode.com'},ton:{n:'TON',hex:null,c:'#0088CC',t:'TON',gp:null,api:'https://toncenter.com/api/v2'}};
const PLS_TOKENS=[{sym:'PLSX',name:'PulseX',contract:'0x95B303987A60C71504D99Aa1b13B4DA07b0790ab',dec:18},{sym:'HEX',name:'HEX',contract:'0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39',dec:8},{sym:'INC',name:'Incentive',contract:'0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d',dec:18},{sym:'WPLS',name:'Wrapped PLS',contract:'0xA1077a294dDE1B09bB078844df40758a5D0f9a27',dec:18},{sym:'DAI',name:'DAI from Ethereum',contract:'0xefD766cCb38EaF1dfd701853BFCe31359239F305',dec:18},{sym:'USDC',name:'USDC from Ethereum',contract:'0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07',dec:6},{sym:'USDT',name:'USDT from Ethereum',contract:'0x0Cb6F5a34ad42ec934882A05265A7d5F59b51A2f',dec:6},{sym:'WETH',name:'WETH from Ethereum',contract:'0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C',dec:18},{sym:'eHEX',name:'HEX from Ethereum',contract:'0x57fde0a71132198BBeC939B98976993d8D89D225',dec:8}];
const NATIVE_ICONS={ETH:'https://assets.coingecko.com/coins/images/279/small/ethereum.png',BNB:'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',POL:'https://assets.coingecko.com/coins/images/4713/small/polygon.png',MATIC:'https://assets.coingecko.com/coins/images/4713/small/polygon.png',AVAX:'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',FTM:'https://assets.coingecko.com/coins/images/4001/small/Fantom_round.png',CRO:'https://assets.coingecko.com/coins/images/7310/small/cro_token_logo.png',xDAI:'https://assets.coingecko.com/coins/images/11062/small/Identity-Primary-DarkBG.png',PLS:'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',PLSX:'https://tokens.app.pulsex.com/images/tokens/0x95B303987A60C71504D99Aa1b13B4DA07b0790ab.png',HEX:'https://tokens.app.pulsex.com/images/tokens/0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39.png',INC:'https://tokens.app.pulsex.com/images/tokens/0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d.png',BXN:'https://assets.coingecko.com/coins/images/15632/small/BXN.png',SHIB:'https://assets.coingecko.com/coins/images/11939/small/shiba.png',BONE:'https://assets.coingecko.com/coins/images/16916/small/bone_icon.png',USDT:'https://assets.coingecko.com/coins/images/325/small/Tether.png',USDC:'https://assets.coingecko.com/coins/images/6319/small/usdc.png',DAI:'https://assets.coingecko.com/coins/images/9956/small/dai-multi-collateral-mcd.png',WETH:'https://assets.coingecko.com/coins/images/2518/small/weth.png',ARB:'https://assets.coingecko.com/coins/images/16547/small/photo_2023-03-29_21.47.00.jpeg',ATOM:'https://assets.coingecko.com/coins/images/1481/small/cosmos_hub.png',OSMO:'https://assets.coingecko.com/coins/images/16724/small/osmo.png',LUNC:'https://assets.coingecko.com/coins/images/8284/small/01_LussssnaC_Logo_Kolor.png',TON:'https://assets.coingecko.com/coins/images/17980/small/ton_symbol.png'};
const EXPLORERS={eth:'https://etherscan.io/tx/',bsc:'https://bscscan.com/tx/',polygon:'https://polygonscan.com/tx/',arbitrum:'https://arbiscan.io/tx/',optimism:'https://optimistic.etherscan.io/tx/',base:'https://basescan.org/tx/',avalanche:'https://snowtrace.io/tx/',fantom:'https://ftmscan.com/tx/',cronos:'https://cronoscan.com/tx/',pulsechain:'https://scan.pulsechain.com/tx/',blackfort:'https://explorer.blackfort.network/tx/',linea:'https://lineascan.build/tx/',gnosis:'https://gnosisscan.io/tx/',cosmos:'https://www.mintscan.io/cosmos/tx/',osmosis:'https://www.mintscan.io/osmosis/tx/',terra:'https://finder.terra.money/classic/tx/',ton:'https://tonscan.org/tx/'};
const VERIFIED=new Set(['ETH','BTC','BNB','USDT','USDC','DAI','WETH','WBTC','WBNB','LINK','UNI','AAVE','MATIC','POL','AVAX','FTM','CRO','SHIB','DOGE','PEPE','CAKE','PLS','PLSX','HEX','INC','WPLS','LOAN','BONE','eHEX','BXN','ARB','GMX','MAGIC','RDNT','GRT','LDO','RPL','PENDLE','STG','OP','VELO','ATOM','OSMO','LUNC','TON']);
const CG_MAP={ETH:'ethereum',BTC:'bitcoin',BNB:'binancecoin',USDT:'tether',USDC:'usd-coin',WETH:'weth',MATIC:'matic-network',POL:'matic-network',AVAX:'avalanche-2',FTM:'fantom',CRO:'crypto-com-chain',LINK:'chainlink',UNI:'uniswap',AAVE:'aave',PLS:'pulsechain',PLSX:'pulsex',HEX:'hex',INC:'incentive',SHIB:'shiba-inu',DOGE:'dogecoin',PEPE:'pepe',CAKE:'pancakeswap-token',BONE:'bone-shibaswap',DAI:'dai',BXN:'bxn',ARB:'arbitrum',GMX:'gmx',MAGIC:'magic',GRT:'the-graph',LDO:'lido-dao',PENDLE:'pendle',STG:'stargate-finance',OP:'optimism',ATOM:'cosmos',OSMO:'osmosis',LUNC:'terra-luna',TON:'the-open-network'};
// SMART SPAM FILTER - Pattern aggressivi
const SPAM_WORDS=['visit','claim','reward','.com','.org','.io','.xyz','.net','.co','airdrop','bonus','free','gift','http','$','#','voucher','promo','winner','congratulation','lucky','surprise','giveaway','drop','swap.','dex.','earn','yield','farm','mine','nft-','mint','presale','private','sale','launch','moon','100x','1000x','üöÄ','üí∞','üéÅ','üìà','telegram','discord'];
const SPAM_PATTERNS=[/^[0-9]+$/,/\d{4,}/,/(.)\1{4,}/,/[^\x00-\x7F]{3,}/];
function isSpam(name,sym){var n=(name||'').toLowerCase(),s=(sym||'').toLowerCase();for(var i=0;i<SPAM_WORDS.length;i++)if(n.includes(SPAM_WORDS[i])||s.includes(SPAM_WORDS[i]))return true;for(var j=0;j<SPAM_PATTERNS.length;j++)if(SPAM_PATTERNS[j].test(n)||SPAM_PATTERNS[j].test(s))return true;if((name||'').length>50||(sym||'').length>15)return true;if(/\s{2,}/.test(name))return true;return false;}
const{createClient}=supabase;const db=createClient(SB_URL,SB_KEY);
let user=null,currency='eur',chart=null,balances=[],prices={},scanning=false,currentWallet=null,inWalletDetail=false;
let whitelist=new Set(JSON.parse(localStorage.getItem('cf_wl')||'[]'));
let blacklist=new Set(JSON.parse(localStorage.getItem('cf_bl')||'[]').map(function(s){return(s||'').toUpperCase();}));
let blacklistContracts=new Set(JSON.parse(localStorage.getItem('cf_bl_contracts')||'[]').map(function(c){return(c||'').toLowerCase();}));
let selectedChains=new Set(JSON.parse(localStorage.getItem('cf_chains')||JSON.stringify(Object.keys(CHAINS))));
let selectedTokenIds=new Set();
function saveBlacklists(){localStorage.setItem('cf_bl',JSON.stringify([...blacklist]));localStorage.setItem('cf_bl_contracts',JSON.stringify([...blacklistContracts]));}
function saveSelectedChains(){localStorage.setItem('cf_chains',JSON.stringify([...selectedChains]));}
function updateBlStats(){var el=document.getElementById('blStats');if(el)el.innerHTML='Simboli: <b>'+blacklist.size+'</b> | Contratti: <b>'+blacklistContracts.size+'</b>';}
function init(){var saved=JSON.parse(localStorage.getItem('cf_apikeys')||'[]').filter(function(k){return k&&k.length>20;});KEYS=saved.length>0?saved.slice(0,4):[...DEF_KEYS];updateApiStatus();}
function updateApiStatus(){document.getElementById('apiStatus').textContent='üîë '+KEYS.length+' keys';}
async function checkAuth(){init();try{var res=await db.auth.getSession();if(res.data.session){user=res.data.session.user;showApp();}else showAuth();}catch(err){showAuth();document.getElementById('authError').innerHTML='‚ö†Ô∏è Connessione a Supabase fallita.<br><small><a href="https://supabase.com/dashboard" target="_blank" style="color:var(--blue)">Verifica il progetto</a></small>';}}
async function handleLogin(){var e=document.getElementById('authEmail').value,p=document.getElementById('authPassword').value;try{var res=await db.auth.signInWithPassword({email:e,password:p});if(res.error){document.getElementById('authError').textContent=res.error.message;return;}user=res.data.user;showApp();}catch(err){document.getElementById('authError').innerHTML='‚ö†Ô∏è Connessione fallita.<br><small>Verifica che Supabase non sia in pausa:<br><a href="https://supabase.com/dashboard" target="_blank" style="color:var(--blue)">Apri Dashboard</a></small>';}}
async function handleSignup(){var e=document.getElementById('authEmail').value,p=document.getElementById('authPassword').value;if(p.length<6){document.getElementById('authError').textContent='Min 6 caratteri';return;}var res=await db.auth.signUp({email:e,password:p});if(res.error){document.getElementById('authError').textContent=res.error.message;return;}await db.from('user_profiles').insert({id:res.data.user.id,email:e});user=res.data.user;showApp();toast('Account creato!');}
async function handleLogout(){await db.auth.signOut();user=null;showAuth();}
function showAuth(){document.getElementById('authScreen').style.display='flex';document.getElementById('appScreen').style.display='none';}
function showApp(){document.getElementById('authScreen').style.display='none';document.getElementById('appScreen').style.display='flex';loadDashboard();updateBlStats();}
function showPage(p){document.querySelectorAll('[id^="page-"]').forEach(function(x){x.style.display='none';});document.getElementById('page-'+p).style.display='block';document.querySelectorAll('.nav').forEach(function(x){x.classList.remove('active');});var nav=document.querySelector('[data-page="'+p+'"]');if(nav)nav.classList.add('active');if(p==='exchange')document.querySelector('[data-page="exchange"]').classList.add('active');inWalletDetail=false;selectedTokenIds.clear();updateBulkBar();if(p==='dashboard')loadDashboard();else if(p==='wallets')loadWallets();else if(p==='exchange')loadExchangeTx();else if(p==='tokens')renderTM();else if(p==='settings'){loadSettings();updateBlStats();}}
function closeModal(id){document.getElementById(id).style.display='none';}
function getKey(){return KEYS[keyIdx%KEYS.length];}
function rotateKey(){keyIdx=(keyIdx+1)%KEYS.length;}
function log(m,cls){cls=cls||'log-info';var logEl=inWalletDetail?document.getElementById('wdScanLog'):document.getElementById('walletScanLog');if(logEl){logEl.innerHTML+='<div class="'+cls+'">'+m+'</div>';logEl.scrollTop=logEl.scrollHeight;}}
async function fetchRpcChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.rpc)return null;try{log('  üîó '+ch.n+' RPC...');var balRes=await fetch(ch.rpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',method:'eth_getBalance',params:[addr,'latest'],id:1})});var balData=await balRes.json();var nativeBal=parseInt(balData.result||'0',16)/1e18;log('  ‚úÖ '+ch.t+': '+fmtN(nativeBal),'log-ok');var tokens=[];if(chainKey==='pulsechain'){for(var i=0;i<PLS_TOKENS.length;i++){var t=PLS_TOKENS[i];try{var data='0x70a08231000000000000000000000000'+addr.slice(2).toLowerCase();var tokRes=await fetch(ch.rpc,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',method:'eth_call',params:[{to:t.contract,data:data},'latest'],id:i+2})});var tokData=await tokRes.json();if(tokData.result&&tokData.result!=='0x'&&tokData.result!=='0x0'){var bal=parseInt(tokData.result,16)/Math.pow(10,t.dec);if(bal>0){tokens.push({symbol:t.sym,name:t.name,balance:bal,decimals:t.dec,contractAddress:t.contract});log('    ‚úÖ '+t.sym+': '+fmtN(bal),'log-ok');}}}catch(e){}}}return{nativeBalance:nativeBal,tokens:tokens,isRpc:true};}catch(e){log('  ‚ùå '+ch.n+' error: '+e.message,'log-err');return null;}}
async function fetchCosmosChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.lcd)return null;var prefix=chainKey==='cosmos'?'cosmos':chainKey==='osmosis'?'osmo':'terra';if(!addr.startsWith(prefix))return null;try{log('  üåå '+ch.n+' LCD...');var r=await fetch(ch.lcd+'/cosmos/bank/v1beta1/balances/'+addr);if(!r.ok)return null;var d=await r.json();var tokens=[];var nativeBal=0;var nativeDenom=chainKey==='cosmos'?'uatom':chainKey==='osmosis'?'uosmo':'uluna';(d.balances||[]).forEach(function(b){var amt=parseInt(b.amount||'0')/1e6;if(b.denom===nativeDenom){nativeBal=amt;}else if(amt>0.0001){var sym=b.denom.toUpperCase().replace('U','');tokens.push({symbol:sym,name:sym,balance:amt,decimals:6,contractAddress:b.denom});}});if(nativeBal>0)log('  ‚úÖ '+ch.t+': '+fmtN(nativeBal),'log-ok');return{nativeBalance:nativeBal,tokens:tokens,isCosmos:true};}catch(e){log('  ‚ùå '+ch.n+' error: '+e.message,'log-err');return null;}}
async function fetchTonChain(addr,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.api)return null;if(!addr.startsWith('EQ')&&!addr.startsWith('UQ'))return null;try{log('  üíé TON...');var r=await fetch(ch.api+'/getAddressBalance?address='+addr);if(!r.ok)return null;var d=await r.json();var bal=(d.result||0)/1e9;if(bal>0)log('  ‚úÖ TON: '+fmtN(bal),'log-ok');return{nativeBalance:bal,tokens:[],isTon:true};}catch(e){log('  ‚ùå TON error: '+e.message,'log-err');return null;}}
async function checkGoPlus(contract,chainKey){var ch=CHAINS[chainKey];if(!ch||!ch.gp||!contract)return{safe:true,checked:false};try{var r=await fetch('https://api.gopluslabs.io/api/v1/token_security/'+ch.gp+'?contract_addresses='+contract);var d=await r.json();var info=d.result?d.result[contract.toLowerCase()]:null;if(info){var hp=info.is_honeypot==='1';var bl=info.is_blacklisted==='1';return{safe:!hp&&!bl,checked:true,honeypot:hp};}return{safe:true,checked:true};}catch(e){return{safe:true,checked:false};}}
async function fetchMoralis(addr,chainKey,retry){retry=retry||0;var ch=CHAINS[chainKey];if(!ch)return null;if(ch.rpc){return await fetchRpcChain(addr,chainKey);}if(ch.lcd){return await fetchCosmosChain(addr,chainKey);}if(ch.api){return await fetchTonChain(addr,chainKey);}try{var key=getKey();var nRes=await fetch('https://deep-index.moralis.io/api/v2.2/'+addr+'/balance?chain='+ch.hex,{headers:{'X-API-Key':key}});if(nRes.status===429||nRes.status===401){rotateKey();if(retry<KEYS.length)return fetchMoralis(addr,chainKey,retry+1);return null;}if(!nRes.ok)return null;var nData=await nRes.json();var tRes=await fetch('https://deep-index.moralis.io/api/v2.2/'+addr+'/erc20?chain='+ch.hex,{headers:{'X-API-Key':key}});if(tRes.status===429||tRes.status===401){rotateKey();if(retry<KEYS.length)return fetchMoralis(addr,chainKey,retry+1);return null;}var tData=tRes.ok?await tRes.json():[];return{nativeBalance:nData.balance||'0',tokens:Array.isArray(tData)?tData:[]};}catch(e){if(retry<KEYS.length){rotateKey();return fetchMoralis(addr,chainKey,retry+1);}return null;}}
function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}
function getStatus(sym,name,contract){var u=(sym||'').toUpperCase();if(whitelist.has(u))return'verified';if(blacklist.has(u))return'spam';if(contract&&blacklistContracts.has(contract.toLowerCase()))return'spam';if(VERIFIED.has(u))return'verified';if(isSpam(name,sym))return'spam';return'unverified';}
function isBlacklisted(sym,contract){var u=(sym||'').toUpperCase();if(blacklist.has(u))return true;if(contract&&blacklistContracts.has(contract.toLowerCase()))return true;return false;}
function icon(sym,chain,logo,sz){sz=sz||32;var ch=CHAINS[chain];var c=ch?ch.c:'#888';var s=(sym||'??').slice(0,2).toUpperCase();var u=(sym||'').toUpperCase();if(!logo&&chain==='pulsechain'){var pt=PLS_TOKENS.find(function(t){return t.sym.toUpperCase()===u;});if(pt)logo='https://tokens.app.pulsex.com/images/tokens/'+pt.contract+'.png';}if(!logo&&NATIVE_ICONS[u])logo=NATIVE_ICONS[u];if(logo)return'<div class="token-icon" style="width:'+sz+'px;height:'+sz+'px"><img src="'+logo+'" onerror="this.onerror=null;this.parentElement.innerHTML=\'<span>'+s+'</span>\';this.parentElement.style.background=\''+c+'30\';this.parentElement.style.color=\''+c+'\';"></div>';return'<div class="token-icon" style="width:'+sz+'px;height:'+sz+'px;background:'+c+'30;color:'+c+';font-weight:700">'+s+'</div>';}
function fmtC(v){var n=parseFloat(v)||0;return(currency==='eur'?'‚Ç¨':'$')+n.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtN(v){var n=parseFloat(v)||0;var abs=Math.abs(n);if(abs===0)return'0';if(abs>=1e9)return(n/1e9).toFixed(2)+'B';if(abs>=1e6)return(n/1e6).toFixed(2)+'M';if(abs>=1e3)return Math.round(n).toLocaleString('it-IT');if(abs<0.0001&&abs>0)return n.toFixed(8);if(abs<0.01)return n.toFixed(6);if(abs<1)return n.toFixed(4);return n.toLocaleString('it-IT',{maximumFractionDigits:2});}
function formatAmount(n){var sign=n>=0?'+':'';var abs=Math.abs(n);if(abs>=1e9)return sign+(n/1e9).toFixed(2)+'B';if(abs>=1e6)return sign+(n/1e6).toFixed(2)+'M';if(abs>=1e3)return sign+Math.round(n).toLocaleString('it-IT');if(abs<0.0001&&abs>0)return sign+n.toFixed(6);if(abs<0.01)return sign+n.toFixed(4);if(abs<1)return sign+n.toFixed(4);return sign+n.toLocaleString('it-IT',{maximumFractionDigits:2});}
function toast(msg,type){type=type||'success';document.querySelectorAll('.toast').forEach(function(t){t.remove();});var t=document.createElement('div');t.className='toast '+type;t.innerHTML=(type==='success'?'‚úÖ':'‚ùå')+' '+msg;document.body.appendChild(t);setTimeout(function(){t.remove();},4000);}
function toggleCurrency(){currency=currency==='eur'?'usd':'eur';document.getElementById('currencyBtn').textContent=currency==='eur'?'üí∂ EUR':'üíµ USD';loadDashboard();}
function renderChainGrid(id){var h='';for(var k in CHAINS){var ch=CHAINS[k];var on=selectedChains.has(k);h+='<label class="chain-item'+(on?' active':'')+'"><input type="checkbox" '+(on?'checked':'')+' onchange="toggleChain(\''+k+'\',this)"><span class="chain-dot" style="background:'+ch.c+'"></span>'+ch.n+'</label>';}var el=document.getElementById(id);if(el)el.innerHTML=h;}
function toggleChain(k,el){if(el.checked)selectedChains.add(k);else selectedChains.delete(k);el.parentElement.classList.toggle('active',el.checked);saveSelectedChains();}
function selectAllChains(){selectedChains=new Set(Object.keys(CHAINS));saveSelectedChains();renderChainGrid('modalChainGrid');}
function selectNoChains(){selectedChains.clear();saveSelectedChains();renderChainGrid('modalChainGrid');}
async function fetchPrices(syms){var ids=[];syms.forEach(function(s){var u=(s||'').toUpperCase();if(CG_MAP[u])ids.push(CG_MAP[u]);});ids=[...new Set(ids)];if(!ids.length)return;
try{var cacheRes=await db.from('price_cache').select('*').in('symbol',syms.map(function(s){return(s||'').toUpperCase();}));var cached=cacheRes.data||[];var now=Date.now();var needFetch=[];var cacheMap={};
cached.forEach(function(c){var age=(now-new Date(c.updated_at).getTime())/60000;cacheMap[c.symbol]={eur:c.price_eur||0,usd:c.price_usd||0,age:age};if(age>10)needFetch.push(c.symbol);});
syms.forEach(function(s){var u=(s||'').toUpperCase();if(!cacheMap[u]&&CG_MAP[u])needFetch.push(u);else if(cacheMap[u])prices[u]=cacheMap[u];});
if(needFetch.length===0)return;
var fetchIds=[...new Set(needFetch.map(function(s){return CG_MAP[s];}).filter(Boolean))];
if(fetchIds.length===0)return;
var r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids='+fetchIds.join(',')+'&vs_currencies=eur,usd');var d=await r.json();
var toUpsert=[];
for(var sym in CG_MAP){if(d[CG_MAP[sym]]){var newEur=d[CG_MAP[sym]].eur||0;var newUsd=d[CG_MAP[sym]].usd||0;var old=cacheMap[sym];
if(!old||Math.abs(old.eur-newEur)>0.0000001||Math.abs(old.usd-newUsd)>0.0000001){toUpsert.push({symbol:sym,price_eur:newEur,price_usd:newUsd,updated_at:new Date().toISOString()});}
prices[sym]={eur:newEur,usd:newUsd};}}
if(toUpsert.length>0){await db.from('price_cache').upsert(toUpsert,{onConflict:'symbol'});console.log('üí∞ Prezzi aggiornati:',toUpsert.length);}}catch(e){console.error('Price fetch error:',e);}}
async function refreshPrices(){toast('Aggiornamento...');await fetchPrices(balances.map(function(b){return b.symbol;}));await loadDashboard();toast('Prezzi aggiornati!');}
function safeAmount(bal){if(bal>1e15)return bal/1e18;return bal;}
function updateBulkBar(){var bar=document.getElementById('bulkBar');var cnt=document.getElementById('bulkCount');if(bar){bar.style.display=selectedTokenIds.size>0?'flex':'none';cnt.textContent=selectedTokenIds.size+' selezionati';}}
function toggleTokenSelect(id){if(selectedTokenIds.has(id))selectedTokenIds.delete(id);else selectedTokenIds.add(id);updateBulkBar();var cb=document.querySelector('input[data-id="'+id+'"]');if(cb)cb.checked=selectedTokenIds.has(id);}
function selectAllTokens(){if(!currentWallet)return;var wb=balances.filter(function(b){return b.wallet_id===currentWallet.id&&b.amount>0;});wb.forEach(function(b){selectedTokenIds.add(b.id);});updateBulkBar();document.querySelectorAll('.chk').forEach(function(c){c.checked=true;});}
function deselectAllTokens(){selectedTokenIds.clear();updateBulkBar();document.querySelectorAll('.chk').forEach(function(c){c.checked=false;});}
async function deleteSelectedTokens(){if(selectedTokenIds.size===0)return;if(!confirm('Eliminare '+selectedTokenIds.size+' token e aggiungerli alla blacklist?'))return;toast('Eliminazione...');var ids=[...selectedTokenIds];var addedBl=0;for(var i=0;i<ids.length;i++){var b=balances.find(function(x){return x.id===ids[i];});if(b){if(b.contract_address&&b.contract_address.length>10){blacklistContracts.add(b.contract_address.toLowerCase());addedBl++;}else if(b.symbol){blacklist.add(b.symbol.toUpperCase());addedBl++;}await db.from('balances').delete().eq('id',ids[i]);}}saveBlacklists();balances=balances.filter(function(b){return!selectedTokenIds.has(b.id);});selectedTokenIds.clear();updateBulkBar();renderWalletTokens(currentWallet.id);loadDashboard();updateBlStats();toast(ids.length+' eliminati, '+addedBl+' in blacklist');}
function clearBlacklist(){if(!confirm('Svuotare tutta la blacklist?'))return;blacklist.clear();blacklistContracts.clear();saveBlacklists();updateBlStats();toast('Blacklist svuotata');}
async function scanWallet(wallet){if(scanning)return;scanning=true;
var scanBox,scanTitle,scanPct,scanBar,scanStatus,scanLog;
if(inWalletDetail){scanBox=document.getElementById('wdScanBox');scanTitle=document.getElementById('wdScanTitle');scanPct=document.getElementById('wdScanPct');scanBar=document.getElementById('wdScanBar');scanStatus=document.getElementById('wdScanStatus');scanLog=document.getElementById('wdScanLog');}
else{scanBox=document.getElementById('walletScanBox');scanTitle=document.getElementById('walletScanTitle');scanPct=document.getElementById('walletScanPct');scanBar=document.getElementById('walletScanBar');scanStatus=document.getElementById('walletScanStatus');scanLog=document.getElementById('walletScanLog');}
scanBox.style.display='block';scanLog.innerHTML='';scanTitle.textContent='üîç '+(wallet.name||'Wallet');
try{
var results=[];var chainKeys=[...selectedChains];var done=0;var blSkipped=0;log('üëõ '+wallet.address.slice(0,10)+'...');log('‚õìÔ∏è Chain: '+chainKeys.length);log('üö´ BL: '+blacklist.size+' sym, '+blacklistContracts.size+' con');
for(var i=0;i<chainKeys.length;i++){var ck=chainKeys[i];var ch=CHAINS[ck];var pct=Math.round((done/chainKeys.length)*100);scanBar.style.width=pct+'%';scanPct.textContent=pct+'%';scanStatus.textContent=ch.n+'...';log('‚Üí '+ch.n+'...');
var data=await fetchMoralis(wallet.address,ck);
if(data){var nativeBal=0;if(data.isRpc||data.isCosmos||data.isTon){nativeBal=data.nativeBalance||0;}else{try{nativeBal=Number(BigInt(data.nativeBalance||'0'))/1e18;}catch(e){}}
if(nativeBal>0.00001){var nLogo=NATIVE_ICONS[ch.t]||null;if(!isBlacklisted(ch.t,null)){results.push({user_id:user.id,wallet_id:wallet.id,symbol:ch.t,name:ch.n+' Native',chain:ck,contract_address:null,amount:safeAmount(nativeBal),logo_url:nLogo,is_hidden:false});log('  ‚úÖ '+ch.t+': '+fmtN(nativeBal),'log-ok');}else{blSkipped++;log('  üö´ '+ch.t+' (BL)','log-warn');}}
if(data.tokens&&data.tokens.length>0){if(!data.isRpc&&!data.isCosmos&&!data.isTon)log('  üì¶ '+data.tokens.length+' token');var added=0,skipped=0;
for(var j=0;j<data.tokens.length;j++){var token=data.tokens[j];var sym=token.symbol||'?';var contract=(data.isRpc||data.isCosmos)?(token.contractAddress||''):(token.token_address||'');contract=(contract||'').toLowerCase();
if(isBlacklisted(sym,contract)){blSkipped++;continue;}
if(isSpam(token.name,sym)&&!whitelist.has(sym.toUpperCase())){skipped++;continue;}
var bal=0;if(data.isRpc||data.isCosmos||data.isTon){bal=token.balance||0;}else{try{bal=Number(BigInt(token.balance||'0'))/Math.pow(10,token.decimals||18);}catch(e){try{bal=parseFloat(token.balance||'0')/Math.pow(10,token.decimals||18);}catch(e2){}}}if(bal<=0)continue;
if(!data.isRpc&&!data.isCosmos&&!data.isTon&&!VERIFIED.has(sym.toUpperCase())&&contract){var gp=await checkGoPlus(contract,ck);if(!gp.safe){log('  ‚ö†Ô∏è '+sym+' HP!','log-err');skipped++;continue;}}
var tLogo=(data.isRpc||data.isCosmos||data.isTon)?null:(token.logo||token.thumbnail||null);results.push({user_id:user.id,wallet_id:wallet.id,symbol:sym,name:token.name||sym,chain:ck,contract_address:contract||null,amount:safeAmount(bal),logo_url:tLogo,is_hidden:false});added++;}
if(!data.isRpc&&!data.isCosmos&&!data.isTon)log('  ‚úÖ '+added+' ok, '+skipped+' spam','log-ok');}}else{log('  ‚ö†Ô∏è No response','log-warn');}await sleep(200);done++;}
if(blSkipped>0)log('üö´ '+blSkipped+' saltati (BL)','log-warn');
scanStatus.textContent='üíæ Salvataggio...';log('üíæ '+results.length+' token...');
await db.from('balances').delete().eq('wallet_id',wallet.id);if(results.length>0){var ok=0;for(var b=0;b<results.length;b+=20){var batch=results.slice(b,b+20);var insRes=await db.from('balances').insert(batch);if(!insRes.error)ok+=batch.length;}log('üìä '+ok+'/'+results.length+' salvati','log-ok');}
await db.from('wallets').update({last_scan_at:new Date().toISOString()}).eq('id',wallet.id);scanBar.style.width='100%';scanPct.textContent='100%';scanStatus.textContent='üìú Sync TX...';log('üìú Sync TX...','log-ok');
await syncWalletTxSilent(wallet);
scanStatus.textContent='‚úÖ Completato!';log('‚úÖ COMPLETATO!','log-ok');toast(results.length+' token');
await loadDashboard();if(!inWalletDetail)await loadWallets();
if(inWalletDetail&&currentWallet&&currentWallet.id===wallet.id){selectedTokenIds.clear();updateBulkBar();renderWalletTokens(wallet.id);var wb=balances.filter(function(b){return b.wallet_id===wallet.id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});document.getElementById('wdValue').textContent=fmtC(wb.reduce(function(s,b){return s+(b.value_eur||0);},0));document.getElementById('wdTokens').textContent=wb.length;}
}catch(e){log('‚ùå '+e.message,'log-err');toast(e.message,'error');}finally{scanning=false;setTimeout(function(){scanBox.style.display='none';},8000);}}
async function loadDashboard(){var wRes=await db.from('wallets').select('*').eq('user_id',user.id);var ws=wRes.data||[];var bRes=await db.from('balances').select('*').in('wallet_id',ws.map(function(w){return w.id;}));balances=bRes.data||[];var syms=[...new Set(balances.map(function(b){return b.symbol;}))];await fetchPrices(syms);var pKey=currency==='eur'?'eur':'usd';balances.forEach(function(b){var u=(b.symbol||'').toUpperCase();b.price=prices[u]?prices[u][pKey]:0;b.value_eur=b.amount*b.price;});var visibleBal=balances.filter(function(b){return getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});var total=visibleBal.reduce(function(s,b){return s+(b.value_eur||0);},0);var chains=new Set(visibleBal.map(function(b){return b.chain;}));document.getElementById('totalValue').textContent=fmtC(total);document.getElementById('totalTokens').textContent=visibleBal.length;document.getElementById('totalWallets').textContent=ws.length;document.getElementById('totalChains').textContent=chains.size;renderCharts(visibleBal);}
function renderCharts(data){var chainData={};data.forEach(function(b){var c=b.chain||'?';chainData[c]=(chainData[c]||0)+(b.value_eur||0);});var labels=Object.keys(chainData).map(function(k){return CHAINS[k]?CHAINS[k].n:k;});var values=Object.values(chainData);var colors=Object.keys(chainData).map(function(k){return CHAINS[k]?CHAINS[k].c:'#888';});var ctx=document.getElementById('chainChart');if(chart)chart.destroy();chart=new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#fff',font:{size:10}}}}}});var sorted=data.slice().sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);}).slice(0,5);var topHtml='';sorted.forEach(function(b){var pct=data.reduce(function(s,x){return s+(x.value_eur||0);},0);pct=pct>0?((b.value_eur||0)/pct*100).toFixed(1):0;var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+';font-size:9px;padding:2px 6px;margin-left:6px">'+ch.n+'</span>':'';topHtml+='<div class="top-item"><div class="top-icon">'+icon(b.symbol,b.chain,b.logo_url,36)+'</div><div class="top-info"><div class="top-row1"><span class="top-sym">'+b.symbol+'</span>'+chTag+'</div><div style="font-size:11px;color:var(--text2)">'+fmtN(b.amount)+'</div></div><div class="top-values"><div class="top-val">'+fmtC(b.value_eur)+'</div><div class="top-pct">'+pct+'%</div></div></div>';});document.getElementById('topList').innerHTML=topHtml||'<div style="color:var(--text2);padding:20px;text-align:center">Nessun token</div>';}
async function loadWallets(){var res=await db.from('wallets').select('*').eq('user_id',user.id).order('created_at',{ascending:false});var ws=res.data||[];var txRes=await db.from('transactions').select('wallet_id').eq('user_id',user.id);var txCounts={};(txRes.data||[]).forEach(function(t){txCounts[t.wallet_id]=(txCounts[t.wallet_id]||0)+1;});var html='';if(ws.length===0){html='<div style="text-align:center;padding:40px;color:var(--text2)">Nessun wallet. Clicca ‚ûï per aggiungere.</div>';}else{ws.forEach(function(w){var wb=balances.filter(function(b){return b.wallet_id===w.id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});var val=wb.reduce(function(s,b){return s+(b.value_eur||0);},0);var top3=wb.sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);}).slice(0,3);var top3Html=top3.map(function(t){return icon(t.symbol,t.chain,t.logo_url,20);}).join('');var txCount=txCounts[w.id]||0;var scanTag=w.last_scan_at?'<span style="font-size:9px;background:var(--green)20;color:var(--green);padding:2px 6px;border-radius:4px">üïê '+new Date(w.last_scan_at).toLocaleDateString('it-IT')+'</span>':'<span style="font-size:9px;background:var(--yellow)20;color:var(--yellow);padding:2px 6px;border-radius:4px">‚ö†Ô∏è Mai scansionato</span>';var txTag=txCount>0?'<span style="font-size:9px;background:var(--blue)20;color:var(--blue);padding:2px 6px;border-radius:4px">üìú '+txCount+' TX</span>':'';html+='<div class="top-item" style="cursor:pointer" onclick="openWallet(\''+w.id+'\')"><div class="top-icon"><div class="token-icon" style="background:linear-gradient(135deg,#8697FF,#7B68EE);display:flex;align-items:center;justify-content:center;font-size:22px">üê∞</div></div><div class="top-info"><div class="top-row1"><span class="top-sym">'+(w.name||'Wallet')+'</span></div><div style="font-size:10px;color:var(--text2)">'+w.address.slice(0,8)+'...'+w.address.slice(-6)+'</div><div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;align-items:center">'+scanTag+txTag+(top3Html?'<span style="display:flex;gap:2px;margin-left:4px">'+top3Html+'</span>':'')+'</div></div><div class="top-values"><div class="top-val">'+fmtC(val)+'</div><div class="top-pct">'+wb.length+' token</div></div></div>';});}document.getElementById('walletsList').innerHTML=html;}
function showAddWallet(){document.getElementById('wName').value='';document.getElementById('wAddr').value='';renderChainGrid('modalChainGrid');document.getElementById('addWalletModal').style.display='flex';}
async function addWallet(){var name=document.getElementById('wName').value.trim();var addr=document.getElementById('wAddr').value.trim();if(!addr){toast('Inserisci indirizzo','error');return;}var res=await db.from('wallets').insert({user_id:user.id,name:name||'Wallet',address:addr,chains:[...selectedChains]}).select().single();if(res.error){toast(res.error.message,'error');return;}closeModal('addWalletModal');toast('Wallet aggiunto!');await loadWallets();await scanWallet(res.data);}
async function openWallet(id){var res=await db.from('wallets').select('*').eq('id',id).single();if(!res.data)return;currentWallet=res.data;inWalletDetail=true;document.getElementById('wdName').textContent=currentWallet.name||'Wallet';document.getElementById('wdAddr').textContent=currentWallet.address;selectedChains=new Set(currentWallet.chains||['eth']);renderChainGrid('wdChainGrid');selectedTokenIds.clear();updateBulkBar();var wb=balances.filter(function(b){return b.wallet_id===id&&getStatus(b.symbol,b.name,b.contract_address)!=='spam'&&!b.is_hidden;});document.getElementById('wdValue').textContent=fmtC(wb.reduce(function(s,b){return s+(b.value_eur||0);},0));document.getElementById('wdTokens').textContent=wb.length;renderWalletTokens(id);document.getElementById('wdTxTab').style.display='none';document.getElementById('wdTokensTab').style.display='block';document.querySelectorAll('[id^="page-"]').forEach(function(x){x.style.display='none';});document.getElementById('page-wallet-detail').style.display='block';}
async function deleteCurrentWallet(){if(!currentWallet)return;if(!confirm('Sicuro di voler eliminare il wallet "'+currentWallet.name+'"?\n\nVerranno eliminati anche tutti i token e le transazioni associate.'))return;try{await db.from('transactions').delete().eq('wallet_id',currentWallet.id);await db.from('balances').delete().eq('wallet_id',currentWallet.id);await db.from('wallets').delete().eq('id',currentWallet.id);balances=balances.filter(function(b){return b.wallet_id!==currentWallet.id;});toast('‚úÖ Wallet eliminato!');currentWallet=null;showPage('wallets');}catch(e){toast('‚ùå Errore: '+e.message,'error');}}
async function saveWalletChains(){if(!currentWallet)return;var chains=[...selectedChains];var res=await db.from('wallets').update({chains:chains}).eq('id',currentWallet.id);if(res.error){toast('Errore: '+res.error.message,'error');return;}currentWallet.chains=chains;toast('‚úÖ Chain salvate ('+chains.length+')');document.getElementById('wdChainSection').style.display='none';}
function renderWalletTokens(id){var wb=balances.filter(function(b){return b.wallet_id===id&&b.amount>0;}).sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);});var html='<table class="table"><thead><tr><th style="width:5%" class="text-center"><input type="checkbox" class="chk" onchange="toggleSelectAll(this)"></th><th style="width:32%">Token</th><th style="width:16%" class="text-right">Quantit√†</th><th style="width:15%" class="text-center">Chain</th><th style="width:16%" class="text-right">Valore</th><th style="width:16%" class="text-center"></th></tr></thead><tbody>';wb.forEach(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);var badge=st==='verified'?'<span class="badge badge-ok">‚úì</span>':st==='spam'?'<span class="badge badge-bad">‚ö†</span>':'<span class="badge badge-unk">?</span>';var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+'">'+ch.n+'</span>':'';var checked=selectedTokenIds.has(b.id)?'checked':'';html+='<tr><td class="text-center"><input type="checkbox" class="chk" data-id="'+b.id+'" '+checked+' onchange="toggleTokenSelect(\''+b.id+'\')"></td><td><div class="token-cell">'+icon(b.symbol,b.chain,b.logo_url)+'<div class="token-info"><div class="symbol">'+b.symbol+' '+badge+'</div><div class="name">'+(b.name||'')+'</div></div></div></td><td class="text-right text-mono">'+fmtN(b.amount)+'</td><td class="text-center">'+chTag+'</td><td class="text-right">'+fmtC(b.value_eur)+'</td><td class="text-center"><button onclick="event.stopPropagation();deleteToken(\''+b.id+'\')" class="btn btn-sm btn-danger">üóëÔ∏è</button></td></tr>';});html+='</tbody></table>';document.getElementById('wdTokensTab').innerHTML=html;}
function toggleSelectAll(el){if(el.checked)selectAllTokens();else deselectAllTokens();}
function showWalletTab(t){document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});event.target.classList.add('active');document.getElementById('wdTokensTab').style.display=t==='tokens'?'block':'none';document.getElementById('wdTxTab').style.display=t==='tx'?'block':'none';}
async function showSavedTx(){if(!currentWallet)return;document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('wdTokensTab').style.display='none';document.getElementById('wdTxTab').style.display='block';document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--text2)">Caricamento...</div>';try{console.log('Loading TX for wallet:',currentWallet.id);var res=await db.from('transactions').select('*').eq('wallet_id',currentWallet.id).order('tx_timestamp',{ascending:false}).limit(100);console.log('TX result:',res);var txs=res.data||[];var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:12px;color:var(--text2)">'+txs.length+' TX salvate</span><button onclick="loadWalletTx()" class="btn btn-primary btn-sm">üîÑ Sync da blockchain</button></div>';if(txs.length===0){html+='<div style="padding:40px;text-align:center;color:var(--text2)">Nessuna TX salvata.<br>Clicca "Sync da blockchain" per scaricarle.</div>';}else{html+='<table class="table"><thead><tr><th>Data</th><th>Tipo</th><th>Token</th><th>Quantit√†</th><th>Chain</th><th>Hash</th></tr></thead><tbody>';txs.forEach(function(t){var dt=new Date(t.tx_timestamp).toLocaleString('it-IT');var type=t.tx_type==='transfer_out'||t.tx_type==='sell'?'<span style="color:var(--red)">üì§ '+t.tx_type+'</span>':'<span style="color:var(--green)">üì• '+t.tx_type+'</span>';var sym=t.token_in_symbol||t.token_out_symbol||'?';var amt=t.token_in_amount||t.token_out_amount||0;var ch=CHAINS[t.chain];var hashShort=t.tx_hash?t.tx_hash.slice(0,8)+'...':'?';var explorer=EXPLORERS[t.chain]||'https://etherscan.io/tx/';html+='<tr><td style="font-size:11px">'+dt+'</td><td>'+type+'</td><td>'+sym+'</td><td class="text-mono">'+fmtN(amt)+'</td><td>'+(ch?ch.n:t.chain)+'</td><td style="font-size:10px"><a href="'+explorer+t.tx_hash+'" target="_blank" style="color:var(--blue)">'+hashShort+'</a></td></tr>';});html+='</tbody></table>';}document.getElementById('wdTxTab').innerHTML=html;}catch(e){console.error('showSavedTx error:',e);document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--red)">Errore: '+e.message+'<br><button onclick="loadWalletTx()" class="btn btn-primary btn-sm" style="margin-top:12px">üîÑ Sync da blockchain</button></div>';}}
async function deleteToken(id){if(!confirm('Eliminare e aggiungere alla blacklist?'))return;var b=balances.find(function(x){return x.id===id;});if(b){if(b.contract_address&&b.contract_address.length>10){blacklistContracts.add(b.contract_address.toLowerCase());}else if(b.symbol){blacklist.add(b.symbol.toUpperCase());}saveBlacklists();}await db.from('balances').delete().eq('id',id);balances=balances.filter(function(b){return b.id!==id;});renderWalletTokens(currentWallet.id);loadDashboard();updateBlStats();toast('Eliminato!');}
function scanCurrentWallet(){if(currentWallet)scanWallet(currentWallet);}
async function syncWalletTxSilent(wallet){try{var key=getKey();var allTx=[];var chainsToScan=wallet.chains&&wallet.chains.length>0?wallet.chains:['eth','bsc','polygon','arbitrum'];var skippedChains=[];for(var ck of chainsToScan){var ch=CHAINS[ck];if(!ch)continue;if(!ch.hex&&!ch.txApi){skippedChains.push(ch.n);continue;}
if(ch.txApi){try{var r=await fetch(ch.txApi+wallet.address);if(r.ok){var d=await r.json();if(d.result&&Array.isArray(d.result)){d.result.slice(0,50).forEach(function(t){allTx.push({hash:t.hash,from_address:t.from,to_address:t.to,value:t.value,block_timestamp:new Date(parseInt(t.timeStamp)*1000).toISOString(),block_number:t.blockNumber,gas_price:t.gasPrice,gas:t.gasUsed||t.gas,_chain:ck});});}}}catch(e){console.log('txApi error for',ck,e);}}
else if(ch.gp){var r=await fetch('https://deep-index.moralis.io/api/v2.2/'+wallet.address+'?chain='+ch.hex+'&limit=50',{headers:{'X-API-Key':key}});if(r.ok){var d=await r.json();if(d.result)allTx=allTx.concat(d.result.map(function(t){t._chain=ck;return t;}));}}}
var toSave=[];allTx.forEach(function(t){var isOut=t.from_address.toLowerCase()===wallet.address.toLowerCase();var txType=isOut?'transfer_out':'transfer_in';var val=Number(t.value||0)/1e18;var ch=CHAINS[t._chain];if(!ch)return;toSave.push({user_id:user.id,wallet_id:wallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:txType,token_in_symbol:isOut?null:ch.t,token_in_amount:isOut?null:val,token_out_symbol:isOut?ch.t:null,token_out_amount:isOut?val:null,fee_amount:Number(t.gas_price||0)*Number(t.gas||0)/1e18,fee_symbol:ch.t,from_address:t.from_address,to_address:t.to_address,value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});});if(toSave.length>0){for(var i=0;i<toSave.length;i+=20){var batch=toSave.slice(i,i+20);await db.from('transactions').upsert(batch,{onConflict:'chain,tx_hash,wallet_id',ignoreDuplicates:true});}}log('üìú '+toSave.length+' TX sync','log-ok');if(skippedChains.length>0)log('‚ö†Ô∏è TX non supportate: '+skippedChains.join(', '),'log-warn');}catch(e){console.error('TX sync error:',e);}}
async function loadWalletTx(){if(!currentWallet)return;document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--text2)">üîÑ Sincronizzazione TX dalla blockchain...</div>';try{var key=getKey();var allTx=[];var chainsToScan=currentWallet.chains&&currentWallet.chains.length>0?currentWallet.chains:['eth','bsc','polygon','arbitrum'];var skippedChains=[];console.log('Scanning chains:',chainsToScan);for(var ck of chainsToScan){var ch=CHAINS[ck];if(!ch)continue;if(!ch.hex&&!ch.txApi){skippedChains.push(ch.n);continue;}
if(ch.txApi){try{console.log('Using txApi for',ck);var r=await fetch(ch.txApi+currentWallet.address);if(r.ok){var d=await r.json();if(d.result&&Array.isArray(d.result)){console.log('txApi TX found:',d.result.length);d.result.slice(0,50).forEach(function(t){allTx.push({hash:t.hash,from_address:t.from,to_address:t.to,value:t.value,block_timestamp:new Date(parseInt(t.timeStamp)*1000).toISOString(),block_number:t.blockNumber,gas_price:t.gasPrice,gas:t.gasUsed||t.gas,_chain:ck});});}}}catch(e){console.log('txApi error for',ck,e);}}
else if(ch.gp){console.log('Using Moralis for',ck,ch.hex);var r=await fetch('https://deep-index.moralis.io/api/v2.2/'+currentWallet.address+'?chain='+ch.hex+'&limit=50',{headers:{'X-API-Key':key}});console.log('Response status:',r.status);if(r.ok){var d=await r.json();console.log('TX found:',d.result?d.result.length:0);if(d.result)allTx=allTx.concat(d.result.map(function(t){t._chain=ck;return t;}));}}}
console.log('Total TX:',allTx.length);if(skippedChains.length>0)toast('‚ö†Ô∏è TX non supportate: '+skippedChains.join(', '),'warning');allTx.sort(function(a,b){return new Date(b.block_timestamp)-new Date(a.block_timestamp);});var toSave=[];allTx.forEach(function(t){var isOut=t.from_address.toLowerCase()===currentWallet.address.toLowerCase();var txType=isOut?'transfer_out':'transfer_in';var val=Number(t.value||0)/1e18;var ch=CHAINS[t._chain];if(!ch)return;toSave.push({user_id:user.id,wallet_id:currentWallet.id,tx_hash:t.hash,chain:t._chain,block_number:parseInt(t.block_number||0),tx_timestamp:t.block_timestamp,tx_type:txType,token_in_symbol:isOut?null:ch.t,token_in_amount:isOut?null:val,token_out_symbol:isOut?ch.t:null,token_out_amount:isOut?val:null,fee_amount:Number(t.gas_price||0)*Number(t.gas||0)/1e18,fee_symbol:ch.t,from_address:t.from_address,to_address:t.to_address,value_eur:null,tax_year:new Date(t.block_timestamp).getFullYear()});});console.log('TX to save:',toSave.length);if(toSave.length>0){for(var i=0;i<toSave.length;i+=20){var batch=toSave.slice(i,i+20);var uRes=await db.from('transactions').upsert(batch,{onConflict:'chain,tx_hash,wallet_id',ignoreDuplicates:true});if(uRes.error)console.error('Upsert error:',uRes.error);}}toast('‚úÖ '+toSave.length+' TX sincronizzate!');await showSavedTx();}catch(e){console.error('TX sync error:',e);document.getElementById('wdTxTab').innerHTML='<div style="padding:20px;text-align:center;color:var(--red)">Errore: '+e.message+'</div>';}}
function renderTM(){var search=(document.getElementById('tmSearch').value||'').toLowerCase();var filter=document.getElementById('tmFilter').value;var list=balances.filter(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);if(filter==='visible'&&(st==='spam'||b.is_hidden))return false;if(filter==='hidden'&&st!=='spam'&&!b.is_hidden)return false;if(search&&!(b.symbol||'').toLowerCase().includes(search)&&!(b.name||'').toLowerCase().includes(search))return false;return true;}).sort(function(a,b){return(b.value_eur||0)-(a.value_eur||0);});var html='<table class="table"><thead><tr><th>Token</th><th class="text-center">Chain</th><th class="text-right">Quantit√†</th><th class="text-center">Status</th><th class="text-center">Azioni</th></tr></thead><tbody>';list.forEach(function(b){var st=getStatus(b.symbol,b.name,b.contract_address);var badge=st==='verified'?'<span class="badge badge-ok">‚úì OK</span>':st==='spam'?'<span class="badge badge-bad">‚ö† SPAM</span>':'<span class="badge badge-unk">? </span>';var ch=CHAINS[b.chain];var chTag=ch?'<span class="chain-tag" style="background:'+ch.c+'30;color:'+ch.c+'">'+ch.n+'</span>':'';html+='<tr><td><div class="token-cell">'+icon(b.symbol,b.chain,b.logo_url)+'<div class="token-info"><div class="symbol">'+b.symbol+'</div><div class="name">'+(b.name||'')+'</div></div></div></td><td class="text-center">'+chTag+'</td><td class="text-right text-mono">'+fmtN(b.amount)+'</td><td class="text-center">'+badge+'</td><td class="text-center"><button onclick="addWL(\''+b.symbol+'\')" class="btn btn-sm btn-secondary">‚úÖ</button> <button onclick="addBL(\''+b.symbol+'\',\''+(b.contract_address||'')+'\')" class="btn btn-sm btn-danger">üö´</button></td></tr>';});html+='</tbody></table>';document.getElementById('tmList').innerHTML=html;}
function addWL(sym){whitelist.add(sym.toUpperCase());localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));renderTM();toast(sym+' in whitelist');}
function addBL(sym,contract){if(contract&&contract.length>10){blacklistContracts.add(contract.toLowerCase());}else{blacklist.add(sym.toUpperCase());}saveBlacklists();renderTM();updateBlStats();toast(sym+' in blacklist');}
function showWhitelist(){var html='';whitelist.forEach(function(s){html+='<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border)"><span>'+s+'</span><button onclick="removeWL(\''+s+'\')" class="btn btn-sm btn-danger">‚úï</button></div>';});document.getElementById('wlList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';document.getElementById('wlModal').style.display='flex';}
function addToWhitelist(){var s=document.getElementById('wlAdd').value.trim().toUpperCase();if(!s)return;whitelist.add(s);localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));document.getElementById('wlAdd').value='';showWhitelist();toast(s+' aggiunto');}
function removeWL(s){whitelist.delete(s);localStorage.setItem('cf_wl',JSON.stringify([...whitelist]));showWhitelist();}
function showImportModal(){document.getElementById('importFile').value='';document.getElementById('importPreview').style.display='none';document.getElementById('importProgress').style.display='none';document.getElementById('importModal').style.display='flex';}
function showApiModal(){document.getElementById('apiKey2').value=localStorage.getItem('binance_api_key')||'';document.getElementById('apiSecret').value=localStorage.getItem('binance_api_secret')||'';document.getElementById('apiStatus').style.display='none';document.getElementById('apiModal').style.display='flex';}
async function showEarnReport(){document.getElementById('earnContent').innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)">‚è≥ Caricamento dati...</div>';document.getElementById('earnModal').style.display='flex';
var allTx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).range(page*1000,(page+1)*1000-1);var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===1000;page++;if(page>50)break;}
var earnTypes=['reward','interest','staking','airdrop','bonus','cashback','rebate','referral','learning'];
var earnTx=allTx.filter(function(t){var op=(t.operation||'').toLowerCase();var type=t.tx_type||'';return type==='reward'||earnTypes.some(function(e){return op.includes(e);});});
var byExchange={};var byCoin={};var byYear={};var totalCount=0;
earnTx.forEach(function(t){var ex=t.exchange||'other';var coin=t.coin||'?';var year=t.tax_year||2024;var amt=parseFloat(t.amount)||0;if(amt<=0)return;totalCount++;
if(!byExchange[ex])byExchange[ex]={count:0,coins:{}};byExchange[ex].count++;if(!byExchange[ex].coins[coin])byExchange[ex].coins[coin]={amount:0,count:0};byExchange[ex].coins[coin].amount+=amt;byExchange[ex].coins[coin].count++;
if(!byCoin[coin])byCoin[coin]={amount:0,count:0,exchanges:new Set()};byCoin[coin].amount+=amt;byCoin[coin].count++;byCoin[coin].exchanges.add(ex);
if(!byYear[year])byYear[year]={count:0,coins:{}};byYear[year].count++;if(!byYear[year].coins[coin])byYear[year].coins[coin]=0;byYear[year].coins[coin]+=amt;});
var html='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--yellow)">'+totalCount+'</div><div style="font-size:11px;color:var(--text2)">TX Totali Earn</div></div>';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--green)">'+Object.keys(byCoin).length+'</div><div style="font-size:11px;color:var(--text2)">Coin Diversi</div></div>';
html+='<div class="card" style="text-align:center;padding:16px"><div style="font-size:24px;font-weight:700;color:var(--cyan)">'+Object.keys(byExchange).length+'</div><div style="font-size:11px;color:var(--text2)">Exchange</div></div></div>';
html+='<h3 style="margin:16px 0 8px;font-size:14px">üìä Per Exchange</h3><div style="display:flex;flex-direction:column;gap:8px">';
Object.entries(byExchange).sort(function(a,b){return b[1].count-a[1].count;}).forEach(function(e){var ex=e[0];var d=e[1];var logo=EX_LOGOS[ex]||EX_LOGOS.other;var color=EX_COLORS[ex]||'#888';
var topCoins=Object.entries(d.coins).sort(function(a,b){return b[1].count-a[1].count;}).slice(0,5).map(function(c){return c[0]+': '+formatAmount(c[1].amount);}).join(', ');
html+='<div class="card" style="padding:12px;border-left:3px solid '+color+'"><div style="display:flex;align-items:center;gap:8px"><img src="'+logo+'" style="width:24px;height:24px;border-radius:4px" onerror="this.style.display=\'none\'"><strong>'+formatExName(ex)+'</strong><span style="color:var(--yellow);margin-left:auto">'+d.count+' rewards</span></div><div style="font-size:11px;color:var(--text2);margin-top:4px">'+topCoins+'</div></div>';});
html+='</div><h3 style="margin:16px 0 8px;font-size:14px">ü™ô Top Coin per Quantit√†</h3><table class="table" style="font-size:12px"><thead><tr><th>Coin</th><th class="text-right">Quantit√†</th><th class="text-right">TX</th><th>Exchange</th></tr></thead><tbody>';
Object.entries(byCoin).sort(function(a,b){return b[1].count-a[1].count;}).slice(0,20).forEach(function(c){var coin=c[0];var d=c[1];
html+='<tr><td><strong>'+coin+'</strong></td><td class="text-right" style="color:var(--green)">'+formatAmount(d.amount)+'</td><td class="text-right">'+d.count+'</td><td style="font-size:10px">'+Array.from(d.exchanges).map(formatExName).join(', ')+'</td></tr>';});
html+='</tbody></table>';
html+='<h3 style="margin:16px 0 8px;font-size:14px">üìÖ Per Anno</h3><table class="table" style="font-size:12px"><thead><tr><th>Anno</th><th class="text-right">TX Earn</th><th>Top Coin</th></tr></thead><tbody>';
Object.entries(byYear).sort(function(a,b){return parseInt(b[0])-parseInt(a[0]);}).forEach(function(y){var year=y[0];var d=y[1];var topCoin=Object.entries(d.coins).sort(function(a,b){return b[1]-a[1];})[0];
html+='<tr><td><strong>'+year+'</strong></td><td class="text-right" style="color:var(--yellow)">'+d.count+'</td><td>'+( topCoin?topCoin[0]+': '+formatAmount(topCoin[1]):'-')+'</td></tr>';});
html+='</tbody></table>';
document.getElementById('earnContent').innerHTML=html;}
async function resetExchangeData(){var allEx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('exchange').eq('user_id',user.id).range(page*1000,(page+1)*1000-1);var data=res.data||[];data.forEach(function(t){if(t.exchange&&!allEx.includes(t.exchange))allEx.push(t.exchange);});hasMore=data.length===1000;page++;if(page>20)break;}if(allEx.length===0){toast('Nessun dato da cancellare','warning');return;}allEx.sort();var html='<button onclick="confirmReset(\'all\')" class="btn" style="width:100%;background:var(--red)20;color:var(--red);justify-content:flex-start;padding:12px 16px"><span style="margin-right:8px">üóëÔ∏è</span> Cancella TUTTI gli exchange ('+allEx.length+')</button>';allEx.forEach(function(ex){var logo=EX_LOGOS[ex]||EX_LOGOS.other;var color=EX_COLORS[ex]||'#888';html+='<button onclick="confirmReset(\''+ex+'\')" class="btn btn-secondary" style="width:100%;justify-content:flex-start;padding:12px 16px;border-left:3px solid '+color+'"><img src="'+logo+'" style="width:20px;height:20px;border-radius:4px;margin-right:8px" onerror="this.style.display=\'none\'"><span>'+formatExName(ex)+'</span></button>';});document.getElementById('resetOptions').innerHTML=html;document.getElementById('resetModal').style.display='flex';}
async function confirmReset(target){if(target==='all'){if(!confirm('‚ö†Ô∏è Sicuro di cancellare TUTTI i dati exchange?'))return;await db.from('exchange_transactions').delete().eq('user_id',user.id);toast('‚úÖ Tutti i dati exchange cancellati!');}else{if(!confirm('Sicuro di cancellare i dati di '+target+'?'))return;await db.from('exchange_transactions').delete().eq('user_id',user.id).eq('exchange',target);toast('‚úÖ Dati '+target+' cancellati!');}closeModal('resetModal');loadExchangeTx();}
function showApiStatus(msg,type){var el=document.getElementById('apiStatus');el.style.display='block';el.style.background=type==='success'?'var(--green)20':type==='error'?'var(--red)20':type==='warning'?'var(--yellow)20':'var(--blue)20';el.style.color=type==='success'?'var(--green)':type==='error'?'var(--red)':type==='warning'?'var(--yellow)':'var(--blue)';el.innerHTML=msg;}
var COIN_MAP={BTC:'bitcoin',ETH:'ethereum',BNB:'binancecoin',USDT:'tether',USDC:'usd-coin',XRP:'ripple',ADA:'cardano',DOGE:'dogecoin',SOL:'solana',DOT:'polkadot',MATIC:'matic-network',SHIB:'shiba-inu',LTC:'litecoin',AVAX:'avalanche-2',LINK:'chainlink',ATOM:'cosmos',UNI:'uniswap',LUNA:'terra-luna-2',LUNC:'terra-luna',CAKE:'pancakeswap-token',FTM:'fantom',SAND:'the-sandbox',MANA:'decentraland',AXS:'axie-infinity',AAVE:'aave',CRO:'crypto-com-chain',TRX:'tron',BUSD:'binance-usd',DAI:'dai',PEPE:'pepe',FLOKI:'floki',ARB:'arbitrum',OP:'optimism',APT:'aptos',SUI:'sui',INJ:'injective-protocol',FET:'fetch-ai',NEAR:'near',GRT:'the-graph',RUNE:'thorchain',IMX:'immutable-x',GALA:'gala',ENJ:'enjincoin',CHZ:'chiliz',GMT:'stepn',APE:'apecoin',LRC:'loopring',ALGO:'algorand',VET:'vechain',HBAR:'hedera-hashgraph',XLM:'stellar',XTZ:'tezos',EOS:'eos',NEO:'neo',XMR:'monero',ZEC:'zcash',DASH:'dash',THETA:'theta-token',EGLD:'elrond-erd-2',FLOW:'flow',KCS:'kucoin-shares',ONE:'harmony',HOT:'holotoken',ANKR:'ankr',AUDIO:'audius',BAT:'basic-attention-token',COMP:'compound-governance-token',CRV:'curve-dao-token',SNX:'havven',SUSHI:'sushi',YFI:'yearn-finance','1INCH':'1inch',BAL:'balancer',REN:'republic-protocol',BAND:'band-protocol',STORJ:'storj',OCEAN:'ocean-protocol',FIL:'filecoin',AR:'arweave',STX:'blockstack',CELO:'celo',KAVA:'kava',ROSE:'oasis-network',NOT:'notcoin',TON:'the-open-network',WLD:'worldcoin-wld',JUP:'jupiter-exchange-solana',BONK:'bonk',WIF:'dogwifcoin',ORDI:'ordi',SATS:'sats-ordinals',RATS:'rats-ordinals',SEI:'sei-network',TIA:'celestia',PYTH:'pyth-network',MEME:'memecoin',ACE:'fusionist',AI:'sleepless-ai',XAI:'xai-blockchain',PIXEL:'pixels',PORTAL:'portal-2',STRK:'starknet',ALT:'altlayer',MANTA:'manta-network',DYM:'dymension',BOME:'book-of-meme',ETHFI:'ether-fi',ENA:'ethena',SAGA:'saga-2',REZ:'renzo',IO:'io-net',ZK:'zksync',LISTA:'lista-dao',ZRO:'layerzero',BANANA:'banana-gun',RENDER:'render-token',TAO:'bittensor',FTN:'fasttoken',JASMY:'jasmycoin',CFX:'conflux-token',BLUR:'blur',ID:'space-id',HOOK:'hooked-protocol',HIGH:'highstreet',LEVER:'lever',RDNT:'radiant-capital',MAGIC:'magic',GMX:'gmx',PENDLE:'pendle',SSV:'ssv-network',LDO:'lido-dao',RPL:'rocket-pool',FXS:'frax-share',CVX:'convex-finance',OSMO:'osmosis',SCRT:'secret',JUNO:'juno-network',EVMOS:'evmos',INJ2:'injective-protocol'};
var rwData=[];
async function calcRW(){document.getElementById('rwModal').style.display='flex';document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Caricamento transazioni...</div></div>';
var allTx=[];var page=0;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).order('tx_timestamp',{ascending:true}).range(page*1000,(page+1)*1000-1);allTx=allTx.concat(res.data||[]);hasMore=(res.data||[]).length===1000;page++;if(page>20)break;}
console.log('Total TX loaded for RW:',allTx.length);if(allTx.length>0)console.log('Sample TX:',allTx[0],allTx[allTx.length-1]);
document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Calcolo saldi per anno...</div></div>';
var years=[2021,2022,2023,2024,2025];var results=[];
for(var yi=0;yi<years.length;yi++){var year=years[yi];var endDate=new Date(year,11,31,23,59,59);var startDate=new Date(year,0,1,0,0,0);var balances={};allTx.forEach(function(t){var txDate=new Date(t.tx_timestamp);if(txDate<=endDate){var coin=t.coin;var amt=parseFloat(t.amount)||0;if(!balances[coin])balances[coin]=0;balances[coin]+=amt;}});
var nonZero=Object.entries(balances).filter(function(e){return Math.abs(e[1])>0.000001;});console.log('Year',year,'non-zero balances:',nonZero.length,nonZero.slice(0,10));
var coinsWithBalance=Object.entries(balances).filter(function(e){return Math.abs(e[1])>0.000001&&!['EUR','USD'].includes(e[0]);});console.log('Year',year,'crypto balances:',coinsWithBalance.length,coinsWithBalance.slice(0,10));results.push({year:year,balances:coinsWithBalance});}
document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Recupero prezzi storici...</div></div>';
var allCoins=[...new Set(results.flatMap(function(r){return r.balances.map(function(b){return b[0];});}))];var pricesToFetch=[];years.forEach(function(y){allCoins.forEach(function(c){pricesToFetch.push({coin:c,date:y+'-12-31'});});});
var cachedRes=await db.from('historical_prices').select('*').in('coin',allCoins);var cached={};(cachedRes.data||[]).forEach(function(p){cached[p.coin+'_'+p.date]=p;});
var missing=pricesToFetch.filter(function(p){return!cached[p.coin+'_'+p.date];});
if(missing.length>0){document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Scarico '+missing.length+' prezzi da CoinGecko...</div></div>';var fetched=0;for(var i=0;i<missing.length;i++){var m=missing[i];var cgId=COIN_MAP[m.coin];if(!cgId)continue;try{var dateStr=m.date.split('-');var cgDate=dateStr[2]+'-'+dateStr[1]+'-'+dateStr[0];var url='https://api.coingecko.com/api/v3/coins/'+cgId+'/history?date='+cgDate+'&localization=false';var res=await fetch(url);if(res.ok){var data=await res.json();var eur=data.market_data?.current_price?.eur||0;var usd=data.market_data?.current_price?.usd||0;if(eur>0){await db.from('historical_prices').upsert({coin:m.coin,coin_id:cgId,date:m.date,price_eur:eur,price_usd:usd},{onConflict:'coin,date'});cached[m.coin+'_'+m.date]={price_eur:eur,price_usd:usd};}}fetched++;if(fetched%5===0)document.getElementById('rwContent').innerHTML='<div style="padding:40px;text-align:center"><div class="spinner"></div><div style="margin-top:12px;color:var(--text2)">Prezzi: '+fetched+'/'+missing.length+'</div></div>';await new Promise(function(r){setTimeout(r,1200);});}catch(e){console.log('Price error:',m.coin,e);}}}
rwData=[];var html='';years.forEach(function(year){var r=results.find(function(x){return x.year===year;});if(!r)return;var rows=[];var totalEur=0;var totalUnpriced=0;r.balances.forEach(function(b){var coin=b[0];var bal=b[1];var priceData=cached[coin+'_'+year+'-12-31'];var price=priceData?parseFloat(priceData.price_eur):0;var value=bal*price;if(Math.abs(bal)>0.000001){totalEur+=value;if(price===0)totalUnpriced++;rows.push({coin:coin,balance:bal,price:price,value:value});}});rows.sort(function(a,b){return Math.abs(b.value)-Math.abs(a.value);});rwData.push({year:year,total:totalEur,rows:rows});html+='<div class="card mb-12"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:14px;font-weight:700">üìÖ '+year+' - Valore al 31/12</div><div style="font-size:16px;font-weight:700;color:var(--green)">'+fmtC(totalEur)+'</div></div>';if(rows.length===0){html+='<div style="color:var(--text2);font-size:12px">Nessun saldo crypto</div>';}else{if(totalUnpriced>0)html+='<div style="color:var(--yellow);font-size:11px;margin-bottom:8px">‚ö†Ô∏è '+totalUnpriced+' coin senza prezzo</div>';html+='<table class="table" style="font-size:11px"><thead><tr><th>Coin</th><th class="text-right">Saldo</th><th class="text-right">Prezzo ‚Ç¨</th><th class="text-right">Valore ‚Ç¨</th></tr></thead><tbody>';rows.slice(0,30).forEach(function(row){var priceCol=row.price>0?fmtC(row.price):'<span style="color:var(--yellow)">?</span>';var valueCol=row.price>0?fmtC(row.value):'<span style="color:var(--yellow)">?</span>';html+='<tr><td><strong>'+row.coin+'</strong></td><td class="text-right text-mono">'+fmtN(row.balance)+'</td><td class="text-right text-mono">'+priceCol+'</td><td class="text-right text-mono" style="color:var(--green)">'+valueCol+'</td></tr>';});if(rows.length>30)html+='<tr><td colspan="4" style="text-align:center;color:var(--text2)">...e altri '+(rows.length-30)+' coin</td></tr>';html+='</tbody></table>';}html+='</div>';});
document.getElementById('rwContent').innerHTML=html||'<div style="padding:40px;text-align:center;color:var(--text2)">Nessun dato</div>';}
function exportRW(){if(!rwData.length){toast('Nessun dato da esportare','error');return;}var csv='Anno,Coin,Saldo,Prezzo_EUR,Valore_EUR\n';rwData.forEach(function(y){y.rows.forEach(function(r){csv+=y.year+',"'+r.coin+'",'+r.balance+','+r.price+','+r.value+'\n';});});var blob=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='QuadroRW_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('‚úÖ CSV esportato!');}
async function testAndSyncApi(){var apiKey=document.getElementById('apiKey2').value.trim();var apiSecret=document.getElementById('apiSecret').value.trim();var exchange=document.getElementById('apiExchange').value;if(!apiKey||!apiSecret){showApiStatus('‚ùå Inserisci API Key e Secret','error');return;}document.getElementById('apiSyncBtn').disabled=true;document.getElementById('apiSyncBtn').textContent='üîÑ Connessione...';showApiStatus('üîÑ Connessione a Binance via Edge Function...','info');try{var edgeUrl=SB_URL+'/functions/v1/binance-proxy';var res=await fetch(edgeUrl,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+SB_KEY},body:JSON.stringify({apiKey:apiKey,apiSecret:apiSecret,action:'all'})});if(!res.ok){var err=await res.json();throw new Error(err.error||'Errore API');}var data=await res.json();localStorage.setItem('binance_api_key',apiKey);localStorage.setItem('binance_api_secret',apiSecret);showApiStatus('‚úÖ Connesso! Balances: '+data.balances.length+', Deposits: '+data.deposits.length+', Withdraws: '+data.withdraws.length,'success');var allTx=[];data.deposits.forEach(function(d){allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(d.insertTime).toISOString(),tax_year:new Date(d.insertTime).getFullYear(),operation:'Deposit',account:'Spot',coin:d.coin,amount:parseFloat(d.amount),tx_type:'deposit',remark:d.txId||''});});data.withdraws.forEach(function(w){allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(w.completeTime||w.applyTime).toISOString(),tax_year:new Date(w.completeTime||w.applyTime).getFullYear(),operation:'Withdraw',account:'Spot',coin:w.coin,amount:-parseFloat(w.amount),tx_type:'withdraw',remark:w.txId||''});});(data.trades||[]).forEach(function(t){var isBuy=t.isBuyer;allTx.push({user_id:user.id,exchange:exchange,tx_timestamp:new Date(t.time).toISOString(),tax_year:new Date(t.time).getFullYear(),operation:isBuy?'Trade Buy':'Trade Sell',account:'Spot',coin:t.symbol.replace('USDT',''),amount:parseFloat(t.qty)*(isBuy?1:-1),tx_type:isBuy?'trade_buy':'trade_sell',remark:'Price: '+t.price});});if(allTx.length>0){showApiStatus('üîÑ Salvataggio '+allTx.length+' transazioni...','info');for(var i=0;i<allTx.length;i+=50){var batch=allTx.slice(i,i+50);await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation',ignoreDuplicates:true});}}showApiStatus('‚úÖ Sincronizzati '+allTx.length+' record!','success');toast('‚úÖ '+allTx.length+' TX sincronizzate via API!');setTimeout(function(){closeModal('apiModal');loadExchangeTx();},2000);}catch(e){console.error('API Error:',e);if(e.message.includes('FunctionNotFound')||e.message.includes('404')){showApiStatus('‚ö†Ô∏è Edge Function non deployata.<br><a href="#" onclick="showEdgeFunctionHelp();return false;" style="color:var(--primary)">‚Üí Come deployare</a><br><br>Oppure usa <strong>Import CSV</strong>','warning');}else{showApiStatus('‚ùå Errore: '+e.message,'error');}}document.getElementById('apiSyncBtn').disabled=false;document.getElementById('apiSyncBtn').textContent='üöÄ Connetti e Sincronizza';}
function showEdgeFunctionHelp(){alert('COME DEPLOYARE LA EDGE FUNCTION:\\n\\n1. Installa Supabase CLI:\\n   npm install -g supabase\\n\\n2. Login:\\n   supabase login\\n\\n3. Link al progetto:\\n   supabase link --project-ref TUO_PROJECT_REF\\n\\n4. Crea la funzione:\\n   supabase functions new binance-proxy\\n\\n5. Copia il file supabase_edge_function_binance.ts\\n\\n6. Deploy:\\n   supabase functions deploy binance-proxy\\n\\nScarica il file dalla chat!');}
function updateApiHelp(){var ex=document.getElementById('apiExchange').value;var helps={binance:'<strong>üìã Come ottenere le API Binance:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.binance.com/it/my/settings/api-management" target="_blank" style="color:var(--primary)">Binance API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo "Read" (nessun permesso di trading!)</li><li>Copia API Key e Secret qui sotto</li></ol>',kucoin:'<strong>üìã Come ottenere le API KuCoin:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.kucoin.com/account/api" target="_blank" style="color:var(--primary)">KuCoin API Management</a></li><li>Crea una nuova API</li><li>Imposta permessi "General" e "Trade" in sola lettura</li></ol>',bybit:'<strong>üìã Come ottenere le API Bybit:</strong><ol style="margin:8px 0 0 16px;padding:0"><li>Vai su <a href="https://www.bybit.com/app/user/api-management" target="_blank" style="color:var(--primary)">Bybit API Management</a></li><li>Crea una nuova API Key</li><li>Abilita solo permessi di lettura</li></ol>'};document.getElementById('apiHelp').innerHTML=helps[ex]||helps.binance;}
var currentExchange='';var exDetailPage=1;var exDetailTxs=[];
var EX_LOGOS={binance:'https://assets.coingecko.com/markets/images/52/small/binance.jpg',bitget:'https://assets.coingecko.com/markets/images/540/small/bitget.png',bitpanda:'https://assets.coingecko.com/markets/images/224/small/bitpanda_pro.png',bybit:'https://assets.coingecko.com/markets/images/698/small/bybit_spot.png',bybit_eu:'https://assets.coingecko.com/markets/images/698/small/bybit_spot.png',cake:'https://assets.coingecko.com/coins/images/12632/small/pancakeswap-cake-logo.png',coinbase:'https://assets.coingecko.com/markets/images/23/small/Coinbase_Coin_Primary.png',crypto_com:'https://assets.coingecko.com/markets/images/589/small/crypto_com.jpg',gate:'https://assets.coingecko.com/markets/images/60/small/gate_io_logo1.jpg',kraken:'https://assets.coingecko.com/markets/images/29/small/kraken.jpg',kucoin:'https://assets.coingecko.com/markets/images/61/small/kucoin.jpg',mexc:'https://assets.coingecko.com/markets/images/409/small/MEXC_logo_square.jpeg',nexo:'https://assets.coingecko.com/coins/images/3695/small/nexo.png',okx:'https://assets.coingecko.com/markets/images/96/small/WeChat_Image_20220117220452.png',pionex:'https://assets.coingecko.com/markets/images/500/small/Pionex_logo.png',revolut:'https://assets.coingecko.com/markets/images/1167/small/revolut.png',whitebit:'https://assets.coingecko.com/markets/images/418/small/whitebit.png',youhodler:'https://assets.coingecko.com/markets/images/661/small/youhodler.png',youngplatform:'https://assets.coingecko.com/markets/images/654/small/young_platform.png',cosmos:'https://assets.coingecko.com/coins/images/1481/small/cosmos_hub.png',osmosis:'https://assets.coingecko.com/coins/images/16724/small/osmo.png',terra:'https://assets.coingecko.com/coins/images/8284/small/01_LussaZb_Nkna_BGDQ.png',pulsechain:'https://assets.coingecko.com/coins/images/25629/small/pulse.png',manta:'https://assets.coingecko.com/coins/images/34289/small/manta.png',other:'https://assets.coingecko.com/markets/images/1/small/bitcoin.jpg'};
var EX_COLORS={binance:'#f3ba2f',bitget:'#00f0ff',bitpanda:'#3d9970',bybit:'#f7a600',bybit_eu:'#f7a600',cake:'#d1884f',coinbase:'#0052ff',crypto_com:'#002d74',gate:'#17e5c1',kraken:'#5741d9',kucoin:'#23af91',mexc:'#1972f5',nexo:'#4f97f7',okx:'#000',pionex:'#0093d5',revolut:'#0075eb',whitebit:'#02c076',youhodler:'#4361ee',youngplatform:'#00d09c',cosmos:'#2e3148',osmosis:'#5e12a0',terra:'#ffd83d',pulsechain:'#00ff8c',manta:'#35a8dc',other:'#888'};
var EX_NAMES={binance:'Binance',bitget:'Bitget',bitpanda:'Bitpanda',bybit:'Bybit',bybit_eu:'Bybit EU',cake:'PancakeSwap',coinbase:'Coinbase',crypto_com:'Crypto.com',gate:'Gate.io',kraken:'Kraken',kucoin:'KuCoin',mexc:'MEXC',nexo:'Nexo',okx:'OKX',pionex:'Pionex',revolut:'Revolut',whitebit:'WhiteBIT',youhodler:'YouHodler',youngplatform:'Young Platform',cosmos:'Cosmos',osmosis:'Osmosis',terra:'Terra LUNC',pulsechain:'PulseChain',manta:'Manta Pacific',other:'Altro'};
function formatExName(ex){return EX_NAMES[ex]||ex.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();});}
var STABLES=['EUR','USD','USDT','USDC','BUSD','DAI','TUSD'];
async function loadExchangeTx(){var allTx=[];var page=0;var pageSize=1000;var hasMore=true;while(hasMore){var res=await db.from('exchange_transactions').select('*').eq('user_id',user.id).range(page*pageSize,(page+1)*pageSize-1);var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===pageSize;page++;if(page>20)break;}console.log('Loaded TX:',allTx.length,'('+page+' pages)');
var byYear={2021:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0},2022:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0},2023:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0},2024:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0},2025:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0},2026:{tx:0,deposits:0,withdraws:0,rewards:0,buys:0,sells:0}};var byExchange={};
allTx.forEach(function(t){var y=t.tax_year||2021;var amt=parseFloat(t.amount)||0;var op=t.operation||'';var type=t.tx_type||'';var coin=t.coin||'';var isEur=coin==='EUR';var isStable=['EUR','USD','USDT','USDC','BUSD','DAI','TUSD'].includes(coin);if(byYear[y]){byYear[y].tx++;if(type==='deposit'&&isEur&&amt>0)byYear[y].deposits+=amt;if(type==='withdraw'&&isEur)byYear[y].withdraws+=Math.abs(amt);if(type==='reward'||op.includes('Interest')||op.includes('Reward')||op.includes('Staking')||op.includes('Learning'))byYear[y].rewards++;if(type==='trade_buy'||op.includes('Buy'))byYear[y].buys++;if(type==='trade_sell'||op.includes('Sell')||op.includes('Sold'))byYear[y].sells++;}if(!byExchange[t.exchange])byExchange[t.exchange]={count:0,coins:new Set(),years:new Set(),deposits:0,withdraws:0,depositsCount:0,withdrawsCount:0,rewards:0,buys:0,sells:0,converts:0,byYear:{}};byExchange[t.exchange].count++;byExchange[t.exchange].coins.add(coin);byExchange[t.exchange].years.add(y);
if(type==='deposit'){byExchange[t.exchange].depositsCount++;if(isEur&&amt>0)byExchange[t.exchange].deposits+=amt;}
if(type==='withdraw'){byExchange[t.exchange].withdrawsCount++;if(isEur)byExchange[t.exchange].withdraws+=Math.abs(amt);}
if(type==='reward'||op.includes('Interest')||op.includes('Reward')||op.includes('Learning'))byExchange[t.exchange].rewards++;
if(type==='trade_buy'||op.includes('Buy'))byExchange[t.exchange].buys++;
if(type==='trade_sell'||op.includes('Sell')||op.includes('Sold'))byExchange[t.exchange].sells++;
if(type==='convert'||op.includes('Convert'))byExchange[t.exchange].converts++;
if(!byExchange[t.exchange].byYear[y])byExchange[t.exchange].byYear[y]={tx:0,deposits:0,withdraws:0,depositsCount:0,withdrawsCount:0,rewards:0,buys:0,sells:0,converts:0};byExchange[t.exchange].byYear[y].tx++;
if(type==='deposit'){byExchange[t.exchange].byYear[y].depositsCount++;if(isEur&&amt>0)byExchange[t.exchange].byYear[y].deposits+=amt;}
if(type==='withdraw'){byExchange[t.exchange].byYear[y].withdrawsCount++;if(isEur)byExchange[t.exchange].byYear[y].withdraws+=Math.abs(amt);}
if(type==='reward'||op.includes('Interest')||op.includes('Reward')||op.includes('Learning'))byExchange[t.exchange].byYear[y].rewards++;
if(type==='trade_buy'||op.includes('Buy'))byExchange[t.exchange].byYear[y].buys++;
if(type==='trade_sell'||op.includes('Sell')||op.includes('Sold'))byExchange[t.exchange].byYear[y].sells++;
if(type==='convert'||op.includes('Convert'))byExchange[t.exchange].byYear[y].converts++;});
for(var y=2021;y<=2026;y++){var el=document.getElementById('exYear'+y);if(el){var d=byYear[y];var html='<div style="font-size:16px;font-weight:700;color:var(--cyan)">'+d.tx+' TX</div>';if(d.deposits>0||d.withdraws>0){html+='<div style="font-size:9px;margin-top:4px"><span style="color:var(--green)">üì•'+fmtC(d.deposits).replace('‚Ç¨','')+'</span> <span style="color:var(--red)">üì§'+fmtC(d.withdraws).replace('‚Ç¨','')+'</span></div>';}if(d.rewards>0||d.buys>0||d.sells>0){html+='<div style="font-size:9px;margin-top:2px">';if(d.rewards>0)html+='<span style="color:var(--yellow)">üéÅ'+d.rewards+'</span> ';if(d.buys>0)html+='<span style="color:var(--green)">üõí'+d.buys+'</span> ';if(d.sells>0)html+='<span style="color:var(--red)">üí∞'+d.sells+'</span>';html+='</div>';}el.innerHTML=html;}}
var html='';if(Object.keys(byExchange).length===0){html='<div class="card" style="grid-column:1/-1;padding:40px;text-align:center;color:var(--text2)">Nessun exchange. Clicca "Import CSV" per importare dati.</div>';}else{Object.entries(byExchange).forEach(function(e){var ex=e[0];var data=e[1];var color=EX_COLORS[ex]||'#888';var logo=EX_LOGOS[ex]||EX_LOGOS.other;
html+='<div class="card" style="grid-column:1/-1"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;cursor:pointer" onclick="openExchangeDetail(\''+ex+'\')"><div style="width:48px;height:48px;border-radius:12px;background:'+color+'20;display:flex;align-items:center;justify-content:center;overflow:hidden"><img src="'+logo+'" style="width:36px;height:36px;border-radius:8px" onerror="this.style.display=\'none\';this.parentElement.innerHTML=\'üè¶\'"></div><div style="flex:1"><div style="font-size:18px;font-weight:700">'+formatExName(ex)+'</div><div style="font-size:12px;color:var(--text2)">'+data.count+' TX totali ‚Ä¢ '+data.coins.size+' coin</div></div><button onclick="event.stopPropagation();openExchangeDetail(\''+ex+'\')" class="btn btn-sm btn-secondary">Dettagli ‚Üí</button></div>';
html+='<div style="overflow-x:auto"><table class="table" style="font-size:12px;margin:0"><thead><tr><th>Anno</th><th class="text-right">TX</th><th class="text-right">üì• Ricevuti</th><th class="text-right">üì§ Inviati</th><th class="text-right">üéÅ Rewards</th><th class="text-right">üõí Buy</th><th class="text-right">üí∞ Sell</th><th class="text-right">üîÑ Convert</th></tr></thead><tbody>';
var years=[2021,2022,2023,2024,2025,2026];years.forEach(function(y){if(data.byYear[y]&&data.byYear[y].tx>0){var yd=data.byYear[y];var depStr=yd.depositsCount>0?(yd.deposits>0?fmtC(yd.deposits):yd.depositsCount):'0';var witStr=yd.withdrawsCount>0?(yd.withdraws>0?fmtC(yd.withdraws):yd.withdrawsCount):'0';html+='<tr style="cursor:pointer" onclick="openExchangeDetail(\''+ex+'\');setTimeout(function(){document.getElementById(\'exDetailYear\').value=\''+y+'\';loadExchangeDetail();},100)"><td><strong>'+y+'</strong></td><td class="text-right text-mono">'+yd.tx+'</td><td class="text-right text-mono" style="color:var(--green)">'+depStr+'</td><td class="text-right text-mono" style="color:var(--red)">'+witStr+'</td><td class="text-right text-mono" style="color:var(--yellow)">'+yd.rewards+'</td><td class="text-right text-mono" style="color:var(--green)">'+yd.buys+'</td><td class="text-right text-mono" style="color:var(--red)">'+yd.sells+'</td><td class="text-right text-mono" style="color:var(--blue)">'+(yd.converts||0)+'</td></tr>';}});
var totDepStr=data.depositsCount>0?(data.deposits>0?fmtC(data.deposits):data.depositsCount):'0';var totWitStr=data.withdrawsCount>0?(data.withdraws>0?fmtC(data.withdraws):data.withdrawsCount):'0';
html+='<tr style="background:var(--bg2);font-weight:700"><td>TOTALE</td><td class="text-right text-mono">'+data.count+'</td><td class="text-right text-mono" style="color:var(--green)">'+totDepStr+'</td><td class="text-right text-mono" style="color:var(--red)">'+totWitStr+'</td><td class="text-right text-mono" style="color:var(--yellow)">'+data.rewards+'</td><td class="text-right text-mono" style="color:var(--green)">'+data.buys+'</td><td class="text-right text-mono" style="color:var(--red)">'+data.sells+'</td><td class="text-right text-mono" style="color:var(--blue)">'+(data.converts||0)+'</td></tr>';
html+='</tbody></table></div></div>';});}document.getElementById('exExchangeGrid').innerHTML=html;}
function openExchangeDetail(ex){currentExchange=ex;exDetailPage=1;exDetailTxs=[];var color=EX_COLORS[ex]||'#888';var logo=EX_LOGOS[ex]||EX_LOGOS.other;document.getElementById('exDetailName').innerHTML='<div class="flex items-center gap-12"><img src="'+logo+'" style="width:32px;height:32px;border-radius:8px" onerror="this.style.display=\'none\'"><span>'+formatExName(ex)+'</span></div>';document.getElementById('exDetailYear').value='';document.getElementById('exDetailType').value='';document.getElementById('exDetailSearch').value='';document.getElementById('page-exchange').style.display='none';document.getElementById('page-exchange-detail').style.display='block';loadExchangeDetail();}
async function resetCurrentExchange(){if(!currentExchange)return;if(!confirm('Sicuro di cancellare tutti i dati di '+currentExchange+'?'))return;try{await db.from('exchange_transactions').delete().eq('user_id',user.id).eq('exchange',currentExchange);toast('‚úÖ Dati '+currentExchange+' cancellati!');showPage('exchange');}catch(e){toast('‚ùå Errore: '+e.message,'error');}}
async function loadExchangeDetail(){if(!currentExchange)return;exDetailPage=1;var yearFilter=document.getElementById('exDetailYear').value;var typeFilter=document.getElementById('exDetailType').value;var searchFilter=(document.getElementById('exDetailSearch').value||'').toLowerCase();
var allTx=[];var page=0;var hasMore=true;while(hasMore){var query=db.from('exchange_transactions').select('*').eq('user_id',user.id).eq('exchange',currentExchange).order('tx_timestamp',{ascending:false}).range(page*1000,(page+1)*1000-1);if(yearFilter)query=query.eq('tax_year',parseInt(yearFilter));if(typeFilter)query=query.eq('tx_type',typeFilter);var res=await query;var data=res.data||[];allTx=allTx.concat(data);hasMore=data.length===1000;page++;if(page>10)break;}
var txs=allTx;if(searchFilter)txs=txs.filter(function(t){return(t.coin||'').toLowerCase().includes(searchFilter)||(t.operation||'').toLowerCase().includes(searchFilter);});
var totalIn=0,totalOut=0,coins=new Set();txs.forEach(function(t){coins.add(t.coin);var amt=parseFloat(t.amount)||0;if(t.coin==='EUR'){if(amt>0)totalIn+=amt;else totalOut+=Math.abs(amt);}});
document.getElementById('exDetailTx').textContent=txs.length;document.getElementById('exDetailCoins').textContent=coins.size;document.getElementById('exDetailIn').textContent=fmtC(totalIn);document.getElementById('exDetailOut').textContent=fmtC(totalOut);
exDetailTxs=txs;renderExDetailPage();}
function renderExDetailPage(){var txs=exDetailTxs;var pageSize=100;var totalPages=Math.ceil(txs.length/pageSize);if(exDetailPage>totalPages)exDetailPage=totalPages;if(exDetailPage<1)exDetailPage=1;var start=(exDetailPage-1)*pageSize;var end=start+pageSize;var pageTxs=txs.slice(start,end);
if(txs.length===0){document.getElementById('exDetailList').innerHTML='<div style="padding:40px;text-align:center;color:var(--text2)">Nessuna transazione</div>';return;}
var typeIcons={deposit:'üì•',withdraw:'üì§',trade_buy:'üõí',trade_sell:'üí∞',reward:'üéÅ',convert:'üîÑ',fee:'üí∏',transfer:'‚ÜîÔ∏è',payment:'üí≥',other:'‚Ä¢'};var typeColors={deposit:'var(--green)',withdraw:'var(--red)',trade_buy:'var(--green)',trade_sell:'var(--red)',reward:'var(--yellow)',convert:'var(--blue)',fee:'var(--red)',transfer:'var(--cyan)',payment:'var(--purple)',other:'var(--text2)'};
var html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">';
html+='<div style="font-size:12px;color:var(--text2)">Totale: <strong>'+txs.length+'</strong> TX | Pagina '+exDetailPage+' di '+totalPages+'</div>';
html+='<div style="display:flex;gap:4px;align-items:center">';
html+='<button onclick="exDetailGoPage(1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===1?'disabled':'')+'>‚èÆ</button>';
html+='<button onclick="exDetailGoPage(exDetailPage-1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===1?'disabled':'')+'>‚óÄ</button>';
var startP=Math.max(1,exDetailPage-2);var endP=Math.min(totalPages,startP+4);if(endP-startP<4)startP=Math.max(1,endP-4);
for(var p=startP;p<=endP;p++){html+='<button onclick="exDetailGoPage('+p+')" class="btn btn-sm '+(p===exDetailPage?'btn-primary':'btn-secondary')+'" style="padding:4px 10px;min-width:32px">'+p+'</button>';}
html+='<button onclick="exDetailGoPage(exDetailPage+1)" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===totalPages?'disabled':'')+'>‚ñ∂</button>';
html+='<button onclick="exDetailGoPage('+totalPages+')" class="btn btn-sm btn-secondary" style="padding:4px 8px" '+(exDetailPage===totalPages?'disabled':'')+'>‚è≠</button>';
html+='</div></div>';
pageTxs.forEach(function(t){var d=new Date(t.tx_timestamp);var dateStr=d.toLocaleDateString('it-IT')+' '+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});var amt=parseFloat(t.amount);var amtStr=formatAmount(amt);var amtColor=amt>=0?'var(--green)':'var(--red)';var icon=typeIcons[t.tx_type]||'‚Ä¢';var opColor=typeColors[t.tx_type]||'var(--text2)';
html+='<div style="display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:12px">';
var coinLower=t.coin.toLowerCase();var iconUrl='https://assets.coincap.io/assets/icons/'+coinLower+'@2x.png';
html+='<div style="position:relative;width:36px;height:36px;flex-shrink:0"><img src="'+iconUrl+'" style="width:36px;height:36px;border-radius:50%" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div style="display:none;width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff">'+t.coin.slice(0,3)+'</div><div style="position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;border-radius:50%;background:'+opColor+';display:flex;align-items:center;justify-content:center;font-size:9px;border:2px solid var(--bg)">'+icon+'</div></div>';
html+='<div style="flex:1;min-width:0;overflow:hidden"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div style="font-weight:600;white-space:nowrap">'+t.coin+'</div><div class="text-mono" style="color:'+amtColor+';font-weight:600;white-space:nowrap">'+amtStr+'</div></div>';
html+='<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:2px;gap:8px"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">'+t.operation+'</div><div style="white-space:nowrap;flex-shrink:0">'+dateStr+'</div></div></div></div>';});
html+='<div style="display:flex;justify-content:center;margin-top:12px;gap:4px">';
html+='<button onclick="exDetailGoPage(exDetailPage-1)" class="btn btn-secondary" style="padding:8px 16px" '+(exDetailPage===1?'disabled':'')+'>‚óÄ Precedente</button>';
html+='<button onclick="exDetailGoPage(exDetailPage+1)" class="btn btn-secondary" style="padding:8px 16px" '+(exDetailPage===totalPages?'disabled':'')+'>Successiva ‚ñ∂</button>';
html+='</div>';
document.getElementById('exDetailList').innerHTML=html;}
function exDetailGoPage(p){var totalPages=Math.ceil(exDetailTxs.length/100);if(p<1)p=1;if(p>totalPages)p=totalPages;exDetailPage=p;renderExDetailPage();document.getElementById('exDetailList').scrollTop=0;}
function toggleYearDetail(year){var el=document.getElementById('yearDetail'+year);el.style.display=el.style.display==='none'?'block':'none';}
async function importCSV(){var files=document.getElementById('importFile').files;if(!files.length){toast('Seleziona file CSV o ZIP','error');return;}var exchange=document.getElementById('importExchange').value;document.getElementById('importProgress').style.display='block';document.getElementById('importBtn').disabled=true;var totalImported=0;var totalParsed=0;var csvTexts=[];
for(var f=0;f<files.length;f++){var file=files[f];document.getElementById('importStatus').textContent='üìÑ Lettura '+file.name+'...';if(file.name.endsWith('.zip')){try{var zip=await JSZip.loadAsync(file);var csvFiles=Object.keys(zip.files).filter(function(n){return n.endsWith('.csv')&&!n.startsWith('__MACOSX')&&!n.includes('/.DS_');});console.log('CSV trovati nel ZIP:',csvFiles);for(var c=0;c<csvFiles.length;c++){var csvContent=await zip.files[csvFiles[c]].async('string');csvTexts.push({name:csvFiles[c],text:csvContent});console.log('Letto:',csvFiles[c],'righe:',csvContent.split('\n').length);}}catch(e){console.error('ZIP error:',e);toast('Errore ZIP: '+e.message,'error');}}else{var text=await file.text();csvTexts.push({name:file.name,text:text});}}
console.log('Totale file CSV:',csvTexts.length);document.getElementById('importStatus').textContent='üìä Elaborazione '+csvTexts.length+' file...';
for(var i=0;i<csvTexts.length;i++){var csv=csvTexts[i];var cleanText=csv.text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');var lines=cleanText.split('\n');var toInsert=[];
var headerLine='';var dataStartLine=1;
for(var h=0;h<Math.min(10,lines.length);h++){var lineH=lines[h]||'';if(lineH.includes('Timestamp')&&lineH.includes('Transaction')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('User_ID')&&lineH.includes('UTC_Time')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date')&&lineH.includes('Type')&&lineH.includes('Asset')&&lineH.includes('Chain')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Date & Time')&&lineH.includes('Coin')&&lineH.includes('QTY')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Currency')&&lineH.includes('Cash Flow')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Spot Pairs')&&lineH.includes('Direction')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('order')&&lineH.includes('Date')&&lineH.includes('Coin')&&lineH.includes('Type')){headerLine=lineH;dataStartLine=h+1;break;}if(lineH.includes('Transaction ID')&&lineH.includes('Amount Asset')){headerLine=lineH;dataStartLine=h+1;break;}}
if(!headerLine)headerLine=lines[0]||'';
console.log('CSV Header:',headerLine,'dataStart:',dataStartLine);
var isBinance=headerLine.includes('User_ID')&&headerLine.includes('UTC_Time');var isCoinbase=headerLine.includes('Transaction Type')&&headerLine.includes('Asset')&&headerLine.includes('Quantity');var isKraken=headerLine.includes('txid')&&headerLine.includes('refid');
var isBybitDeposit=headerLine.includes('Date')&&headerLine.includes('Type')&&headerLine.includes('Asset')&&headerLine.includes('Chain');var isBybitFund=headerLine.includes('Date & Time')&&headerLine.includes('Coin')&&headerLine.includes('QTY');var isBybitUta=headerLine.includes('Currency')&&headerLine.includes('Cash Flow')&&headerLine.includes('Wallet Balance');var isBybitSpot=headerLine.includes('Spot Pairs')&&headerLine.includes('Direction')&&headerLine.includes('Filled');
var isBitget=headerLine.includes('order')&&headerLine.includes('Date')&&headerLine.includes('Coin')&&headerLine.includes('Type')&&headerLine.includes('Amount');
var isBitpanda=headerLine.includes('Transaction ID')&&headerLine.includes('Amount Asset');
var isBybit=isBybitDeposit||isBybitFund||isBybitUta||isBybitSpot;
console.log('Format - Binance:',isBinance,'Coinbase:',isCoinbase,'Bybit:',isBybit,'Bitget:',isBitget,'Bitpanda:',isBitpanda,'dataStart:',dataStartLine);
for(var j=dataStartLine;j<lines.length;j++){var line=lines[j].trim();if(!line)continue;var cols=parseCSVLine(line);
var utcTime,operation,coin,change,remark='',account='Spot';
if(isBinance&&cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[4]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);remark=cols[6]?.replace(/"/g,'')||'';account=cols[2]?.replace(/"/g,'')||'Spot';}
else if(isCoinbase&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'');operation=cols[2]?.replace(/"/g,'');coin=cols[3]?.replace(/"/g,'');change=parseFloat(cols[4]?.replace(/"/g,'')||0);if(cols.length>=11)remark=cols[10]?.replace(/"/g,'')||'';account='Coinbase';
var totalEurStr=cols[8]?.replace(/"/g,'').replace('‚Ç¨','').replace(',','.')||'0';var valueEur=parseFloat(totalEurStr)||0;}
else if(isBybitDeposit&&cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[2]?.replace(/"/g,'');coin=cols[3]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);remark=(cols[4]||'')+' '+(cols[7]||'');account='Bybit';if(operation==='Withdraw')change=-Math.abs(change);}
else if(isBybitFund&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'');coin=cols[2]?.replace(/"/g,'');change=parseFloat(cols[3]?.replace(/"/g,'')||0);operation=cols[4]?.replace(/"/g,'')||'';remark=cols[6]?.replace(/"/g,'')||'';account='Bybit Fund';}
else if(isBybitUta&&cols.length>=14){utcTime=cols[14]?.replace(/"/g,'');coin=cols[1]?.replace(/"/g,'');change=parseFloat(cols[11]?.replace(/"/g,'')||0);operation=cols[3]?.replace(/"/g,'')||'';remark=cols[13]?.replace(/"/g,'')||'';account='Bybit UTA';}
else if(isBybitSpot&&cols.length>=10){utcTime=cols[10]?.replace(/"/g,'');var pair=cols[1]?.replace(/"/g,'')||'';coin=pair.replace(/USDT|USDC|EUR|USD/g,'');operation=cols[3]?.replace(/"/g,'')||'';change=parseFloat(cols[6]?.replace(/"/g,'')||0);if(operation==='SELL')change=-Math.abs(change);remark='Spot Trade '+pair;account='Bybit Spot';}
else if(isBitget&&cols.length>=5){utcTime=cols[1]?.replace(/"/g,'').trim();coin=cols[2]?.replace(/"/g,'').trim();operation=cols[3]?.replace(/"/g,'').trim();change=parseFloat(cols[4]?.replace(/"/g,'')||0);remark=operation;account='Bitget';}
else if(isBitpanda&&cols.length>=8){utcTime=cols[1]?.replace(/"/g,'').trim();operation=cols[2]?.replace(/"/g,'').trim();var inOut=cols[3]?.replace(/"/g,'').trim()||'';change=parseFloat(cols[6]?.replace(/"/g,'')||0);coin=cols[7]?.replace(/"/g,'').trim();if(inOut==='outgoing')change=-Math.abs(change);remark=operation+' '+inOut;account='Bitpanda';}
else if(isKraken&&cols.length>=7){utcTime=cols[2]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[5]?.replace(/"/g,'');change=parseFloat(cols[6]?.replace(/"/g,'')||0);}
else if(cols.length>=6){utcTime=cols[1]?.replace(/"/g,'');operation=cols[3]?.replace(/"/g,'');coin=cols[4]?.replace(/"/g,'');change=parseFloat(cols[5]?.replace(/"/g,'')||0);}
if(!utcTime||!coin||coin.length<1)continue;
var valueEur=typeof valueEur!=='undefined'?valueEur:0;
var txType='other';var opLower=(operation||'').toLowerCase();if(opLower.includes('deposit')||opLower==='incoming')txType='deposit';else if(opLower.includes('withdraw')||opLower.includes('withdrawal'))txType='withdraw';else if(opLower.includes('buy')||opLower==='buy'||opLower.includes('coin purchase'))txType='trade_buy';else if(opLower.includes('sell')||opLower.includes('sold')||opLower==='sell')txType='trade_sell';else if(opLower.includes('fee'))txType='fee';else if(opLower.includes('reward')||opLower.includes('interest')||opLower.includes('staking')||opLower.includes('learning')||opLower.includes('airdrop')||opLower.includes('bonus')||opLower.includes('redeem'))txType='reward';else if(opLower.includes('convert')||opLower.includes('exchange')||opLower.includes('swap')||opLower==='fiat')txType='convert';else if(opLower.includes('transfer')||opLower==='receive'||opLower==='send'||opLower==='transfer_in'||opLower==='transfer_out')txType='transfer';else if(opLower.includes('purchase')||opLower.includes('card'))txType='payment';
var timestamp=utcTime.includes('T')?utcTime:utcTime.replace(' ','T');if(!timestamp.includes('Z')&&!timestamp.includes('+'))timestamp=timestamp.replace(' UTC','')+'Z';
var taxYear=parseInt(utcTime.slice(0,4));if(isNaN(taxYear)||taxYear<2010||taxYear>2030)continue;
if(!coin||coin.length>20)continue;
if(isNaN(change))change=0;
toInsert.push({user_id:user.id,exchange:exchange,tx_timestamp:timestamp,tax_year:taxYear,operation:(operation||'Unknown').slice(0,100),account:(account||'Spot').slice(0,50),coin:coin.slice(0,20),amount:change,remark:(remark||'').slice(0,255),tx_type:txType});}
totalParsed+=toInsert.length;console.log('File',csv.name,'parsed:',toInsert.length,'records');if(toInsert.length===0){console.warn('‚ö†Ô∏è File',csv.name,'- 0 records! Header:',headerLine,'Format detected: Bybit=',isBybit,'(dep:',isBybitDeposit,'fund:',isBybitFund,')');}
var seen={};var uniqueInsert=[];toInsert.forEach(function(r){var key=r.tx_timestamp+'|'+r.coin+'|'+r.amount+'|'+r.operation;if(!seen[key]){seen[key]=true;uniqueInsert.push(r);}});if(uniqueInsert.length<toInsert.length)console.log('Dedup:',toInsert.length,'->',uniqueInsert.length);toInsert=uniqueInsert;
document.getElementById('importStatus').textContent='üíæ Salvataggio '+csv.name+' ('+toInsert.length+' TX)...';document.getElementById('importBar').style.width=Math.round(((i+0.5)/csvTexts.length)*100)+'%';
if(toInsert.length>0){var inserted=0;var errors=0;for(var b=0;b<toInsert.length;b+=100){var batch=toInsert.slice(b,b+100);try{var res=await db.from('exchange_transactions').upsert(batch,{onConflict:'user_id,exchange,tx_timestamp,coin,amount,operation'});if(res.error){console.error('Upsert error batch',b,':',res.error.message,res.error.details);errors+=batch.length;}else{inserted+=batch.length;}}catch(e){console.error('Exception batch',b,':',e);errors+=batch.length;}}totalImported+=inserted;console.log('File',csv.name,'inserted:',inserted,'errors:',errors);}
document.getElementById('importBar').style.width=Math.round(((i+1)/csvTexts.length)*100)+'%';}
console.log('TOTALE - Parsed:',totalParsed,'Imported:',totalImported);document.getElementById('importBar').style.width='100%';document.getElementById('importStatus').textContent='‚úÖ '+totalImported+' TX importate ('+totalParsed+' parsate)';document.getElementById('importBtn').disabled=false;toast('‚úÖ '+totalImported+' TX importate!');setTimeout(function(){closeModal('importModal');loadExchangeTx();},2000);}
function parseCSVLine(line){var result=[];var inQuotes=false;var current='';for(var i=0;i<line.length;i++){var c=line[i];if(c==='"'){inQuotes=!inQuotes;}else if(c===','&&!inQuotes){result.push(current);current='';}else{current+=c;}}result.push(current);return result;}
function showBlacklist(){document.getElementById('blSymCount').textContent=blacklist.size;document.getElementById('blConCount').textContent=blacklistContracts.size;showBlTab('symbols');document.getElementById('blModal').style.display='flex';}
function showBlTab(t){document.querySelectorAll('#blModal .tab').forEach(function(x){x.classList.remove('active');});event.target.classList.add('active');document.getElementById('blSymbols').style.display=t==='symbols'?'block':'none';document.getElementById('blContracts').style.display=t==='contracts'?'block':'none';if(t==='symbols'){var html='';blacklist.forEach(function(s){html+='<div class="flex justify-between items-center" style="padding:8px 0;border-bottom:1px solid var(--border)"><span>'+s+'</span><button onclick="removeBL(\''+s+'\')" class="btn btn-sm btn-secondary">‚úï</button></div>';});document.getElementById('blList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';}else{var html='';blacklistContracts.forEach(function(c){html+='<div class="flex justify-between items-center" style="padding:6px 0;border-bottom:1px solid var(--border)"><code style="font-size:9px;word-break:break-all">'+c+'</code><button onclick="removeBlCon(\''+c+'\')" class="btn btn-sm btn-secondary" style="margin-left:8px">‚úï</button></div>';});document.getElementById('blConList').innerHTML=html||'<div style="color:var(--text2)">Vuota</div>';}}
function addToBlacklist(){var s=document.getElementById('blAdd').value.trim().toUpperCase();if(!s)return;blacklist.add(s);saveBlacklists();document.getElementById('blAdd').value='';updateBlStats();showBlacklist();toast(s+' in blacklist');}
function removeBL(s){blacklist.delete(s);saveBlacklists();updateBlStats();showBlTab('symbols');}
function removeBlCon(c){blacklistContracts.delete(c);saveBlacklists();updateBlStats();showBlTab('contracts');}
function loadSettings(){var keys=JSON.parse(localStorage.getItem('cf_apikeys')||'[]');document.getElementById('apiKey1').value=keys[0]||'';document.getElementById('apiKey2').value=keys[1]||'';document.getElementById('apiKey3').value=keys[2]||'';document.getElementById('apiKey4').value=keys[3]||'';document.getElementById('setCurrency').value=localStorage.getItem('cf_currency')||'eur';}
function saveApiKeys(){var keys=[document.getElementById('apiKey1').value.trim(),document.getElementById('apiKey2').value.trim(),document.getElementById('apiKey3').value.trim(),document.getElementById('apiKey4').value.trim()].filter(function(k){return k.length>20;});localStorage.setItem('cf_apikeys',JSON.stringify(keys));KEYS=keys.length>0?keys:[...DEF_KEYS];updateApiStatus();toast('API Keys salvate!');}
function saveCurrency(){currency=document.getElementById('setCurrency').value;localStorage.setItem('cf_currency',currency);loadDashboard();}
function exportCSV(){var csv='Symbol,Name,Chain,Amount,Value_EUR,Contract\n';balances.forEach(function(b){csv+='"'+b.symbol+'","'+(b.name||'')+'","'+b.chain+'",'+b.amount+','+(b.value_eur||0)+',"'+(b.contract_address||'')+'"\n';});var blob=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='cryptofolio_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('CSV esportato!');}
async function clearAllData(){if(!confirm('Eliminare TUTTI i dati?'))return;await db.from('balances').delete().eq('user_id',user.id);await db.from('wallets').delete().eq('user_id',user.id);balances=[];localStorage.removeItem('cf_wl');localStorage.removeItem('cf_bl');localStorage.removeItem('cf_bl_contracts');whitelist.clear();blacklist.clear();blacklistContracts.clear();loadDashboard();loadWallets();toast('Dati eliminati!');}
checkAuth();
</script>
</body>
</html>
