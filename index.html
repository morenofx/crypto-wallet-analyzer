<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoFolio v6 - Modulare</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VARIABILI CSS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
            --border: #30363d;
            --radius: 12px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & BASE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 20px;
            color: var(--accent);
        }
        
        .logo span {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent);
            color: white;
        }
        
        .nav-item .icon {
            font-size: 18px;
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 24px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .header h2 {
            font-size: 24px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        #syncDot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 20px;
        }
        
        .stat-card .label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .stat-card .value.positive { color: var(--green); }
        .stat-card .value.negative { color: var(--red); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FORMS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        input, select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 14px;
            width: 100%;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .btn-danger {
            background: var(--red);
        }
        
        .btn-success {
            background: var(--green);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TABLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
        }
        
        td {
            font-size: 14px;
        }
        
        tr:hover {
            background: var(--bg-secondary);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VIEWS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           UTILITIES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-yellow { color: var(--yellow); }
        .text-secondary { color: var(--text-secondary); }
        
        .mt-8 { margin-top: 8px; }
        .mt-16 { margin-top: 16px; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        
        .flex { display: flex; }
        .gap-8 { gap: 8px; }
        .gap-16 { gap: 16px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMPTY STATE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           WALLET LIST
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .wallet-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .wallet-item:hover {
            background: var(--bg-card);
            transform: translateX(4px);
        }
        
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .wallet-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .wallet-name {
            font-weight: 500;
        }
        
        .wallet-address {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        .wallet-value {
            text-align: right;
        }
        
        .wallet-value .amount {
            font-weight: 600;
            font-size: 16px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOG CONSOLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #logConsole {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BLACKLIST / HIDE TOKEN (come v5.2)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hide-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0.4;
            transition: all 0.2s;
        }
        
        .hide-btn:hover {
            background: var(--red);
            color: white;
            opacity: 1;
        }
        
        .blacklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .btn-restore {
            background: var(--green);
            color: #000;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
        }
        
        .btn-restore:hover {
            opacity: 0.8;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CHAIN SELECTOR (Professionale con icone SVG)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .chain-selector-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .chain-selector-item:hover {
            background: var(--bg-card);
            border-color: var(--text-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .chain-selector-item.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.05));
            border-color: var(--accent);
        }
        
        .chain-selector-item.selected[data-chain="eth"] { border-color: #627eea; background: linear-gradient(135deg, rgba(98, 126, 234, 0.2), rgba(98, 126, 234, 0.05)); }
        .chain-selector-item.selected[data-chain="bsc"] { border-color: #f3ba2f; background: linear-gradient(135deg, rgba(243, 186, 47, 0.2), rgba(243, 186, 47, 0.05)); }
        .chain-selector-item.selected[data-chain="polygon"] { border-color: #8247e5; background: linear-gradient(135deg, rgba(130, 71, 229, 0.2), rgba(130, 71, 229, 0.05)); }
        .chain-selector-item.selected[data-chain="arbitrum"] { border-color: #28a0f0; background: linear-gradient(135deg, rgba(40, 160, 240, 0.2), rgba(40, 160, 240, 0.05)); }
        .chain-selector-item.selected[data-chain="optimism"] { border-color: #ff0420; background: linear-gradient(135deg, rgba(255, 4, 32, 0.2), rgba(255, 4, 32, 0.05)); }
        .chain-selector-item.selected[data-chain="base"] { border-color: #0052ff; background: linear-gradient(135deg, rgba(0, 82, 255, 0.2), rgba(0, 82, 255, 0.05)); }
        .chain-selector-item.selected[data-chain="avalanche"] { border-color: #e84142; background: linear-gradient(135deg, rgba(232, 65, 66, 0.2), rgba(232, 65, 66, 0.05)); }
        .chain-selector-item.selected[data-chain="fantom"] { border-color: #1969ff; background: linear-gradient(135deg, rgba(25, 105, 255, 0.2), rgba(25, 105, 255, 0.05)); }
        .chain-selector-item.selected[data-chain="cronos"] { border-color: #002d74; background: linear-gradient(135deg, rgba(0, 45, 116, 0.3), rgba(0, 45, 116, 0.1)); }
        .chain-selector-item.selected[data-chain="pulse"] { border-color: #00ff00; background: linear-gradient(135deg, rgba(0, 255, 0, 0.15), rgba(0, 255, 0, 0.03)); }
        .chain-selector-item.selected[data-chain="blackfort"] { border-color: #00d4ff; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.05)); }
        
        .chain-icon {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }
        
        .chain-icon svg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .chain-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .chain-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chain-symbol {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chain-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: var(--green);
            transition: all 0.2s;
        }
        
        .chain-selector-item.selected .chain-check {
            background: var(--green);
            color: #000;
        }
        
        .chain-selector-item.selected[data-chain="eth"] .chain-check { background: #627eea; }
        .chain-selector-item.selected[data-chain="bsc"] .chain-check { background: #f3ba2f; color: #000; }
        .chain-selector-item.selected[data-chain="polygon"] .chain-check { background: #8247e5; }
        .chain-selector-item.selected[data-chain="arbitrum"] .chain-check { background: #28a0f0; }
        .chain-selector-item.selected[data-chain="optimism"] .chain-check { background: #ff0420; }
        .chain-selector-item.selected[data-chain="base"] .chain-check { background: #0052ff; }
        .chain-selector-item.selected[data-chain="avalanche"] .chain-check { background: #e84142; }
        .chain-selector-item.selected[data-chain="fantom"] .chain-check { background: #1969ff; }
        .chain-selector-item.selected[data-chain="cronos"] .chain-check { background: #002d74; }
        .chain-selector-item.selected[data-chain="pulse"] .chain-check { background: #00ff00; color: #000; }
        .chain-selector-item.selected[data-chain="blackfort"] .chain-check { background: #00d4ff; color: #000; }
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CHAIN DROPDOWN MULTI-SELECT (COMPATTO)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .chain-dropdown-container {
            position: relative;
            width: 100%;
        }
        
        .chain-dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chain-dropdown-trigger:hover {
            border-color: var(--accent);
        }
        
        .chain-dropdown-trigger.open {
            border-color: var(--accent);
            border-radius: 10px 10px 0 0;
        }
        
        .chain-dropdown-selected {
            font-size: 14px;
        }
        
        .chain-dropdown-selected .placeholder {
            color: var(--text-secondary);
        }
        
        .chain-dropdown-arrow {
            color: var(--text-secondary);
            font-size: 10px;
            transition: transform 0.2s;
        }
        
        .chain-dropdown-trigger.open .chain-dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .chain-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        .chain-dropdown-menu.open {
            display: block;
        }
        
        .chain-dropdown-actions {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .chain-action-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chain-action-btn:hover {
            background: var(--border);
        }
        
        .chain-action-btn.primary {
            background: var(--accent);
            color: #000;
        }
        
        .chain-dropdown-divider {
            height: 1px;
            background: var(--border);
        }
        
        .chain-section-label {
            padding: 8px 12px 4px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }
        
        .chain-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .chain-dropdown-item:hover {
            background: var(--bg-secondary);
        }
        
        .chain-dropdown-item.selected {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .chain-icon-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .chain-info-compact {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chain-info-compact .chain-name {
            font-size: 13px;
            font-weight: 500;
        }
        
        .chain-info-compact .chain-symbol {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .chain-dropdown-item .chain-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: transparent;
            transition: all 0.2s;
        }
        
        .chain-dropdown-item.selected .chain-checkbox {
            background: var(--green);
            border-color: var(--green);
            color: #000;
        }
        
        /* Selected Chain Tags */
        .selected-chain-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .chain-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .chain-tag .tag-remove {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-secondary);
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chain-tag .tag-remove:hover {
            background: var(--red);
        }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SIDEBAR
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <nav class="sidebar">
            <div class="logo">
                <h1>ğŸ’° CryptoFolio</h1>
                <span>v6.0 Modulare</span>
            </div>
            
            <div class="nav-item active" onclick="showView('dashboard')">
                <span class="icon">ğŸ“Š</span>
                <span>Dashboard</span>
            </div>
            
            <div class="nav-item" onclick="showView('wallets')">
                <span class="icon">ğŸ‘›</span>
                <span>Wallets</span>
            </div>
            
            <div class="nav-item" onclick="showView('transactions')">
                <span class="icon">ğŸ“œ</span>
                <span>Transazioni</span>
            </div>
            
            <div class="nav-item" onclick="showView('tax')">
                <span class="icon">ğŸ“‹</span>
                <span>Report Fiscale</span>
            </div>
            
            <div class="nav-item" onclick="showView('settings')">
                <span class="icon">âš™ï¸</span>
                <span>Impostazioni</span>
            </div>
            
            <div style="border-top:1px solid var(--border);margin:16px 0;"></div>
            
            <div class="nav-item" onclick="toggleBlacklist()">
                <span class="icon">ğŸš«</span>
                <span>Token Nascosti</span>
                <span id="blacklistCount" style="background:var(--red);color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;">0</span>
            </div>
            
            <!-- Pannello Token Nascosti -->
            <div id="blacklistPanel" style="display:none;padding:12px;background:var(--bg-card);margin:8px;border-radius:8px;border:1px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="font-size:13px;font-weight:600;">ğŸš« Nascosti</span>
                    <button class="btn btn-secondary" onclick="clearBlacklist()" style="padding:4px 8px;font-size:10px;">ğŸ—‘ï¸ Svuota</button>
                </div>
                <div id="blacklistContent">
                    <p class="text-secondary" style="font-size:12px;">Nessun token nascosto</p>
                </div>
            </div>
        </nav>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             MAIN CONTENT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="main-content">
            
            <!-- HEADER -->
            <div class="header">
                <h2 id="viewTitle">Dashboard</h2>
                <div class="sync-status">
                    <span id="syncDot"></span>
                    <span id="syncStatus">Inizializzazione...</span>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: DASHBOARD
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-dashboard" class="view active">
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">ğŸ’° Patrimonio Totale</div>
                        <div class="value" id="totalValue">â‚¬0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ğŸ‘› Wallets</div>
                        <div class="value" id="totalWallets">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ğŸ“œ Transazioni</div>
                        <div class="value" id="totalTx">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ğŸª™ Asset Diversi</div>
                        <div class="value" id="totalAssets">0</div>
                    </div>
                </div>
                
                <!-- Grafico e Top Holdings -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
                    
                    <!-- Grafico a Torta -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“Š Distribuzione Portfolio</div>
                        </div>
                        <div style="position:relative;height:280px;">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top Holdings -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ† Top Holdings</div>
                        </div>
                        <div id="topHoldingsList">
                            <div class="empty-state" style="padding:20px;">
                                <p class="text-secondary">Nessun asset</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">âš¡ Azioni Rapide</div>
                    </div>
                    <div class="flex gap-8">
                        <button class="btn" onclick="showView('wallets')">â• Aggiungi Wallet</button>
                        <button class="btn btn-secondary" onclick="refreshAll()">ğŸ”„ Aggiorna Tutto</button>
                        <button class="btn btn-secondary" onclick="showView('tax')">ğŸ“‹ Genera Report</button>
                    </div>
                </div>
                
                <!-- Log Console -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“ Log</div>
                        <button class="btn btn-secondary" onclick="clearLog()">Pulisci</button>
                    </div>
                    <div id="logConsole">
                        <div class="log-entry text-secondary">In attesa di inizializzazione...</div>
                    </div>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: WALLETS
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-wallets" class="view">
                
                <!-- Add Wallet -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">â• Aggiungi Wallet</div>
                    </div>
                    <div class="flex gap-8 items-center">
                        <input type="text" id="walletName" placeholder="Nome (es: Main Wallet)" style="max-width:200px">
                        <input type="text" id="walletAddress" placeholder="Indirizzo (0x... o terra1... o cosmos1...)">
                        <button class="btn" onclick="addWallet()">Aggiungi</button>
                    </div>
                    <p class="text-secondary mt-8" style="font-size:12px;">
                        Supportati: EVM (ETH, BSC, Polygon...), Cosmos (Terra, ATOM, OSMO)
                    </p>
                </div>
                
                <!-- Chain Selector - Dropdown Multi-Select -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">â›“ï¸ Chain da Scansionare</div>
                    </div>
                    
                    <!-- Dropdown Container -->
                    <div class="chain-dropdown-container">
                        <div class="chain-dropdown-trigger" onclick="toggleChainDropdown()">
                            <div class="chain-dropdown-selected" id="chainDropdownSelected">
                                <span class="placeholder">Seleziona chain...</span>
                            </div>
                            <div class="chain-dropdown-arrow">â–¼</div>
                        </div>
                        
                        <div class="chain-dropdown-menu" id="chainDropdownMenu">
                            <!-- Quick Actions -->
                            <div class="chain-dropdown-actions">
                                <button onclick="selectAllChains()" class="chain-action-btn">âœ… Tutte</button>
                                <button onclick="selectNoChains()" class="chain-action-btn">âŒ Nessuna</button>
                                <button onclick="selectMainChains()" class="chain-action-btn primary">â­ Principali</button>
                            </div>
                            
                            <!-- Divider -->
                            <div class="chain-dropdown-divider"></div>
                            
                            <!-- EVM Chains Section -->
                            <div class="chain-section-label">ğŸ”· EVM Chains</div>
                            <div id="evmChainsList"></div>
                            
                            <!-- Divider -->
                            <div class="chain-dropdown-divider"></div>
                            
                            <!-- Cosmos Chains Section -->
                            <div class="chain-section-label">ğŸŒŒ Cosmos Ecosystem</div>
                            <div id="cosmosChainsList"></div>
                            
                            <!-- Divider -->
                            <div class="chain-dropdown-divider"></div>
                            
                            <!-- Other Chains Section -->
                            <div class="chain-section-label">ğŸ”— Other Chains</div>
                            <div id="otherChainsList"></div>
                        </div>
                    </div>
                    
                    <!-- Selected Tags -->
                    <div id="selectedChainTags" class="selected-chain-tags mt-12"></div>
                    
                    <div class="mt-8 text-secondary" style="font-size:11px;">
                        <span id="selectedChainsCount">0</span> chain selezionate
                    </div>
                </div>
                
                <!-- Wallet List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ‘› I Tuoi Wallets</div>
                        <button class="btn btn-secondary" onclick="scanAllWallets()">ğŸ”„ Scansiona Tutti</button>
                    </div>
                    <div id="walletList">
                        <div class="empty-state">
                            <div class="icon">ğŸ‘›</div>
                            <p>Nessun wallet aggiunto</p>
                        </div>
                    </div>
                    
                    <!-- Pulsanti Reset -->
                    <div class="mt-16 pt-16" style="border-top:1px solid var(--border);">
                        <div class="flex gap-8" style="margin-bottom:12px;">
                            <button class="btn" onclick="resetKeepApiKeys()" style="flex:1;background:var(--yellow);color:#000;">
                                ğŸ”„ Reset Pulito (mantieni API Keys)
                            </button>
                        </div>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width:100%;">
                            ğŸ—‘ï¸ Cancella TUTTO (incluse API Keys)
                        </button>
                        <p class="text-secondary mt-8" style="font-size:11px;text-align:center;">
                            Reset Pulito: rimuove dati ma mantiene le API keys configurate<br>
                            Cancella TUTTO: rimuove anche le API keys
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: WALLET DETAIL
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-walletDetail" class="view">
                
                <!-- Header -->
                <div class="card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-16">
                            <button class="btn btn-secondary" onclick="showView('wallets')">â† Indietro</button>
                            <div>
                                <h3 id="detailWalletName" style="font-size:20px;">Wallet</h3>
                                <code id="detailWalletAddress" class="text-secondary" style="font-size:12px;"></code>
                            </div>
                        </div>
                        <div class="flex gap-8">
                            <button class="btn" onclick="scanCurrentWallet()">ğŸ”„ Scansiona</button>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">ğŸ’° Valore Totale</div>
                        <div class="value" id="detailTotalValue">â‚¬0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ğŸª™ Token</div>
                        <div class="value" id="detailTokenCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ğŸ“œ Transazioni</div>
                        <div class="value" id="detailTxCount">0</div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex gap-8 mb-16">
                    <button class="btn" id="tabTokens" onclick="showWalletTab('tokens')" style="background:var(--accent);color:white;">ğŸª™ Token</button>
                    <button class="btn" id="tabTx" onclick="showWalletTab('tx')" style="background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);">ğŸ“œ Transazioni</button>
                </div>
                
                <!-- Token List -->
                <div id="walletTokensTab" class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸª™ Token</div>
                    </div>
                    <div id="walletTokensList">
                        <div class="empty-state">
                            <div class="icon">ğŸª™</div>
                            <p>Nessun token trovato</p>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions List -->
                <div id="walletTxTab" class="card" style="display:none;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“œ Transazioni</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Coin</th>
                                    <th>Importo</th>
                                    <th>Chain</th>
                                </tr>
                            </thead>
                            <tbody id="walletTxTableBody">
                                <tr>
                                    <td colspan="5" class="text-secondary" style="text-align:center;">
                                        Nessuna transazione
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: TRANSACTIONS
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-transactions" class="view">
                
                <!-- Filters -->
                <div class="card">
                    <div class="flex gap-8 items-center">
                        <select id="txFilterYear" onchange="filterTransactions()">
                            <option value="">Tutti gli anni</option>
                        </select>
                        <select id="txFilterSource" onchange="filterTransactions()">
                            <option value="">Tutte le fonti</option>
                        </select>
                        <select id="txFilterType" onchange="filterTransactions()">
                            <option value="">Tutti i tipi</option>
                            <option value="deposit">Depositi</option>
                            <option value="withdrawal">Prelievi</option>
                            <option value="trade">Trade</option>
                            <option value="fee">Fee</option>
                            <option value="staking">Staking</option>
                        </select>
                    </div>
                </div>
                
                <!-- Transaction Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“œ Transazioni (<span id="txCount">0</span>)</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Coin In</th>
                                    <th>Coin Out</th>
                                    <th>Valore â‚¬</th>
                                    <th>Fonte</th>
                                </tr>
                            </thead>
                            <tbody id="txTableBody">
                                <tr>
                                    <td colspan="6" class="text-secondary" style="text-align:center;padding:40px;">
                                        Nessuna transazione
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: TAX
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-tax" class="view">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“‹ Report Fiscale</div>
                    </div>
                    <div class="flex gap-8 items-center mb-16">
                        <select id="taxYear">
                            <option value="2025">2025</option>
                            <option value="2024" selected>2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                        <button class="btn" onclick="generateTaxReport()">ğŸ“Š Genera Report</button>
                        <button class="btn btn-secondary" onclick="exportTaxReport()">ğŸ“¤ Esporta CSV</button>
                    </div>
                    <div id="taxReportContent">
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>Seleziona un anno e genera il report</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 VIEW: SETTINGS
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="view-settings" class="view">
                
                <!-- API Keys -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ”‘ API Keys Moralis (a cascata)</div>
                    </div>
                    
                    <p class="text-secondary mb-16" style="font-size:12px;">
                        Aggiungi piÃ¹ API key per evitare rate limit. Verranno usate a rotazione.<br>
                        Ottieni gratis su <a href="https://moralis.io" target="_blank" style="color:var(--accent)">moralis.io</a>
                    </p>
                    
                    <div class="flex gap-8 mb-16">
                        <input type="text" id="newMoralisKey" placeholder="Incolla nuova API Key Moralis">
                        <button class="btn" onclick="addMoralisKey()">â• Aggiungi</button>
                    </div>
                    
                    <div id="moralisKeysList">
                        <!-- Lista dinamica -->
                    </div>
                </div>
                
                <!-- Etherscan API -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ”‘ Etherscan API Key (opzionale)</div>
                    </div>
                    
                    <div class="flex gap-8">
                        <input type="password" id="apiEtherscan" placeholder="Inserisci API Key Etherscan">
                        <button class="btn btn-secondary" onclick="saveApiKey('etherscan')">Salva</button>
                    </div>
                </div>
                
                <!-- Helius API (Solana) -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">â— Helius API Key (Solana)</div>
                    </div>
                    
                    <p class="text-secondary mb-12" style="font-size:12px;">
                        Per scansionare wallet Solana. Ottieni gratis su <a href="https://dev.helius.xyz/" target="_blank" style="color:var(--accent)">dev.helius.xyz</a> (100k req/mese gratis)
                    </p>
                    
                    <div class="flex gap-8">
                        <input type="password" id="apiHelius" placeholder="Inserisci API Key Helius">
                        <button class="btn btn-secondary" onclick="saveApiKey('helius')">Salva</button>
                    </div>
                    <div id="heliusStatus" class="mt-8" style="font-size:11px;"></div>
                </div>
                
                <!-- Data Management -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ’¾ Gestione Dati</div>
                    </div>
                    <div class="flex gap-8">
                        <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ Esporta JSON</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ Importa JSON</button>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                        <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Cancella Tutto</button>
                    </div>
                </div>
                
                <!-- Debug Info -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ› Debug Info</div>
                    </div>
                    <pre id="debugInfo" style="font-size:11px;color:var(--text-secondary);"></pre>
                </div>
            </div>
            
        </main>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODULI JAVASCRIPT
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script src="modules/schema.js"></script>
    <script src="modules/config.js"></script>
    <script src="modules/database.js"></script>
    <script src="modules/prices.js"></script>
    <script src="modules/wallet-evm.js"></script>
    <script src="modules/wallet-cosmos.js"></script>
    <script src="modules/wallet-solana.js"></script>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         APP MAIN
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function init() {
            log('ğŸš€ Inizializzazione CryptoFolio v6...');
            
            // Init database (Firebase)
            await Database.init();
            
            // Carica API keys salvate
            loadApiKeys();
            
            // Inizializza chain selector
            initChainSelector();
            
            // Aggiorna UI
            updateDashboard();
            updateWalletList();
            await updateTransactionTable();
            updateDebugInfo();
            updateBlacklistPanel();  // Badge token nascosti
            
            log('âœ… Inizializzazione completata');
            document.getElementById('syncStatus').textContent = 'Pronto';
            document.getElementById('syncDot').style.background = 'var(--green)';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHAIN SELECTOR - DROPDOWN COMPATTO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Tutte le chain supportate (EVM + Cosmos + Solana)
        const ALL_CHAINS = {
            // === EVM CHAINS ===
            'eth': { name: 'Ethereum', symbol: 'ETH', color: '#627eea', type: 'evm', icon: 'âŸ ' },
            'bsc': { name: 'BNB Chain', symbol: 'BNB', color: '#f3ba2f', type: 'evm', icon: 'ğŸ”¶' },
            'polygon': { name: 'Polygon', symbol: 'MATIC', color: '#8247e5', type: 'evm', icon: 'ğŸŸ£' },
            'arbitrum': { name: 'Arbitrum', symbol: 'ARB', color: '#28a0f0', type: 'evm', icon: 'ğŸ”µ' },
            'optimism': { name: 'Optimism', symbol: 'OP', color: '#ff0420', type: 'evm', icon: 'ğŸ”´' },
            'base': { name: 'Base', symbol: 'ETH', color: '#0052ff', type: 'evm', icon: 'ğŸ”·' },
            'avalanche': { name: 'Avalanche', symbol: 'AVAX', color: '#e84142', type: 'evm', icon: 'ğŸ”º' },
            'fantom': { name: 'Fantom', symbol: 'FTM', color: '#1969ff', type: 'evm', icon: 'ğŸ‘»' },
            'cronos': { name: 'Cronos', symbol: 'CRO', color: '#002d74', type: 'evm', icon: 'ğŸ¦' },
            'pulse': { name: 'PulseChain', symbol: 'PLS', color: '#00ff00', type: 'evm', icon: 'ğŸ’š' },
            'blackfort': { name: 'BlackFort', symbol: 'BXN', color: '#00d4ff', type: 'evm', icon: 'ğŸ°' },
            // === COSMOS CHAINS ===
            'atom': { name: 'Cosmos Hub', symbol: 'ATOM', color: '#2E3148', type: 'cosmos', icon: 'âš›ï¸' },
            'osmo': { name: 'Osmosis', symbol: 'OSMO', color: '#750BBB', type: 'cosmos', icon: 'ğŸ§ª' },
            'terra': { name: 'Terra Classic', symbol: 'LUNC', color: '#172852', type: 'cosmos', icon: 'ğŸŒ™' },
            'luna': { name: 'Terra 2.0', symbol: 'LUNA', color: '#172852', type: 'cosmos', icon: 'ğŸŒ•' },
            // === SOLANA ===
            'sol': { name: 'Solana', symbol: 'SOL', color: '#9945FF', type: 'solana', icon: 'â—' },
            // === OTHER ===
            'top': { name: 'TOP Network', symbol: 'TOP', color: '#00A3FF', type: 'other', icon: 'ğŸ”' }
        };
        
        // Chain principali (default)
        const MAIN_CHAINS = ['eth', 'bsc', 'polygon', 'arbitrum', 'base'];
        
        // Stato dropdown
        let chainDropdownOpen = false;
        
        function initChainSelector() {
            // Carica selezione salvata o usa default
            const saved = localStorage.getItem('cryptofolio_selectedChains');
            const selectedChains = saved ? JSON.parse(saved) : MAIN_CHAINS;
            AppState.selectedChains = selectedChains;
            
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
        }
        
        function renderChainDropdown() {
            const evmList = document.getElementById('evmChainsList');
            const cosmosList = document.getElementById('cosmosChainsList');
            const otherList = document.getElementById('otherChainsList');
            
            if (!evmList) return;
            
            let evmHtml = '';
            let cosmosHtml = '';
            let otherHtml = '';
            
            for (const [key, chain] of Object.entries(ALL_CHAINS)) {
                const isSelected = AppState.selectedChains.includes(key);
                const itemHtml = `
                    <div class="chain-dropdown-item ${isSelected ? 'selected' : ''}" onclick="toggleChainSelect('${key}')">
                        <div class="chain-icon-small" style="background:${chain.color};">${chain.icon}</div>
                        <div class="chain-info-compact">
                            <span class="chain-name">${chain.name}</span>
                            <span class="chain-symbol">${chain.symbol}</span>
                        </div>
                        <div class="chain-checkbox">${isSelected ? 'âœ“' : ''}</div>
                    </div>
                `;
                
                if (chain.type === 'evm') evmHtml += itemHtml;
                else if (chain.type === 'cosmos') cosmosHtml += itemHtml;
                else otherHtml += itemHtml;
            }
            
            evmList.innerHTML = evmHtml;
            cosmosList.innerHTML = cosmosHtml;
            otherList.innerHTML = otherHtml;
        }
        
        function renderSelectedTags() {
            const container = document.getElementById('selectedChainTags');
            if (!container) return;
            
            if (AppState.selectedChains.length === 0) {
                container.innerHTML = '<span class="text-secondary" style="font-size:12px;">Nessuna chain selezionata</span>';
                return;
            }
            
            let html = '';
            for (const key of AppState.selectedChains) {
                const chain = ALL_CHAINS[key];
                if (!chain) continue;
                html += `
                    <span class="chain-tag" style="border-color:${chain.color}40;background:${chain.color}15;">
                        <span style="font-size:14px;">${chain.icon}</span>
                        <span>${chain.symbol}</span>
                        <span class="tag-remove" onclick="removeChain('${key}')">âœ•</span>
                    </span>
                `;
            }
            container.innerHTML = html;
        }
        
        function toggleChainDropdown() {
            chainDropdownOpen = !chainDropdownOpen;
            const trigger = document.querySelector('.chain-dropdown-trigger');
            const menu = document.getElementById('chainDropdownMenu');
            
            if (chainDropdownOpen) {
                trigger.classList.add('open');
                menu.classList.add('open');
            } else {
                trigger.classList.remove('open');
                menu.classList.remove('open');
            }
        }
        
        function toggleChainSelect(chainKey) {
            const index = AppState.selectedChains.indexOf(chainKey);
            
            if (index > -1) {
                AppState.selectedChains.splice(index, 1);
            } else {
                AppState.selectedChains.push(chainKey);
            }
            
            localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(AppState.selectedChains));
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
            
            const chain = ALL_CHAINS[chainKey];
            log(`â›“ï¸ ${chain.name}: ${index > -1 ? 'rimossa' : 'aggiunta'}`);
        }
        
        function removeChain(chainKey) {
            AppState.selectedChains = AppState.selectedChains.filter(c => c !== chainKey);
            localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(AppState.selectedChains));
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
        }
        
        function selectAllChains() {
            AppState.selectedChains = Object.keys(ALL_CHAINS);
            localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(AppState.selectedChains));
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
            log('âœ… Tutte le chain selezionate');
        }
        
        function selectNoChains() {
            AppState.selectedChains = [];
            localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(AppState.selectedChains));
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
            log('âŒ Nessuna chain selezionata');
        }
        
        function selectMainChains() {
            AppState.selectedChains = [...MAIN_CHAINS];
            localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(AppState.selectedChains));
            renderChainDropdown();
            renderSelectedTags();
            updateSelectedChainsCount();
            log('â­ Chain principali: ' + MAIN_CHAINS.join(', '));
        }
        
        function updateSelectedChainsCount() {
            const countEl = document.getElementById('selectedChainsCount');
            if (countEl) {
                countEl.textContent = AppState.selectedChains.length;
            }
            
            // Aggiorna anche placeholder dropdown
            const placeholder = document.querySelector('.chain-dropdown-selected');
            if (placeholder) {
                if (AppState.selectedChains.length === 0) {
                    placeholder.innerHTML = '<span class="placeholder">Seleziona chain...</span>';
                } else {
                    placeholder.innerHTML = `<span>${AppState.selectedChains.length} chain selezionate</span>`;
                }
            }
        }
        
        function getSelectedChains() {
            return AppState.selectedChains || MAIN_CHAINS;
        }
        
        // Chiudi dropdown cliccando fuori
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chain-dropdown-container') && chainDropdownOpen) {
                toggleChainDropdown();
            }
        });
        
        // Per compatibilitÃ  con EVM_CHAINS usato altrove
        const EVM_CHAINS = {};
        for (const [k, v] of Object.entries(ALL_CHAINS)) {
            if (v.type === 'evm') EVM_CHAINS[k] = v;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Update nav (solo se esiste il nav-item)
            const navItem = document.querySelector(`.nav-item[onclick="showView('${viewName}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            } else if (viewName === 'walletDetail') {
                // Per walletDetail, evidenzia "Wallets" nel menu
                const walletsNav = document.querySelector(`.nav-item[onclick="showView('wallets')"]`);
                if (walletsNav) walletsNav.classList.add('active');
            }
            
            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'wallets': 'Wallets',
                'walletDetail': 'Dettaglio Wallet',
                'transactions': 'Transazioni',
                'tax': 'Report Fiscale',
                'settings': 'Impostazioni'
            };
            document.getElementById('viewTitle').textContent = titles[viewName] || viewName;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WALLET MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function addWallet() {
            const name = document.getElementById('walletName').value.trim();
            const address = document.getElementById('walletAddress').value.trim();
            
            if (!name) {
                alert('Inserisci un nome per il wallet');
                return;
            }
            if (!address) {
                alert('Inserisci un indirizzo');
                return;
            }
            
            // Rileva tipo wallet
            let type = 'unknown';
            let chain = '';
            
            if (address.startsWith('0x') && address.length === 42) {
                type = 'evm';
                chain = 'eth'; // Default, verrÃ  scansionato su multiple chain
            } else if (address.startsWith('terra1')) {
                type = 'cosmos';
                chain = 'terra';
            } else if (address.startsWith('cosmos1')) {
                type = 'cosmos';
                chain = 'atom';
            } else if (address.startsWith('osmo1')) {
                type = 'cosmos';
                chain = 'osmo';
            } else if (/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address)) {
                // Solana address (base58 encoded, 32-44 chars)
                type = 'solana';
                chain = 'sol';
                
                // Verifica API Key Helius
                const heliusKey = Database.getState().apiKeys?.helius;
                if (!heliusKey) {
                    alert('âš ï¸ Per scansionare wallet Solana devi configurare l\'API Key Helius!\n\nVai in Impostazioni e aggiungi la chiave gratuita da dev.helius.xyz');
                }
            } else {
                alert('Indirizzo non riconosciuto.\n\nSupportati:\nâ€¢ EVM (0x...)\nâ€¢ Solana (base58)\nâ€¢ Terra (terra1...)\nâ€¢ Cosmos (cosmos1...)\nâ€¢ Osmosis (osmo1...)');
                return;
            }
            
            const wallet = {
                id: generateUUID(),
                name: name,
                address: address,
                type: type,
                chain: chain,
                addedAt: Date.now(),
                lastSync: null
            };
            
            if (Database.addWallet(wallet)) {
                log(`âœ… Wallet ${type.toUpperCase()} aggiunto: ${name}`);
                document.getElementById('walletName').value = '';
                document.getElementById('walletAddress').value = '';
                updateWalletList();
                updateDashboard();
            } else {
                alert('Wallet giÃ  esistente');
            }
        }
        
        function removeWallet(address) {
            if (confirm('Eliminare questo wallet e TUTTI i dati associati (balance e transazioni)?')) {
                Database.removeWallet(address);
                updateWalletList();
                updateDashboard();
                updateTransactionTable();
                log(`ğŸ—‘ï¸ Wallet e dati associati eliminati`);
            }
        }
        
        // Cancella TUTTI i dati
        function clearAllData() {
            if (confirm('âš ï¸ ATTENZIONE!\n\nQuesto cancellerÃ  TUTTI i dati:\n- Wallet\n- Balance\n- Transazioni\n- Exchange\n- Blacklist\n\nI dati verranno cancellati anche su Firebase!\n\nContinuare?')) {
                Database.clearAllData();
                localStorage.removeItem('cryptofolio_blacklist');
                updateWalletList();
                updateDashboard();
                updateTransactionTable();
                log(`ğŸ—‘ï¸ RESET TOTALE - tutti i dati cancellati`);
                alert('âœ… Tutti i dati cancellati!\n\nWallet: 0\nBalance: 0\nTransazioni: 0');
            }
        }
        
        // Reset pulito mantenendo SOLO le API Keys
        function resetKeepApiKeys() {
            if (confirm('ğŸ”„ RESET PULITO\n\nQuesto cancellerÃ :\nâœ— Wallet\nâœ— Balance\nâœ— Transazioni\nâœ— Exchange\nâœ— Blacklist\n\nâœ“ Le API Keys verranno MANTENUTE!\n\nContinuare?')) {
                const state = Database.getState();
                
                // Salva le API keys
                const savedApiKeys = JSON.parse(JSON.stringify(state.apiKeys));
                const savedChains = JSON.parse(JSON.stringify(AppState.selectedChains || []));
                
                log('ğŸ’¾ Salvate API Keys: Moralis x' + (savedApiKeys.moralis?.length || 0) + ', Etherscan: ' + (savedApiKeys.etherscan ? 'âœ“' : 'âœ—'));
                
                // Cancella tutto
                AppState.wallets = [];
                AppState.balances = {};
                AppState.transactions = [];
                AppState.exchanges = {};
                AppState.prices = {};
                AppState.historicalPrices = {};
                
                // Ripristina API keys
                AppState.apiKeys = savedApiKeys;
                
                // Salva su Firebase
                Database.saveNow();
                
                // Pulisci localStorage (tranne chain selector)
                localStorage.removeItem('cryptofolio_blacklist');
                localStorage.removeItem('cryptofolio_v6_backup');
                
                // Ripristina chain selection
                if (savedChains.length > 0) {
                    localStorage.setItem('cryptofolio_selectedChains', JSON.stringify(savedChains));
                }
                
                // Aggiorna UI
                updateWalletList();
                updateDashboard();
                updateTransactionTable();
                updateDebugInfo();
                
                log('âœ… RESET PULITO completato!');
                log('ğŸ’¾ API Keys mantenute: Moralis x' + (savedApiKeys.moralis?.length || 0));
                
                alert('âœ… Reset Pulito completato!\n\n' +
                      'âœ— Wallet: 0\n' +
                      'âœ— Balance: 0\n' +
                      'âœ— Transazioni: 0\n\n' +
                      'âœ“ API Keys mantenute:\n' +
                      '  - Moralis: ' + (savedApiKeys.moralis?.length || 0) + ' keys\n' +
                      '  - Etherscan: ' + (savedApiKeys.etherscan ? 'SÃ¬' : 'No'));
            }
        }
        
        async function scanWallet(address) {
            const wallets = Database.getWallets();
            const wallet = wallets.find(w => w.address.toLowerCase() === address.toLowerCase());
            
            if (!wallet) {
                log('âŒ Wallet non trovato');
                return;
            }
            
            log(`ğŸ”„ Scansione ${wallet.name}...`);
            document.getElementById('syncStatus').textContent = 'Scansione...';
            document.getElementById('syncDot').style.background = 'var(--yellow)';
            
            let result;
            
            // Usa le chain selezionate dall'utente
            const selectedChains = getSelectedChains();
            
            if (selectedChains.length === 0) {
                log('âš ï¸ Nessuna chain selezionata! Vai su Wallets e seleziona almeno una chain.');
                document.getElementById('syncStatus').textContent = 'Pronto';
                document.getElementById('syncDot').style.background = 'var(--green)';
                return;
            }
            
            log(`â›“ï¸ Scansione su ${selectedChains.length} chain: ${selectedChains.join(', ')}`);
            
            if (wallet.type === 'evm') {
                // Filtra solo chain EVM selezionate
                const evmChains = selectedChains.filter(c => ALL_CHAINS[c]?.type === 'evm');
                if (evmChains.length > 0) {
                    result = await WalletEVM.fullScan(wallet.address, evmChains);
                }
            } else if (wallet.type === 'cosmos') {
                result = await WalletCosmos.fullScan(wallet.address);
            } else if (wallet.type === 'solana') {
                // Scan Solana con Helius
                if (typeof WalletSolana !== 'undefined') {
                    log('â— Scansione Solana con Helius...');
                    result = await WalletSolana.fullScan(wallet.address);
                } else {
                    log('âš ï¸ Modulo Solana non caricato');
                    result = { success: false, error: 'Modulo Solana non disponibile' };
                }
            }
            
            if (result && result.success) {
                log(`âœ… ${wallet.name}: ${result.balances?.length || 0} token, ${result.transactions?.length || 0} tx`);
                wallet.lastSync = Date.now();
                Database.save();
            } else {
                log(`âŒ Errore scansione: ${result?.error || 'Sconosciuto'}`);
            }
            
            updateWalletList();
            updateDashboard();
            updateTransactionTable();
            
            document.getElementById('syncStatus').textContent = 'Pronto';
            document.getElementById('syncDot').style.background = 'var(--green)';
        }
        
        async function scanAllWallets() {
            const wallets = Database.getWallets();
            
            for (const wallet of wallets) {
                await scanWallet(wallet.address);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WALLET DETAIL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentWalletAddress = null;
        
        function openWalletDetail(address) {
            const wallets = Database.getWallets();
            const wallet = wallets.find(w => w.address.toLowerCase() === address.toLowerCase());
            
            if (!wallet) {
                log('âŒ Wallet non trovato');
                return;
            }
            
            currentWalletAddress = address.toLowerCase();
            
            // Aggiorna header
            document.getElementById('detailWalletName').textContent = wallet.name;
            document.getElementById('detailWalletAddress').textContent = wallet.address;
            
            // Carica dati
            updateWalletDetail();
            
            // Mostra view
            showView('walletDetail');
        }
        
        function updateWalletDetail() {
            if (!currentWalletAddress) return;
            
            const state = Database.getState();
            
            // Trova token di questo wallet (esclusi blacklist)
            const walletBalances = [];
            const searchSource = `wallet_${currentWalletAddress.toLowerCase()}`;
            
            console.log('ğŸ” Cercando balance per:', searchSource);
            
            for (const [key, balance] of Object.entries(state.balances)) {
                // Match piÃ¹ permissivo: controlla se source contiene l'indirizzo
                const isMatch = (balance.source && balance.source.toLowerCase() === searchSource) ||
                               (balance.source && balance.source.toLowerCase().includes(currentWalletAddress.toLowerCase()));
                
                if (!isMatch) continue;
                
                // âš ï¸ Blacklist basata su CONTRACT ADDRESS (come v5.2)
                const contractAddr = balance.contractAddress || `native-${balance.chain}`;
                if (isBlacklisted(contractAddr)) {
                    console.log(`  âŒ Escluso (blacklist): ${balance.coin}`);
                    continue;
                }
                
                // Filtra pattern scam (come v5.2)
                if (isScamToken(balance.name, balance.coin)) {
                    console.log(`  âŒ Escluso (scam pattern): ${balance.coin}`);
                    continue;
                }
                
                walletBalances.push(balance);
            }
            
            console.log('âœ… Trovati', walletBalances.length, 'token (dopo filtri)');
            
            // Ordina per valore
            walletBalances.sort((a, b) => (b.valueEUR || 0) - (a.valueEUR || 0));
            
            // Trova transazioni di questo wallet
            const addrLower = currentWalletAddress.toLowerCase();
            const walletTx = state.transactions.filter(tx => {
                const txWallet = (tx.wallet || '').toLowerCase();
                const txSource = (tx.source || '').toLowerCase();
                return txWallet === addrLower || 
                       txWallet.includes(addrLower) ||
                       txSource.includes(addrLower);
            });
            
            // Calcola totale
            let totalValue = 0;
            for (const bal of walletBalances) {
                const price = PriceService.getPrice(bal.coin, 'eur');
                bal.valueEUR = bal.amount * price;
                totalValue += bal.valueEUR;
            }
            
            // Aggiorna stats
            document.getElementById('detailTotalValue').textContent = 'â‚¬' + formatEUR(totalValue);
            document.getElementById('detailTokenCount').textContent = walletBalances.length;
            document.getElementById('detailTxCount').textContent = walletTx.length;
            
            // Render token list
            renderWalletTokens(walletBalances);
            
            // Render transactions
            renderWalletTransactions(walletTx);
        }
        
        // Lista token scam/spam da filtrare (LOGICA v5.2 - SEMPLICE ED EFFICACE)
        const SCAM_PATTERNS = [
            'visit', 'claim', 'reward', '.com', '.org', '.io', '.xyz', 
            'airdrop', 'bonus', 'free', 'gift', 'http', '$', '#'
        ];
        
        // Token legittimi (mai filtrati automaticamente)
        const LEGITIMATE_TOKENS = [
            'BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'AVAX', 'DOT', 'LINK', 'MATIC', 'POL',
            'LTC', 'ATOM', 'UNI', 'AAVE', 'MKR', 'SHIB', 'DOGE', 'PEPE', 'FLOKI',
            'USDT', 'USDC', 'DAI', 'BUSD', 'TUSD', 'FRAX', 'USDD', 'FDUSD',
            'PLS', 'PLSX', 'HEX', 'INC', 'LUNC', 'USTC', 'OSMO', 'LUNA',
            'WETH', 'WBTC', 'WBNB', 'WPLS', 'STETH', 'RETH', 'CBETH',
            'CRO', 'FTM', 'ARB', 'OP', 'NEAR', 'APT', 'SUI', 'TON', 'TRX',
            'CAKE', 'OKB', 'BXN', 'BGB', 'KCS', 'GT', 'INJ', 'SEI', 'TIA',
            'SAND', 'MANA', 'AXS', 'GALA', 'ENJ', 'IMX', 'MAVIA', 'PIXEL',
            'BLUR', 'APE', 'LDO', 'RENDER', 'FET', 'GRT', 'WLD', 'TAO',
            'BONK', 'WIF', 'BRETT', 'POPCAT', 'NEIRO', 'TURBO', 'PRIME'
        ];
        
        // Filtro spam SEMPLICE come v5.2
        function isScamToken(name, symbol) {
            // Converti in stringa se non lo Ã¨
            const nameStr = String(name || '');
            const symStr = String(symbol || '');
            
            const n = nameStr.toLowerCase();
            const s = symStr.toLowerCase();
            
            // Token legittimi - mai filtrati
            if (LEGITIMATE_TOKENS.includes(symStr.toUpperCase())) {
                return false;
            }
            
            // Pattern spam (come v5.2)
            for (const pattern of SCAM_PATTERNS) {
                if (n.includes(pattern) || s.includes(pattern)) {
                    return true;
                }
            }
            
            // Nome troppo lungo (> 40 char) = spam (come v5.2)
            if (nameStr.length > 40) {
                return true;
            }
            
            return false;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BLACKLIST (come v5.2 - basata su CONTRACT ADDRESS)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // tokenBlacklist = array di contract address
        // blacklistNames = { contractAddress: symbolName }
        let tokenBlacklist = JSON.parse(localStorage.getItem('cryptofolio_blacklist') || '[]');
        let blacklistNames = JSON.parse(localStorage.getItem('cryptofolio_blacklist_names') || '{}');
        
        function isBlacklisted(contractAddress) {
            if (!contractAddress) return false;
            return tokenBlacklist.includes(contractAddress.toLowerCase());
        }
        
        // Nascondi token (come v5.2 - SOLO FILTRO UI, non cancella dal DB!)
        function hideToken(contractAddress, symbol) {
            const lc = (contractAddress || '').toLowerCase();
            if (!lc) return;
            
            if (!tokenBlacklist.includes(lc)) {
                tokenBlacklist.push(lc);
                blacklistNames[lc] = symbol || lc.slice(0, 10);
                
                localStorage.setItem('cryptofolio_blacklist', JSON.stringify(tokenBlacklist));
                localStorage.setItem('cryptofolio_blacklist_names', JSON.stringify(blacklistNames));
                
                log(`ğŸš« ${symbol || 'Token'} nascosto (${lc.slice(0,10)}...)`);
            }
            
            // Aggiorna UI (NON cancellare dal database!)
            updateBlacklistPanel();
            updateWalletDetail();
            updateDashboard();
        }
        
        // Ripristina token (come v5.2)
        function restoreToken(contractAddress) {
            const lc = (contractAddress || '').toLowerCase();
            tokenBlacklist = tokenBlacklist.filter(x => x !== lc);
            delete blacklistNames[lc];
            
            localStorage.setItem('cryptofolio_blacklist', JSON.stringify(tokenBlacklist));
            localStorage.setItem('cryptofolio_blacklist_names', JSON.stringify(blacklistNames));
            
            log(`âœ… Token ripristinato`);
            
            updateBlacklistPanel();
            updateWalletDetail();
            updateDashboard();
        }
        
        // Svuota blacklist
        function clearBlacklist() {
            if (!confirm('Svuotare la lista dei token nascosti?')) return;
            
            tokenBlacklist = [];
            blacklistNames = {};
            localStorage.removeItem('cryptofolio_blacklist');
            localStorage.removeItem('cryptofolio_blacklist_names');
            
            log('ğŸ—‘ï¸ Blacklist svuotata');
            
            updateBlacklistPanel();
            updateWalletDetail();
            updateDashboard();
        }
        
        // Toggle pannello blacklist
        function toggleBlacklist() {
            const panel = document.getElementById('blacklistPanel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Aggiorna pannello blacklist
        function updateBlacklistPanel() {
            const countEl = document.getElementById('blacklistCount');
            if (countEl) {
                countEl.textContent = tokenBlacklist.length;
            }
            
            const content = document.getElementById('blacklistContent');
            if (!content) return;
            
            if (tokenBlacklist.length === 0) {
                content.innerHTML = '<p class="text-secondary" style="padding:12px;">Nessun token nascosto</p>';
                return;
            }
            
            let html = '';
            for (const addr of tokenBlacklist) {
                const name = blacklistNames[addr] || addr.slice(0, 10) + '...';
                html += `
                    <div class="blacklist-item">
                        <span>${name}</span>
                        <button class="btn-restore" onclick="restoreToken('${addr}')">â†©ï¸ Ripristina</button>
                    </div>
                `;
            }
            content.innerHTML = html;
        }
        
        // Legacy compatibility
        function getBlacklist() { return tokenBlacklist; }
        function addToBlacklist(contract, symbol) { hideToken(contract, symbol); }
        function removeFromBlacklist(contract) { restoreToken(contract); }
        
        // Rimuove TUTTI i token blacklistati dal database
        function cleanupBlacklistedTokens() {
            const blacklist = getBlacklist();
            if (blacklist.length === 0) {
                log('ğŸ“‹ Blacklist vuota, nulla da rimuovere');
                return;
            }
            
            const state = Database.getState();
            const keysToRemove = [];
            
            for (const [key, balance] of Object.entries(state.balances)) {
                const coinLower = (balance.coin || '').toLowerCase();
                const contractLower = (balance.contractAddress || '').toLowerCase();
                
                if (blacklist.includes(coinLower) || (contractLower && blacklist.includes(contractLower))) {
                    keysToRemove.push(key);
                }
            }
            
            if (keysToRemove.length === 0) {
                log('âœ… Database giÃ  pulito');
                return;
            }
            
            for (const key of keysToRemove) {
                delete state.balances[key];
            }
            
            Database.save();
            log(`ğŸ—‘ï¸ Rimossi ${keysToRemove.length} token blacklistati dal database`);
            
            // Aggiorna view
            updateWalletDetail();
            updateDashboard();
            updateTransactionTable();
        }
        
        // Stato filtro scam
        let showScamTokens = false;
        
        function toggleScamFilter() {
            showScamTokens = !showScamTokens;
            document.getElementById('scamFilterBtn').textContent = showScamTokens ? 'ğŸ‘ï¸ Mostra Tutti' : 'ğŸ”’ Nascondi Scam';
            updateWalletDetail();
        }
        
        // Mappa icone token conosciute (fallback) - ESPANSA
        const TOKEN_ICONS = {
            // === MAJOR COINS ===
            'ETH': 'https://assets.coingecko.com/coins/images/279/small/ethereum.png',
            'WETH': 'https://assets.coingecko.com/coins/images/2518/small/weth.png',
            'BTC': 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png',
            'WBTC': 'https://assets.coingecko.com/coins/images/7598/small/wrapped_bitcoin_wbtc.png',
            'BNB': 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',
            'WBNB': 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',
            'SOL': 'https://assets.coingecko.com/coins/images/4128/small/solana.png',
            'XRP': 'https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png',
            'ADA': 'https://assets.coingecko.com/coins/images/975/small/cardano.png',
            'AVAX': 'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',
            'WAVAX': 'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',
            'DOT': 'https://assets.coingecko.com/coins/images/12171/small/polkadot.png',
            'MATIC': 'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png',
            'POL': 'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png',
            'WMATIC': 'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png',
            'LINK': 'https://assets.coingecko.com/coins/images/877/small/chainlink-new-logo.png',
            'LTC': 'https://assets.coingecko.com/coins/images/2/small/litecoin.png',
            'BCH': 'https://assets.coingecko.com/coins/images/780/small/bitcoin-cash-circle.png',
            'XLM': 'https://assets.coingecko.com/coins/images/100/small/Stellar_symbol_black_RGB.png',
            'XMR': 'https://assets.coingecko.com/coins/images/69/small/monero_logo.png',
            'ETC': 'https://assets.coingecko.com/coins/images/453/small/ethereum-classic-logo.png',
            'FIL': 'https://assets.coingecko.com/coins/images/12817/small/filecoin.png',
            'VET': 'https://assets.coingecko.com/coins/images/1167/small/VET_Token_Icon.png',
            'ALGO': 'https://assets.coingecko.com/coins/images/4380/small/download.png',
            'HBAR': 'https://assets.coingecko.com/coins/images/3688/small/hbar.png',
            'EGLD': 'https://assets.coingecko.com/coins/images/12335/small/egld-token-logo.png',
            'NEAR': 'https://assets.coingecko.com/coins/images/10365/small/near.jpg',
            'APT': 'https://assets.coingecko.com/coins/images/26455/small/aptos_round.png',
            'SUI': 'https://assets.coingecko.com/coins/images/26375/small/sui_asset.jpeg',
            'TRX': 'https://assets.coingecko.com/coins/images/1094/small/tron-logo.png',
            'TON': 'https://assets.coingecko.com/coins/images/17980/small/ton_symbol.png',
            
            // === STABLECOINS ===
            'USDT': 'https://assets.coingecko.com/coins/images/325/small/Tether.png',
            'USDC': 'https://assets.coingecko.com/coins/images/6319/small/usdc.png',
            'DAI': 'https://assets.coingecko.com/coins/images/9956/small/Badge_Dai.png',
            'BUSD': 'https://assets.coingecko.com/coins/images/9576/small/BUSD.png',
            'TUSD': 'https://assets.coingecko.com/coins/images/3449/small/tusd.png',
            'FRAX': 'https://assets.coingecko.com/coins/images/13422/small/FRAX_icon.png',
            'FDUSD': 'https://assets.coingecko.com/coins/images/31079/small/firstdigitalusd.jpeg',
            'PYUSD': 'https://assets.coingecko.com/coins/images/31212/small/PYUSD_Logo_%282%29.png',
            'GUSD': 'https://assets.coingecko.com/coins/images/5992/small/gemini-dollar-gusd.png',
            'LUSD': 'https://assets.coingecko.com/coins/images/14666/small/Group_3.png',
            'CRVUSD': 'https://assets.coingecko.com/coins/images/30118/small/crvusd.jpeg',
            'GHO': 'https://assets.coingecko.com/coins/images/30663/small/gho-token-logo.png',
            
            // === LAYER 2 / SCALING ===
            'ARB': 'https://assets.coingecko.com/coins/images/16547/small/photo_2023-03-29_21.47.00.jpeg',
            'OP': 'https://assets.coingecko.com/coins/images/25244/small/Optimism.png',
            'FTM': 'https://assets.coingecko.com/coins/images/4001/small/Fantom_round.png',
            'WFTM': 'https://assets.coingecko.com/coins/images/4001/small/Fantom_round.png',
            'CRO': 'https://assets.coingecko.com/coins/images/7310/small/cro_token_logo.png',
            'WCRO': 'https://assets.coingecko.com/coins/images/7310/small/cro_token_logo.png',
            'METIS': 'https://assets.coingecko.com/coins/images/15595/small/metis.PNG',
            'CELO': 'https://assets.coingecko.com/coins/images/11090/small/InjsNVl.png',
            'GLMR': 'https://assets.coingecko.com/coins/images/22459/small/glmr.png',
            'MOVR': 'https://assets.coingecko.com/coins/images/17984/small/9285.png',
            'ZK': 'https://assets.coingecko.com/coins/images/38043/small/ZKTokenBlack.png',
            'STRK': 'https://assets.coingecko.com/coins/images/26433/small/starknet.png',
            'MANTA': 'https://assets.coingecko.com/coins/images/34289/small/manta.png',
            'IMX': 'https://assets.coingecko.com/coins/images/17233/small/immutableX-symbol-BLK-RGB.png',
            
            // === DEFI ===
            'UNI': 'https://assets.coingecko.com/coins/images/12504/small/uniswap-uni.png',
            'AAVE': 'https://assets.coingecko.com/coins/images/12645/small/AAVE.png',
            'MKR': 'https://assets.coingecko.com/coins/images/1364/small/Mark_Maker.png',
            'COMP': 'https://assets.coingecko.com/coins/images/10775/small/COMP.png',
            'CRV': 'https://assets.coingecko.com/coins/images/12124/small/Curve.png',
            'CVX': 'https://assets.coingecko.com/coins/images/15585/small/convex.png',
            'SNX': 'https://assets.coingecko.com/coins/images/3406/small/SNX.png',
            'SUSHI': 'https://assets.coingecko.com/coins/images/12271/small/512x512_Logo_no_chop.png',
            '1INCH': 'https://assets.coingecko.com/coins/images/13469/small/1inch-token.png',
            'CAKE': 'https://assets.coingecko.com/coins/images/12632/small/pancakeswap-cake-logo.png',
            'LDO': 'https://assets.coingecko.com/coins/images/13573/small/Lido_DAO.png',
            'RPL': 'https://assets.coingecko.com/coins/images/2090/small/rocket_pool_%28RPL%29.png',
            'FXS': 'https://assets.coingecko.com/coins/images/13423/small/Frax_Shares_icon.png',
            'PENDLE': 'https://assets.coingecko.com/coins/images/15069/small/Pendle_Logo_Normal-03.png',
            'GMX': 'https://assets.coingecko.com/coins/images/18323/small/arbritrum_gmx.png',
            'DYDX': 'https://assets.coingecko.com/coins/images/17500/small/hjnIm9bV.jpg',
            'BAL': 'https://assets.coingecko.com/coins/images/11683/small/Balancer.png',
            'ZRX': 'https://assets.coingecko.com/coins/images/863/small/0x.png',
            'LRC': 'https://assets.coingecko.com/coins/images/913/small/LRC.png',
            'ENS': 'https://assets.coingecko.com/coins/images/19785/small/acatxTm8_400x400.jpg',
            'EIGEN': 'https://assets.coingecko.com/coins/images/37441/small/eigen.jpeg',
            'ENA': 'https://assets.coingecko.com/coins/images/36530/small/ethena.png',
            'ETHFI': 'https://assets.coingecko.com/coins/images/35958/small/etherfi.jpeg',
            
            // === LIQUID STAKING ===
            'STETH': 'https://assets.coingecko.com/coins/images/13442/small/steth_logo.png',
            'WSTETH': 'https://assets.coingecko.com/coins/images/18834/small/wstETH.png',
            'RETH': 'https://assets.coingecko.com/coins/images/20764/small/reth.png',
            'CBETH': 'https://assets.coingecko.com/coins/images/27008/small/cbeth.png',
            'FRXETH': 'https://assets.coingecko.com/coins/images/28284/small/frxETH_icon.png',
            
            // === MEME COINS ===
            'SHIB': 'https://assets.coingecko.com/coins/images/11939/small/shiba.png',
            'DOGE': 'https://assets.coingecko.com/coins/images/5/small/dogecoin.png',
            'PEPE': 'https://assets.coingecko.com/coins/images/29850/small/pepe-token.jpeg',
            'FLOKI': 'https://assets.coingecko.com/coins/images/16746/small/PNG_image.png',
            'BONK': 'https://assets.coingecko.com/coins/images/28600/small/bonk.jpg',
            'WIF': 'https://assets.coingecko.com/coins/images/33566/small/dogwifhat.jpg',
            'BONE': 'https://assets.coingecko.com/coins/images/16916/small/bone_icon.png',
            'LEASH': 'https://assets.coingecko.com/coins/images/15802/small/LEASH.png',
            'TURBO': 'https://assets.coingecko.com/coins/images/30117/small/turbo.png',
            'MEME': 'https://assets.coingecko.com/coins/images/32528/small/memecoin_%281%29.png',
            'BRETT': 'https://assets.coingecko.com/coins/images/35529/small/1000050750.png',
            'POPCAT': 'https://assets.coingecko.com/coins/images/36455/small/popcat.jpeg',
            'MEW': 'https://assets.coingecko.com/coins/images/36436/small/MEW.png',
            'NEIRO': 'https://assets.coingecko.com/coins/images/39720/small/NEIRO.png',
            
            // === COSMOS ECOSYSTEM ===
            'ATOM': 'https://assets.coingecko.com/coins/images/1481/small/cosmos_hub.png',
            'OSMO': 'https://assets.coingecko.com/coins/images/16724/small/osmo.png',
            'INJ': 'https://assets.coingecko.com/coins/images/12882/small/Secondary_Symbol.png',
            'SEI': 'https://assets.coingecko.com/coins/images/28205/small/Sei_Logo_-_Transparent.png',
            'TIA': 'https://assets.coingecko.com/coins/images/31967/small/tia.jpg',
            'KAVA': 'https://assets.coingecko.com/coins/images/9761/small/kava.png',
            'RUNE': 'https://assets.coingecko.com/coins/images/6595/small/Rune200x200.png',
            'KUJI': 'https://assets.coingecko.com/coins/images/20685/small/kuji-200x200.png',
            
            // === TERRA/LUNA ===
            'LUNC': 'https://assets.coingecko.com/coins/images/8284/small/01_LunasLogo_color.png',
            'LUNA': 'https://assets.coingecko.com/coins/images/25767/small/01_Luna_color.png',
            'USTC': 'https://assets.coingecko.com/coins/images/12681/small/UST.png',
            
            // === PULSECHAIN ===
            'PLS': 'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',
            'WPLS': 'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',
            'PLSX': 'https://tokens.app.pulsex.com/images/tokens/0x95B303987A60C71504D99Aa1b13B4DA07b0790ab.png',
            'HEX': 'https://tokens.app.pulsex.com/images/tokens/0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39.png',
            'INC': 'https://tokens.app.pulsex.com/images/tokens/0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d.png',
            
            // === BLACKFORT ===
            'BXN': 'https://assets.coingecko.com/coins/images/29287/small/bxn.png',
            
            // === GAMING / METAVERSE ===
            'SAND': 'https://assets.coingecko.com/coins/images/12129/small/sandbox_logo.jpg',
            'MANA': 'https://assets.coingecko.com/coins/images/878/small/decentraland-mana.png',
            'AXS': 'https://assets.coingecko.com/coins/images/13029/small/axie_infinity_logo.png',
            'SLP': 'https://assets.coingecko.com/coins/images/10366/small/SLP.png',
            'GALA': 'https://assets.coingecko.com/coins/images/12493/small/GALA-COINGECKO.png',
            'ENJ': 'https://assets.coingecko.com/coins/images/1102/small/enjin-coin-logo.png',
            'MAVIA': 'https://assets.coingecko.com/coins/images/35420/small/mavia.png',
            'PIXEL': 'https://assets.coingecko.com/coins/images/35338/small/pixel-icon.png',
            'PRIME': 'https://assets.coingecko.com/coins/images/29053/small/PRIMELOGOOO.png',
            'GODS': 'https://assets.coingecko.com/coins/images/17139/small/10631.png',
            'ILV': 'https://assets.coingecko.com/coins/images/14468/small/logo-200x200.png',
            'YGG': 'https://assets.coingecko.com/coins/images/17358/small/le1nzlO6_400x400.jpg',
            'RON': 'https://assets.coingecko.com/coins/images/20009/small/ronin.jpg',
            'MAGIC': 'https://assets.coingecko.com/coins/images/18623/small/magic.png',
            
            // === AI TOKENS ===
            'RENDER': 'https://assets.coingecko.com/coins/images/11636/small/rndr.png',
            'RNDR': 'https://assets.coingecko.com/coins/images/11636/small/rndr.png',
            'FET': 'https://assets.coingecko.com/coins/images/5681/small/Fetch.jpg',
            'AGIX': 'https://assets.coingecko.com/coins/images/2138/small/singularitynet.png',
            'OCEAN': 'https://assets.coingecko.com/coins/images/3687/small/ocean-protocol-logo.jpg',
            'GRT': 'https://assets.coingecko.com/coins/images/13397/small/Graph_Token.png',
            'WLD': 'https://assets.coingecko.com/coins/images/31069/small/worldcoin.jpeg',
            'TAO': 'https://assets.coingecko.com/coins/images/28452/small/ARUsPeNQ_400x400.jpeg',
            'ARKM': 'https://assets.coingecko.com/coins/images/30929/small/Arkham_Logo_CG.png',
            'AKT': 'https://assets.coingecko.com/coins/images/12785/small/akash-logo.png',
            
            // === NFT / MARKETPLACE ===
            'BLUR': 'https://assets.coingecko.com/coins/images/28453/small/blur.png',
            'APE': 'https://assets.coingecko.com/coins/images/24383/small/apecoin.jpg',
            'LOOKS': 'https://assets.coingecko.com/coins/images/22173/small/circle-black-256.png',
            'X2Y2': 'https://assets.coingecko.com/coins/images/23618/small/logo-square.png',
            
            // === EXCHANGE TOKENS ===
            'OKB': 'https://assets.coingecko.com/coins/images/4463/small/WeChat_Image_20220118095654.png',
            'BGB': 'https://assets.coingecko.com/coins/images/11681/small/BGB.png',
            'KCS': 'https://assets.coingecko.com/coins/images/1047/small/sa9z79.png',
            'GT': 'https://assets.coingecko.com/coins/images/8183/small/gt.png',
            
            // === OTHER POPULAR ===
            'BAT': 'https://assets.coingecko.com/coins/images/677/small/basic-attention-token.png',
            'CHZ': 'https://assets.coingecko.com/coins/images/8834/small/CHZ_Token_updated.png',
            'AUDIO': 'https://assets.coingecko.com/coins/images/12913/small/AusijV8A_400x400.png',
            'MASK': 'https://assets.coingecko.com/coins/images/14051/small/Mask_Network.jpg',
            'STORJ': 'https://assets.coingecko.com/coins/images/949/small/storj.png',
            'ANKR': 'https://assets.coingecko.com/coins/images/4324/small/U85xTl2.png',
            'ONE': 'https://assets.coingecko.com/coins/images/4344/small/Y88JAze.png',
            
            // === TOKEN SPECIFICI ===
            'SHIFU': 'https://assets.coingecko.com/coins/images/35165/small/shifu.png',
            'BUBBLE': 'https://assets.coingecko.com/coins/images/33874/small/bubble.png',
            'CIV': 'https://assets.coingecko.com/coins/images/17528/small/civilization.png',
            'STONE': 'https://assets.coingecko.com/coins/images/34581/small/stone.png',
            
            // === MEME COINS ===
            'FLOKI': 'https://assets.coingecko.com/coins/images/16746/small/PNG_image.png',
            'BABYDOGE': 'https://assets.coingecko.com/coins/images/16125/small/babydoge.jpg',
            'ELON': 'https://assets.coingecko.com/coins/images/14962/small/6GxcPRo3_400x400.jpg',
            'KISHU': 'https://assets.coingecko.com/coins/images/14890/small/kishu.png',
            'HOGE': 'https://assets.coingecko.com/coins/images/14360/small/hoge.jpg',
            'SAFEMOON': 'https://assets.coingecko.com/coins/images/14362/small/174x174-white.png',
            'VOLT': 'https://assets.coingecko.com/coins/images/21832/small/volt.png',
            'LEASH': 'https://assets.coingecko.com/coins/images/15802/small/leash.png',
            'BONE': 'https://assets.coingecko.com/coins/images/16916/small/bone_icon.png',
            'SAITAMA': 'https://assets.coingecko.com/coins/images/16898/small/saitama.png',
            'TSUKA': 'https://assets.coingecko.com/coins/images/26951/small/tsuka.png',
            'CULT': 'https://assets.coingecko.com/coins/images/23331/small/cult.png',
            'STARL': 'https://assets.coingecko.com/coins/images/16673/small/starlink.png',
            
            // === BSC COMMON ===
            'XVS': 'https://assets.coingecko.com/coins/images/12677/small/XVS_Logo_200.png',
            'ALPACA': 'https://assets.coingecko.com/coins/images/14165/small/alpaca.png',
            'BAKE': 'https://assets.coingecko.com/coins/images/12588/small/bakerytoken_logo.jpg',
            'BURGER': 'https://assets.coingecko.com/coins/images/12563/small/burger.png',
            'AUTO': 'https://assets.coingecko.com/coins/images/13751/small/autofarm_icon_200x200.png',
            'BUNNY': 'https://assets.coingecko.com/coins/images/13607/small/1_BTm3RIiLjbJJ6cC7GCdNjQ.png',
            'BSW': 'https://assets.coingecko.com/coins/images/16845/small/biswap.png',
            'BABY': 'https://assets.coingecko.com/coins/images/15531/small/baby.png',
            'SFUND': 'https://assets.coingecko.com/coins/images/14616/small/seedify.png',
            'C98': 'https://assets.coingecko.com/coins/images/17117/small/coin98.png',
            'TWT': 'https://assets.coingecko.com/coins/images/11085/small/Trust.png',
            'SFP': 'https://assets.coingecko.com/coins/images/13905/small/sfp.png',
            
            // === POLYGON COMMON ===
            'QUICK': 'https://assets.coingecko.com/coins/images/13970/small/quick.png',
            'GHST': 'https://assets.coingecko.com/coins/images/12467/small/ghst_200.png',
            'DFYN': 'https://assets.coingecko.com/coins/images/15368/small/dfyn.png',
            'MIMATIC': 'https://assets.coingecko.com/coins/images/15264/small/mimatic-red.png',
            'MAI': 'https://assets.coingecko.com/coins/images/15264/small/mimatic-red.png',
            
            // === ARBITRUM COMMON ===
            'MAGIC': 'https://assets.coingecko.com/coins/images/18623/small/magic.png',
            'JONES': 'https://assets.coingecko.com/coins/images/23348/small/jones.png',
            'DPX': 'https://assets.coingecko.com/coins/images/16652/small/DPX.png',
            'RDNT': 'https://assets.coingecko.com/coins/images/26536/small/radiant.png',
            'VELA': 'https://assets.coingecko.com/coins/images/28793/small/vela.png',
            'GNS': 'https://assets.coingecko.com/coins/images/19737/small/gns.png',
            
            // === BASE COMMON ===
            'BRETT': 'https://assets.coingecko.com/coins/images/35529/small/brett.png',
            'TOSHI': 'https://assets.coingecko.com/coins/images/31126/small/toshi.png',
            'DEGEN': 'https://assets.coingecko.com/coins/images/34515/small/degen.png',
            'AERO': 'https://assets.coingecko.com/coins/images/31745/small/aero.png',
            
            // === PULSECHAIN ===
            'PLS': 'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',
            'PLSX': 'https://tokens.app.pulsex.com/images/tokens/0x95B303987A60C71504D99Aa1b13B4DA07b0790ab.png',
            'HEX': 'https://assets.coingecko.com/coins/images/10103/small/HEX-logo.png',
            'INC': 'https://tokens.app.pulsex.com/images/tokens/0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d.png',
            'WPLS': 'https://tokens.app.pulsex.com/images/tokens/0xA1077a294dDE1B09bB078844df40758a5D0f9a27.png',
            'EHEX': 'https://assets.coingecko.com/coins/images/10103/small/HEX-logo.png',
            
            // === BLACKFORT ===
            'BXN': 'https://assets.coingecko.com/coins/images/29287/small/bxn.png',
            'WBXN': 'https://assets.coingecko.com/coins/images/29287/small/bxn.png',
        };
        
        function getTokenIcon(bal, chainColor) {
            const coinUpper = (bal.coin || '').toUpperCase();
            
            // 1. PRIMA TOKEN_ICONS hardcoded (piÃ¹ affidabili!)
            if (TOKEN_ICONS[coinUpper]) {
                return `<img src="${TOKEN_ICONS[coinUpper]}" style="width:32px;height:32px;border-radius:50%;" onerror="this.outerHTML='<div style=\\'width:32px;height:32px;border-radius:50%;background:${chainColor}30;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;\\'>${coinUpper.slice(0,3)}</div>'">`;
            }
            
            // 2. Logo da API (Moralis) - puÃ² essere inaffidabile
            if (bal.logo && bal.logo.startsWith('http')) {
                return `<img src="${bal.logo}" style="width:32px;height:32px;border-radius:50%;" onerror="this.outerHTML='<div style=\\'width:32px;height:32px;border-radius:50%;background:${chainColor}30;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;\\'>${coinUpper.slice(0,3)}</div>'">`;
            }
            
            // 3. Fallback con iniziali
            return `<div style="width:32px;height:32px;border-radius:50%;background:${chainColor}30;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;">${coinUpper.slice(0,3)}</div>`;
        }
        
        function renderWalletTokens(balances) {
            const container = document.getElementById('walletTokensList');
            
            // Filtra scam e blacklist se necessario
            let filtered = balances;
            let scamCount = 0;
            let blacklistCount = 0;
            
            if (!showScamTokens) {
                filtered = balances.filter(bal => {
                    // Filtro balance zero o negativo (come v5.2)
                    if (!bal.amount || bal.amount <= 0) {
                        return false;
                    }
                    
                    // Blacklist basata su CONTRACT ADDRESS (come v5.2)
                    const contractAddr = bal.contractAddress || `native-${bal.chain}`;
                    if (isBlacklisted(contractAddr)) {
                        blacklistCount++;
                        return false;
                    }
                    
                    // Filtro spam (come v5.2)
                    if (isScamToken(bal.name, bal.coin)) {
                        scamCount++;
                        return false;
                    }
                    
                    // Filtro valore minimo (< $0.01) - nasconde dust e possibili scam
                    const price = PriceService.getPrice(bal.coin, 'eur');
                    const value = bal.amount * price;
                    if (price > 0 && value < 0.01) {
                        return false; // Nascondi dust tokens
                    }
                    
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸª™</div>
                        <p>Nessun token trovato</p>
                        <p class="text-secondary" style="font-size:12px;">Scansiona il wallet per caricare i token</p>
                    </div>
                `;
                return;
            }
            
            // âš ï¸ IMPORTANTE: Aggrega token duplicati per coin+chain
            const aggregatedByChainCoin = {};
            for (const bal of filtered) {
                const chain = bal.chain || 'unknown';
                const key = `${chain}_${bal.coin}`;
                
                if (!aggregatedByChainCoin[key]) {
                    aggregatedByChainCoin[key] = {
                        ...bal,
                        chain: chain
                    };
                } else {
                    // Somma le quantitÃ 
                    aggregatedByChainCoin[key].amount += bal.amount;
                }
            }
            
            // Converti in array
            const uniqueTokens = Object.values(aggregatedByChainCoin);
            
            // Raggruppa per chain
            const byChain = {};
            for (const bal of uniqueTokens) {
                const chain = bal.chain || 'unknown';
                if (!byChain[chain]) byChain[chain] = [];
                byChain[chain].push(bal);
            }
            
            // Ordina chain per valore totale
            const chainOrder = Object.keys(byChain).sort((a, b) => {
                const totalA = byChain[a].reduce((sum, t) => sum + (t.amount * PriceService.getPrice(t.coin, 'eur')), 0);
                const totalB = byChain[b].reduce((sum, t) => sum + (t.amount * PriceService.getPrice(t.coin, 'eur')), 0);
                return totalB - totalA;
            });
            
            // Header con filtro e info
            const hiddenCount = scamCount + blacklistCount;
            let html = `
                <div class="flex items-center justify-between mb-16">
                    <span class="text-secondary" style="font-size:12px;">
                        ${filtered.length} token su ${chainOrder.length} chain${hiddenCount > 0 ? ` (${hiddenCount} nascosti)` : ''}
                    </span>
                    <div class="flex gap-8">
                        ${tokenBlacklist.length > 0 ? `<button class="btn btn-secondary" onclick="showBlacklistModal()" style="padding:6px 12px;font-size:12px;color:var(--text-primary);">ğŸ“‹ Blacklist (${tokenBlacklist.length})</button>` : ''}
                        <button class="btn btn-secondary" id="scamFilterBtn" onclick="toggleScamFilter()" style="padding:6px 12px;font-size:12px;color:var(--text-primary);">
                            ${showScamTokens ? 'ğŸ‘ï¸ Mostra Tutti' : 'ğŸ”’ Nascondi Scam'}
                        </button>
                    </div>
                </div>
            `;
            
            // Render ogni chain
            for (const chain of chainOrder) {
                const tokens = byChain[chain];
                const chainInfo = CHAINS[chain] || { name: chain.toUpperCase(), color: '#888', symbol: '?' };
                
                // Calcola totale chain
                let chainTotal = 0;
                for (const t of tokens) {
                    chainTotal += t.amount * PriceService.getPrice(t.coin, 'eur');
                }
                
                // Ordina token per valore
                tokens.sort((a, b) => {
                    const valA = a.amount * PriceService.getPrice(a.coin, 'eur');
                    const valB = b.amount * PriceService.getPrice(b.coin, 'eur');
                    return valB - valA;
                });
                
                html += `
                    <div style="margin-bottom:24px;">
                        <div class="flex items-center justify-between" style="padding:12px 16px;background:${chainInfo.color}15;border-radius:8px 8px 0 0;border-left:4px solid ${chainInfo.color};">
                            <div class="flex items-center gap-8">
                                <span style="font-size:18px;">${chainInfo.symbol === 'ETH' ? 'âŸ ' : chainInfo.symbol === 'BNB' ? 'ğŸŸ¡' : chainInfo.symbol === 'MATIC' ? 'ğŸŸ£' : chainInfo.symbol === 'PLS' ? 'ğŸ’œ' : chainInfo.symbol === 'ARB' ? 'ğŸ”µ' : 'ğŸ”—'}</span>
                                <span style="font-weight:600;">${chainInfo.name}</span>
                                <span class="text-secondary" style="font-size:12px;">(${tokens.length} token)</span>
                            </div>
                            <span style="font-weight:600;color:var(--green);">â‚¬${formatEUR(chainTotal)}</span>
                        </div>
                        <table style="width:100%;background:var(--bg-secondary);border-radius:0 0 8px 8px;">
                            <tbody>
                `;
                
                for (const bal of tokens) {
                    const price = PriceService.getPrice(bal.coin, 'eur');
                    const value = bal.amount * price;
                    const iconHtml = getTokenIcon(bal, chainInfo.color);
                    
                    // Contract address (usato per blacklist come v5.2)
                    const contractAddr = bal.contractAddress || `native-${chain}`;
                    
                    // Link all'explorer per contract address
                    let contractLink = '';
                    if (bal.contractAddress) {
                        const explorerUrl = chainInfo.explorer || 'https://etherscan.io';
                        contractLink = `<a href="${explorerUrl}/token/${bal.contractAddress}" target="_blank" class="text-secondary" style="font-size:9px;text-decoration:none;opacity:0.6;" title="${bal.contractAddress}">${bal.contractAddress.slice(0,6)}...${bal.contractAddress.slice(-4)}</a>`;
                    }
                    
                    html += `
                        <tr style="border-bottom:1px solid var(--border);">
                            <td style="padding:12px;">
                                <div class="flex items-center gap-8">
                                    <button class="hide-btn" onclick="hideToken('${contractAddr}','${bal.coin}')" title="Nascondi token">âœ•</button>
                                    ${iconHtml}
                                    <div>
                                        <div style="font-weight:500;">${bal.coin}</div>
                                        ${bal.name && bal.name !== bal.coin ? `<div class="text-secondary" style="font-size:10px;">${bal.name.slice(0,25)}</div>` : ''}
                                        ${contractLink}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align:right;font-family:monospace;padding:12px;">${formatCrypto(bal.amount)}</td>
                            <td style="text-align:right;padding:12px;color:var(--text-secondary);">â‚¬${formatEUR(price)}</td>
                            <td style="text-align:right;font-weight:600;color:var(--green);padding:12px;">â‚¬${formatEUR(value)}</td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Modal per gestire blacklist
        function showBlacklistModal() {
            const blacklist = getBlacklist();
            
            let html = `
                <div id="blacklistModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;" onclick="if(event.target.id==='blacklistModal')closeBlacklistModal()">
                    <div class="card" style="width:400px;max-height:80vh;overflow-y:auto;">
                        <div class="card-header">
                            <div class="card-title">ğŸ“‹ Blacklist Personalizzata</div>
                            <button onclick="closeBlacklistModal()" style="background:none;border:none;cursor:pointer;font-size:20px;color:var(--text-secondary);">âœ•</button>
                        </div>
                        <p class="text-secondary mb-16" style="font-size:12px;">Token che hai nascosto manualmente. Clicca âœ… per ripristinarli.</p>
            `;
            
            if (blacklist.length === 0) {
                html += `<p class="text-secondary">Nessun token in blacklist</p>`;
            } else {
                for (const coin of blacklist) {
                    html += `
                        <div class="flex items-center justify-between" style="padding:8px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;">
                            <span>${coin}</span>
                            <button onclick="removeFromBlacklist('${coin}');closeBlacklistModal();" class="btn btn-success" style="padding:4px 12px;font-size:12px;">âœ… Ripristina</button>
                        </div>
                    `;
                }
            }
            
            html += `
                        <div class="flex gap-8 mt-16">
                            <button onclick="cleanupBlacklistedTokens();closeBlacklistModal();" class="btn btn-danger" style="flex:1;font-size:12px;">ğŸ—‘ï¸ Pulisci Database</button>
                            <button onclick="closeBlacklistModal()" class="btn btn-secondary" style="flex:1;">Chiudi</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeBlacklistModal() {
            const modal = document.getElementById('blacklistModal');
            if (modal) modal.remove();
        }
        
        function renderWalletTransactions(transactions) {
            const tbody = document.getElementById('walletTxTableBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-secondary" style="text-align:center;padding:40px;">
                            Nessuna transazione trovata
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordina per data (piÃ¹ recenti prima)
            transactions.sort((a, b) => b.timestamp - a.timestamp);
            
            // Mostra max 100
            const toShow = transactions.slice(0, 100);
            
            let html = '';
            for (const tx of toShow) {
                const isIn = tx.type === 'deposit' || tx.amountIn > 0;
                const coin = tx.coinIn || tx.coinOut || '-';
                const amount = tx.amountIn || tx.amountOut || 0;
                
                html += `
                    <tr>
                        <td>${formatDate(tx.timestamp)}</td>
                        <td class="${isIn ? 'text-green' : 'text-red'}">${tx.type || '-'}</td>
                        <td>${coin}</td>
                        <td class="${isIn ? 'text-green' : 'text-red'}">${isIn ? '+' : '-'}${formatCrypto(amount)}</td>
                        <td class="text-secondary">${tx.chain || '-'}</td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }
        
        function showWalletTab(tab) {
            if (tab === 'tokens') {
                document.getElementById('walletTokensTab').style.display = 'block';
                document.getElementById('walletTxTab').style.display = 'none';
                document.getElementById('tabTokens').style.background = 'var(--accent)';
                document.getElementById('tabTokens').style.color = 'white';
                document.getElementById('tabTokens').style.border = 'none';
                document.getElementById('tabTx').style.background = 'var(--bg-secondary)';
                document.getElementById('tabTx').style.color = 'var(--text-primary)';
                document.getElementById('tabTx').style.border = '1px solid var(--border)';
            } else {
                document.getElementById('walletTokensTab').style.display = 'none';
                document.getElementById('walletTxTab').style.display = 'block';
                document.getElementById('tabTx').style.background = 'var(--accent)';
                document.getElementById('tabTx').style.color = 'white';
                document.getElementById('tabTx').style.border = 'none';
                document.getElementById('tabTokens').style.background = 'var(--bg-secondary)';
                document.getElementById('tabTokens').style.color = 'var(--text-primary)';
                document.getElementById('tabTokens').style.border = '1px solid var(--border)';
            }
        }
        
        async function scanCurrentWallet() {
            if (!currentWalletAddress) return;
            await scanWallet(currentWalletAddress);
            updateWalletDetail();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI UPDATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let portfolioChart = null;
        
        async function updateDashboard() {
            const state = Database.getState();
            
            // Totali
            document.getElementById('totalWallets').textContent = state.wallets.length;
            document.getElementById('totalTx').textContent = state.transactions.length;
            
            // Aggrega balance per coin (sommando da tutti i wallet)
            const aggregated = {};
            for (const [key, balance] of Object.entries(state.balances)) {
                const coin = balance.coin;
                const contractAddr = balance.contractAddress || `native-${balance.chain}`;
                
                // Filtra token in blacklist manuale (per CONTRACT ADDRESS, come v5.2!)
                if (isBlacklisted(contractAddr)) continue;
                
                // Filtra pattern scam ovvi (usa coin come name e symbol)
                if (isScamToken(balance.name || coin, coin)) continue;
                
                if (!aggregated[coin]) {
                    aggregated[coin] = { coin, amount: 0, valueEUR: 0 };
                }
                aggregated[coin].amount += balance.amount;
            }
            
            // Fetch prezzi per tutti i coin
            const coins = Object.keys(aggregated);
            if (coins.length > 0) {
                await PriceService.fetchCurrentPrices(coins);
            }
            
            // Per token senza prezzo CoinGecko, prova DexScreener
            for (const [key, balance] of Object.entries(state.balances)) {
                const coin = balance.coin;
                if (!aggregated[coin]) continue;
                
                const price = PriceService.getPrice(coin, 'eur');
                if (price === 0 && balance.contractAddress) {
                    // Prova DexScreener
                    const chain = balance.chain === 'pulse' ? 'pulsechain' : balance.chain;
                    try {
                        const dexPrice = await PriceService.fetchTokenPriceFromDex(balance.contractAddress, chain);
                        if (dexPrice && dexPrice.priceEur > 0) {
                            Logger.info('Dashboard', `DexScreener: ${coin} = â‚¬${dexPrice.priceEur.toFixed(6)}`);
                        }
                    } catch (e) {
                        // Ignora errori DexScreener
                    }
                }
            }
            
            // Calcola valori e filtra scam con valore anomalo
            let validAssets = 0;
            for (const coin of coins) {
                const price = PriceService.getPrice(coin, 'eur');
                const amount = aggregated[coin].amount;
                
                // Filtra token scam (usa coin sia come name che symbol)
                if (isScamToken(coin, coin)) {
                    delete aggregated[coin];
                    continue;
                }
                
                aggregated[coin].valueEUR = amount * price;
                aggregated[coin].price = price;
                validAssets++;
            }
            
            document.getElementById('totalAssets').textContent = validAssets;
            
            // Converti in array e ordina per valore
            const holdings = Object.values(aggregated)
                .filter(h => h.valueEUR > 0.01)
                .sort((a, b) => b.valueEUR - a.valueEUR);
            
            // Calcola totale
            const totalValue = holdings.reduce((sum, h) => sum + h.valueEUR, 0);
            document.getElementById('totalValue').textContent = 'â‚¬' + formatEUR(totalValue);
            
            // Aggiorna grafico a torta
            updatePortfolioChart(holdings, totalValue);
            
            // Aggiorna top holdings list
            updateTopHoldings(holdings, totalValue);
        }
        
        function updatePortfolioChart(holdings, totalValue) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            // Prendi top 6 + "Altri"
            const topN = 6;
            let chartData = holdings.slice(0, topN);
            const othersValue = holdings.slice(topN).reduce((sum, h) => sum + h.valueEUR, 0);
            
            if (othersValue > 0) {
                chartData.push({ coin: 'Altri', valueEUR: othersValue });
            }
            
            // Colori
            const colors = [
                '#627eea', // ETH blue
                '#f3ba2f', // BNB yellow
                '#8247e5', // Polygon purple
                '#3fb950', // Green
                '#58a6ff', // Accent blue
                '#f85149', // Red
                '#8b949e', // Gray for "Altri"
            ];
            
            // Distruggi grafico esistente
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            // Se non ci sono dati
            if (chartData.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            // Crea nuovo grafico
            portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(h => h.coin),
                    datasets: [{
                        data: chartData.map(h => h.valueEUR),
                        backgroundColor: colors.slice(0, chartData.length),
                        borderColor: '#1c2128',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e6edf3',
                                padding: 12,
                                font: { size: 12 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const pct = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label} (${pct}%)`,
                                            fillStyle: colors[i],
                                            strokeStyle: colors[i],
                                            lineWidth: 0,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const pct = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0;
                                    return `â‚¬${formatEUR(value)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        function updateTopHoldings(holdings, totalValue) {
            const container = document.getElementById('topHoldingsList');
            
            if (holdings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:20px;">
                        <p class="text-secondary">Nessun asset trovato</p>
                        <p class="text-secondary" style="font-size:11px;">Aggiungi un wallet e scansiona</p>
                    </div>
                `;
                return;
            }
            
            // Mostra top 5
            const top5 = holdings.slice(0, 5);
            
            let html = '';
            for (const holding of top5) {
                const pct = totalValue > 0 ? ((holding.valueEUR / totalValue) * 100).toFixed(1) : 0;
                
                // Crea oggetto balance fittizio per getTokenIcon
                const fakeBal = { coin: holding.coin, logo: null };
                const iconHtml = getTokenIcon(fakeBal, 'var(--accent)');
                
                html += `
                    <div class="top-holding-item" style="display:flex;align-items:center;justify-content:space-between;padding:12px 8px;border-bottom:1px solid var(--border);cursor:pointer;border-radius:8px;transition:background 0.2s;" 
                         onmouseover="this.style.background='var(--bg-secondary)'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="showTokenActions('${holding.coin}', ${holding.valueEUR.toFixed(2)})">
                        <div style="display:flex;align-items:center;gap:12px;">
                            ${iconHtml}
                            <div>
                                <div style="font-weight:600;">${holding.coin}</div>
                                <div class="text-secondary" style="font-size:11px;">${formatCrypto(holding.amount)}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:600;color:var(--green);">â‚¬${formatEUR(holding.valueEUR)}</div>
                            <div class="text-secondary" style="font-size:11px;">${pct}%</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Modal per azioni su token dalla dashboard
        function showTokenActions(coin, value) {
            // Trova in quali wallet Ã¨ presente il token
            const state = Database.getState();
            const walletSources = [];
            
            for (const [key, balance] of Object.entries(state.balances)) {
                if (balance.coin === coin && balance.source) {
                    const walletAddr = balance.source.replace('wallet_', '');
                    const wallet = state.wallets.find(w => w.address.toLowerCase() === walletAddr.toLowerCase());
                    if (wallet) {
                        walletSources.push({
                            name: wallet.name,
                            address: wallet.address,
                            chain: balance.chain,
                            amount: balance.amount
                        });
                    }
                }
            }
            
            let walletsHtml = '';
            if (walletSources.length > 0) {
                walletsHtml = walletSources.map(ws => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-primary);border-radius:8px;margin-bottom:8px;">
                        <div>
                            <div style="font-weight:500;">${ws.name}</div>
                            <div class="text-secondary" style="font-size:11px;">${ws.chain} â€¢ ${formatCrypto(ws.amount)} ${coin}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="openWalletDetail('${ws.address}');closeTokenActionsModal();" style="padding:6px 12px;font-size:12px;">
                            ğŸ‘ï¸ Apri
                        </button>
                    </div>
                `).join('');
            } else {
                walletsHtml = '<p class="text-secondary">Token non trovato nei wallet</p>';
            }
            
            const modal = document.createElement('div');
            modal.id = 'tokenActionsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;';
            
            modal.innerHTML = `
                <div class="card" style="width:420px;max-height:80vh;overflow-y:auto;">
                    <div class="card-header">
                        <div class="card-title">ğŸª™ ${coin}</div>
                        <button onclick="closeTokenActionsModal()" style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer;">âœ•</button>
                    </div>
                    
                    <div style="text-align:center;padding:16px;background:var(--bg-secondary);border-radius:8px;margin-bottom:16px;">
                        <div style="font-size:24px;font-weight:700;color:var(--green);">â‚¬${formatEUR(value)}</div>
                        <div class="text-secondary" style="font-size:12px;">Valore totale</div>
                    </div>
                    
                    <div style="margin-bottom:16px;">
                        <div style="font-weight:600;margin-bottom:8px;">ğŸ“ Presente in:</div>
                        ${walletsHtml}
                    </div>
                    
                    <div class="flex gap-8">
                        <button class="btn btn-danger" onclick="addToBlacklist('${coin}');closeTokenActionsModal();" style="flex:1;">
                            ğŸš« Nascondi (Scam)
                        </button>
                        <button class="btn btn-secondary" onclick="closeTokenActionsModal()" style="flex:1;">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeTokenActionsModal(); };
        }
        
        function closeTokenActionsModal() {
            const modal = document.getElementById('tokenActionsModal');
            if (modal) modal.remove();
        }
        
        function updateWalletList() {
            const wallets = Database.getWallets();
            const container = document.getElementById('walletList');
            
            if (wallets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘›</div>
                        <p>Nessun wallet aggiunto</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            for (const wallet of wallets) {
                const chainInfo = CHAINS[wallet.chain] || { name: wallet.chain, color: '#888' };
                const lastSync = wallet.lastSync ? formatDateTime(wallet.lastSync) : 'Mai';
                
                // Icona Rabby Wallet per EVM
                const walletIcon = wallet.type === 'evm' 
                    ? `<img src="https://raw.githubusercontent.com/RabbyHub/logo/master/symbol.png" style="width:28px;height:28px;border-radius:50%;" onerror="this.outerHTML='<span style=\\'font-size:24px;\\'>ğŸ”·</span>'">`
                    : 'ğŸŒ';
                
                html += `
                    <div class="wallet-item" style="cursor:pointer;" onclick="openWalletDetail('${wallet.address}')">
                        <div class="wallet-info">
                            <div class="wallet-icon" style="background:${chainInfo.color}20;color:${chainInfo.color}">
                                ${walletIcon}
                            </div>
                            <div>
                                <div class="wallet-name">${wallet.name}</div>
                                <div class="wallet-address">${wallet.address.slice(0,8)}...${wallet.address.slice(-6)}</div>
                                <div class="text-secondary" style="font-size:11px;">Ultimo sync: ${lastSync}</div>
                            </div>
                        </div>
                        <div class="flex gap-8" onclick="event.stopPropagation();">
                            <button class="btn btn-secondary" onclick="scanWallet('${wallet.address}')">ğŸ”„ Scan</button>
                            <button class="btn btn-danger" onclick="removeWallet('${wallet.address}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function updateTransactionTable() {
            const transactions = Database.getTransactions();
            const tbody = document.getElementById('txTableBody');
            
            document.getElementById('txCount').textContent = transactions.length;
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-secondary" style="text-align:center;padding:40px;">
                            Nessuna transazione
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Mostra solo le prime 100
            const toShow = transactions.slice(0, 100);
            
            // Raccogli tutti i coin unici per fetch prezzi
            const uniqueCoins = [...new Set(toShow.map(tx => tx.coinIn || tx.coinOut).filter(Boolean))];
            if (uniqueCoins.length > 0) {
                await PriceService.fetchCurrentPrices(uniqueCoins);
            }
            
            let html = '';
            for (const tx of toShow) {
                const typeColors = {
                    'deposit': 'text-green',
                    'withdrawal': 'text-red',
                    'trade': 'text-yellow',
                    'fee': 'text-red',
                    'staking': 'text-secondary'
                };
                
                // Calcola valore EUR (usa prezzo corrente come approssimazione)
                let valueEUR = tx.valueEUR || 0;
                if (valueEUR === 0) {
                    const coin = tx.coinIn || tx.coinOut;
                    const amount = tx.amountIn || tx.amountOut || 0;
                    if (coin && amount > 0) {
                        const price = PriceService.getPrice(coin, 'eur');
                        valueEUR = amount * price;
                    }
                }
                
                html += `
                    <tr>
                        <td>${formatDate(tx.timestamp)}</td>
                        <td class="${typeColors[tx.type] || ''}">${tx.type}</td>
                        <td>${tx.coinIn ? `+${formatCrypto(tx.amountIn)} ${tx.coinIn}` : '-'}</td>
                        <td>${tx.coinOut ? `-${formatCrypto(tx.amountOut)} ${tx.coinOut}` : '-'}</td>
                        <td>â‚¬${formatEUR(valueEUR)}</td>
                        <td class="text-secondary">${tx.source}</td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }
        
        function updateDebugInfo() {
            const state = Database.getState();
            const moralisKeys = Database.getMoralisKeys();
            const info = {
                wallets: state.wallets.length,
                transactions: state.transactions.length,
                balances: Object.keys(state.balances).length,
                lastSync: state.lastSync ? new Date(state.lastSync).toISOString() : 'Mai',
                apiKeys: {
                    moralis: moralisKeys.length > 0 ? `âœ… ${moralisKeys.length} keys configurate` : 'âŒ Mancante',
                    etherscan: state.apiKeys.etherscan ? 'âœ… Configurata' : 'âŒ Mancante'
                }
            };
            
            document.getElementById('debugInfo').textContent = JSON.stringify(info, null, 2);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SETTINGS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function loadApiKeys() {
            // Mostra lista Moralis keys
            updateMoralisKeysList();
            
            // Etherscan
            const etherscan = Database.getState().apiKeys.etherscan;
            if (etherscan) document.getElementById('apiEtherscan').value = etherscan;
            
            // Helius (Solana)
            const helius = Database.getState().apiKeys.helius;
            if (helius) {
                document.getElementById('apiHelius').value = helius;
                document.getElementById('heliusStatus').innerHTML = '<span style="color:var(--green);">âœ“ Configurata</span>';
            }
        }
        
        function addMoralisKey() {
            const input = document.getElementById('newMoralisKey');
            const key = input.value.trim();
            
            if (!key) {
                alert('Inserisci una API key');
                return;
            }
            
            if (Database.addMoralisKey(key)) {
                input.value = '';
                updateMoralisKeysList();
                log(`âœ… API Key Moralis aggiunta (${Database.getMoralisKeys().length} totali)`);
            } else {
                alert('API Key giÃ  presente');
            }
        }
        
        function removeMoralisKey(index) {
            if (confirm('Rimuovere questa API key?')) {
                Database.removeMoralisKey(index);
                updateMoralisKeysList();
                log(`ğŸ—‘ï¸ API Key Moralis rimossa`);
            }
        }
        
        function updateMoralisKeysList() {
            const keys = Database.getMoralisKeys();
            const container = document.getElementById('moralisKeysList');
            
            if (keys.length === 0) {
                container.innerHTML = `
                    <div class="text-secondary" style="font-size:13px;padding:12px;background:var(--bg-secondary);border-radius:8px;">
                        âš ï¸ Nessuna API key configurata. Aggiungi almeno una key per scansionare wallet EVM.
                    </div>
                `;
                return;
            }
            
            let html = '';
            keys.forEach((key, index) => {
                const masked = key.slice(0, 8) + '...' + key.slice(-4);
                html += `
                    <div class="flex items-center justify-between" style="padding:10px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;">
                        <div>
                            <span style="color:var(--green);">âœ“</span>
                            <code style="font-size:13px;margin-left:8px;">${masked}</code>
                            <span class="text-secondary" style="font-size:11px;margin-left:8px;">Key #${index + 1}</span>
                        </div>
                        <button class="btn btn-danger" style="padding:6px 12px;font-size:12px;" onclick="removeMoralisKey(${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
            });
            
            html += `<div class="text-secondary mt-8" style="font-size:11px;">âœ… ${keys.length} API key${keys.length > 1 ? 's' : ''} configurate - rotazione automatica attiva</div>`;
            
            container.innerHTML = html;
        }
        
        function saveApiKey(name) {
            if (name === 'etherscan') {
                const value = document.getElementById('apiEtherscan').value.trim();
                Database.setApiKey('etherscan', value);
                log(`âœ… API Key Etherscan salvata`);
            } else if (name === 'helius') {
                const value = document.getElementById('apiHelius').value.trim();
                Database.setApiKey('helius', value);
                if (value) {
                    document.getElementById('heliusStatus').innerHTML = '<span style="color:var(--green);">âœ“ Configurata</span>';
                }
                log(`âœ… API Key Helius (Solana) salvata`);
            }
            updateDebugInfo();
        }
        
        function exportData() {
            const state = Database.getState();
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `cryptofolio_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            log('ğŸ“¤ Dati esportati');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // TODO: Merge dati importati
                    log('ğŸ“¥ Importazione completata');
                    updateDashboard();
                    updateWalletList();
                    updateTransactionTable();
                } catch (err) {
                    alert('Errore importazione: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REFRESH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function refreshAll() {
            log('ğŸ”„ Aggiornamento completo...');
            
            // Aggiorna prezzi
            await PriceService.fetchCurrentPrices();
            
            // Scansiona tutti i wallet
            await scanAllWallets();
            
            // Aggiorna UI
            updateDashboard();
            updateTransactionTable();
            
            log('âœ… Aggiornamento completato');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TAX REPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function generateTaxReport() {
            const year = parseInt(document.getElementById('taxYear').value);
            log(`ğŸ“‹ Generazione report fiscale ${year}...`);
            
            const container = document.getElementById('taxReportContent');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Scaricamento prezzi storici 1/1 e 31/12/${year}...</span>
                </div>
            `;
            
            try {
                const state = Database.getState();
                
                // Aggrega balance per coin
                const holdings = {};
                for (const [key, balance] of Object.entries(state.balances)) {
                    const coin = balance.coin;
                    if (!holdings[coin]) holdings[coin] = 0;
                    holdings[coin] += balance.amount;
                }
                
                // Lista coin con balance > 0
                const coins = Object.keys(holdings).filter(c => holdings[c] > 0);
                
                if (coins.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>Nessun asset trovato</p>
                            <p class="text-secondary">Aggiungi wallet e scansiona per generare il report</p>
                        </div>
                    `;
                    return;
                }
                
                log(`ğŸ“Š Scaricamento prezzi per ${coins.length} coin...`);
                
                // Fetch prezzi 1/1 e 31/12
                const prices = await PriceService.fetchYearPricesForTax(coins, year);
                
                // Calcola valori
                let valoreInizio = 0;
                let valoreFine = 0;
                const dettagli = [];
                
                for (const coin of coins) {
                    const amount = holdings[coin];
                    const priceJan1 = prices.jan1[coin] || 0;
                    const priceDec31 = prices.dec31[coin] || 0;
                    const valueJan1 = amount * priceJan1;
                    const valueDec31 = amount * priceDec31;
                    
                    valoreInizio += valueJan1;
                    valoreFine += valueDec31;
                    
                    if (valueDec31 > 1) { // Solo se valore > 1â‚¬
                        dettagli.push({
                            coin,
                            amount,
                            priceJan1,
                            priceDec31,
                            valueJan1,
                            valueDec31,
                            variazione: priceDec31 > 0 && priceJan1 > 0 ? ((priceDec31 - priceJan1) / priceJan1 * 100) : 0
                        });
                    }
                }
                
                // Ordina per valore 31/12
                dettagli.sort((a, b) => b.valueDec31 - a.valueDec31);
                
                // Calcola IVAFE (0.2% sul valore medio)
                const valoreMediaAnnuo = (valoreInizio + valoreFine) / 2;
                const ivafe = valoreMediaAnnuo * 0.002;
                
                // Render report
                let html = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">ğŸ“… Valore 01/01/${year}</div>
                            <div class="value">â‚¬${formatEUR(valoreInizio)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ğŸ“… Valore 31/12/${year}</div>
                            <div class="value" style="color:${valoreFine >= valoreInizio ? 'var(--green)' : 'var(--red)'}">â‚¬${formatEUR(valoreFine)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ğŸ“Š Variazione</div>
                            <div class="value" style="color:${valoreFine >= valoreInizio ? 'var(--green)' : 'var(--red)'}">
                                ${valoreFine >= valoreInizio ? '+' : ''}${formatEUR(valoreFine - valoreInizio)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ğŸ’° IVAFE Stimata (0.2%)</div>
                            <div class="value text-yellow">â‚¬${formatEUR(ivafe)}</div>
                        </div>
                    </div>
                    
                    <div class="card mt-16">
                        <div class="card-header">
                            <div class="card-title">ğŸ“‹ Quadro RW - Dettaglio Asset</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th style="text-align:right;">QuantitÃ </th>
                                        <th style="text-align:right;">Prezzo 01/01</th>
                                        <th style="text-align:right;">Prezzo 31/12</th>
                                        <th style="text-align:right;">Valore 31/12</th>
                                        <th style="text-align:right;">Var. %</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const d of dettagli) {
                    const varClass = d.variazione >= 0 ? 'text-green' : 'text-red';
                    html += `
                        <tr>
                            <td><strong>${d.coin}</strong></td>
                            <td style="text-align:right;font-family:monospace;">${formatCrypto(d.amount)}</td>
                            <td style="text-align:right;">â‚¬${formatEUR(d.priceJan1)}</td>
                            <td style="text-align:right;">â‚¬${formatEUR(d.priceDec31)}</td>
                            <td style="text-align:right;font-weight:600;">â‚¬${formatEUR(d.valueDec31)}</td>
                            <td style="text-align:right;" class="${varClass}">${d.variazione >= 0 ? '+' : ''}${d.variazione.toFixed(1)}%</td>
                        </tr>
                    `;
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card mt-16" style="background:var(--bg-secondary);">
                        <div class="card-title mb-8">â„¹ï¸ Note</div>
                        <ul class="text-secondary" style="font-size:13px;line-height:1.8;padding-left:20px;">
                            <li><strong>Quadro RW:</strong> Obbligatorio se il valore complessivo supera â‚¬15.000 in qualsiasi momento dell'anno</li>
                            <li><strong>IVAFE:</strong> 0.2% sul valore medio annuo (proporzionata ai giorni di detenzione)</li>
                            <li><strong>Plusvalenze:</strong> Tassate al 26% (Quadro RT) - richiede calcolo LIFO non ancora implementato</li>
                            <li>I prezzi sono recuperati da CoinGecko. Verifica sempre con il tuo commercialista.</li>
                        </ul>
                    </div>
                `;
                
                container.innerHTML = html;
                log(`âœ… Report fiscale ${year} completato`);
                
            } catch (error) {
                Logger.error('TaxReport', 'Errore generazione', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <p>Errore durante la generazione del report</p>
                        <p class="text-secondary">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Variabile per salvare ultimo report generato
        let lastTaxReportData = null;
        
        async function exportTaxReport() {
            const year = document.getElementById('taxYear').value;
            const state = Database.getState();
            
            // Aggrega balance
            const holdings = {};
            for (const [key, balance] of Object.entries(state.balances)) {
                const coin = balance.coin;
                if (!holdings[coin]) holdings[coin] = 0;
                holdings[coin] += balance.amount;
            }
            
            const coins = Object.keys(holdings).filter(c => holdings[c] > 0);
            
            if (coins.length === 0) {
                alert('Nessun asset da esportare');
                return;
            }
            
            log(`ğŸ“¤ Esportazione CSV report ${year}...`);
            
            // Fetch prezzi se necessario
            const prices = await PriceService.fetchYearPricesForTax(coins, parseInt(year));
            
            // Crea CSV
            let csv = 'Asset,QuantitÃ ,Prezzo 01/01,Valore 01/01,Prezzo 31/12,Valore 31/12,Variazione %\n';
            
            let totJan1 = 0, totDec31 = 0;
            
            for (const coin of coins) {
                const amount = holdings[coin];
                const priceJan1 = prices.jan1[coin] || 0;
                const priceDec31 = prices.dec31[coin] || 0;
                const valueJan1 = amount * priceJan1;
                const valueDec31 = amount * priceDec31;
                const variazione = priceJan1 > 0 ? ((priceDec31 - priceJan1) / priceJan1 * 100).toFixed(2) : 0;
                
                totJan1 += valueJan1;
                totDec31 += valueDec31;
                
                csv += `${coin},${amount},${priceJan1.toFixed(4)},${valueJan1.toFixed(2)},${priceDec31.toFixed(4)},${valueDec31.toFixed(2)},${variazione}\n`;
            }
            
            // Riga totale
            csv += `TOTALE,-,-,${totJan1.toFixed(2)},-,${totDec31.toFixed(2)},${((totDec31-totJan1)/totJan1*100).toFixed(2)}\n`;
            csv += `IVAFE (0.2%),-,-,-,-,${((totJan1+totDec31)/2*0.002).toFixed(2)},-\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QuadroRW_${year}.csv`;
            a.click();
            
            log(`âœ… CSV esportato: QuadroRW_${year}.csv`);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOG CONSOLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function log(message) {
            const console = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString('it-IT');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="text-secondary">[${time}]</span> ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
            
            // Limita a 50 entries
            while (console.children.length > 50) {
                console.removeChild(console.firstChild);
            }
        }
        
        function clearLog() {
            document.getElementById('logConsole').innerHTML = '';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILTER TRANSACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function filterTransactions() {
            // TODO: Implementare filtri
            updateTransactionTable();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // START APP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
