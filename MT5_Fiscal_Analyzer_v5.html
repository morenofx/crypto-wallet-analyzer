<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Fiscal Analyzer v5.0 - Multi-Anno Automatico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'JetBrains Mono', monospace;
            color: #e0e0e0;
            padding: 24px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 {
            font-size: 28px; font-weight: 700;
            background: linear-gradient(135deg, #00ff88, #00a8ff, #fbbf24);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .header p { color: #888; font-size: 14px; }
        .header .version { 
            color: #00ff88; font-size: 12px; margin-top: 8px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .badge {
            padding: 3px 10px; border-radius: 12px;
            font-size: 10px; font-weight: 600;
        }
        .badge-ai { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; }
        .badge-auto { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #0a0a0a; }
        
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            margin-bottom: 24px;
            padding: 24px;
        }
        
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }
        .drop-zone .icon { font-size: 48px; margin-bottom: 16px; }
        .drop-zone .hint { color: #666; font-size: 13px; margin-top: 10px; }
        
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-family: inherit; font-weight: 600;
            transition: all 0.3s ease; font-size: 14px;
            margin-right: 8px; margin-bottom: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #0a0a0a; }
        .btn-secondary { background: linear-gradient(135deg, #00a8ff, #0066ff); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0a0a; }
        .btn-ai { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; }
        .btn-danger { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid #ff4757; }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .flex-between {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        
        .table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .table th, .table td {
            padding: 12px; text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .table th {
            color: #888; font-weight: 500;
            text-transform: uppercase; font-size: 10px; letter-spacing: 1px;
        }
        .table tr:hover { background: rgba(255,255,255,0.02); }
        .total-row { background: rgba(255,255,255,0.05); font-weight: 700; }
        
        .profit { color: #00ff88; }
        .loss { color: #ff4757; }
        .warning-text { color: #fbbf24; }
        .info-text { color: #00a8ff; }
        
        .tag {
            display: inline-block; padding: 4px 10px; border-radius: 4px;
            font-size: 11px; font-weight: 500;
        }
        .tag-blue { background: rgba(0, 168, 255, 0.2); color: #00a8ff; }
        .tag-yellow { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .tag-green { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        
        .year-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .year-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .year-badge {
            font-size: 24px; font-weight: 700;
            background: linear-gradient(135deg, #00a8ff, #0066ff);
            padding: 10px 20px; border-radius: 10px;
        }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 15px; margin-bottom: 20px;
        }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px; padding: 15px; text-align: center;
        }
        .stat-box .label { font-size: 10px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .stat-box .value { font-size: 16px; font-weight: 700; }
        
        .section-title {
            font-size: 14px; font-weight: 600; margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px;
        }
        
        .info-box {
            padding: 15px; border-radius: 8px; font-size: 12px; margin-top: 15px;
        }
        .info-box.blue { background: rgba(0, 168, 255, 0.1); border: 1px solid rgba(0, 168, 255, 0.3); color: #00a8ff; }
        .info-box.yellow { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); color: #fbbf24; }
        .info-box.green { background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); color: #00ff88; }
        
        .summary-card {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,168,255,0.1));
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 12px; padding: 25px; text-align: center;
        }
        .summary-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; margin-top: 20px;
        }
        @media (max-width: 768px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .api-section {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px; padding: 15px; margin-bottom: 24px;
        }
        .api-row { display: flex; gap: 10px; align-items: center; }
        .api-input {
            flex: 1; padding: 10px 15px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 8px; background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-family: inherit; font-size: 13px;
        }
        .api-status { font-size: 11px; padding: 5px 10px; border-radius: 4px; }
        .api-status.on { background: rgba(0,255,136,0.2); color: #00ff88; }
        .api-status.off { background: rgba(255,71,87,0.2); color: #ff4757; }
        
        .hidden { display: none; }
        h2 { font-size: 18px; margin: 0; }
        
        .footer { text-align: center; margin-top: 40px; color: #444; font-size: 11px; }
        
        .glow-green { box-shadow: 0 0 30px rgba(0, 255, 136, 0.15); }
        .glow-blue { box-shadow: 0 0 30px rgba(0, 168, 255, 0.15); }
        .glow-yellow { box-shadow: 0 0 30px rgba(251, 191, 36, 0.15); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä MT5 Fiscal Analyzer</h1>
            <p>Quadro RT + Quadro RW + IVAFE ‚Ä¢ Estrazione Multi-Anno Automatica</p>
            <div class="version">
                <span>v5.0</span>
                <span class="badge badge-auto">üîÑ AUTO</span>
                <span class="badge badge-ai">ü§ñ AI</span>
            </div>
        </div>

        <!-- Intestatario + API Section -->
        <div class="api-section" style="background: rgba(0,168,255,0.1); border-color: rgba(0,168,255,0.3);">
            <div class="api-row" style="margin-bottom:10px;">
                <span style="font-size:13px;">üë§ Intestatario:</span>
                <input type="text" id="intestatario" class="api-input" placeholder="Nome e Cognome (es. ROSSI MARIO)" style="max-width:350px; text-transform:uppercase;" onchange="saveIntestatario()">
                <span style="font-size:11px;color:#888;">Apparir√† su tutti i PDF</span>
            </div>
            <div class="api-row">
                <span style="font-size:13px;">üîë Claude API:</span>
                <input type="password" id="apiKey" class="api-input" placeholder="sk-ant-... (opzionale)" style="max-width:300px;">
                <button class="btn btn-ai btn-small" onclick="saveKey()">Salva</button>
                <span id="apiStatus" class="api-status off">OFF</span>
            </div>
        </div>

        <!-- Drop Zone -->
        <div class="drop-zone" id="dropZone">
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls" style="display:none">
            <div class="icon">üìÅ</div>
            <p>Trascina qui i <strong>ReportHistory.xlsx</strong> da MT5</p>
            <p class="hint">üí° Genera il report con <strong>tutto lo storico</strong> per estrazione multi-anno automatica</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Account Info -->
            <div class="card">
                <div class="flex-between">
                    <h2>üìÑ Report Caricati</h2>
                    <div>
                        <button class="btn btn-ai btn-small" onclick="runAI()">ü§ñ Analisi AI</button>
                        <button class="btn btn-danger btn-small" onclick="clearAll()">Cancella</button>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Intestatario</th>
                            <th>Broker</th>
                            <th>Paese</th>
                            <th>Periodo</th>
                            <th>Anni</th>
                            <th>Trade</th>
                            <th>Net Profit</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTable"></tbody>
                </table>
            </div>

            <!-- Years Detail -->
            <div id="yearsContainer"></div>

            <!-- Grand Total -->
            <div class="summary-card glow-green" id="grandTotal"></div>

            <!-- Export All -->
            <div style="text-align:center;margin-top:30px;">
                <button class="btn btn-primary" onclick="exportAllPDF()">üìÑ Scarica TUTTI i PDF (RT + RW)</button>
                <button class="btn btn-secondary" onclick="exportCSV()">üì• Esporta CSV</button>
            </div>
        </div>

        <!-- AI Section -->
        <div id="aiSection" class="card hidden" style="border-color:rgba(168,85,247,0.3);">
            <h2 style="color:#a855f7;margin-bottom:15px;">ü§ñ Analisi Claude AI</h2>
            <div id="aiContent" style="background:rgba(0,0,0,0.2);border-radius:8px;padding:15px;font-size:13px;line-height:1.6;white-space:pre-wrap;"></div>
        </div>

        <div class="footer">
            <p>MT5 Fiscal Analyzer v5.0 ‚Ä¢ Quadro RT + RW + IVAFE ‚Ä¢ Creato per Moreno ‚Ä¢ 2025</p>
            <p>‚ö†Ô∏è Documento di supporto. Verificare sempre con un commercialista.</p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // Data structures
        let accounts = [];
        let yearlyData = {};
        
        // Country codes
        const COUNTRIES = {
            'AU': { code: '008', name: 'Australia' },
            'UK': { code: '031', name: 'Regno Unito' },
            'CY': { code: '600', name: 'Cipro' },
            'US': { code: '069', name: 'Stati Uniti' },
            'KY': { code: '312', name: 'Isole Cayman' },
            'MT': { code: '046', name: 'Malta' },
            'IE': { code: '040', name: 'Irlanda' }
        };
        
        // Broker detection
        function detectCountry(company) {
            const c = (company || '').toLowerCase();
            if (c.includes('vantage')) return 'AU';
            if (c.includes('etoro')) return 'CY';
            if (c.includes('interactive')) return 'US';
            if (c.includes('plus500')) return 'CY';
            if (c.includes('pepperstone')) return 'AU';
            if (c.includes('ig ')) return 'UK';
            return 'AU';
        }

        // Intestatario Management
        function saveIntestatario() {
            const nome = document.getElementById('intestatario').value.trim().toUpperCase();
            localStorage.setItem('mt5_intestatario', nome);
        }
        
        function getIntestatario() {
            return localStorage.getItem('mt5_intestatario') || '';
        }
        
        // Save custom holder per account
        function saveHolder(input) {
            const account = input.dataset.account;
            const value = input.value.trim().toUpperCase();
            input.value = value;
            localStorage.setItem(`holder_${account}`, value);
        }
        
        // Get custom holder for account
        function getHolder(accountNumber) {
            return localStorage.getItem(`holder_${accountNumber}`) || '';
        }
        
        // API Management
        function saveKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key.startsWith('sk-ant-')) {
                localStorage.setItem('claude_key', key);
                document.getElementById('apiKey').value = '';
                updateApiStatus();
            }
        }
        
        function updateApiStatus() {
            const s = document.getElementById('apiStatus');
            if (localStorage.getItem('claude_key')) {
                s.className = 'api-status on';
                s.textContent = 'ON';
            } else {
                s.className = 'api-status off';
                s.textContent = 'OFF';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            updateApiStatus();
            // Load saved intestatario
            const saved = getIntestatario();
            if (saved) document.getElementById('intestatario').value = saved;
        });

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('active');
        dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('active'); handleFiles(e.dataTransfer.files); };
        fileInput.onchange = e => handleFiles(e.target.files);

        async function handleFiles(files) {
            dropZone.innerHTML = '<div class="icon">‚è≥</div><p>Elaborazione...</p>';
            
            for (const file of files) {
                if (file.name.match(/\.xlsx?$/i)) {
                    try {
                        const data = await processFile(file);
                        accounts.push(data);
                    } catch (e) { console.error(e); }
                }
            }
            
            dropZone.innerHTML = '<div class="icon">üìÅ</div><p>Trascina altri file o clicca</p><p class="hint">üí° Genera il report con tutto lo storico</p>';
            
            if (accounts.length > 0) {
                consolidateData();
                render();
            }
        }

        async function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        
                        // Extract account info
                        let accountName = '', accountNumber = '', company = '';
                        let holderName = ''; // Nome intestatario
                        
                        for (let i = 0; i < 10; i++) {
                            const row = data[i] || [];
                            if (row[0] === 'Name:') accountName = row[3] || '';
                            if (row[0] === 'Account:') {
                                const m = String(row[3] || '').match(/(\d+)/);
                                if (m) accountNumber = m[1];
                            }
                            if (row[0] === 'Company:') company = row[3] || '';
                        }
                        
                        // Detect if accountName is a person name or EA name
                        const eaKeywords = ['trader', 'ea', 'bot', 'auto', 'script', 'expert', 'system', 'algo', 'grid', 'scalp', 'hedge'];
                        const nameLower = accountName.toLowerCase();
                        const isEA = eaKeywords.some(kw => nameLower.includes(kw));
                        
                        // If it looks like a person name (2+ words, no EA keywords), use it as holder
                        const words = accountName.trim().split(/\s+/);
                        if (!isEA && words.length >= 2 && words.every(w => /^[A-Z][a-z]*$/.test(w) || /^[A-Z]+$/.test(w))) {
                            holderName = accountName.toUpperCase();
                        }
                        
                        const eaName = accountName; // Always keep original as EA name
                        
                        // Find Deals section
                        let dealsStart = -1;
                        for (let i = 0; i < data.length; i++) {
                            if (data[i][0] === 'Deals') { dealsStart = i + 2; break; }
                        }
                        
                        if (dealsStart === -1) {
                            reject(new Error('Sezione Deals non trovata'));
                            return;
                        }
                        
                        // Process all deals
                        const deals = [];
                        const balanceHistory = []; // Track balance changes
                        
                        for (let i = dealsStart; i < data.length; i++) {
                            const row = data[i];
                            const dateStr = String(row[0] || '');
                            
                            if (!dateStr.match(/^\d{4}\.\d{2}\.\d{2}/)) {
                                if (['Working Orders', 'Results', ''].includes(row[0]) || !row[0]) break;
                                continue;
                            }
                            
                            const match = dateStr.match(/(\d{4})\.(\d{2})\.(\d{2})/);
                            if (!match) continue;
                            
                            const date = new Date(match[1], match[2] - 1, match[3]);
                            const year = parseInt(match[1]);
                            const type = String(row[3] || '').toLowerCase();
                            const direction = String(row[4] || '').toLowerCase();
                            const profit = parseFloat(row[11]) || 0;
                            const balance = parseFloat(row[12]) || 0;
                            const comment = String(row[13] || '');
                            
                            // Track ALL balance entries for RW
                            if (balance > 0) {
                                balanceHistory.push({ date, year, balance, type, profit });
                            }
                            
                            // Track trades (only OUT for P&L)
                            if (direction === 'out' && (type === 'buy' || type === 'sell')) {
                                deals.push({
                                    date, year, type, profit, balance,
                                    isWin: profit >= 0
                                });
                            }
                        }
                        
                        // Group by year
                        const byYear = {};
                        const years = [...new Set(deals.map(d => d.year))].sort();
                        
                        years.forEach(year => {
                            const yearDeals = deals.filter(d => d.year === year);
                            const yearBalances = balanceHistory.filter(b => b.year === year);
                            
                            // Find first and last balance of the year
                            const sortedBalances = yearBalances.sort((a, b) => a.date - b.date);
                            
                            // First balance: either Jan 1 or first transaction
                            let valoreIniziale = 0;
                            let valoreFinale = 0;
                            let firstDate = null;
                            let lastDate = null;
                            
                            if (sortedBalances.length > 0) {
                                // Find the balance AFTER all initial deposits (credit/balance types)
                                // This is the starting capital before any trading
                                let foundFirstTrade = false;
                                
                                for (let j = 0; j < sortedBalances.length; j++) {
                                    const entry = sortedBalances[j];
                                    
                                    // If this is a deposit/credit, update initial value
                                    if (entry.type === 'deposit' || entry.type === 'credit' || entry.type === 'balance') {
                                        valoreIniziale = entry.balance;
                                    } 
                                    // Once we hit a trade (buy/sell), stop - we have our initial value
                                    else if ((entry.type === 'buy' || entry.type === 'sell') && !foundFirstTrade) {
                                        // If no deposits found yet, use the balance before this trade
                                        if (valoreIniziale === 0) {
                                            valoreIniziale = entry.balance - (entry.profit || 0);
                                        }
                                        foundFirstTrade = true;
                                        break;
                                    }
                                }
                                
                                // If still 0, use first balance entry
                                if (valoreIniziale === 0 && sortedBalances.length > 0) {
                                    valoreIniziale = sortedBalances[0].balance;
                                }
                                
                                // Final value is last balance
                                valoreFinale = sortedBalances[sortedBalances.length - 1].balance;
                                
                                firstDate = sortedBalances[0].date;
                                lastDate = sortedBalances[sortedBalances.length - 1].date;
                            }
                            
                            // Calculate days
                            let giorni = 365;
                            if (firstDate && lastDate) {
                                const janFirst = new Date(year, 0, 1);
                                const decLast = new Date(year, 11, 31);
                                const start = firstDate < janFirst ? janFirst : firstDate;
                                const end = lastDate > decLast ? decLast : lastDate;
                                giorni = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                                if (giorni > 365) giorni = 365;
                                if (giorni < 1) giorni = 1;
                            }
                            
                            // Calculate P&L
                            let grossProfit = 0, grossLoss = 0, wins = 0, losses = 0;
                            yearDeals.forEach(d => {
                                if (d.profit >= 0) {
                                    grossProfit += d.profit;
                                    wins++;
                                } else {
                                    grossLoss += d.profit;
                                    losses++;
                                }
                            });
                            
                            byYear[year] = {
                                trades: yearDeals.length,
                                wins, losses,
                                grossProfit,
                                grossLoss,
                                netProfit: grossProfit + grossLoss,
                                valoreIniziale,
                                valoreFinale,
                                giorni,
                                firstDate,
                                lastDate
                            };
                        });
                        
                        const country = detectCountry(company);
                        
                        resolve({
                            fileName: file.name,
                            accountName: eaName,
                            holderName: holderName,
                            accountNumber,
                            company,
                            country,
                            countryInfo: COUNTRIES[country] || COUNTRIES['AU'],
                            years: Object.keys(byYear).map(Number).sort(),
                            byYear,
                            totalTrades: deals.length,
                            totalProfit: deals.reduce((s, d) => s + d.profit, 0)
                        });
                        
                    } catch (error) { reject(error); }
                };
                reader.onerror = () => reject(new Error('Errore lettura'));
                reader.readAsArrayBuffer(file);
            });
        }

        function consolidateData() {
            yearlyData = {};
            
            accounts.forEach(acc => {
                Object.entries(acc.byYear).forEach(([year, data]) => {
                    if (!yearlyData[year]) {
                        yearlyData[year] = {
                            accounts: {},
                            totals: {
                                trades: 0, wins: 0, losses: 0,
                                grossProfit: 0, grossLoss: 0, netProfit: 0,
                                ivafe: 0
                            }
                        };
                    }
                    
                    // Calculate IVAFE
                    const valoreMedio = (data.valoreIniziale + data.valoreFinale) / 2;
                    const ivafe = (valoreMedio * 0.002 * data.giorni) / 365;
                    
                    yearlyData[year].accounts[acc.accountNumber] = {
                        ...data,
                        accountName: acc.accountName,
                        company: acc.company,
                        country: acc.country,
                        countryInfo: acc.countryInfo,
                        ivafe
                    };
                    
                    // Update totals
                    const t = yearlyData[year].totals;
                    t.trades += data.trades;
                    t.wins += data.wins;
                    t.losses += data.losses;
                    t.grossProfit += data.grossProfit;
                    t.grossLoss += data.grossLoss;
                    t.netProfit += data.netProfit;
                    t.ivafe += ivafe;
                });
            });
        }

        function fmt(n) { return Math.abs(n).toFixed(2).replace('.', ','); }
        function fmtSign(n) { return (n >= 0 ? '+' : '-') + '‚Ç¨' + fmt(n); }

        function render() {
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Accounts table
            const intestatarioGlobale = getIntestatario();
            document.getElementById('accountsTable').innerHTML = accounts.map((a, idx) => {
                // Priority: 1) custom holder, 2) holderName from file, 3) global intestatario, 4) accountName
                const savedHolder = localStorage.getItem(`holder_${a.accountNumber}`);
                const displayHolder = savedHolder || a.holderName || intestatarioGlobale || a.accountName;
                return `
                <tr>
                    <td><span class="tag tag-blue">${a.accountNumber}</span></td>
                    <td>
                        <input type="text" class="holder-input" 
                            value="${displayHolder}" 
                            data-account="${a.accountNumber}"
                            onchange="saveHolder(this)"
                            style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:4px;padding:6px 10px;color:#e0e0e0;font-family:inherit;font-size:12px;width:150px;font-weight:600;">
                    </td>
                    <td style="font-size:11px;">${a.company}</td>
                    <td><span class="tag tag-yellow">üåç ${a.countryInfo.name}</span></td>
                    <td style="font-size:11px;">${a.years[0]} ‚Üí ${a.years[a.years.length-1]}</td>
                    <td><span class="tag tag-green">${a.years.length} anni</span></td>
                    <td>${a.totalTrades}</td>
                    <td class="${a.totalProfit >= 0 ? 'profit' : 'loss'}" style="font-weight:600;">${fmtSign(a.totalProfit)}</td>
                </tr>
            `}).join('');
            
            // Years detail
            const yearsHtml = Object.entries(yearlyData).sort().map(([year, data]) => {
                const t = data.totals;
                const winRate = t.trades > 0 ? ((t.wins / t.trades) * 100).toFixed(1) : 0;
                const imposta = t.netProfit > 0 ? t.netProfit * 0.26 : 0;
                
                return `
                <div class="year-card">
                    <div class="year-header">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <span class="year-badge">${year}</span>
                            <span style="color:#888;">Anno Fiscale</span>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="genRT(${year})">üìÑ PDF RT</button>
                            <button class="btn btn-warning btn-small" onclick="genRW(${year})">üìÑ PDF RW</button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="label">Trade</div>
                            <div class="value">${t.trades}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Win Rate</div>
                            <div class="value profit">${winRate}%</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Gross Profit</div>
                            <div class="value profit">‚Ç¨${fmt(t.grossProfit)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Gross Loss</div>
                            <div class="value loss">‚Ç¨${fmt(Math.abs(t.grossLoss))}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Net Profit</div>
                            <div class="value ${t.netProfit >= 0 ? 'profit' : 'loss'}">${fmtSign(t.netProfit)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">IVAFE Tot.</div>
                            <div class="value warning-text">‚Ç¨${fmt(t.ivafe)}</div>
                        </div>
                    </div>
                    
                    <!-- RT Section -->
                    <div class="section-title">üìà Quadro RT - Plusvalenze CFD</div>
                    <div class="info-box blue">
                        <strong>RT21</strong> Corrispettivi: ‚Ç¨${fmt(t.grossProfit)} &nbsp;|&nbsp;
                        <strong>RT22</strong> Costi: ‚Ç¨${fmt(Math.abs(t.grossLoss))} &nbsp;|&nbsp;
                        <strong>RT23</strong> Plusvalenza: ‚Ç¨${t.netProfit > 0 ? fmt(t.netProfit) : '0,00'} &nbsp;|&nbsp;
                        <strong>RT26</strong> Imposta 26%: <strong>‚Ç¨${fmt(imposta)}</strong>
                    </div>
                    
                    <!-- RW Section -->
                    <div class="section-title" style="margin-top:20px;">üåç Quadro RW - Monitoraggio Estero</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Broker</th>
                                <th>Paese (Cod.)</th>
                                <th>Val. Iniziale</th>
                                <th>Val. Finale</th>
                                <th>Giorni</th>
                                <th>IVAFE 0,2%</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(data.accounts).map(([accNum, acc]) => `
                                <tr>
                                    <td><span class="tag tag-blue">${accNum}</span></td>
                                    <td style="font-size:11px;">${acc.company}</td>
                                    <td>${acc.countryInfo.name} (${acc.countryInfo.code})</td>
                                    <td>‚Ç¨${fmt(acc.valoreIniziale)}</td>
                                    <td>‚Ç¨${fmt(acc.valoreFinale)}</td>
                                    <td>${acc.giorni}</td>
                                    <td class="warning-text" style="font-weight:600;">‚Ç¨${fmt(acc.ivafe)}</td>
                                </tr>
                            `).join('')}
                            <tr class="total-row">
                                <td colspan="6">TOTALE IVAFE ${year}</td>
                                <td class="warning-text">‚Ç¨${fmt(t.ivafe)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="info-box yellow" style="margin-top:15px;">
                        <strong>üí∞ Imposte ${year}:</strong> 
                        RT (26%): <strong>‚Ç¨${fmt(imposta)}</strong> (cod. 1100) &nbsp;+&nbsp; 
                        IVAFE: <strong>‚Ç¨${fmt(t.ivafe)}</strong> (cod. 4043) &nbsp;=&nbsp;
                        <strong style="font-size:14px;">TOTALE: ‚Ç¨${fmt(imposta + t.ivafe)}</strong>
                    </div>
                </div>
                `;
            }).join('');
            
            document.getElementById('yearsContainer').innerHTML = yearsHtml;
            
            // Grand total
            let totalRT = 0, totalIVAFE = 0, totalTrades = 0, totalNet = 0;
            Object.values(yearlyData).forEach(y => {
                totalTrades += y.totals.trades;
                totalNet += y.totals.netProfit;
                totalRT += y.totals.netProfit > 0 ? y.totals.netProfit * 0.26 : 0;
                totalIVAFE += y.totals.ivafe;
            });
            
            document.getElementById('grandTotal').innerHTML = `
                <h2 style="margin-bottom:20px;">üìä RIEPILOGO TOTALE TUTTI GLI ANNI</h2>
                <div class="summary-grid">
                    <div>
                        <div style="color:#888;font-size:11px;margin-bottom:5px;">TRADE TOTALI</div>
                        <div style="font-size:24px;font-weight:700;">${totalTrades}</div>
                    </div>
                    <div>
                        <div style="color:#888;font-size:11px;margin-bottom:5px;">NET PROFIT</div>
                        <div style="font-size:24px;font-weight:700;" class="${totalNet >= 0 ? 'profit' : 'loss'}">${fmtSign(totalNet)}</div>
                    </div>
                    <div>
                        <div style="color:#888;font-size:11px;margin-bottom:5px;">IMPOSTA RT</div>
                        <div style="font-size:24px;font-weight:700;color:#fbbf24;">‚Ç¨${fmt(totalRT)}</div>
                    </div>
                    <div>
                        <div style="color:#888;font-size:11px;margin-bottom:5px;">IVAFE</div>
                        <div style="font-size:24px;font-weight:700;color:#fbbf24;">‚Ç¨${fmt(totalIVAFE)}</div>
                    </div>
                </div>
                <div style="margin-top:25px;padding:20px;background:rgba(251,191,36,0.2);border-radius:10px;">
                    <span style="font-size:12px;color:#888;">TOTALE IMPOSTE DA VERSARE:</span>
                    <span style="font-size:28px;font-weight:700;color:#fbbf24;margin-left:15px;">‚Ç¨${fmt(totalRT + totalIVAFE)}</span>
                </div>
            `;
        }

        // PDF Generation
        function genRT(year) {
            const data = yearlyData[year];
            if (!data) return;
            
            const t = data.totals;
            const intestatario = getIntestatario();
            const doc = new jsPDF();
            const pw = doc.internal.pageSize.getWidth();
            
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('QUADRO RT - PLUSVALENZE DI NATURA FINANZIARIA', pw/2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`ANNO FISCALE ${year}`, pw/2, 28, { align: 'center' });
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Sezione II-B - Plusvalenze da contratti derivati (CFD/Forex)', pw/2, 35, { align: 'center' });
            
            // Intestatario box
            if (intestatario) {
                doc.setFillColor(230, 245, 255);
                doc.rect(15, 40, pw - 30, 12, 'F');
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(`CONTRIBUENTE: ${intestatario}`, pw/2, 48, { align: 'center' });
            }
            
            // Info box
            const infoY = intestatario ? 56 : 42;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, infoY, pw - 30, 18, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generato: ${new Date().toLocaleString('it-IT')} | MT5 Fiscal Analyzer v5.0`, 20, infoY + 7);
            doc.text('Documento di supporto alla compilazione - Verificare con commercialista', 20, infoY + 13);
            
            let y = infoY + 28;
            
            // Stats
            const winRate = t.trades > 0 ? ((t.wins / t.trades) * 100).toFixed(1) : 0;
            doc.setFontSize(10);
            doc.text(`Trade: ${t.trades} | Vinti: ${t.wins} | Persi: ${t.losses} | Win Rate: ${winRate}%`, 15, y);
            y += 12;
            
            // Accounts detail
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('CONTI TRADING ESTERI:', 15, y);
            y += 8;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            Object.entries(data.accounts).forEach(([accNum, acc]) => {
                const holderName = getHolder(accNum) || acc.accountName;
                doc.text(`‚Ä¢ ${accNum} - ${holderName} (${acc.countryInfo.name})`, 15, y);
                y += 5;
                doc.text(`  Gross Profit: ‚Ç¨${fmt(acc.grossProfit)} | Gross Loss: ‚Ç¨${fmt(Math.abs(acc.grossLoss))} | Net: ‚Ç¨${fmt(acc.netProfit)}`, 15, y);
                y += 8;
            });
            
            // RT Table
            y += 5;
            doc.setFillColor(0, 100, 180);
            doc.setTextColor(255, 255, 255);
            doc.rect(15, y - 5, pw - 30, 10, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('QUADRO RT - SEZIONE II-B (DERIVATI)', 20, y + 2);
            y += 15;
            
            doc.setTextColor(0, 0, 0);
            const imposta = t.netProfit > 0 ? t.netProfit * 0.26 : 0;
            const righi = [
                ['RT21', 'Corrispettivi percepiti', fmt(t.grossProfit)],
                ['RT22', 'Costi e valori di acquisto', fmt(Math.abs(t.grossLoss))],
                ['RT23', 'Plusvalenze', t.netProfit > 0 ? fmt(t.netProfit) : '0,00'],
                ['RT24', 'Minusvalenze', t.netProfit < 0 ? fmt(Math.abs(t.netProfit)) : '0,00'],
                ['RT25', 'Minusvalenze anni precedenti', '0,00'],
                ['RT26', 'Imposta sostitutiva (26%)', fmt(imposta)]
            ];
            
            // Table header
            doc.setFillColor(220, 220, 220);
            doc.rect(15, y, 25, 8, 'F');
            doc.rect(40, y, 100, 8, 'F');
            doc.rect(140, y, 55, 8, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('RIGO', 18, y + 6);
            doc.text('DESCRIZIONE', 45, y + 6);
            doc.text('IMPORTO ‚Ç¨', 145, y + 6);
            y += 8;
            
            // Table rows
            doc.setFont('helvetica', 'normal');
            righi.forEach(([rigo, desc, val]) => {
                doc.rect(15, y, 25, 8);
                doc.rect(40, y, 100, 8);
                doc.rect(140, y, 55, 8);
                doc.text(rigo, 18, y + 6);
                doc.text(desc, 42, y + 6);
                doc.text(val, 190, y + 6, { align: 'right' });
                y += 8;
            });
            
            // Result box
            y += 10;
            if (t.netProfit > 0) {
                doc.setFillColor(200, 255, 200);
                doc.rect(15, y, pw - 30, 22, 'F');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`IMPOSTA DOVUTA: ‚Ç¨ ${fmt(imposta)}`, pw/2, y + 9, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Codice tributo F24: 1100 | Scadenza: 30 giugno', pw/2, y + 17, { align: 'center' });
            } else {
                doc.setFillColor(255, 230, 230);
                doc.rect(15, y, pw - 30, 18, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`MINUSVALENZA: ‚Ç¨ ${fmt(Math.abs(t.netProfit))}`, pw/2, y + 8, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Riportabile nei 4 anni successivi', pw/2, y + 14, { align: 'center' });
            }
            
            doc.setFontSize(7);
            doc.setTextColor(128, 128, 128);
            doc.text('MT5 Fiscal Analyzer v5.0 - Moreno', pw/2, 287, { align: 'center' });
            
            doc.save(`Quadro_RT_${year}.pdf`);
        }

        function genRW(year) {
            const data = yearlyData[year];
            if (!data) return;
            
            const intestatario = getIntestatario();
            const doc = new jsPDF();
            const pw = doc.internal.pageSize.getWidth();
            
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('QUADRO RW - MONITORAGGIO FISCALE', pw/2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`ANNO FISCALE ${year}`, pw/2, 28, { align: 'center' });
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Investimenti e attivit√† finanziarie detenute all\'estero', pw/2, 35, { align: 'center' });
            
            // Intestatario box
            if (intestatario) {
                doc.setFillColor(255, 250, 230);
                doc.rect(15, 40, pw - 30, 12, 'F');
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(`CONTRIBUENTE: ${intestatario}`, pw/2, 48, { align: 'center' });
            }
            
            // Info box
            const infoY = intestatario ? 56 : 42;
            doc.setFillColor(255, 248, 220);
            doc.rect(15, infoY, pw - 30, 18, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generato: ${new Date().toLocaleString('it-IT')} | MT5 Fiscal Analyzer v5.0`, 20, infoY + 7);
            doc.text('Documento di supporto alla compilazione - Verificare con commercialista', 20, infoY + 13);
            
            let y = infoY + 28;
            
            // Instructions
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('OBBLIGHI BROKER ESTERI:', 15, y);
            y += 7;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('‚Ä¢ Quadro RW: Obbligatorio per monitoraggio fiscale conti trading esteri', 15, y); y += 5;
            doc.text('‚Ä¢ IVAFE: Imposta 0,2% annuo sul valore medio delle attivit√†', 15, y); y += 5;
            doc.text('‚Ä¢ Codice investimento: 20 (Altri rapporti finanziari)', 15, y); y += 12;
            
            // Accounts detail
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('CONTI TRADING ESTERI:', 15, y);
            y += 10;
            
            let totalIVAFE = 0;
            let rigoNum = 1;
            
            Object.entries(data.accounts).forEach(([accNum, acc]) => {
                const holderName = getHolder(accNum) || acc.accountName;
                
                doc.setFillColor(250, 250, 250);
                doc.rect(15, y - 3, pw - 30, 32, 'F');
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`RW${rigoNum} - Conto: ${accNum} - ${holderName}`, 20, y + 3);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                y += 9;
                doc.text(`Broker: ${acc.company}`, 20, y);
                doc.text(`Paese: ${acc.countryInfo.name} (codice ${acc.countryInfo.code})`, 110, y);
                y += 6;
                doc.text(`Col. 7 - Valore iniziale: ‚Ç¨ ${fmt(acc.valoreIniziale)}`, 20, y);
                doc.text(`Col. 8 - Valore finale: ‚Ç¨ ${fmt(acc.valoreFinale)}`, 110, y);
                y += 6;
                doc.text(`Col. 10 - Giorni detenzione: ${acc.giorni}`, 20, y);
                doc.text(`IVAFE: ‚Ç¨ ${fmt(acc.ivafe)}`, 110, y);
                
                totalIVAFE += acc.ivafe;
                y += 14;
                rigoNum++;
            });
            
            // IVAFE Total
            y += 5;
            doc.setFillColor(255, 200, 0);
            doc.rect(15, y, pw - 30, 20, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`TOTALE IVAFE ${year}: ‚Ç¨ ${fmt(totalIVAFE)}`, pw/2, y + 8, { align: 'center' });
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Codice tributo F24: 4043 | Scadenza: 30 giugno', pw/2, y + 15, { align: 'center' });
            
            // Compilation guide
            y += 30;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('GUIDA COMPILAZIONE QUADRO RW:', 15, y);
            y += 7;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            const guide = [
                'Col. 1: Codice titolo possesso = 1 (propriet√†)',
                'Col. 3: Codice individuazione bene = 20',
                'Col. 4: Codice Stato estero (vedere tabella AdE)',
                'Col. 5: Quota possesso = 100',
                'Col. 6: Criterio determinazione valore = 1 (mercato)',
                'Col. 7: Valore inizio periodo (estratto automaticamente)',
                'Col. 8: Valore fine periodo (estratto automaticamente)',
                'Col. 10: Giorni detenzione (calcolato automaticamente)',
                'Col. 20: Barrare casella IVAFE'
            ];
            guide.forEach(line => {
                doc.text(line, 15, y);
                y += 5;
            });
            
            doc.setFontSize(7);
            doc.setTextColor(128, 128, 128);
            doc.text('MT5 Fiscal Analyzer v5.0 - Moreno', pw/2, 287, { align: 'center' });
            
            doc.save(`Quadro_RW_${year}.pdf`);
        }

        function exportAllPDF() {
            const years = Object.keys(yearlyData).sort();
            let delay = 0;
            
            years.forEach((year) => {
                // RT first
                setTimeout(() => genRT(parseInt(year)), delay);
                delay += 1000;
                
                // RW after
                setTimeout(() => genRW(parseInt(year)), delay);
                delay += 1000;
            });
            
            // Alert when done
            setTimeout(() => {
                alert(`‚úÖ Generati ${years.length * 2} PDF (RT + RW) per gli anni: ${years.join(', ')}`);
            }, delay);
        }

        function exportCSV() {
            let csv = 'MT5 FISCAL ANALYZER - RIEPILOGO\n';
            csv += `Generato: ${new Date().toLocaleString('it-IT')}\n\n`;
            csv += 'QUADRO RT + RW\n';
            csv += 'Anno,Account,EA,Paese,Trade,Gross Profit,Gross Loss,Net Profit,Imposta RT,Val.Iniziale,Val.Finale,Giorni,IVAFE\n';
            
            Object.entries(yearlyData).sort().forEach(([year, data]) => {
                Object.entries(data.accounts).forEach(([accNum, acc]) => {
                    const imposta = acc.netProfit > 0 ? (acc.netProfit * 0.26).toFixed(2) : '0.00';
                    csv += `${year},${accNum},${acc.accountName},${acc.countryInfo.name},`;
                    csv += `${acc.trades},${acc.grossProfit.toFixed(2)},${Math.abs(acc.grossLoss).toFixed(2)},${acc.netProfit.toFixed(2)},${imposta},`;
                    csv += `${acc.valoreIniziale.toFixed(2)},${acc.valoreFinale.toFixed(2)},${acc.giorni},${acc.ivafe.toFixed(2)}\n`;
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MT5_Fiscale_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function clearAll() {
            accounts = [];
            yearlyData = {};
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
        }

        // AI Analysis
        async function runAI() {
            const key = localStorage.getItem('claude_key');
            if (!key) { alert('Configura API Key'); return; }
            
            const section = document.getElementById('aiSection');
            const content = document.getElementById('aiContent');
            section.classList.remove('hidden');
            content.innerHTML = '‚è≥ Analisi in corso...';
            
            const summary = {};
            Object.entries(yearlyData).forEach(([year, data]) => {
                const t = data.totals;
                summary[year] = {
                    trades: t.trades,
                    winRate: t.trades > 0 ? ((t.wins / t.trades) * 100).toFixed(1) + '%' : '0%',
                    netProfit: '‚Ç¨' + fmt(t.netProfit),
                    impostaRT: '‚Ç¨' + fmt(t.netProfit > 0 ? t.netProfit * 0.26 : 0),
                    ivafe: '‚Ç¨' + fmt(t.ivafe)
                };
            });
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: `Analizza questi dati fiscali trading MT5 (broker ESTERO):

${JSON.stringify(summary, null, 2)}

Fornisci:
1. ‚úÖ VERIFICA CALCOLI
2. üìä PERFORMANCE per anno
3. ‚ö†Ô∏è OBBLIGHI FISCALI (RT + RW + IVAFE)
4. üìÖ SCADENZE importanti
5. üí° SUGGERIMENTI

Rispondi in italiano, conciso e pratico.`
                        }]
                    })
                });
                
                const data = await response.json();
                content.innerHTML = data.content[0].text;
            } catch (e) {
                content.innerHTML = '‚ùå Errore: ' + e.message;
            }
        }
    </script>
</body>
</html>
