<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Wallet Analyzer v7</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'JetBrains Mono', monospace;
            color: #e0e0e0;
            padding: 24px;
        }
        
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 1000;
        }
        .home-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 {
            font-size: 28px; font-weight: 700;
            background: linear-gradient(135deg, #f7931a, #627eea, #00d4aa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .header p { color: #888; font-size: 14px; }
        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 12px;
            font-size: 10px; font-weight: 600; margin-left: 8px;
        }
        .badge-live { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #000; }
        .badge-ai { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; }
        .badge-new { background: linear-gradient(135deg, #ff6b6b, #ffa500); color: #fff; }
        
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 24px; margin-bottom: 24px;
        }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-wallet {
            flex: 1; min-width: 280px; padding: 14px 18px;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
            background: rgba(0,0,0,0.3); color: #e0e0e0;
            font-family: inherit; font-size: 14px;
        }
        .input-wallet:focus { outline: none; border-color: #00ff88; }
        
        .btn {
            padding: 14px 28px; border: none; border-radius: 8px;
            cursor: pointer; font-family: inherit; font-weight: 600;
            transition: all 0.3s ease; font-size: 14px;
        }
        .btn-primary { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #000; }
        .btn-ai { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .btn-info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        
        .api-section {
            background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .api-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .api-row:last-child { margin-bottom: 0; }
        .api-input {
            flex: 1; min-width: 200px; padding: 10px 14px;
            border: 1px solid rgba(0,255,136,0.3); border-radius: 6px;
            background: rgba(0,0,0,0.3); color: #e0e0e0;
            font-family: inherit; font-size: 12px;
        }
        .api-status { font-size: 11px; padding: 5px 10px; border-radius: 4px; }
        .api-status.on { background: rgba(0,255,136,0.2); color: #00ff88; }
        .api-status.off { background: rgba(255,71,87,0.2); color: #ff4757; }
        
        /* Backup Section */
        .backup-section {
            background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .backup-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .backup-title { font-size: 12px; font-weight: 600; color: #3b82f6; margin-bottom: 10px; }
        
        /* Date Picker */
        .date-section {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .date-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .date-input {
            padding: 10px 14px; border: 1px solid rgba(251,191,36,0.3); border-radius: 6px;
            background: rgba(0,0,0,0.3); color: #e0e0e0;
            font-family: inherit; font-size: 12px;
        }
        .date-label { font-size: 12px; color: #fbbf24; }
        .rate-display { font-size: 11px; color: #888; margin-left: 10px; }
        
        /* Wallet Preview */
        .wallet-preview-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: rgba(255,255,255,0.02);
            border: 1px dashed rgba(0,255,136,0.3); border-radius: 8px;
            margin-bottom: 8px; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .wallet-preview-left { display: flex; align-items: center; gap: 12px; }
        .wallet-preview-icon {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(0,255,136,0.2); border: 1px dashed rgba(0,255,136,0.5);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .wallet-preview-name { font-weight: 600; font-size: 13px; color: #fff; }
        .wallet-preview-address { font-size: 11px; color: #888; }
        .wallet-preview-status {
            font-size: 10px; color: #00ff88;
            background: rgba(0,255,136,0.1); padding: 4px 10px; border-radius: 12px;
        }
        .wallet-preview-remove {
            background: none; border: none; color: #ff4757;
            cursor: pointer; font-size: 18px; padding: 5px;
            margin-left: 10px; opacity: 0.7;
        }
        .wallet-preview-remove:hover { opacity: 1; }
        
        /* Wallet Cards */
        .wallet-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; margin-bottom: 16px; overflow: hidden;
        }
        .wallet-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; cursor: pointer;
            background: rgba(255,255,255,0.02); transition: background 0.2s;
        }
        .wallet-header:hover { background: rgba(255,255,255,0.05); }
        .wallet-left { display: flex; align-items: center; gap: 12px; }
        .wallet-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00d4aa);
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .wallet-name {
            font-weight: 600; font-size: 14px; color: #fff;
            background: transparent; border: none; padding: 0;
            font-family: inherit; cursor: text; width: 200px;
        }
        .wallet-name:focus { outline: none; border-bottom: 1px solid #00ff88; }
        .wallet-address { font-size: 11px; color: #888; }
        .wallet-right { display: flex; align-items: center; gap: 20px; }
        .wallet-value { font-size: 20px; font-weight: 700; color: #00ff88; }
        .wallet-tokens { font-size: 11px; color: #888; }
        .wallet-toggle { font-size: 14px; color: #00ff88; transition: transform 0.3s; }
        .wallet-toggle.open { transform: rotate(180deg); }
        
        .wallet-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .wallet-content.open { max-height: 5000px; }
        
        /* Chain Cards (inside wallet) */
        .chain-section {
            margin: 10px 15px; border-radius: 10px;
            background: rgba(0,0,0,0.2); overflow: hidden;
        }
        .chain-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; cursor: pointer;
            background: rgba(255,255,255,0.02); transition: background 0.2s;
        }
        .chain-header:hover { background: rgba(255,255,255,0.05); }
        .chain-left { display: flex; align-items: center; gap: 10px; }
        .chain-icon {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
        .chain-name { font-weight: 600; font-size: 13px; }
        .chain-count { font-size: 11px; color: #888; margin-left: 8px; }
        .chain-value { font-size: 14px; font-weight: 600; color: #00ff88; }
        .chain-toggle { font-size: 12px; color: #888; transition: transform 0.3s; margin-left: 10px; }
        .chain-toggle.open { transform: rotate(180deg); }
        
        .chain-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .chain-content.open { max-height: 2000px; }
        
        /* Token rows */
        .token-list { padding: 0 10px 10px 10px; }
        .token-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-radius: 6px;
            background: rgba(255,255,255,0.02); margin-bottom: 6px;
            transition: background 0.2s;
        }
        .token-item:hover { background: rgba(255,255,255,0.05); }
        .token-item.scam { opacity: 0.4; background: rgba(255,71,87,0.1); }
        .token-left { display: flex; align-items: center; gap: 10px; }
        .token-logo {
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(255,255,255,0.1); object-fit: cover;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .token-symbol { font-weight: 600; font-size: 13px; }
        .token-name { font-size: 10px; color: #888; }
        .token-balance { font-size: 12px; color: #888; }
        .token-value { font-size: 13px; font-weight: 600; color: #00ff88; }
        .token-price { font-size: 10px; color: #666; }
        
        .token-badge {
            font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;
        }
        .token-badge.verified { background: rgba(0,255,136,0.2); color: #00ff88; }
        .token-badge.scam { background: rgba(255,71,87,0.2); color: #ff4757; }
        
        .hide-btn {
            background: none; border: none; color: #ff4757; cursor: pointer;
            font-size: 14px; padding: 6px; opacity: 0.3; margin-right: 10px;
            transition: all 0.2s;
        }
        .hide-btn:hover { opacity: 1; transform: scale(1.2); }
        .token-item:hover .hide-btn { opacity: 0.6; }
        
        /* Filters */
        .filter-bar {
            display: flex; gap: 12px; align-items: center;
            padding: 12px 16px; background: rgba(255,71,87,0.1);
            border: 1px solid rgba(255,71,87,0.3); border-radius: 8px;
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .filter-bar label {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; cursor: pointer; padding: 6px 12px;
            background: rgba(0,0,0,0.2); border-radius: 6px;
        }
        .filter-bar label:hover { background: rgba(0,0,0,0.4); }
        .filter-bar input[type="checkbox"] { accent-color: #00ff88; }
        .filter-title { font-weight: 600; color: #ff4757; font-size: 12px; }
        
        /* Summary */
        .summary-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 15px; margin: 20px 0;
        }
        @media (max-width: 900px) { .summary-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
        .summary-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px; padding: 15px; text-align: center;
        }
        .summary-box .label { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .summary-box .value { font-size: 18px; font-weight: 700; }
        .summary-box .sub { font-size: 10px; color: #666; margin-top: 3px; }
        
        /* Fiscal */
        .fiscal-summary {
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px; padding: 20px; margin-top: 20px;
        }
        .fiscal-summary h3 { color: #fbbf24; margin-bottom: 15px; }
        .fiscal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 768px) { .fiscal-grid { grid-template-columns: 1fr; } }
        .fiscal-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; }
        .fiscal-box .title { font-size: 12px; color: #fbbf24; margin-bottom: 8px; }
        .fiscal-box .amount { font-size: 20px; font-weight: 700; }
        .fiscal-box .note { font-size: 11px; color: #888; margin-top: 5px; }
        
        /* AI */
        .ai-section {
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
            border-radius: 12px; padding: 20px; margin-top: 20px;
        }
        .ai-section h3 { color: #a855f7; font-size: 16px; margin-bottom: 15px; }
        .ai-response {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;
            font-size: 13px; line-height: 1.7;
            white-space: pre-wrap; max-height: 500px; overflow-y: auto;
        }
        
        .loading { display: flex; align-items: center; gap: 10px; padding: 20px; justify-content: center; }
        .loading-spinner {
            width: 24px; height: 24px;
            border: 3px solid rgba(0,255,136,0.3); border-top-color: #00ff88;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none; }
        .footer { text-align: center; margin-top: 40px; color: #444; font-size: 11px; }
        .price-info { font-size: 10px; color: #888; margin-top: 10px; text-align: right; }
        
        /* File input hidden */
        .file-input-hidden { display: none; }
    </style>
</head>
<body>
    <a href="index.html" class="home-btn">üè† Home</a>
    
    <div class="container">
        <div class="header">
            <h1>üîó Crypto Wallet Analyzer</h1>
            <p>Multi-Chain ‚Ä¢ Prezzi Real-Time ‚Ä¢ Fiscalit√† Italiana</p>
            <div style="margin-top:10px;">
                <span class="badge badge-live">üì° Live Prices</span>
                <span class="badge badge-ai">ü§ñ Claude AI</span>
                <span class="badge badge-new">v7.0</span>
            </div>
        </div>
        
        <!-- API Section -->
        <div class="api-section">
            <div class="api-row">
                <span style="font-size:12px;min-width:100px;">ü¶ä Moralis:</span>
                <input type="password" id="moralisKey" class="api-input" placeholder="eyJ... (per tutti i token ERC-20)" style="max-width:350px;">
                <button class="btn btn-small" style="background:#00ff88;color:#000;" onclick="saveMoralisKey()">Salva</button>
                <button class="btn btn-small" style="background:#ff4757;color:#fff;" onclick="clearMoralisKey()">‚ùå</button>
                <span id="moralisStatus" class="api-status off">OFF</span>
            </div>
            <div class="api-row">
                <span style="font-size:12px;min-width:100px;">ü§ñ Claude:</span>
                <input type="password" id="claudeKey" class="api-input" placeholder="sk-ant-... (per analisi AI)" style="max-width:350px;">
                <button class="btn btn-small" style="background:#a855f7;color:white;" onclick="saveClaudeKey()">Salva</button>
                <span id="claudeStatus" class="api-status off">OFF</span>
            </div>
        </div>
        
        <!-- Date & Rate Section -->
        <div class="date-section">
            <div class="date-row">
                <span class="date-label">üìÖ Data Riferimento Fiscale:</span>
                <input type="date" id="fiscalDate" class="date-input" value="2024-12-31">
                <span class="rate-display" id="rateDisplay">EUR/USD: caricamento...</span>
                <button class="btn btn-small btn-warning" onclick="fetchEurUsdRate()">üîÑ Aggiorna Tasso</button>
            </div>
        </div>
        
        <!-- Backup Section -->
        <div class="backup-section">
            <div class="backup-title">üíæ Backup & Ripristino Dati</div>
            <div class="backup-row">
                <button class="btn btn-small btn-info" onclick="exportJSON()">üì§ Esporta JSON</button>
                <button class="btn btn-small btn-success" onclick="document.getElementById('importFile').click()">üì• Importa JSON</button>
                <input type="file" id="importFile" class="file-input-hidden" accept=".json" onchange="importJSON(event)">
                <span style="font-size:11px;color:#888;margin-left:10px;">Salva i tuoi dati per usarli su altri dispositivi</span>
            </div>
        </div>
        
        <!-- Wallet Input -->
        <div class="card">
            <h2 style="margin-bottom:15px;">üìç Aggiungi Wallet</h2>
            <div class="input-group">
                <input type="text" id="walletInput" class="input-wallet" placeholder="Inserisci indirizzo 0x...">
                <input type="text" id="walletName" class="input-wallet" placeholder="Nome (es. Wallet Principale)" style="max-width:200px;">
                <button class="btn btn-primary" onclick="addWallet()">+ Aggiungi</button>
            </div>
            
            <div id="walletsPreview" class="hidden" style="margin-top:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="font-size:14px;color:#888;">Wallet da scansionare:</h3>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-small" style="background:linear-gradient(135deg,#00ff88,#00d4aa);color:#000;" onclick="scanAllWallets()">üîç Scansiona Tutti</button>
                        <button class="btn btn-small" style="background:rgba(255,71,87,0.2);color:#ff4757;" onclick="clearAllWallets()">üóëÔ∏è Cancella</button>
                    </div>
                </div>
                <div id="walletsPreviewList"></div>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="loadingSection" class="card hidden">
            <div class="loading">
                <div class="loading-spinner"></div>
                <span id="loadingText">Caricamento prezzi real-time...</span>
            </div>
        </div>
        
        <!-- Results -->
        <div id="resultsSection" class="hidden">
            
            <!-- Filters -->
            <div class="filter-bar">
                <span class="filter-title">üõ°Ô∏è Filtri:</span>
                <label>
                    <input type="checkbox" id="filterScam" checked onchange="renderResults()">
                    Nascondi scam
                </label>
                <label>
                    <input type="checkbox" id="filterDust" onchange="renderResults()">
                    Nascondi &lt; $1
                </label>
                <label>
                    <input type="checkbox" id="filterHidden" checked onchange="renderResults()">
                    Nascondi manuali
                </label>
                <div style="margin-left:auto;font-size:11px;color:#888;">
                    <span id="filterStats">0 token nascosti</span>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <h2>üìä Riepilogo Totale</h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-ai btn-small" onclick="analyzeWithAI()">ü§ñ Analisi AI</button>
                        <button class="btn btn-warning btn-small" onclick="exportCSV()">üì• CSV</button>
                        <button class="btn btn-info btn-small" onclick="exportCSVFiscale()">üìã CSV Fiscale</button>
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="label">Wallet</div>
                        <div class="value" id="totalWallets">0</div>
                    </div>
                    <div class="summary-box">
                        <div class="label">Token</div>
                        <div class="value" id="totalTokens">0</div>
                    </div>
                    <div class="summary-box">
                        <div class="label">Chain</div>
                        <div class="value" id="totalChains">0</div>
                    </div>
                    <div class="summary-box">
                        <div class="label">Valore USD</div>
                        <div class="value" style="color:#00ff88;" id="totalValue">$0</div>
                    </div>
                    <div class="summary-box">
                        <div class="label">Valore EUR</div>
                        <div class="value" style="color:#fbbf24;" id="totalValueEur">‚Ç¨0</div>
                        <div class="sub" id="rateUsed">@0.92</div>
                    </div>
                </div>
                <div class="price-info" id="priceInfo">Prezzi: --</div>
            </div>
            
            <!-- Wallets -->
            <div id="walletsContainer"></div>
            
            <!-- Fiscal -->
            <div class="fiscal-summary">
                <h3>üáÆüáπ Riepilogo Fiscale Italia <span id="fiscalYear" style="font-size:14px;opacity:0.7;">(Anno 2024)</span></h3>
                <div class="fiscal-grid">
                    <div class="fiscal-box">
                        <div class="title">üìã QUADRO RW</div>
                        <div class="amount" id="rwValue">‚Ç¨0,00</div>
                        <div class="note">Valore al <span id="rwDate">31/12/2024</span></div>
                    </div>
                    <div class="fiscal-box">
                        <div class="title">üí∏ IVAFE (0,2%)</div>
                        <div class="amount" id="ivafe">‚Ç¨0,00</div>
                        <div class="note">Codice F24: 4043</div>
                    </div>
                    <div class="fiscal-box">
                        <div class="title">üìà QUADRO RT</div>
                        <div class="amount">Serve storico</div>
                        <div class="note">26% plusvalenze</div>
                    </div>
                </div>
            </div>
            
            <!-- AI -->
            <div id="aiSection" class="ai-section hidden">
                <h3>ü§ñ Analisi AI</h3>
                <div id="aiResponse" class="ai-response"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>Crypto Wallet Analyzer v7.0 - EUR/USD Live ‚Ä¢ Export JSON ‚Ä¢ CSV Fiscale</p>
        </div>
    </div>
    
    <script>
        let wallets = [];
        let prices = {};
        let hiddenTokens = JSON.parse(localStorage.getItem('hidden_tokens_v7') || '[]');
        let EUR_USD = 0.92; // Default, will be updated
        let lastScanDate = null;
        
        // Chain config
        const CHAINS = {
            'eth': { name: 'Ethereum', icon: 'üî∑', color: '#627eea' },
            'bsc': { name: 'BSC', icon: 'üü°', color: '#f3ba2f' },
            'polygon': { name: 'Polygon', icon: 'üü£', color: '#8247e5' },
            'arbitrum': { name: 'Arbitrum', icon: 'üîµ', color: '#28a0f0' },
            'optimism': { name: 'Optimism', icon: 'üî¥', color: '#ff0420' },
            'avalanche': { name: 'Avalanche', icon: 'üî∫', color: '#e84142' },
            'base': { name: 'Base', icon: 'üîµ', color: '#0052ff' },
            'pulse': { name: 'PulseChain', icon: 'üíú', color: '#9b59b6' }
        };
        
        // CoinGecko IDs
        const COINGECKO_IDS = {
            'ETH': 'ethereum', 'BNB': 'binancecoin', 'MATIC': 'matic-network',
            'AVAX': 'avalanche-2', 'FTM': 'fantom', 'SHIB': 'shiba-inu',
            'BONE': 'bone-shibaswap', 'USDT': 'tether', 'USDC': 'usd-coin',
            'DAI': 'dai', 'CAKE': 'pancakeswap-token', 'PLS': 'pulsechain',
            'PLSX': 'pulsex', 'HEX': 'hex', 'INC': 'incentive',
            'DOGE': 'dogecoin', 'PEPE': 'pepe', 'FLOKI': 'floki',
            'UNI': 'uniswap', 'AAVE': 'aave', 'LINK': 'chainlink',
            'ARB': 'arbitrum', 'OP': 'optimism', 'SOL': 'solana',
            'WBTC': 'wrapped-bitcoin', 'WETH': 'weth'
        };
        
        // Token logos
        const TOKEN_LOGOS = {
            'ETH': 'https://assets.coingecko.com/coins/images/279/small/ethereum.png',
            'BNB': 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',
            'MATIC': 'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png',
            'AVAX': 'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',
            'SHIB': 'https://assets.coingecko.com/coins/images/11939/small/shiba.png',
            'BONE': 'https://assets.coingecko.com/coins/images/16916/small/bone_icon.png',
            'USDT': 'https://assets.coingecko.com/coins/images/325/small/Tether.png',
            'USDC': 'https://assets.coingecko.com/coins/images/6319/small/usdc.png',
            'DAI': 'https://assets.coingecko.com/coins/images/9956/small/Badge_Dai.png',
            'CAKE': 'https://assets.coingecko.com/coins/images/12632/small/pancakeswap-cake-logo.png',
            'PLS': 'https://assets.coingecko.com/coins/images/25667/small/PLS_WLOGO.png',
            'PLSX': 'https://assets.coingecko.com/coins/images/29993/small/PLSX.png',
            'HEX': 'https://assets.coingecko.com/coins/images/10103/small/HEX-logo.png',
            'INC': 'https://assets.coingecko.com/coins/images/30298/small/INC.png',
            'DOGE': 'https://assets.coingecko.com/coins/images/5/small/dogecoin.png',
            'PEPE': 'https://assets.coingecko.com/coins/images/29850/small/pepe-token.jpeg',
            'FLOKI': 'https://assets.coingecko.com/coins/images/16746/small/PNG_image.png',
            'UNI': 'https://assets.coingecko.com/coins/images/12504/small/uniswap-logo.png',
            'AAVE': 'https://assets.coingecko.com/coins/images/12645/small/AAVE.png',
            'LINK': 'https://assets.coingecko.com/coins/images/877/small/chainlink-new-logo.png',
            'ARB': 'https://assets.coingecko.com/coins/images/16547/small/photo_2023-03-29_21.47.00.jpeg',
            'OP': 'https://assets.coingecko.com/coins/images/25244/small/Optimism.png',
            'LEASH': 'https://assets.coingecko.com/coins/images/15802/small/leash.png'
        };
        
        function getTokenLogo(symbol) {
            return TOKEN_LOGOS[symbol.toUpperCase()] || '';
        }
        
        // Scam patterns
        const SCAM_PATTERNS = [
            /airdrop/i, /claim/i, /\.com$/i, /\.io$/i, /\.org$/i, /\.net$/i,
            /reward/i, /bonus/i, /gift/i, /visit/i, /http/i, /www\./i,
            /free.*token/i, /token.*free/i
        ];
        
        // ==================== EUR/USD RATE ====================
        async function fetchEurUsdRate() {
            document.getElementById('rateDisplay').textContent = 'EUR/USD: caricamento...';
            
            try {
                // Try exchangerate-api (free, no key needed)
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (res.ok) {
                    const data = await res.json();
                    EUR_USD = data.rates.EUR;
                    localStorage.setItem('eur_usd_rate', EUR_USD);
                    localStorage.setItem('eur_usd_date', new Date().toISOString());
                    document.getElementById('rateDisplay').textContent = `EUR/USD: ${EUR_USD.toFixed(4)} (live)`;
                    document.getElementById('rateUsed').textContent = `@${EUR_USD.toFixed(4)}`;
                    return;
                }
            } catch (e) {
                console.error('Exchange rate error:', e);
            }
            
            // Fallback to cached or default
            const cached = localStorage.getItem('eur_usd_rate');
            if (cached) {
                EUR_USD = parseFloat(cached);
                document.getElementById('rateDisplay').textContent = `EUR/USD: ${EUR_USD.toFixed(4)} (cache)`;
            } else {
                document.getElementById('rateDisplay').textContent = `EUR/USD: ${EUR_USD.toFixed(4)} (default)`;
            }
            document.getElementById('rateUsed').textContent = `@${EUR_USD.toFixed(4)}`;
        }
        
        // ==================== BACKUP/RESTORE ====================
        function exportJSON() {
            const data = {
                version: '7.0',
                exportDate: new Date().toISOString(),
                fiscalDate: document.getElementById('fiscalDate').value,
                eurUsdRate: EUR_USD,
                wallets: wallets,
                hiddenTokens: hiddenTokens,
                lastScanDate: lastScanDate
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `crypto_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('‚úÖ Backup esportato con successo!');
        }
        
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.wallets) {
                        wallets = data.wallets;
                        saveWallets();
                    }
                    if (data.hiddenTokens) {
                        hiddenTokens = data.hiddenTokens;
                        localStorage.setItem('hidden_tokens_v7', JSON.stringify(hiddenTokens));
                    }
                    if (data.fiscalDate) {
                        document.getElementById('fiscalDate').value = data.fiscalDate;
                    }
                    if (data.eurUsdRate) {
                        EUR_USD = data.eurUsdRate;
                        document.getElementById('rateDisplay').textContent = `EUR/USD: ${EUR_USD.toFixed(4)} (importato)`;
                        document.getElementById('rateUsed').textContent = `@${EUR_USD.toFixed(4)}`;
                    }
                    if (data.lastScanDate) {
                        lastScanDate = data.lastScanDate;
                    }
                    
                    renderWalletsPreview();
                    
                    if (wallets.some(w => w.tokens && w.tokens.length > 0)) {
                        document.getElementById('resultsSection').classList.remove('hidden');
                        renderResults();
                    }
                    
                    alert(`‚úÖ Importati ${wallets.length} wallet con successo!`);
                } catch (err) {
                    alert('‚ùå Errore nel file JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }
        
        // ==================== API MANAGEMENT ====================
        function saveMoralisKey() {
            const key = document.getElementById('moralisKey').value.trim();
            if (key) {
                localStorage.setItem('moralis_key', key);
                document.getElementById('moralisKey').value = '';
                updateApiStatus();
            }
        }
        
        function clearMoralisKey() {
            localStorage.removeItem('moralis_key');
            updateApiStatus();
            alert('Moralis API rimossa!');
        }
        
        function saveClaudeKey() {
            const key = document.getElementById('claudeKey').value.trim();
            if (key.startsWith('sk-ant-')) {
                localStorage.setItem('claude_key', key);
                document.getElementById('claudeKey').value = '';
                updateApiStatus();
            }
        }
        
        function updateApiStatus() {
            const moralis = localStorage.getItem('moralis_key');
            const claude = localStorage.getItem('claude_key');
            document.getElementById('moralisStatus').className = moralis ? 'api-status on' : 'api-status off';
            document.getElementById('moralisStatus').textContent = moralis ? 'ON' : 'OFF';
            document.getElementById('claudeStatus').className = claude ? 'api-status on' : 'api-status off';
            document.getElementById('claudeStatus').textContent = claude ? 'ON' : 'OFF';
        }
        
        // ==================== WALLET MANAGEMENT ====================
        function addWallet() {
            const addressInput = document.getElementById('walletInput');
            const nameInput = document.getElementById('walletName');
            const address = addressInput.value.trim().toLowerCase();
            const name = nameInput.value.trim() || `Wallet ${wallets.length + 1}`;
            
            if (!address || !address.startsWith('0x') || address.length !== 42) {
                alert('Indirizzo non valido');
                return;
            }
            
            if (wallets.find(w => w.address === address)) {
                alert('Wallet gi√† aggiunto');
                return;
            }
            
            wallets.push({ address, name, tokens: [], totalUSD: 0 });
            addressInput.value = '';
            nameInput.value = '';
            saveWallets();
            renderWalletsPreview();
        }
        
        function removeWallet(address) {
            wallets = wallets.filter(w => w.address !== address);
            saveWallets();
            renderWalletsPreview();
            if (wallets.length === 0) {
                document.getElementById('resultsSection').classList.add('hidden');
            }
        }
        
        function updateWalletName(address, newName) {
            const wallet = wallets.find(w => w.address === address);
            if (wallet) {
                wallet.name = newName || 'Wallet';
                saveWallets();
            }
        }
        
        function clearAllWallets() {
            if (confirm('Cancellare tutti i wallet?')) {
                wallets = [];
                saveWallets();
                document.getElementById('resultsSection').classList.add('hidden');
                renderWalletsPreview();
            }
        }
        
        function saveWallets() {
            localStorage.setItem('crypto_wallets_v7', JSON.stringify(wallets));
        }
        
        function loadWallets() {
            // Try v7 first, then migrate from v6
            let saved = localStorage.getItem('crypto_wallets_v7');
            if (!saved) {
                saved = localStorage.getItem('crypto_wallets_v6');
                if (saved) {
                    // Migrate hidden tokens too
                    const oldHidden = localStorage.getItem('hidden_tokens_v6');
                    if (oldHidden) {
                        localStorage.setItem('hidden_tokens_v7', oldHidden);
                        hiddenTokens = JSON.parse(oldHidden);
                    }
                }
            }
            if (saved) wallets = JSON.parse(saved);
        }
        
        function renderWalletsPreview() {
            if (wallets.length === 0) {
                document.getElementById('walletsPreview').classList.add('hidden');
                return;
            }
            
            document.getElementById('walletsPreview').classList.remove('hidden');
            document.getElementById('walletsPreviewList').innerHTML = wallets.map(w => `
                <div class="wallet-preview-item">
                    <div class="wallet-preview-left">
                        <div class="wallet-preview-icon">üíº</div>
                        <div>
                            <div class="wallet-preview-name">${w.name}</div>
                            <div class="wallet-preview-address">${w.address.slice(0,10)}...${w.address.slice(-6)}</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;">
                        ${w.tokens.length > 0 
                            ? `<span style="color:#00ff88;font-weight:600;">$${w.totalUSD.toLocaleString('en-US', {minimumFractionDigits:2})}</span>` 
                            : `<span class="wallet-preview-status">‚è≥ Pronto</span>`}
                        <button class="wallet-preview-remove" onclick="removeWallet('${w.address}')">‚úï</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ==================== PRICES ====================
        async function fetchPrices() {
            const ids = Object.values(COINGECKO_IDS).join(',');
            try {
                const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
                const data = await res.json();
                for (const [symbol, id] of Object.entries(COINGECKO_IDS)) {
                    if (data[id]) prices[symbol] = data[id].usd;
                }
                document.getElementById('priceInfo').textContent = `Prezzi aggiornati: ${new Date().toLocaleTimeString('it-IT')}`;
            } catch (e) {
                console.error('CoinGecko error:', e);
            }
        }
        
        // ==================== SCAM & HIDE ====================
        function isScam(token) {
            const name = (token.name || '').toLowerCase();
            const symbol = (token.symbol || '').toLowerCase();
            
            for (const pattern of SCAM_PATTERNS) {
                if (pattern.test(symbol) || pattern.test(name)) return true;
            }
            if (name.length > 40) return true;
            if (/[\/\\<>]/.test(name)) return true;
            
            return false;
        }
        
        function hideTokenKeepOpen(chain, address, symbol, name, walletIdx, chainIdx) {
            const contractId = `contract:${address.toLowerCase()}`;
            const symbolId = `symbol:${symbol.toUpperCase()}`;
            const nameId = `name:${name.toLowerCase()}`;
            
            if (!hiddenTokens.includes(contractId)) hiddenTokens.push(contractId);
            if (!hiddenTokens.includes(symbolId)) hiddenTokens.push(symbolId);
            if (name && !hiddenTokens.includes(nameId)) hiddenTokens.push(nameId);
            
            localStorage.setItem('hidden_tokens_v7', JSON.stringify(hiddenTokens));
            
            const tokenEl = document.getElementById(`token-${chain}-${address}`);
            if (tokenEl) {
                tokenEl.style.transition = 'opacity 0.3s, transform 0.3s';
                tokenEl.style.opacity = '0';
                tokenEl.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    tokenEl.remove();
                    updateDashboardTotals();
                }, 300);
            }
        }
        
        function updateDashboardTotals() {
            let totalUSD = 0;
            let totalTokens = 0;
            const allChains = new Set();
            
            wallets.forEach(wallet => {
                wallet.tokens.forEach(token => {
                    if (!isHidden(token)) {
                        totalUSD += token.valueUSD || 0;
                        totalTokens++;
                        allChains.add(token.chain);
                    }
                });
            });
            
            document.getElementById('totalTokens').textContent = totalTokens;
            document.getElementById('totalChains').textContent = allChains.size;
            document.getElementById('totalValue').textContent = `$${totalUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            const eurValue = totalUSD * EUR_USD;
            document.getElementById('totalValueEur').textContent = `‚Ç¨${eurValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            document.getElementById('rwValue').textContent = `‚Ç¨${eurValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            document.getElementById('ivafe').textContent = `‚Ç¨${(eurValue * 0.002).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
        }
        
        function isHidden(token) {
            const contractId = `contract:${(token.contractAddress || '').toLowerCase()}`;
            const symbolId = `symbol:${(token.symbol || '').toUpperCase()}`;
            const nameId = `name:${(token.name || '').toLowerCase()}`;
            
            return hiddenTokens.includes(contractId) || 
                   hiddenTokens.includes(symbolId) || 
                   hiddenTokens.includes(nameId);
        }
        
        // ==================== MORALIS API ====================
        async function getMoralisBalances(address) {
            const moralisKey = localStorage.getItem('moralis_key');
            const tokens = [];
            
            if (!moralisKey) {
                console.log('No Moralis key, usando fallback');
                return await getFallbackBalances(address);
            }
            
            const chains = ['eth', 'bsc', 'polygon', 'arbitrum', 'base', 'optimism', 'avalanche'];
            
            for (const chain of chains) {
                try {
                    // Native balance
                    const nativeRes = await fetch(
                        `https://deep-index.moralis.io/api/v2.2/${address}/balance?chain=${chain}`,
                        { headers: { 'X-API-Key': moralisKey } }
                    );
                    
                    if (nativeRes.ok) {
                        const data = await nativeRes.json();
                        const balance = parseInt(data.balance) / 1e18;
                        if (balance > 0.0001) {
                            const symbol = chain === 'bsc' ? 'BNB' : chain === 'polygon' ? 'MATIC' : chain === 'avalanche' ? 'AVAX' : 'ETH';
                            tokens.push({
                                symbol, name: symbol, chain, balance,
                                price: prices[symbol] || 0,
                                valueUSD: balance * (prices[symbol] || 0),
                                logo: getTokenLogo(symbol), contractAddress: 'native'
                            });
                        }
                    }
                    
                    // ERC-20 tokens
                    const tokensRes = await fetch(
                        `https://deep-index.moralis.io/api/v2.2/${address}/erc20?chain=${chain}`,
                        { headers: { 'X-API-Key': moralisKey } }
                    );
                    
                    if (tokensRes.ok) {
                        const data = await tokensRes.json();
                        
                        for (const t of data) {
                            const balance = parseFloat(t.balance) / Math.pow(10, t.decimals || 18);
                            if (balance <= 0) continue;
                            
                            const symbol = (t.symbol || 'UNKNOWN').toUpperCase();
                            let price = prices[symbol] || 0;
                            
                            if (price === 0) {
                                try {
                                    const priceRes = await fetch(
                                        `https://deep-index.moralis.io/api/v2.2/erc20/${t.token_address}/price?chain=${chain}`,
                                        { headers: { 'X-API-Key': moralisKey } }
                                    );
                                    if (priceRes.ok) {
                                        const priceData = await priceRes.json();
                                        price = priceData.usdPrice || 0;
                                    }
                                } catch (e) {}
                            }
                            
                            tokens.push({
                                symbol, name: t.name || symbol, chain, balance, price,
                                valueUSD: balance * price,
                                logo: t.logo || t.thumbnail || getTokenLogo(symbol),
                                contractAddress: t.token_address
                            });
                        }
                    }
                    
                    await new Promise(r => setTimeout(r, 100));
                } catch (e) {
                    console.error(`${chain} error:`, e);
                }
            }
            
            // PulseChain
            const pulseTokens = await getPulseChainTokens(address);
            tokens.push(...pulseTokens);
            
            return tokens;
        }
        
        async function getPulseChainTokens(address) {
            const tokens = [];
            
            try {
                const res = await fetch('https://rpc.pulsechain.com', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0', method: 'eth_getBalance',
                        params: [address, 'latest'], id: 1
                    })
                });
                const data = await res.json();
                if (data.result) {
                    const balance = parseInt(data.result, 16) / 1e18;
                    if (balance > 0) {
                        const price = prices['PLS'] || 0;
                        tokens.push({
                            symbol: 'PLS', name: 'PulseChain', chain: 'pulse',
                            balance, price, valueUSD: balance * price,
                            logo: getTokenLogo('PLS'), contractAddress: 'native'
                        });
                    }
                }
                
                const pulseTokensList = [
                    { address: '0x95B303987A60C71504D99Aa1b13B4DA07b0790ab', symbol: 'PLSX', name: 'PulseX', decimals: 18 },
                    { address: '0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39', symbol: 'HEX', name: 'HEX', decimals: 8 },
                    { address: '0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d', symbol: 'INC', name: 'Incentive', decimals: 18 }
                ];
                
                const balanceOfData = '0x70a08231000000000000000000000000' + address.slice(2);
                
                for (const t of pulseTokensList) {
                    try {
                        const res = await fetch('https://rpc.pulsechain.com', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                jsonrpc: '2.0', method: 'eth_call',
                                params: [{ to: t.address, data: balanceOfData }, 'latest'], id: 1
                            })
                        });
                        const result = await res.json();
                        if (result.result && result.result !== '0x' && result.result !== '0x0') {
                            const balance = parseInt(result.result, 16) / Math.pow(10, t.decimals);
                            if (balance > 0) {
                                const price = prices[t.symbol] || 0;
                                tokens.push({
                                    symbol: t.symbol, name: t.name, chain: 'pulse',
                                    balance, price, valueUSD: balance * price,
                                    logo: getTokenLogo(t.symbol), contractAddress: t.address
                                });
                            }
                        }
                    } catch (e) {}
                }
            } catch (e) {
                console.error('PulseChain error:', e);
            }
            
            return tokens;
        }
        
        async function getFallbackBalances(address) {
            const tokens = [];
            const rpcs = {
                eth: 'https://eth.llamarpc.com',
                bsc: 'https://bsc-dataseed.binance.org',
                polygon: 'https://polygon-rpc.com',
                base: 'https://mainnet.base.org',
                pulse: 'https://rpc.pulsechain.com'
            };
            
            const nativeSymbols = {
                eth: 'ETH', bsc: 'BNB', polygon: 'MATIC', base: 'ETH', pulse: 'PLS'
            };
            
            for (const [chain, rpc] of Object.entries(rpcs)) {
                try {
                    const res = await fetch(rpc, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0', method: 'eth_getBalance',
                            params: [address, 'latest'], id: 1
                        })
                    });
                    const data = await res.json();
                    if (data.result) {
                        const balance = parseInt(data.result, 16) / 1e18;
                        if (balance > 0.0001) {
                            const symbol = nativeSymbols[chain];
                            tokens.push({
                                symbol, name: CHAINS[chain]?.name || chain, chain, balance,
                                price: prices[symbol] || 0,
                                valueUSD: balance * (prices[symbol] || 0),
                                logo: getTokenLogo(symbol), contractAddress: 'native'
                            });
                        }
                    }
                } catch (e) {}
            }
            
            const pulseTokens = await getPulseChainTokens(address);
            tokens.push(...pulseTokens);
            
            return tokens;
        }
        
        // ==================== SCAN ====================
        async function scanAllWallets() {
            if (wallets.length === 0) {
                const input = document.getElementById('walletInput').value.trim().toLowerCase();
                if (input && input.startsWith('0x') && input.length === 42) {
                    wallets.push({
                        address: input,
                        name: document.getElementById('walletName').value.trim() || 'Wallet 1',
                        tokens: [], totalUSD: 0
                    });
                    document.getElementById('walletInput').value = '';
                    document.getElementById('walletName').value = '';
                    saveWallets();
                } else {
                    alert('Aggiungi almeno un wallet');
                    return;
                }
            }
            
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            
            document.getElementById('loadingText').textContent = 'Caricamento tasso EUR/USD...';
            await fetchEurUsdRate();
            
            document.getElementById('loadingText').textContent = 'Caricamento prezzi...';
            await fetchPrices();
            
            for (let i = 0; i < wallets.length; i++) {
                const wallet = wallets[i];
                document.getElementById('loadingText').textContent = `Scansione ${i + 1}/${wallets.length}: ${wallet.name}...`;
                
                wallet.tokens = await getMoralisBalances(wallet.address);
                wallet.totalUSD = wallet.tokens.reduce((s, t) => s + (t.valueUSD || 0), 0);
                
                await new Promise(r => setTimeout(r, 200));
            }
            
            lastScanDate = new Date().toISOString();
            saveWallets();
            
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            updateFiscalDisplay();
            renderResults();
        }
        
        function updateFiscalDisplay() {
            const fiscalDate = document.getElementById('fiscalDate').value;
            const year = fiscalDate.split('-')[0];
            const dateFormatted = fiscalDate.split('-').reverse().join('/');
            
            document.getElementById('fiscalYear').textContent = `(Anno ${year})`;
            document.getElementById('rwDate').textContent = dateFormatted;
        }
        
        // ==================== RENDER ====================
        function renderResults() {
            const filterScam = document.getElementById('filterScam')?.checked ?? true;
            const filterDust = document.getElementById('filterDust')?.checked ?? true;
            const filterHiddenCheck = document.getElementById('filterHidden')?.checked ?? true;
            
            let totalUSD = 0;
            let totalTokens = 0;
            let hiddenCount = 0;
            const allChains = new Set();
            
            wallets.forEach(wallet => {
                wallet._filteredTokens = wallet.tokens.filter(token => {
                    const tokenIsScam = isScam(token);
                    const tokenIsHidden = isHidden(token);
                    const tokenIsDust = (token.valueUSD || 0) < 1;
                    
                    token._isScam = tokenIsScam;
                    token._isHidden = tokenIsHidden;
                    token._isDust = tokenIsDust;
                    
                    let show = true;
                    
                    if (filterScam && tokenIsScam) show = false;
                    if (show && filterDust && tokenIsDust) show = false;
                    if (show && filterHiddenCheck && tokenIsHidden) show = false;
                    
                    if (!show) hiddenCount++;
                    
                    if (show) {
                        totalUSD += token.valueUSD || 0;
                        totalTokens++;
                        allChains.add(token.chain);
                    }
                    
                    return show;
                });
                
                wallet._filteredUSD = wallet._filteredTokens.reduce((s, t) => s + (t.valueUSD || 0), 0);
            });
            
            // Summary
            document.getElementById('totalWallets').textContent = wallets.length;
            document.getElementById('totalTokens').textContent = totalTokens;
            document.getElementById('totalChains').textContent = allChains.size;
            document.getElementById('totalValue').textContent = `$${totalUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('filterStats').textContent = `${hiddenCount} nascosti`;
            
            // EUR values
            const eurValue = totalUSD * EUR_USD;
            document.getElementById('totalValueEur').textContent = `‚Ç¨${eurValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            document.getElementById('rateUsed').textContent = `@${EUR_USD.toFixed(4)}`;
            document.getElementById('rwValue').textContent = `‚Ç¨${eurValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            document.getElementById('ivafe').textContent = `‚Ç¨${(eurValue * 0.002).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            
            // Wallets container
            const container = document.getElementById('walletsContainer');
            container.innerHTML = wallets.map((wallet, wIdx) => {
                const chainGroups = {};
                wallet._filteredTokens.forEach(token => {
                    if (!chainGroups[token.chain]) chainGroups[token.chain] = [];
                    chainGroups[token.chain].push(token);
                });
                
                const sortedChains = Object.entries(chainGroups)
                    .map(([chain, tokens]) => ({
                        chain,
                        tokens: tokens.sort((a, b) => (b.valueUSD || 0) - (a.valueUSD || 0)),
                        totalUSD: tokens.reduce((s, t) => s + (t.valueUSD || 0), 0)
                    }))
                    .sort((a, b) => b.totalUSD - a.totalUSD);
                
                return `
                    <div class="wallet-card">
                        <div class="wallet-header" onclick="toggleWallet(${wIdx})">
                            <div class="wallet-left">
                                <div class="wallet-icon">üíº</div>
                                <div>
                                    <input type="text" class="wallet-name" value="${wallet.name}"
                                        onclick="event.stopPropagation()"
                                        onchange="updateWalletName('${wallet.address}', this.value)">
                                    <div class="wallet-address">${wallet.address.slice(0, 8)}...${wallet.address.slice(-6)}</div>
                                </div>
                            </div>
                            <div class="wallet-right">
                                <div>
                                    <div class="wallet-value">$${wallet._filteredUSD.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                                    <div class="wallet-tokens">${wallet._filteredTokens.length} token ‚Ä¢ ${sortedChains.length} chain</div>
                                </div>
                                <div class="wallet-toggle" id="wallet-toggle-${wIdx}">‚ñº</div>
                            </div>
                        </div>
                        <div class="wallet-content" id="wallet-content-${wIdx}">
                            ${sortedChains.map((chainData, cIdx) => {
                                const chainInfo = CHAINS[chainData.chain] || { name: chainData.chain, icon: 'üîó' };
                                return `
                                    <div class="chain-section">
                                        <div class="chain-header" onclick="toggleChain(${wIdx}, ${cIdx})">
                                            <div class="chain-left">
                                                <div class="chain-icon">${chainInfo.icon}</div>
                                                <div class="chain-name">${chainInfo.name}</div>
                                                <div class="chain-count">(${chainData.tokens.length} token)</div>
                                            </div>
                                            <div style="display:flex;align-items:center;">
                                                <div class="chain-value">$${chainData.totalUSD.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                                                <div class="chain-toggle" id="chain-toggle-${wIdx}-${cIdx}">‚ñº</div>
                                            </div>
                                        </div>
                                        <div class="chain-content" id="chain-content-${wIdx}-${cIdx}">
                                            <div class="token-list">
                                                ${chainData.tokens.map(token => `
                                                    <div class="token-item ${token._isScam ? 'scam' : ''}" id="token-${token.chain}-${token.contractAddress}">
                                                        <div class="token-left">
                                                            <button class="hide-btn" onclick="event.stopPropagation(); hideTokenKeepOpen('${token.chain}', '${token.contractAddress}', '${token.symbol}', '${(token.name || '').replace(/'/g, "\\'")}', ${wIdx}, ${cIdx})" title="Elimina per sempre">üóëÔ∏è</button>
                                                            ${token.logo 
                                                                ? `<img src="${token.logo}" class="token-logo" onerror="this.style.display='none'">`
                                                                : `<div class="token-logo">${token.symbol.slice(0, 3)}</div>`}
                                                            <div>
                                                                <div class="token-symbol">
                                                                    ${token.symbol}
                                                                    ${token._isScam ? '<span class="token-badge scam">‚ö†Ô∏è SCAM</span>' : ''}
                                                                </div>
                                                                <div class="token-name">${token.name}</div>
                                                            </div>
                                                        </div>
                                                        <div style="display:flex;align-items:center;gap:15px;">
                                                            <div style="text-align:right;">
                                                                <div class="token-balance">${formatBalance(token.balance)}</div>
                                                                <div class="token-price">@$${(token.price || 0).toFixed(6)}</div>
                                                            </div>
                                                            <div class="token-value">$${(token.valueUSD || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleWallet(idx) {
            const content = document.getElementById(`wallet-content-${idx}`);
            const toggle = document.getElementById(`wallet-toggle-${idx}`);
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }
        
        function toggleChain(wIdx, cIdx) {
            const content = document.getElementById(`chain-content-${wIdx}-${cIdx}`);
            const toggle = document.getElementById(`chain-toggle-${wIdx}-${cIdx}`);
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }
        
        function formatBalance(balance) {
            if (!balance) return '0';
            if (balance >= 1e12) return (balance / 1e12).toFixed(2) + 'T';
            if (balance >= 1e9) return (balance / 1e9).toFixed(2) + 'B';
            if (balance >= 1e6) return (balance / 1e6).toFixed(2) + 'M';
            if (balance >= 1e3) return (balance / 1e3).toFixed(2) + 'K';
            if (balance >= 1) return balance.toFixed(4);
            return balance.toFixed(8);
        }
        
        // ==================== EXPORT CSV ====================
        function exportCSV() {
            const fiscalDate = document.getElementById('fiscalDate').value;
            let csv = 'Wallet,Chain,Token,Name,Balance,Price USD,Value USD,Value EUR,Rate EUR/USD,Data\n';
            wallets.forEach(w => {
                (w._filteredTokens || w.tokens).forEach(t => {
                    const valueEur = (t.valueUSD || 0) * EUR_USD;
                    csv += `"${w.name}","${t.chain}","${t.symbol}","${t.name}",${t.balance},${t.price},${t.valueUSD},${valueEur.toFixed(2)},${EUR_USD},${fiscalDate}\n`;
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `crypto_${fiscalDate}.csv`;
            link.click();
        }
        
        function exportCSVFiscale() {
            const fiscalDate = document.getElementById('fiscalDate').value;
            const year = fiscalDate.split('-')[0];
            
            let totalUSD = 0;
            let totalEUR = 0;
            
            let csv = `RIEPILOGO FISCALE CRYPTO - ANNO ${year}\n`;
            csv += `Data riferimento: ${fiscalDate.split('-').reverse().join('/')}\n`;
            csv += `Tasso EUR/USD: ${EUR_USD.toFixed(4)}\n\n`;
            csv += 'Wallet,Indirizzo,Valore USD,Valore EUR\n';
            
            wallets.forEach(w => {
                const usd = w._filteredUSD || w.totalUSD;
                const eur = usd * EUR_USD;
                totalUSD += usd;
                totalEUR += eur;
                csv += `"${w.name}","${w.address}",${usd.toFixed(2)},${eur.toFixed(2)}\n`;
            });
            
            csv += `\nTOTALE,,${totalUSD.toFixed(2)},${totalEUR.toFixed(2)}\n`;
            csv += `\nQUADRO RW: ‚Ç¨${totalEUR.toFixed(2)}\n`;
            csv += `IVAFE (0.2%): ‚Ç¨${(totalEUR * 0.002).toFixed(2)}\n`;
            csv += `Codice F24: 4043\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `crypto_fiscale_${year}.csv`;
            link.click();
        }
        
        // ==================== AI ====================
        async function analyzeWithAI() {
            const apiKey = localStorage.getItem('claude_key');
            const aiSection = document.getElementById('aiSection');
            const aiResponse = document.getElementById('aiResponse');
            
            aiSection.classList.remove('hidden');
            aiResponse.innerHTML = '<div class="loading"><div class="loading-spinner"></div> Analisi AI...</div>';
            
            const totalUSD = wallets.reduce((s, w) => s + (w._filteredUSD || w.totalUSD), 0);
            const fiscalDate = document.getElementById('fiscalDate').value;
            
            const summary = {
                dataRiferimento: fiscalDate,
                tassoEurUsd: EUR_USD,
                wallets: wallets.map(w => ({
                    name: w.name,
                    totalUSD: w._filteredUSD || w.totalUSD,
                    tokens: (w._filteredTokens || w.tokens)
                        .sort((a, b) => b.valueUSD - a.valueUSD)
                        .slice(0, 5)
                        .map(t => ({ symbol: t.symbol, chain: t.chain, valueUSD: t.valueUSD }))
                })),
                totalUSD,
                totalEUR: totalUSD * EUR_USD,
                ivafe: totalUSD * EUR_USD * 0.002
            };
            
            if (apiKey) {
                try {
                    const res = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2500,
                            messages: [{
                                role: 'user',
                                content: `Analizza portafoglio crypto per fiscalit√† italiana:\n\n${JSON.stringify(summary, null, 2)}\n\nFornisci:\n1. üìä RIEPILOGO\n2. üáÆüáπ FISCALE: RW, IVAFE, RT\n3. ‚ö†Ô∏è RISCHI\n4. ‚úÖ AZIONI\n\nItaliano, conciso.`
                            }]
                        })
                    });
                    const data = await res.json();
                    aiResponse.innerHTML = data.content[0].text;
                } catch (e) {
                    aiResponse.innerHTML = '‚ùå Errore: ' + e.message;
                }
            } else {
                const eurValue = totalUSD * EUR_USD;
                aiResponse.innerHTML = `üìä RIEPILOGO:
‚Ä¢ ${wallets.length} wallet analizzati
‚Ä¢ $${totalUSD.toFixed(2)} (~‚Ç¨${eurValue.toFixed(2)})
‚Ä¢ Tasso EUR/USD: ${EUR_USD.toFixed(4)}

üáÆüáπ FISCALE:
‚Ä¢ Quadro RW: ‚Ç¨${eurValue.toFixed(2)}
‚Ä¢ IVAFE (0,2%): ‚Ç¨${(eurValue * 0.002).toFixed(2)}
‚Ä¢ Codice F24: 4043

‚ö†Ô∏è Inserisci Claude API per analisi completa`;
            }
        }
        
        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            updateApiStatus();
            loadWallets();
            renderWalletsPreview();
            fetchEurUsdRate();
            updateFiscalDisplay();
            
            const hasScannedTokens = wallets.some(w => w.tokens && w.tokens.length > 0);
            if (hasScannedTokens) {
                document.getElementById('resultsSection').classList.remove('hidden');
                renderResults();
            }
        });
        
        document.getElementById('walletInput')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') addWallet();
        });
        
        document.getElementById('fiscalDate')?.addEventListener('change', updateFiscalDisplay);
    </script>
</body>
</html>
