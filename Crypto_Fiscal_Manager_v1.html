<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Fiscal Manager v1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDAmtceQc0m-KQC7xGmu0IH1cR4tnI8oCQ",
            authDomain: "moreno-crypto-tools.firebaseapp.com",
            projectId: "moreno-crypto-tools",
            storageBucket: "moreno-crypto-tools.firebasestorage.app",
            messagingSenderId: "875997322481",
            appId: "1:875997322481:web:1a012bec2aff2cb5205d50"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'JetBrains Mono', monospace;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 1000;
        }
        .home-btn:hover { background: rgba(255,255,255,0.2); }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        .header h1 {
            font-size: 32px; font-weight: 700;
            background: linear-gradient(135deg, #f7931a, #627eea, #00d4aa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .header p { color: #888; font-size: 14px; }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 12px;
        }
        .tab {
            padding: 12px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab.active { background: rgba(0,255,136,0.2); border-color: #00ff88; color: #00ff88; }
        .tab .count {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .tab.active .count { background: rgba(0,255,136,0.3); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #000; }
        .btn-warning { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .btn-danger { background: linear-gradient(135deg, #ff4757, #ff6b81); color: #fff; }
        .btn-info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; }
        .btn-small { padding: 6px 12px; font-size: 11px; }
        
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #00ff88;
            background: rgba(0,255,136,0.05);
        }
        .drop-zone-icon { font-size: 48px; margin-bottom: 15px; }
        .drop-zone-text { color: #888; font-size: 14px; }
        .drop-zone-hint { color: #666; font-size: 12px; margin-top: 10px; }
        
        .file-input { display: none; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-label { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 20px; font-weight: 700; color: #00ff88; }
        .stat-value.warning { color: #fbbf24; }
        .stat-value.danger { color: #ff4757; }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .data-table th {
            text-align: left;
            padding: 12px 10px;
            background: rgba(0,0,0,0.3);
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            position: sticky;
            top: 0;
        }
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .data-table tr:hover { background: rgba(255,255,255,0.02); }
        .data-table .positive { color: #00ff88; }
        .data-table .negative { color: #ff4757; }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .fiscal-summary {
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 12px;
            padding: 20px;
        }
        .fiscal-summary h3 { color: #fbbf24; margin-bottom: 15px; font-size: 16px; }
        .fiscal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .fiscal-year {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
        }
        .fiscal-year-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: #fff; }
        .fiscal-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .fiscal-row:last-child { border-bottom: none; }
        .fiscal-row .label { color: #888; }
        .fiscal-row .value { font-weight: 600; }
        
        .exchange-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .exchange-logo.binance { background: #f3ba2f; }
        .exchange-logo.revolut { background: #0075eb; }
        .exchange-logo.bitpanda { background: #3e7bfa; }
        .exchange-logo.kucoin { background: #24ae8f; }
        .exchange-logo.mexc { background: #00b897; }
        .exchange-logo.crypto { background: #002d74; }
        .exchange-logo.coinbase { background: #0052ff; }
        .exchange-logo.wallet { background: linear-gradient(135deg, #627eea, #00d4aa); }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .empty-state-text { font-size: 14px; }
        
        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4aa);
            transition: width 0.3s;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .alert-success { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); color: #00ff88; }
        .alert-warning { background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); color: #fbbf24; }
        .alert-error { background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.3); color: #ff4757; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 12px;
        }
        .filter-bar select:focus, .filter-bar input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .badge-buy { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge-sell { background: rgba(255,71,87,0.2); color: #ff4757; }
        .badge-deposit { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .badge-withdraw { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .badge-fee { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .badge-reward { background: rgba(168,85,247,0.2); color: #a855f7; }
        .badge-transfer { background: rgba(236,72,153,0.2); color: #ec4899; }
        
        .api-status {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .api-status.on { background: rgba(0,255,136,0.2); color: #00ff88; }
        .api-status.off { background: rgba(255,71,87,0.2); color: #ff4757; }
        
        .hidden { display: none; }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #444;
            font-size: 11px;
        }
        
        /* Navigation Bar */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-logo {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #f7931a, #627eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-links {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .nav-link {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #888;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .nav-link.active {
            background: rgba(0,255,136,0.2);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        body { padding-top: 60px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <span class="nav-logo">ü™ô Crypto Tools</span>
        <div class="nav-links">
            <a href="index.html" class="nav-link">üè† Home</a>
            <a href="Crypto_Fiscal_Manager_v1.html" class="nav-link active">üìä Fiscal Manager</a>
            <a href="Crypto_Wallet_Analyzer_v8.html" class="nav-link">üîó Wallet Analyzer</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>üìä Crypto Fiscal Manager</h1>
            <p>Gestione Fiscale Multi-Exchange ‚Ä¢ Report Annuali ‚Ä¢ Quadro RW & RT</p>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">
                üìä Dashboard
            </button>
            <button class="tab" onclick="showTab('binance')" id="tab-binance">
                <span class="exchange-logo binance">B</span>
                Binance
                <span class="count" id="count-binance">0</span>
            </button>
            <button class="tab" onclick="showTab('revolut')" id="tab-revolut">
                <span class="exchange-logo revolut">R</span>
                Revolut
                <span class="count" id="count-revolut">0</span>
            </button>
            <button class="tab" onclick="showTab('bitpanda')" id="tab-bitpanda">
                <span class="exchange-logo bitpanda">B</span>
                Bitpanda
                <span class="count" id="count-bitpanda">0</span>
            </button>
            <button class="tab" onclick="showTab('kucoin')" id="tab-kucoin">
                <span class="exchange-logo kucoin">K</span>
                KuCoin
                <span class="count" id="count-kucoin">0</span>
            </button>
            <button class="tab" onclick="showTab('mexc')" id="tab-mexc">
                <span class="exchange-logo mexc">M</span>
                MEXC
                <span class="count" id="count-mexc">0</span>
            </button>
            <button class="tab" onclick="showTab('cryptocom')" id="tab-cryptocom">
                <span class="exchange-logo crypto">C</span>
                Crypto.com
                <span class="count" id="count-cryptocom">0</span>
            </button>
            <button class="tab" onclick="showTab('wallet')" id="tab-wallet">
                <span class="exchange-logo wallet">üîó</span>
                Wallet
                <span class="count" id="count-wallet">0</span>
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="content-dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Riepilogo Generale</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span id="syncStatus" style="font-size:11px;color:#888;">‚è≥ Connessione...</span>
                        <button class="btn btn-primary btn-small" onclick="forceSaveToFirebase()">üíæ Salva Ora</button>
                        <button class="btn btn-info btn-small" onclick="importAllData()">üìÇ Importa JSON</button>
                        <input type="file" id="importBackupFile" class="file-input" accept=".json" onchange="handleImportBackup(event)">
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Transazioni Totali</div>
                        <div class="stat-value" id="total-transactions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Exchange Attivi</div>
                        <div class="stat-value" id="total-exchanges">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Crypto Diverse</div>
                        <div class="stat-value" id="total-coins">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Volume Totale</div>
                        <div class="stat-value" id="total-volume">‚Ç¨0</div>
                    </div>
                </div>
            </div>
            
            <!-- Fiscal Summary by Year -->
            <div class="fiscal-summary">
                <h3>üáÆüáπ Riepilogo Fiscale per Anno</h3>
                <div class="fiscal-grid" id="fiscal-years-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">Importa i CSV degli exchange per vedere il riepilogo fiscale</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Binance Tab -->
        <div class="tab-content" id="content-binance">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo binance">B</span>
                        Binance
                    </div>
                    <div>
                        <button class="btn btn-danger btn-small" onclick="clearExchange('binance')">üóëÔ∏è Cancella</button>
                    </div>
                </div>
                
                <!-- Server Sync Section -->
                <div class="api-section" style="margin-bottom:20px;padding:20px;background:rgba(243,186,47,0.1);border:1px solid rgba(243,186,47,0.3);border-radius:12px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
                        <span style="font-weight:600;color:#f3ba2f;font-size:16px;">üîÑ Sincronizza con Binance</span>
                        <span id="serverStatus" style="font-size:11px;padding:4px 10px;border-radius:4px;background:rgba(255,71,87,0.2);color:#ff4757;">Server Offline</span>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                        <button class="btn" style="background:linear-gradient(135deg,#f3ba2f,#f7931a);color:#000;padding:12px 24px;font-size:14px;font-weight:700;" onclick="syncBinanceFromServer()">
                            üì° SINCRONIZZA DATI
                        </button>
                        <span id="syncStatus" style="font-size:12px;color:#888;"></span>
                    </div>
                    
                    <div style="margin-top:15px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:11px;color:#888;">
                        <strong style="color:#f3ba2f;">Come usare:</strong><br>
                        1. Avvia il server: doppio click su <code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">AVVIA_SERVER.command</code><br>
                        2. Clicca "Sincronizza Dati" qui sopra<br>
                        3. I dati vengono salvati su Firebase automaticamente
                    </div>
                </div>
                
                <!-- Binance Live Balances -->
                <div id="binanceLiveSection" class="hidden" style="margin-bottom:20px;">
                    <h4 style="color:#f3ba2f;margin-bottom:10px;">üí∞ Saldo Attuale Binance</h4>
                    <div class="stats-grid" id="binanceLiveStats">
                        <div class="stat-box">
                            <div class="stat-label">Spot</div>
                            <div class="stat-value" id="binance-spot-total">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Earn Flexible</div>
                            <div class="stat-value" id="binance-earn-total">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Staking Locked</div>
                            <div class="stat-value" id="binance-staking-total">‚Ç¨0</div>
                        </div>
                        <div class="stat-box" style="background:rgba(243,186,47,0.2);">
                            <div class="stat-label">TOTALE BINANCE</div>
                            <div class="stat-value" style="color:#f3ba2f;" id="binance-total-value">‚Ç¨0</div>
                        </div>
                    </div>
                    <div id="binanceTokensList" style="margin-top:15px;"></div>
                </div>
                
                <div class="drop-zone" id="dropzone-binance" onclick="document.getElementById('file-binance').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui i CSV di Binance</div>
                    <div class="drop-zone-hint">Puoi aggiungere pi√π file (uno per anno) ‚Ä¢ I duplicati vengono ignorati</div>
                </div>
                <input type="file" id="file-binance" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'binance')">
                
                <div id="binance-stats" class="hidden" style="margin-top:20px;">
                    <h4 style="color:#888;margin-bottom:10px;">üìú Storico Transazioni (da CSV)</h4>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Transazioni</div>
                            <div class="stat-value" id="binance-tx-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Depositi</div>
                            <div class="stat-value" id="binance-deposits">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Acquisti</div>
                            <div class="stat-value" id="binance-buys">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Vendite</div>
                            <div class="stat-value" id="binance-sells">0</div>
                        </div>
                    </div>
                    
                    <div class="filter-bar">
                        <select id="binance-year-filter" onchange="renderBinanceTable()">
                            <option value="all">Tutti gli anni</option>
                        </select>
                        <select id="binance-type-filter" onchange="renderBinanceTable()">
                            <option value="all">Tutte le operazioni</option>
                            <option value="buy">Acquisti</option>
                            <option value="sell">Vendite</option>
                            <option value="deposit">Depositi</option>
                            <option value="withdraw">Prelievi</option>
                        </select>
                        <input type="text" id="binance-coin-filter" placeholder="Cerca coin..." onkeyup="renderBinanceTable()">
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Operazione</th>
                                    <th>Coin</th>
                                    <th>Quantit√†</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody id="binance-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Revolut Tab -->
        <div class="tab-content" id="content-revolut">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo revolut">R</span>
                        Revolut
                    </div>
                    <div>
                        <button class="btn btn-danger btn-small" onclick="clearExchange('revolut')">üóëÔ∏è Cancella</button>
                    </div>
                </div>
                
                <div class="drop-zone" id="dropzone-revolut" onclick="document.getElementById('file-revolut').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui i CSV di Revolut</div>
                    <div class="drop-zone-hint">Puoi aggiungere pi√π file ‚Ä¢ I duplicati vengono ignorati</div>
                </div>
                <input type="file" id="file-revolut" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'revolut')">
                
                <div id="revolut-stats" class="hidden" style="margin-top:20px;">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Transazioni</div>
                            <div class="stat-value" id="revolut-tx-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Investito</div>
                            <div class="stat-value" id="revolut-invested">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Venduto</div>
                            <div class="stat-value" id="revolut-sold">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Fees</div>
                            <div class="stat-value warning" id="revolut-fees">‚Ç¨0</div>
                        </div>
                    </div>
                    
                    <div class="filter-bar">
                        <select id="revolut-year-filter" onchange="renderRevolutTable()">
                            <option value="all">Tutti gli anni</option>
                        </select>
                        <select id="revolut-type-filter" onchange="renderRevolutTable()">
                            <option value="all">Tutte le operazioni</option>
                            <option value="Acquisto">Acquisti</option>
                            <option value="Vendita">Vendite</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Coin</th>
                                    <th>Quantit√†</th>
                                    <th>Prezzo</th>
                                    <th>Valore</th>
                                    <th>Fees</th>
                                </tr>
                            </thead>
                            <tbody id="revolut-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bitpanda Tab -->
        <div class="tab-content" id="content-bitpanda">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo bitpanda">B</span>
                        Bitpanda
                    </div>
                    <div>
                        <button class="btn btn-danger btn-small" onclick="clearExchange('bitpanda')">üóëÔ∏è Cancella</button>
                    </div>
                </div>
                
                <div class="drop-zone" id="dropzone-bitpanda" onclick="document.getElementById('file-bitpanda').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui i CSV di Bitpanda</div>
                    <div class="drop-zone-hint">Puoi aggiungere pi√π file ‚Ä¢ I duplicati vengono ignorati</div>
                </div>
                <input type="file" id="file-bitpanda" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'bitpanda')">
                
                <div id="bitpanda-stats" class="hidden" style="margin-top:20px;">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Transazioni</div>
                            <div class="stat-value" id="bitpanda-tx-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Depositi</div>
                            <div class="stat-value" id="bitpanda-deposits">‚Ç¨0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Acquisti</div>
                            <div class="stat-value" id="bitpanda-buys">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Vendite</div>
                            <div class="stat-value" id="bitpanda-sells">0</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Asset</th>
                                    <th>Quantit√†</th>
                                    <th>Valore Fiat</th>
                                </tr>
                            </thead>
                            <tbody id="bitpanda-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KuCoin Tab -->
        <div class="tab-content" id="content-kucoin">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo kucoin">K</span>
                        KuCoin
                    </div>
                </div>
                <div class="drop-zone" id="dropzone-kucoin" onclick="document.getElementById('file-kucoin').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui il CSV di KuCoin</div>
                    <div class="drop-zone-hint">Assets ‚Üí History ‚Üí Export</div>
                </div>
                <input type="file" id="file-kucoin" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'kucoin')">
                <div id="kucoin-stats" class="hidden"></div>
            </div>
        </div>
        
        <!-- MEXC Tab -->
        <div class="tab-content" id="content-mexc">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo mexc">M</span>
                        MEXC
                    </div>
                </div>
                <div class="drop-zone" id="dropzone-mexc" onclick="document.getElementById('file-mexc').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui il CSV di MEXC</div>
                    <div class="drop-zone-hint">Assets ‚Üí Transaction History ‚Üí Export</div>
                </div>
                <input type="file" id="file-mexc" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'mexc')">
                <div id="mexc-stats" class="hidden"></div>
            </div>
        </div>
        
        <!-- Crypto.com Tab -->
        <div class="tab-content" id="content-cryptocom">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo crypto">C</span>
                        Crypto.com
                    </div>
                </div>
                <div class="drop-zone" id="dropzone-cryptocom" onclick="document.getElementById('file-cryptocom').click()">
                    <div class="drop-zone-icon">üìÅ</div>
                    <div class="drop-zone-text">Trascina qui il CSV di Crypto.com</div>
                    <div class="drop-zone-hint">Accounts ‚Üí Transaction History ‚Üí Export</div>
                </div>
                <input type="file" id="file-cryptocom" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'cryptocom')">
                <div id="cryptocom-stats" class="hidden"></div>
            </div>
        </div>
        
        <!-- Wallet Tab -->
        <div class="tab-content" id="content-wallet">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="exchange-logo wallet">üîó</span>
                        Wallet On-Chain
                    </div>
                    <div>
                        <a href="Crypto_Wallet_Analyzer_v8.html" class="btn btn-primary btn-small">üîó Apri Analyzer</a>
                    </div>
                </div>
                <div class="alert alert-warning">
                    Per i wallet on-chain, usa il <strong>Crypto Wallet Analyzer v8</strong> che scansiona automaticamente le blockchain.
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Crypto Fiscal Manager v1.0 ‚Ä¢ Multi-Exchange ‚Ä¢ Report Fiscali Italiani</p>
        </div>
    </div>
    
    <script>
        // ==================== DATA STORAGE ====================
        const exchangeData = {
            binance: [],
            revolut: [],
            bitpanda: [],
            kucoin: [],
            mexc: [],
            cryptocom: []
        };
        
        // ==================== TAB NAVIGATION ====================
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`)?.classList.add('active');
            document.getElementById(`content-${tabName}`)?.classList.add('active');
        }
        
        // ==================== FILE HANDLING ====================
        function handleFileUpload(event, exchange) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseCSV(content, exchange);
            };
            reader.readAsText(file);
        }
        
        // Setup drag & drop
        document.querySelectorAll('.drop-zone').forEach(zone => {
            const exchange = zone.id.replace('dropzone-', '');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => parseCSV(ev.target.result, exchange);
                    reader.readAsText(file);
                }
            });
        });
        
        // ==================== PARSERS ====================
        function parseCSV(content, exchange) {
            switch(exchange) {
                case 'binance': parseBinance(content); break;
                case 'revolut': parseRevolut(content); break;
                case 'bitpanda': parseBitpanda(content); break;
                default: alert('Parser non ancora implementato per ' + exchange);
            }
            saveData();
            updateDashboard();
        }
        
        // BINANCE PARSER - Accumula dati da pi√π CSV
        function parseBinance(content) {
            const lines = content.split('\n');
            const newData = [];
            let addedCount = 0;
            let duplicateCount = 0;
            
            // Crea un set di chiavi esistenti per evitare duplicati
            const existingKeys = new Set(
                exchangeData.binance.map(d => `${d.date}|${d.operation}|${d.coin}|${d.amount}`)
            );
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV with quotes
                const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if (!matches || matches.length < 6) continue;
                
                const clean = matches.map(m => m.replace(/^"|"$/g, '').trim());
                
                const [userId, utcTime, account, operation, coin, change, remark] = clean;
                
                if (!utcTime || !operation || !coin) continue;
                
                const entry = {
                    date: utcTime,
                    year: utcTime.split('-')[0],
                    account: account,
                    operation: operation,
                    coin: coin,
                    amount: parseFloat(change) || 0,
                    remark: remark || ''
                };
                
                // Controlla duplicati
                const key = `${entry.date}|${entry.operation}|${entry.coin}|${entry.amount}`;
                if (!existingKeys.has(key)) {
                    newData.push(entry);
                    existingKeys.add(key);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            }
            
            // AGGIUNGI ai dati esistenti invece di sovrascrivere
            exchangeData.binance = [...exchangeData.binance, ...newData];
            
            // Ordina per data
            exchangeData.binance.sort((a, b) => a.date.localeCompare(b.date));
            
            const data = exchangeData.binance;
            document.getElementById('count-binance').textContent = data.length;
            document.getElementById('binance-stats').classList.remove('hidden');
            // NON nascondere la drop zone - cos√¨ pu√≤ aggiungere altri file
            
            // Update stats
            const deposits = data.filter(d => d.operation === 'Deposit' && (d.coin === 'EUR' || d.coin === 'USD'));
            const buys = data.filter(d => d.operation === 'Buy' || d.operation.includes('Convert'));
            const sells = data.filter(d => d.operation === 'Sell');
            
            document.getElementById('binance-tx-count').textContent = data.length;
            document.getElementById('binance-deposits').textContent = '‚Ç¨' + deposits.reduce((s, d) => s + Math.abs(d.amount), 0).toFixed(0);
            document.getElementById('binance-buys').textContent = buys.length;
            document.getElementById('binance-sells').textContent = sells.length;
            
            // Populate year filter
            const years = [...new Set(data.map(d => d.year))].sort();
            const yearFilter = document.getElementById('binance-year-filter');
            yearFilter.innerHTML = '<option value="all">Tutti gli anni</option>';
            years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
            
            renderBinanceTable();
            
            // Mostra feedback
            showAlert('binance', `‚úÖ Aggiunte ${addedCount} transazioni (${duplicateCount} duplicati ignorati). Totale: ${data.length}`);
        }
        
        function renderBinanceTable() {
            const data = exchangeData.binance;
            const yearFilter = document.getElementById('binance-year-filter').value;
            const typeFilter = document.getElementById('binance-type-filter').value;
            const coinFilter = document.getElementById('binance-coin-filter').value.toUpperCase();
            
            let filtered = data;
            
            if (yearFilter !== 'all') {
                filtered = filtered.filter(d => d.year === yearFilter);
            }
            
            if (typeFilter !== 'all') {
                const typeMap = {
                    'buy': ['Buy', 'Transaction Buy', 'Binance Convert'],
                    'sell': ['Sell', 'Transaction Sell'],
                    'deposit': ['Deposit'],
                    'withdraw': ['Withdraw']
                };
                filtered = filtered.filter(d => typeMap[typeFilter]?.some(t => d.operation.includes(t)));
            }
            
            if (coinFilter) {
                filtered = filtered.filter(d => d.coin.includes(coinFilter));
            }
            
            const tbody = document.getElementById('binance-table-body');
            tbody.innerHTML = filtered.slice(0, 500).map(d => {
                const badgeClass = getBadgeClass(d.operation);
                const amountClass = d.amount >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${d.date}</td>
                        <td><span class="badge ${badgeClass}">${d.operation}</span></td>
                        <td>${d.coin}</td>
                        <td class="${amountClass}">${d.amount >= 0 ? '+' : ''}${d.amount.toFixed(8)}</td>
                        <td style="color:#666;font-size:10px;">${d.remark}</td>
                    </tr>
                `;
            }).join('');
            
            if (filtered.length > 500) {
                tbody.innerHTML += `<tr><td colspan="5" style="text-align:center;color:#888;">... e altre ${filtered.length - 500} transazioni</td></tr>`;
            }
        }
        
        // REVOLUT PARSER - Accumula dati da pi√π CSV
        function parseRevolut(content) {
            const lines = content.split('\n');
            const newData = [];
            let addedCount = 0;
            let duplicateCount = 0;
            
            const existingKeys = new Set(
                exchangeData.revolut.map(d => `${d.date}|${d.type}|${d.symbol}|${d.quantity}`)
            );
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Revolut uses comma as decimal separator
                const parts = line.split(',');
                if (parts.length < 7) continue;
                
                const symbol = parts[0];
                const type = parts[1];
                const quantity = parseItalianNumber(parts[2]);
                const price = parseItalianNumber(parts[3]);
                const value = parseItalianNumber(parts[4]);
                const fees = parseItalianNumber(parts[5]);
                const dateStr = parts.slice(6).join(',').replace(/"/g, '');
                
                if (!symbol || !type) continue;
                
                // Parse Italian date format
                const year = extractYear(dateStr);
                
                const entry = {
                    symbol: symbol,
                    type: type,
                    quantity: quantity,
                    price: price,
                    value: value,
                    fees: fees,
                    date: dateStr,
                    year: year
                };
                
                const key = `${entry.date}|${entry.type}|${entry.symbol}|${entry.quantity}`;
                if (!existingKeys.has(key)) {
                    newData.push(entry);
                    existingKeys.add(key);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            }
            
            // AGGIUNGI ai dati esistenti
            exchangeData.revolut = [...exchangeData.revolut, ...newData];
            
            const data = exchangeData.revolut;
            document.getElementById('count-revolut').textContent = data.length;
            document.getElementById('revolut-stats').classList.remove('hidden');
            
            // Stats
            const invested = data.filter(d => d.type === 'Acquisto').reduce((s, d) => s + d.value, 0);
            const sold = data.filter(d => d.type === 'Vendita').reduce((s, d) => s + d.value, 0);
            const fees = data.reduce((s, d) => s + d.fees, 0);
            
            document.getElementById('revolut-tx-count').textContent = data.length;
            document.getElementById('revolut-invested').textContent = '‚Ç¨' + invested.toFixed(0);
            document.getElementById('revolut-sold').textContent = '‚Ç¨' + sold.toFixed(0);
            document.getElementById('revolut-fees').textContent = '‚Ç¨' + fees.toFixed(2);
            
            // Year filter
            const years = [...new Set(data.map(d => d.year).filter(y => y))].sort();
            const yearFilter = document.getElementById('revolut-year-filter');
            yearFilter.innerHTML = '<option value="all">Tutti gli anni</option>';
            years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
            
            renderRevolutTable();
            
            showAlert('revolut', `‚úÖ Aggiunte ${addedCount} transazioni (${duplicateCount} duplicati ignorati). Totale: ${data.length}`);
        }
        
        function renderRevolutTable() {
            const data = exchangeData.revolut;
            const yearFilter = document.getElementById('revolut-year-filter').value;
            const typeFilter = document.getElementById('revolut-type-filter').value;
            
            let filtered = data;
            
            if (yearFilter !== 'all') {
                filtered = filtered.filter(d => d.year === yearFilter);
            }
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(d => d.type === typeFilter);
            }
            
            const tbody = document.getElementById('revolut-table-body');
            tbody.innerHTML = filtered.slice(0, 500).map(d => {
                const badgeClass = d.type === 'Acquisto' ? 'badge-buy' : d.type === 'Vendita' ? 'badge-sell' : 'badge-transfer';
                return `
                    <tr>
                        <td>${d.date}</td>
                        <td><span class="badge ${badgeClass}">${d.type}</span></td>
                        <td>${d.symbol}</td>
                        <td>${d.quantity.toFixed(8)}</td>
                        <td>‚Ç¨${d.price.toFixed(2)}</td>
                        <td>‚Ç¨${d.value.toFixed(2)}</td>
                        <td class="warning">‚Ç¨${d.fees.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // BITPANDA PARSER - Accumula dati da pi√π CSV
        function parseBitpanda(content) {
            const lines = content.split('\n');
            const newData = [];
            let addedCount = 0;
            let duplicateCount = 0;
            
            const existingKeys = new Set(
                exchangeData.bitpanda.map(d => `${d.txId}`)
            );
            
            // Skip header rows (first 6 lines are metadata)
            let startIndex = 0;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('"Transaction ID"')) {
                    startIndex = i + 1;
                    break;
                }
            }
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if (!matches || matches.length < 10) continue;
                
                const clean = matches.map(m => m.replace(/^"|"$/g, '').trim());
                
                const [txId, timestamp, txType, inOut, amountFiat, fiat, amountAsset, asset] = clean;
                
                if (!timestamp || !txType) continue;
                
                const year = timestamp.split('-')[0];
                
                const entry = {
                    txId: txId,
                    date: timestamp,
                    year: year,
                    type: txType,
                    direction: inOut,
                    amountFiat: parseFloat(amountFiat) || 0,
                    fiat: fiat,
                    amountAsset: parseFloat(amountAsset) || 0,
                    asset: asset
                };
                
                if (!existingKeys.has(entry.txId)) {
                    newData.push(entry);
                    existingKeys.add(entry.txId);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            }
            
            // AGGIUNGI ai dati esistenti
            exchangeData.bitpanda = [...exchangeData.bitpanda, ...newData];
            
            // Ordina per data
            exchangeData.bitpanda.sort((a, b) => a.date.localeCompare(b.date));
            
            const data = exchangeData.bitpanda;
            document.getElementById('count-bitpanda').textContent = data.length;
            document.getElementById('bitpanda-stats').classList.remove('hidden');
            
            // Stats
            const deposits = data.filter(d => d.type === 'deposit');
            const buys = data.filter(d => d.type === 'buy');
            const sells = data.filter(d => d.type === 'sell');
            
            document.getElementById('bitpanda-tx-count').textContent = data.length;
            document.getElementById('bitpanda-deposits').textContent = deposits.length;
            document.getElementById('bitpanda-buys').textContent = buys.length;
            document.getElementById('bitpanda-sells').textContent = sells.length;
            
            renderBitpandaTable();
            
            showAlert('bitpanda', `‚úÖ Aggiunte ${addedCount} transazioni (${duplicateCount} duplicati ignorati). Totale: ${data.length}`);
        }
        
        function renderBitpandaTable() {
            const data = exchangeData.bitpanda;
            
            const tbody = document.getElementById('bitpanda-table-body');
            tbody.innerHTML = data.slice(0, 500).map(d => {
                const badgeClass = d.type === 'buy' ? 'badge-buy' : 
                                   d.type === 'sell' ? 'badge-sell' : 
                                   d.type === 'deposit' ? 'badge-deposit' :
                                   d.type === 'reward' ? 'badge-reward' : 'badge-transfer';
                return `
                    <tr>
                        <td>${d.date.split('T')[0]}</td>
                        <td><span class="badge ${badgeClass}">${d.type}</span></td>
                        <td>${d.asset}</td>
                        <td>${d.amountAsset.toFixed(6)}</td>
                        <td>${d.amountFiat > 0 ? '‚Ç¨' + d.amountFiat.toFixed(2) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==================== HELPERS ====================
        function parseItalianNumber(str) {
            if (!str) return 0;
            // Remove ‚Ç¨ or $ and spaces
            str = str.replace(/[‚Ç¨$\s]/g, '');
            // Italian format: 1.234,56 -> 1234.56
            str = str.replace(/\./g, '').replace(',', '.');
            return parseFloat(str) || 0;
        }
        
        function extractYear(dateStr) {
            // Try to find 4-digit year
            const match = dateStr.match(/\b(20\d{2})\b/);
            return match ? match[1] : null;
        }
        
        function getBadgeClass(operation) {
            const op = operation.toLowerCase();
            if (op.includes('buy') || op.includes('acquis')) return 'badge-buy';
            if (op.includes('sell') || op.includes('vend')) return 'badge-sell';
            if (op.includes('deposit')) return 'badge-deposit';
            if (op.includes('withdraw')) return 'badge-withdraw';
            if (op.includes('fee')) return 'badge-fee';
            if (op.includes('reward') || op.includes('interest') || op.includes('staking')) return 'badge-reward';
            return 'badge-transfer';
        }
        
        // ==================== DASHBOARD ====================
        function updateDashboard() {
            let totalTx = 0;
            let activeExchanges = 0;
            const allCoins = new Set();
            
            Object.entries(exchangeData).forEach(([exchange, data]) => {
                totalTx += data.length;
                if (data.length > 0) activeExchanges++;
                
                data.forEach(d => {
                    if (d.coin) allCoins.add(d.coin);
                    if (d.symbol) allCoins.add(d.symbol);
                    if (d.asset) allCoins.add(d.asset);
                });
            });
            
            // Add Binance API tokens to coins
            binanceBalances.spot.forEach(t => allCoins.add(t.symbol));
            binanceBalances.earn.forEach(t => allCoins.add(t.symbol));
            binanceBalances.staking.forEach(t => allCoins.add(t.symbol));
            
            // Add wallet tokens
            if (walletData.wallets) {
                walletData.wallets.forEach(w => {
                    if (w.tokens) w.tokens.forEach(t => allCoins.add(t.symbol));
                });
            }
            
            // Count exchanges with API data
            if (binanceTotals.spot > 0 || binanceTotals.earn > 0) activeExchanges = Math.max(activeExchanges, 1);
            if (walletData.totalEur > 0) activeExchanges++;
            
            document.getElementById('total-transactions').textContent = totalTx.toLocaleString();
            document.getElementById('total-exchanges').textContent = activeExchanges;
            document.getElementById('total-coins').textContent = allCoins.size;
            
            // Calculate total volume
            const binanceTotal = binanceTotals.spot + binanceTotals.earn + binanceTotals.staking;
            const walletTotal = walletData.totalEur || 0;
            const totalValue = binanceTotal + walletTotal;
            
            document.getElementById('total-volume').textContent = '‚Ç¨' + totalValue.toLocaleString('it-IT', {maximumFractionDigits: 0});
            
            updateFiscalSummary();
        }
        
        function updateFiscalSummary() {
            const years = new Set();
            
            Object.values(exchangeData).forEach(data => {
                data.forEach(d => {
                    if (d.year) years.add(d.year);
                });
            });
            
            const sortedYears = [...years].sort();
            
            if (sortedYears.length === 0) {
                document.getElementById('fiscal-years-grid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">Importa i CSV degli exchange per vedere il riepilogo fiscale</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            sortedYears.forEach(year => {
                const yearData = getYearData(year);
                html += `
                    <div class="fiscal-year">
                        <div class="fiscal-year-title">üìÖ Anno ${year}</div>
                        <div class="fiscal-row">
                            <span class="label">Transazioni</span>
                            <span class="value">${yearData.transactions}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="label">Acquisti</span>
                            <span class="value positive">‚Ç¨${yearData.buys.toFixed(0)}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="label">Vendite</span>
                            <span class="value negative">‚Ç¨${yearData.sells.toFixed(0)}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="label">Quadro RW</span>
                            <span class="value" style="color:#fbbf24;">Da calcolare</span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('fiscal-years-grid').innerHTML = html;
        }
        
        function getYearData(year) {
            let transactions = 0;
            let buys = 0;
            let sells = 0;
            
            // Binance
            exchangeData.binance.filter(d => d.year === year).forEach(d => {
                transactions++;
                if (d.operation.includes('Buy') || d.operation.includes('Convert')) {
                    if (d.amount > 0 && (d.coin === 'EUR' || d.coin === 'USD')) {
                        buys += Math.abs(d.amount);
                    }
                }
            });
            
            // Revolut
            exchangeData.revolut.filter(d => d.year === year).forEach(d => {
                transactions++;
                if (d.type === 'Acquisto') buys += d.value;
                if (d.type === 'Vendita') sells += d.value;
            });
            
            // Bitpanda
            exchangeData.bitpanda.filter(d => d.year === year).forEach(d => {
                transactions++;
                if (d.type === 'buy') buys += d.amountFiat;
                if (d.type === 'sell') sells += d.amountFiat;
            });
            
            return { transactions, buys, sells };
        }
        
        // ==================== DATA PERSISTENCE (FIREBASE) ====================
        let saveTimeout = null;
        
        function saveData() {
            localStorage.setItem('crypto_fiscal_data', JSON.stringify(exchangeData));
            saveToFirebase();
        }
        
        async function saveToFirebase() {
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                try {
                    const syncStatus = document.getElementById('syncStatus');
                    syncStatus.innerHTML = '‚è≥ Salvataggio...';
                    syncStatus.style.color = '#fbbf24';
                    
                    await db.collection('fiscal').doc('exchanges').set({
                        exchanges: exchangeData,
                        lastUpdate: new Date().toISOString()
                    });
                    
                    syncStatus.innerHTML = '‚úÖ Sincronizzato ' + new Date().toLocaleTimeString('it-IT');
                    syncStatus.style.color = '#00ff88';
                    console.log('‚úÖ Salvato su Firebase');
                } catch (e) {
                    console.error('Firebase save error:', e);
                    document.getElementById('syncStatus').innerHTML = '‚ùå Errore sync';
                    document.getElementById('syncStatus').style.color = '#ff4757';
                }
            }, 2000);
        }
        
        function forceSaveToFirebase() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = null;
            
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.innerHTML = '‚è≥ Salvataggio...';
            
            db.collection('fiscal').doc('exchanges').set({
                exchanges: exchangeData,
                lastUpdate: new Date().toISOString()
            }).then(() => {
                syncStatus.innerHTML = '‚úÖ Salvato! ' + new Date().toLocaleTimeString('it-IT');
                syncStatus.style.color = '#00ff88';
            }).catch(e => {
                syncStatus.innerHTML = '‚ùå Errore: ' + e.message;
                syncStatus.style.color = '#ff4757';
            });
        }
        
        async function loadData() {
            const syncStatus = document.getElementById('syncStatus');
            
            // Prima prova Firebase
            try {
                syncStatus.innerHTML = '‚è≥ Caricamento...';
                syncStatus.style.color = '#fbbf24';
                
                const doc = await db.collection('fiscal').doc('exchanges').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    if (data.exchanges) {
                        Object.assign(exchangeData, data.exchanges);
                        
                        // Backup locale
                        localStorage.setItem('crypto_fiscal_data', JSON.stringify(exchangeData));
                        
                        const totalTx = Object.values(exchangeData).reduce((s, arr) => s + arr.length, 0);
                        const lastUpdate = data.lastUpdate ? new Date(data.lastUpdate).toLocaleString('it-IT') : 'N/A';
                        syncStatus.innerHTML = 'üî• Firebase OK ‚Ä¢ ' + totalTx + ' transazioni';
                        syncStatus.style.color = '#00ff88';
                        console.log('‚úÖ Caricato da Firebase');
                    }
                } else {
                    syncStatus.innerHTML = 'üì≠ Nessun dato Firebase';
                    syncStatus.style.color = '#888';
                    
                    // Fallback localStorage
                    const saved = localStorage.getItem('crypto_fiscal_data');
                    if (saved) {
                        Object.assign(exchangeData, JSON.parse(saved));
                        syncStatus.innerHTML = 'üíæ Dati locali caricati';
                    }
                }
            } catch (e) {
                console.error('Firebase load error:', e);
                syncStatus.innerHTML = '‚ùå Errore Firebase';
                syncStatus.style.color = '#ff4757';
                
                // Fallback localStorage
                const saved = localStorage.getItem('crypto_fiscal_data');
                if (saved) {
                    Object.assign(exchangeData, JSON.parse(saved));
                }
            }
            
            // Update UI per tutti gli exchange con dati
            Object.keys(exchangeData).forEach(exchange => {
                if (exchangeData[exchange].length > 0) {
                    document.getElementById(`count-${exchange}`).textContent = exchangeData[exchange].length;
                    const statsEl = document.getElementById(`${exchange}-stats`);
                    if (statsEl) statsEl.classList.remove('hidden');
                    
                    if (exchange === 'binance') updateBinanceUI();
                    if (exchange === 'revolut') updateRevolutUI();
                    if (exchange === 'bitpanda') updateBitpandaUI();
                }
            });
            
            updateDashboard();
        }
        
        function updateBinanceUI() {
            const data = exchangeData.binance;
            if (data.length === 0) return;
            
            document.getElementById('binance-tx-count').textContent = data.length;
            const deposits = data.filter(d => d.operation === 'Deposit' && (d.coin === 'EUR' || d.coin === 'USD'));
            const buys = data.filter(d => d.operation === 'Buy' || d.operation.includes('Convert'));
            const sells = data.filter(d => d.operation === 'Sell');
            
            document.getElementById('binance-deposits').textContent = '‚Ç¨' + deposits.reduce((s, d) => s + Math.abs(d.amount), 0).toFixed(0);
            document.getElementById('binance-buys').textContent = buys.length;
            document.getElementById('binance-sells').textContent = sells.length;
            
            const years = [...new Set(data.map(d => d.year))].sort();
            const yearFilter = document.getElementById('binance-year-filter');
            yearFilter.innerHTML = '<option value="all">Tutti gli anni</option>';
            years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
            
            renderBinanceTable();
        }
        
        function updateRevolutUI() {
            const data = exchangeData.revolut;
            if (data.length === 0) return;
            
            document.getElementById('revolut-tx-count').textContent = data.length;
            const invested = data.filter(d => d.type === 'Acquisto').reduce((s, d) => s + d.value, 0);
            const sold = data.filter(d => d.type === 'Vendita').reduce((s, d) => s + d.value, 0);
            const fees = data.reduce((s, d) => s + d.fees, 0);
            
            document.getElementById('revolut-invested').textContent = '‚Ç¨' + invested.toFixed(0);
            document.getElementById('revolut-sold').textContent = '‚Ç¨' + sold.toFixed(0);
            document.getElementById('revolut-fees').textContent = '‚Ç¨' + fees.toFixed(2);
            
            const years = [...new Set(data.map(d => d.year).filter(y => y))].sort();
            const yearFilter = document.getElementById('revolut-year-filter');
            yearFilter.innerHTML = '<option value="all">Tutti gli anni</option>';
            years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
            
            renderRevolutTable();
        }
        
        function updateBitpandaUI() {
            const data = exchangeData.bitpanda;
            if (data.length === 0) return;
            
            document.getElementById('bitpanda-tx-count').textContent = data.length;
            const deposits = data.filter(d => d.type === 'deposit');
            const buys = data.filter(d => d.type === 'buy');
            const sells = data.filter(d => d.type === 'sell');
            
            document.getElementById('bitpanda-deposits').textContent = deposits.length;
            document.getElementById('bitpanda-buys').textContent = buys.length;
            document.getElementById('bitpanda-sells').textContent = sells.length;
            
            renderBitpandaTable();
        }
        
        function clearExchange(exchange) {
            if (confirm(`Cancellare tutti i dati di ${exchange}?`)) {
                exchangeData[exchange] = [];
                document.getElementById(`count-${exchange}`).textContent = '0';
                const statsEl = document.getElementById(`${exchange}-stats`);
                if (statsEl) statsEl.classList.add('hidden');
                saveData();
                updateDashboard();
            }
        }
        
        function exportAllData() {
            const data = {
                version: '1.0',
                lastUpdate: new Date().toISOString(),
                exchanges: exchangeData
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'fiscal_data.json';
            link.click();
            
            showGlobalAlert('üì• File scaricato! Caricalo su GitHub nella cartella /data/', 'success');
        }
        
        function importAllData() {
            document.getElementById('importBackupFile').click();
        }
        
        function handleImportBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.exchanges) {
                        Object.assign(exchangeData, data.exchanges);
                        saveData();
                        location.reload();
                    }
                } catch (err) {
                    alert('Errore nel file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function showGlobalAlert(message, type) {
            const existing = document.getElementById('global-alert');
            if (existing) existing.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'global-alert';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '70px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // ==================== BINANCE API ====================
        let binanceBalances = { spot: [], earn: [], staking: [] };
        let binanceTotals = { spot: 0, earn: 0, staking: 0 };
        let prices = {};
        
        // CoinGecko IDs for price lookup
        const COINGECKO_IDS = {
            'BTC': 'bitcoin', 'ETH': 'ethereum', 'BNB': 'binancecoin', 'SOL': 'solana',
            'XRP': 'ripple', 'ADA': 'cardano', 'DOGE': 'dogecoin', 'DOT': 'polkadot',
            'MATIC': 'matic-network', 'AVAX': 'avalanche-2', 'LINK': 'chainlink',
            'UNI': 'uniswap', 'ATOM': 'cosmos', 'LTC': 'litecoin', 'NEAR': 'near',
            'CAKE': 'pancakeswap-token', 'USDT': 'tether', 'USDC': 'usd-coin'
        };
        
        async function fetchPrices() {
            const ids = Object.values(COINGECKO_IDS).join(',');
            try {
                const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=eur`);
                const data = await res.json();
                for (const [symbol, id] of Object.entries(COINGECKO_IDS)) {
                    if (data[id]) prices[symbol] = data[id].eur;
                }
                // Stablecoins
                prices['USDT'] = 0.96;
                prices['USDC'] = 0.96;
                prices['BUSD'] = 0.96;
                prices['EUR'] = 1;
                console.log('‚úÖ Prezzi caricati');
            } catch (e) {
                console.error('CoinGecko error:', e);
            }
        }
        
        function saveBinanceKeys() {
            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const secretKey = document.getElementById('binanceSecretKey').value.trim();
            
            if (apiKey && secretKey) {
                localStorage.setItem('binance_api_key', apiKey);
                localStorage.setItem('binance_secret_key', secretKey);
                document.getElementById('binanceApiKey').value = '';
                document.getElementById('binanceSecretKey').value = '';
                updateBinanceApiStatus();
                showGlobalAlert('‚úÖ API Binance salvate!', 'success');
            } else {
                showGlobalAlert('‚ö†Ô∏è Inserisci sia API Key che Secret Key', 'warning');
            }
        }
        
        function clearBinanceKeys() {
            localStorage.removeItem('binance_api_key');
            localStorage.removeItem('binance_secret_key');
            binanceBalances = { spot: [], earn: [], staking: [] };
            binanceTotals = { spot: 0, earn: 0, staking: 0 };
            document.getElementById('binanceLiveSection').classList.add('hidden');
            showGlobalAlert('Dati Binance cancellati', 'warning');
        }
        
        // ==================== SERVER SYNC ====================
        const SERVER_URL = 'http://localhost:3456';
        const BINANCE_API_KEY = '8jD5UTifvT5We5aQl09Xx2N5mB4f8emAloyll5dNaAqoONiNGSybCgWhlvSqoI6x';
        const BINANCE_SECRET_KEY = '1SGmpE3diPGw2WsCffImzkGjOf0aCsItiqnOMMEWVfneKm1rYDhB0YlzUA3S7zGN';
        
        async function checkServerStatus() {
            const statusEl = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/status`, { timeout: 2000 });
                if (response.ok) {
                    statusEl.textContent = 'Server Online ‚úì';
                    statusEl.style.background = 'rgba(0,255,136,0.2)';
                    statusEl.style.color = '#00ff88';
                    return true;
                }
            } catch (e) {
                statusEl.textContent = 'Server Offline';
                statusEl.style.background = 'rgba(255,71,87,0.2)';
                statusEl.style.color = '#ff4757';
            }
            return false;
        }
        
        async function syncBinanceFromServer() {
            const syncStatus = document.getElementById('syncStatus');
            const serverStatus = document.getElementById('serverStatus');
            
            syncStatus.innerHTML = '‚è≥ Connessione al server...';
            syncStatus.style.color = '#fbbf24';
            
            try {
                const response = await fetch(`${SERVER_URL}/fetch?apiKey=${BINANCE_API_KEY}&secretKey=${BINANCE_SECRET_KEY}`);
                
                if (!response.ok) {
                    throw new Error('Errore server');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    serverStatus.textContent = 'Server Online ‚úì';
                    serverStatus.style.background = 'rgba(0,255,136,0.2)';
                    serverStatus.style.color = '#00ff88';
                    
                    syncStatus.innerHTML = `‚úÖ Sincronizzato! Totale: ‚Ç¨${data.total.toFixed(2)}`;
                    syncStatus.style.color = '#00ff88';
                    
                    // Ricarica dati da Firebase
                    await loadBinanceFromFirebase();
                    updateDashboard();
                    
                    showGlobalAlert(`‚úÖ Binance sincronizzato: ‚Ç¨${data.total.toFixed(2)}`, 'success');
                } else {
                    throw new Error(data.error || 'Errore sconosciuto');
                }
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    syncStatus.innerHTML = '‚ùå Server non attivo - Avvia AVVIA_SERVER.command';
                    serverStatus.textContent = 'Server Offline';
                    serverStatus.style.background = 'rgba(255,71,87,0.2)';
                    serverStatus.style.color = '#ff4757';
                } else {
                    syncStatus.innerHTML = '‚ùå ' + error.message;
                }
                syncStatus.style.color = '#ff4757';
            }
        }
        
        // Check server status on load
        setTimeout(checkServerStatus, 1000);
        
        function updateBinanceLiveUI() {
            document.getElementById('binanceLiveSection').classList.remove('hidden');
            
            document.getElementById('binance-spot-total').textContent = '‚Ç¨' + binanceTotals.spot.toLocaleString('it-IT', {maximumFractionDigits: 2});
            document.getElementById('binance-earn-total').textContent = '‚Ç¨' + binanceTotals.earn.toLocaleString('it-IT', {maximumFractionDigits: 2});
            document.getElementById('binance-staking-total').textContent = '‚Ç¨' + binanceTotals.staking.toLocaleString('it-IT', {maximumFractionDigits: 2});
            
            const total = binanceTotals.spot + binanceTotals.earn + binanceTotals.staking;
            document.getElementById('binance-total-value').textContent = '‚Ç¨' + total.toLocaleString('it-IT', {maximumFractionDigits: 2});
            
            // Token list
            const allTokens = [
                ...binanceBalances.spot.map(t => ({...t, source: 'Spot'})),
                ...binanceBalances.earn.map(t => ({...t, total: t.amount, source: 'Earn'})),
                ...binanceBalances.staking.map(t => ({...t, total: t.amount, source: 'Staking'}))
            ].sort((a, b) => b.valueEur - a.valueEur);
            
            // Update Binance badge
            const tokenCount = allTokens.length;
            document.getElementById('count-binance').textContent = tokenCount;
            
            if (allTokens.length > 0) {
                document.getElementById('binanceTokensList').innerHTML = `
                    <table class="data-table" style="font-size:12px;">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Tipo</th>
                                <th>Quantit√†</th>
                                <th>Valore EUR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allTokens.slice(0, 20).map(t => `
                                <tr>
                                    <td><strong>${t.symbol}</strong></td>
                                    <td><span class="badge badge-${t.source === 'Spot' ? 'buy' : t.source === 'Earn' ? 'reward' : 'deposit'}">${t.source}</span></td>
                                    <td>${t.total?.toLocaleString('en-US', {maximumFractionDigits: 6}) || t.amount?.toLocaleString('en-US', {maximumFractionDigits: 6})}</td>
                                    <td style="color:#00ff88;font-weight:600;">‚Ç¨${t.valueEur.toLocaleString('it-IT', {maximumFractionDigits: 2})}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${allTokens.length > 20 ? `<div style="text-align:center;color:#888;margin-top:10px;font-size:11px;">+ altri ${allTokens.length - 20} token</div>` : ''}
                `;
            }
            
            // Update dashboard
            updateDashboard();
        }
        
        async function saveBinanceToFirebase() {
            try {
                await db.collection('fiscal').doc('binance_live').set({
                    balances: binanceBalances,
                    totals: binanceTotals,
                    lastUpdate: new Date().toISOString()
                });
                console.log('‚úÖ Binance live data saved to Firebase');
            } catch (e) {
                console.error('Firebase save error:', e);
            }
        }
        
        async function loadBinanceFromFirebase() {
            try {
                const doc = await db.collection('fiscal').doc('binance_live').get();
                if (doc.exists) {
                    const data = doc.data();
                    binanceBalances = data.balances || { spot: [], earn: [], staking: [] };
                    binanceTotals = data.totals || { spot: 0, earn: 0, staking: 0 };
                    
                    if (binanceTotals.spot > 0 || binanceTotals.earn > 0 || binanceTotals.staking > 0) {
                        updateBinanceLiveUI();
                    }
                }
            } catch (e) {
                console.error('Firebase load error:', e);
            }
        }
        
        // ==================== WALLET INTEGRATION ====================
        let walletData = { wallets: [], totalEur: 0 };
        
        async function loadWalletDataFromFirebase() {
            try {
                const doc = await db.collection('users').doc('moreno').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.wallets && data.wallets.length > 0) {
                        walletData.wallets = data.wallets;
                        
                        // Calcola totale EUR (usa rate 0.96)
                        const eurRate = 0.96;
                        walletData.totalEur = data.wallets.reduce((sum, w) => {
                            return sum + (w.totalUSD || 0) * eurRate;
                        }, 0);
                        
                        document.getElementById('count-wallet').textContent = data.wallets.length;
                        console.log('‚úÖ Wallet data loaded:', data.wallets.length, 'wallets, ‚Ç¨' + walletData.totalEur.toFixed(2));
                    }
                }
            } catch (e) {
                console.error('Wallet data load error:', e);
            }
        }
        
        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            await loadBinanceFromFirebase();
            await loadWalletDataFromFirebase();
            checkServerStatus();
            updateDashboard();
        });
        
        // ==================== ALERT SYSTEM ====================
        function showAlert(exchange, message) {
            // Rimuovi alert precedenti
            const oldAlert = document.getElementById(`alert-${exchange}`);
            if (oldAlert) oldAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = `alert-${exchange}`;
            alertDiv.className = 'alert alert-success';
            alertDiv.innerHTML = message;
            alertDiv.style.marginTop = '15px';
            
            const dropzone = document.getElementById(`dropzone-${exchange}`);
            if (dropzone) {
                dropzone.parentNode.insertBefore(alertDiv, dropzone.nextSibling);
            }
            
            // Auto-rimuovi dopo 5 secondi
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>
